<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o V·∫≠n H√†nh Ca Tr·ª±c</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style id="print-styles">
    /* JavaScript s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn l·ªÅ in v√†o ƒë√¢y */
    </style>
    
    <style>
        /* CSS M·ªöI ƒê·ªÇ X·∫æP H√ÄNG NGANG */
        .action-row {
            display: flex;
            align-items: flex-end; /* CƒÉn c√°c ph·∫ßn t·ª≠ theo l·ªÅ d∆∞·ªõi */
            gap: 10px;           /* Kho·∫£ng c√°ch 10px gi·ªØa c√°c ph·∫ßn t·ª≠ */
        }

        /* Cho ph√©p √¥ input d√£n ra l·∫•p ƒë·∫ßy */
        .action-row .form-group {
            flex: 1; /* Quan tr·ªçng: cho ph√©p n√≥ d√£n ra */
        }
        
        /* Ghi ƒë√® l·∫°i 2 n√∫t b·∫•m */
        .action-row .print-button {
            width: auto;      /* H·ªßy 100% width */
            flex-shrink: 0; /* NgƒÉn n√∫t b·ªã co l·∫°i khi m√†n h√¨nh h·∫πp */
            margin: 0;      /* X√≥a margin m·∫∑c ƒë·ªãnh */
        }
        
        /* Ghi ƒë√® style inline c·ªßa n√∫t "L∆∞u" */
        .action-row #save-report-btn {
            margin-bottom: 0 !important;
        }

        .admin-only {
            display: none;/* M·∫∑c ƒë·ªãnh ·∫©n */
        }
        .admin-visible {
            display: block !important; /* L·ªõp n√†y s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o n·∫øu l√† admin */
        }

        :root {
            --border-color: #333;
            --header-bg: #f2f2f2;
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            background-color: #f9f9f9;
            margin: 0;
        }
        
        .container {
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 25px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 7px;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h2 {
            margin: 0;
            font-size: 18px;
            color: #1e4a8a;
            font-weight: bold;
            text-transform: uppercase;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .header-info div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input, select, textarea {
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 4px;
            border-radius: 3px;
            max-width: 100%;
            box-sizing: border-box;
        }

        input.number-input {
            text-align: right;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* ƒê·∫£m b·∫£o input trong b·∫£ng kh√¥ng tr√†n */
        table input,
        table select {
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }
        
        table input.input-small {
            width: 100%;
            max-width: 100px;
        }
        
        input:invalid {
            border-color: #e53935;
            box-shadow: 0 0 3px rgba(229, 57, 53, 0.4);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            max-width: 100%;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 6px !important;
            text-align: center !important;
            vertical-align: middle;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
            max-width: 100%;
        }
        .container table {
                min-width: auto;
            }
        th {
            background-color: #d5ddf5;
            font-weight: bold;
            color: #1e4a8a;
        }
        
        .staff-table th {
            background-color: #d5ddf5;
            color: #1e4a8a;
        }
        
        .section-title {
            font-weight: bold;
            text-align: left;
            margin: 5px 0 0px 0;
        }

        .staff-section {
            display: flex;
            flex-direction: row;
            gap: 5px;
            margin-bottom: 10px;
        }

        .staff-table {
            flex: 1;
            min-width: 0;
        }

        .staff-table td:first-child {
            width: 5%;
        }
        
        .staff-table td:nth-child(2) {
            width: 70%;
        }

        .staff-table td:last-child {
            width: 25%;
            text-align: left !important;
            padding-left: 5px;
        }

        .notes-section textarea {
            width: 100%;
            min-height: 150px;
            box-sizing: border-box;
            resize: vertical;
        }
        
        .text-left {
            text-align: left;
        }
        
        .input-full {
            width: 95%;
            border: none;
            border-bottom: 1px dotted #000;
        }
        
        .input-small {
             width: 100px;
             text-align: center;
             box-sizing: border-box;
        }

        .print-button {
            display: block;
            width: 100%;
            padding: 9px;
            margin-top: 25px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .print-button:hover {
            background-color: #0056b3;
        }
        #save-report-btn:hover {
            background-color: #218838; /* M√†u xanh l√° ƒë·∫≠m h∆°n */
        }

        .table-scroll-wrapper {
            overflow-x: visible; 
            margin-bottom: 0px !important; 
        }
        
        .table-scroll-wrapper table {
            margin-bottom: 10px;
            width: 100%;
            table-layout: auto;
        }
        
        /* Fix cho b·∫£ng admin config */
        #shiftConfig {
            overflow-x: hidden;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        #shift-list-table {
            width: 100% !important;
            max-width: 100%;
            table-layout: fixed;
            box-sizing: border-box;
        }
        
        #shift-list-table th,
        #shift-list-table td {
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 6px 4px !important;
            font-size: 13px;
        }
        
        #shift-list-table th:nth-child(1),
        #shift-list-table td:nth-child(1) {
            width: 40%;
        }
        
        #shift-list-table th:nth-child(2),
        #shift-list-table td:nth-child(2),
        #shift-list-table th:nth-child(3),
        #shift-list-table td:nth-child(3) {
            width: 18%;
        }
        
        #shift-list-table th:nth-child(4),
        #shift-list-table td:nth-child(4) {
            width: 24%;
        }
        
        #shift-list-table button {
            font-size: 12px;
            padding: 4px 6px;
            white-space: nowrap;
        }
        
        #shiftConfig > div {
            max-width: 100%;
            box-sizing: border-box;
        }

/* ----- CSS M·ªöI: ·∫®N SPAN TR√äN M√ÄN H√åNH ----- */
        .print-only-span {
            display: none; /* ·∫®n tr√™n m√†n h√¨nh */
            width: 100%;
            display: block;
            box-sizing: border-box;
        }


        /* ----- B·∫ÆT ƒê·∫¶U CSS IN M·ªöI (V4) ----- */
        @media print {
            /* --- ‚≠ê D√ÅN CODE S·ª¨A L·ªñI V√ÄO ƒê√ÇY ‚≠ê --- */
            .staff-section {
                display: flex !important;
                flex-direction: row !important; /* √âp x·∫øp h√†ng ngang khi in */
                gap: 5px;
            }
            .staff-table {
                flex: 1; /* ƒê·∫£m b·∫£o 2 b·∫£ng chia ƒë·ªÅu */
            }
            /* ----- 1. THI·∫æT L·∫¨P TRANG IN (√âP G·∫ÆT) ----- */
            body {
                font-size: 12px;
                line-height: 1.1;
                background-color: #fff;
                padding: 0;
            }
            .main-container, .container {
                max-width: none; padding: 0; border: none; box-shadow: none;
            }
            
            /* L·ªÅ g√°y s·ªï (Gi·ªØ l·∫°i logic c≈© c·ªßa b·∫°n) */
            /* @page { margin: 0.5cm 1cm 0.5cm 2.5cm; } */

            /* ----- 2. ·∫®N C√ÅC TH√ÄNH PH·∫¶N TH·ª™A ----- */
            .print-button, #menu-placeholder, #footer-placeholder, #shiftConfig { 
                display: none !important; 
            }
            /* QUY T·∫ÆC M·ªöI ƒê·ªÇ ·∫®N HO√ÄN TO√ÄN PH·∫¶N H√åNH ·∫¢NH */
            #image-title,          /* ·∫®n ti√™u ƒë·ªÅ m·ªõi th√™m ID */
            #existing-images,      /* ·∫®n container ·∫£nh */
            #report-images,        /* ·∫®n input file */
            .action-row .form-group { /* ƒê·∫£m b·∫£o ·∫©n kh·ªëi ch·ª©a input file */
                display: none !important; 
            }

            /* ƒê·∫£m b·∫£o ch·ªâ ·∫©n c√°c ph·∫ßn T·∫¢I ·∫¢NH, gi·ªØ l·∫°i c√°c n√∫t SAVE/PRINT*/
            .action-row {
                justify-content: flex-end; /* Ch·ªâ cƒÉn ph·∫£i c√°c n√∫t c√≤n l·∫°i (L∆∞u, In) */
                display: none !important;
            }
            /* ·∫®n th·∫ª <br> n·∫±m ngay sau h√†ng n√∫t */
            .action-row + br {
                display: none !important;
            }
            /* ----- 3. T·ªêI ∆ØU CHI·ªÄU D·ªåC (N√âN G·∫ÆT) ----- */
            header { margin-bottom: 4px; }
            header h2 { font-size: 15px; }
            .header-info { margin-bottom: 4px; }
            
            .section-title { 
                margin: 4px 0 1px 0;
                font-size: 12px;
                page-break-after: avoid; 
            }
            table { 
                margin-bottom: 2px !important;
                margin-top: 0px !important;
            }
            th, td { 
                padding: 2px 3px !important;
                vertical-align: middle; /* CƒÉn gi·ªØa cho ƒë·∫πp */
                border: 1px solid #000 !important;
            }
            .staff-table th {
                font-size: 12px;
                padding: 1px 3px;
            }

            /* ----- 4. GI·∫¢I PH√ÅP M·ªöI (·∫®N INPUT, HI·ªÜN SPAN) ----- */
            
            /* ·∫®n t·∫•t c·∫£ c√°c √¥ nh·∫≠p li·ªáu */
            .container input, 
            .container select, 
            .container textarea {
                display: none !important;
            }

            /* HI·ªÇN TH·ªä C√ÅC SPAN M√Ä CH√öNG TA ƒê√É T·∫†O */
            .print-only-span {
                display: block !important; /* Hi·ªÉn th·ªã khi in */
                color: #000;
            }
            /* S·ª¨A L·ªñI R·ªöT H√ÄNG "CA TR·ª∞C" */
            .header-info .print-only-span {
                display: inline !important; /* Cho ph√©p n√≥ n·∫±m c√πng h√†ng */
                width: auto !important;
            }
            /* ----- 6. THU H·∫∏P C·ªòT "CH·ªà S·ªê ƒê·ªíNG H·ªí" ----- */
            
            /* Ch·ªçn c·ªôt ƒë·∫ßu ti√™n c·ªßa b·∫£ng (table) ngay sau ti√™u ƒë·ªÅ (.section-title) */
            .container .section-title + table th:first-child, 
            .container .section-title + table td:first-child {
                width: 20% !important; /* ƒê·∫∑t chi·ªÅu r·ªông nh·ªè (b·∫°n c√≥ th·ªÉ ch·ªânh 20% - 30%) */
            }
            /* X·ª≠ l√Ω Ghi ch√∫ (textarea) -> gi·ªù l√† span */
            .notes-section .print-only-span {
                height: 250px;
                min-height: 60px;
                border: 1px solid #999;
                padding: 3px;
                text-align: left;
                overflow: hidden;
                /* Cho ph√©p xu·ªëng d√≤ng */
                white-space: pre-wrap; 
            }
            
            /* ----- 5. X·ª¨ L√ù √î K√ù T√äN ----- */
            .staff-table td:last-child {
                border: none;
                border-bottom: 1px dotted #333;
                text-align: left;
                padding-left: 10px;
                vertical-align: bottom;
            }
        }

        @media (max-width: 768px) {
            
            /* --- S·ª¨A L·ªñI CH√çNH: CHO CONTAINER V·ª™A M√ÄN H√åNH --- */
            .main-container {
                max-width: 100%;
                width: 100%;
                padding: 0;
                box-sizing: border-box;
            }
            .container {
                padding: 10px;
                width: 100%;
                box-sizing: border-box;
            }
            /* --- H·∫æT S·ª¨A L·ªñI CH√çNH --- */

            /* B·∫≠t cu·ªôn ngang cho b·∫£ng tr√™n mobile */
            .table-scroll-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* S·ª¨A L·ªñI 1: Cho 2 b·∫£ng nh√¢n vi√™n x·∫øp d·ªçc */
            .staff-section {
                flex-direction: column;
            }

            /* S·ª¨A L·ªñI 2: Cho h√†ng input c·ªßa Admin t·ª± xu·ªëng d√≤ng */
            #shiftConfig > div {
                flex-wrap: wrap;
            }

            

            
           

            /* S·ª¨A L·ªñI 4: CHO "NG√ÄY" V√Ä "CA" C√ôNG 1 H√ÄNG */
            .header-info {
                flex-wrap: nowrap;
                justify-content: space-between;
                align-items: center;
                gap: 5px;
                font-size: 12px;
            }
            
            .header-info div {
                display: flex;
                align-items: center;
                gap: 4px;
                flex-shrink: 0;
            }
            
            .header-info input[type="date"] {
                width: 110px;
                font-size: 11px;
                padding: 2px;
            }
            
            .header-info select {
                width: 95px;
                font-size: 11px;
                padding: 2px;
            }
            
            /* Gi·∫£m font size cho t√™n nh√¢n vi√™n */
            .staff-table select,
            .staff-table input {
                font-size: 11px;
            }
            
            /* Gi·∫£m font size cho t√™n h√≥a ch·∫•t */
            #chemicals-table input {
                font-size: 11px;
            }
            
            /* Gi·∫£m chi·ªÅu cao c·ªßa t·∫•t c·∫£ input trong b·∫£ng */
            table input,
            table select {
                padding: 1px 3px !important;
                font-size: 11px !important;
                height: 22px !important;
                line-height: 1.2;
            }
            
            table input[type="time"],
            table input.input-small {
                padding: 1px 2px !important;
                font-size: 10px !important;
                height: 20px !important;
            }
            
            table textarea {
                padding: 3px !important;
                font-size: 11px !important;
                line-height: 1.3;
            }
            
            /* Gi·∫£m font size cho c√°c ti√™u ƒë·ªÅ section */
            .section-title {
                font-size: 12px !important;
            }
            
            /* Gi·∫£m font size cho header c·ªßa b·∫£ng */
            table th {
                font-size: 11px !important;
                padding: 3px 2px !important;
            }
            
            /* Gi·∫£m font size cho n·ªôi dung √¥ b·∫£ng */
            table td {
                font-size: 11px !important;
                padding: 3px 2px !important;
            }
        }
    </style>
</head>
<body>

<div id="menu-placeholder"></div>
<div id="loading-placeholder"></div>

<div class="main-container">
<div id="notLogged" style="display:none; text-align:center; padding: 20px;"> 
    <h2>‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.</h2>
</div>

    <div id="pageContent" style="display:none;">
        <datalist id="chemical-list">
            <option value="Polymer Anion"></option>
            <option value="Polymer Cation"></option>
            <option value="PAC"></option>
            <option value="Chlorine"></option>
            <option value="Javen"></option>
            <option value="Ph√®n s·∫Øt"></option>
            <option value="Ph√®n nh√¥m"></option>
            <option value="X√∫t (NaOH)"></option>
            <option value="Axit Sunfuric (H2SO4)"></option>
        </datalist>

        <div class="container">
            <header>
                <h2>B√ÅO C√ÅO V·∫¨N H√ÄNH CA TR·ª∞C</h2>
            </header>

            <div class="header-info">
                <div>
                    Ng√†y: <input type="date" id="reportDate" required>
                </div>
                <div>
                    Ca tr·ª±c: 
                    <select id="shiftSelect">
                        <option value="ngay">Ca ng√†y</option>
                        <option value="dem">Ca ƒë√™m</option>
                    </select>
                </div>
            </div>
            
            <div class="staff-section">
                <table class="staff-table">
                    <thead>
                        <tr>
                            <th colspan="3">Nh√¢n vi√™n giao ca</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1/</td><td><select id="handover-staff-1" class="staff-select input-full"></select></td><td>k√Ω t√™n:</td></tr>
                        <tr><td>2/</td><td><select id="handover-staff-2" class="staff-select input-full"></select></td><td>k√Ω t√™n:</td></tr>
                        <tr><td>3/</td><td><select id="handover-staff-3" class="staff-select input-full"></select></td><td>k√Ω t√™n:</td></tr>
                    </tbody>
                </table>
                <table class="staff-table">
                    <thead>
                        <tr>
                            <th colspan="3" id="receiving-shift-title">Nh√¢n vi√™n nh·∫≠n ca</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1/</td><td><select id="receiving-staff-1" class="staff-select input-full" required></select></td><td>k√Ω t√™n:</td></tr>
                        <tr><td>2/</td><td><select id="receiving-staff-2" class="staff-select input-full"></select></td><td>k√Ω t√™n:</td></tr>
                        <tr><td>3/</td><td><select id="receiving-staff-3" class="staff-select input-full"></select></td><td>k√Ω t√™n:</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="section-title">C√°c ch·ªâ s·ªë ƒêi·ªán v√† N∆∞·ªõc c·∫•p:</div>
            <div class="table-scroll-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">Ch·ªâ s·ªë</th>
                            <th colspan="3">ƒê·∫ßu ca</th>
                            <th colspan="3">Cu·ªëi ca</th>
                            <th rowspan="2">S·ªë l∆∞·ª£ng</th>
                        </tr>
                        <tr>
                            <th>B√¨nh th∆∞·ªùng</th><th>Cao ƒëi·ªÉm</th><th>Th·∫•p ƒëi·ªÉm</th>
                            <th>B√¨nh th∆∞·ªùng</th><th>Cao ƒëi·ªÉm</th><th>Th·∫•p ƒëi·ªÉm</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-left">ƒêi·ªán</td>
                            <td><input type="text" id="dien-bt-dau" class="number-input calc-dien" required></td>
                            <td><input type="text" id="dien-cd-dau" class="number-input calc-dien" required></td>
                            <td><input type="text" id="dien-td-dau" class="number-input calc-dien" required></td>
                            <td><input type="text" id="dien-bt-cuoi" class="number-input calc-dien" required></td>
                            <td><input type="text" id="dien-cd-cuoi" class="number-input calc-dien" required></td>
                            <td><input type="text" id="dien-td-cuoi" class="number-input calc-dien" required></td>
                            <td><span id="dien-sl">0</span> kWh</td>
                        </tr>
                        <tr>
                            <td class="text-left">N∆∞·ªõc c·∫•p</td>
                            <td colspan="3"><input type="text" id="nuoc-dau" class="number-input calc-nuoc" required></td>
                            <td colspan="3"><input type="text" id="nuoc-cuoi" class="number-input calc-nuoc" required></td>
                            <td><span id="nuoc-sl">0</span> m¬≥</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section-title">Ch·ªâ s·ªë ƒë·ªìng h·ªì ƒëo l∆∞u l∆∞·ª£ng ƒë·∫ßu v√†o (b·ªÉ ƒëi·ªÅu h√≤a) v√† ƒë·∫ßu ra (k√™nh ƒëo l∆∞u l∆∞·ª£ng):</div>
            <table>
                <thead>
                    <tr>
                        <th>Ch·ªâ s·ªë ƒê·ªìng h·ªì</th>
                        <th>ƒê·∫ßu ca</th>
                        <th>Cu·ªëi ca</th>
                        <th>T·ªïng (m¬≥)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-left">ƒê·∫ßu v√†o</td>
                        <td><input type="text" id="flow-in-start" class="number-input calc-flow-in" required></td>
                        <td><input type="text" id="flow-in-end" class="number-input calc-flow-in" required></td>
                        <td><span id="flow-in-total">0</span></td>
                    </tr>
                    <tr>
                        <td class="text-left">ƒê·∫ßu ra</td>
                        <td><input type="text" id="flow-out-start" class="number-input calc-flow-out" required></td>
                        <td><input type="text" id="flow-out-end" class="number-input calc-flow-out" required></td>
                        <td><span id="flow-out-total">0</span></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="section-title">H√≥a ch·∫•t s·ª≠ d·ª•ng trong ca:</div>
            <table id="chemicals-table">
                <thead>
                    <tr>
                        <th>T√™n h√≥a ch·∫•t</th>
                        <th>S·ªë l∆∞·ª£ng s·ª≠ d·ª•ng trong ca (kg)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td class="text-left"><input type="text" class="input-full" list="chemical-list" value="Polymer Anion"></td><td><input type="text" class="number-input"></td></tr>
                    <tr><td class="text-left"><input type="text" class="input-full" list="chemical-list" value="PAC"></td><td><input type="text" class="number-input"></td></tr>
                    <tr><td class="text-left"><input type="text" class="input-full" list="chemical-list" value="Chlorine"></td><td><input type="text" class="number-input"></td></tr>
                    <tr><td class="text-left"><input type="text" class="input-full" list="chemical-list" value="Polymer Cation"></td><td><input type="text" class="number-input"></td></tr>
                    <tr><td class="text-left"><input type="text" class="input-full" list="chemical-list" placeholder="H√≥a ch·∫•t kh√°c..."></td><td><input type="text" class="number-input"></td></tr>
                    <tr><td class="text-left"><input type="text" class="input-full" list="chemical-list" placeholder="H√≥a ch·∫•t kh√°c..."></td><td><input type="text" class="number-input"></td></tr>
                </tbody>
            </table>

            <div class="section-title">C√°c th√¥ng s·ªë h·ªá th·ªëng sinh h·ªçc:</div>
            <div class="table-scroll-wrapper">
                <table id="bio-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Gi·ªù</th>
                            <th colspan="3">Ki·ªÉm so√°t DO (mg/l)</th>
                            <th colspan="3">Ki·ªÉm so√°t SV30 (mg/l)</th>
                        </tr>
                        <tr>
                            <th>Anoxic</th><th>Aerobic</th><th>Aerobic</th>
                            <th>Anoxic</th><th>Aerobic</th><th>Aerobic</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="time" class="input-small"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                        </tr>
                        <tr>
                            <td><input type="time" class="input-small"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section-title">Ki·ªÉm so√°t n∆∞·ªõc th·∫£i ƒë·∫ßu ra:</div>
            <div class="table-scroll-wrapper">
                <table id="output-table">
                    <thead>
                        <tr>
                            <th>Gi·ªù</th><th>pH</th><th>COD</th><th>N</th><th>TSS</th><th>Clo d∆∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="time" class="input-small"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                        </tr>
                        <tr>
                            <td><input type="time" class="input-small"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                            <td><input type="text" class="number-input"></td><td><input type="text" class="number-input"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section-title notes-section">
                N·ªôi dung ca tr·ª±c v√† nh·ªØng ƒëi·ªÅu ch·ªânh c√¥ng ngh·ªá (n·∫øu c√≥):
                <textarea maxlength="750"></textarea>
            </div>

            <div class="section-title" style="margin-top: 10px;" id="image-title">H√¨nh ·∫£nh ƒë√≠nh k√®m:</div>
            <div id="existing-images" style="margin-top: 5px; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
            </div>

            <div class="action-row">
                <div class="form-group" style="margin-bottom: 0;">
                    <input type="file" id="report-images" class="form-control-file" 
                        accept="image/*" multiple>
                </div>
                
                <button id="save-report-btn" class="print-button" style="background-color: #28a745;">üíæ L∆∞u B√°o c√°o</button>
                
                <button class="print-button" onclick="window.print()">üñ®Ô∏è In B√°o C√°o</button>
            </div>
        <br>
            <div id="shiftConfig" class="admin-only" style="display: none; margin-bottom: 20px; padding: 15px; background: #f0f7ff; border: 1px solid #b3d7ff; border-radius: 8px;">
                <h3 style="margin-top: 0; color: #0056b3;">‚öôÔ∏è C√†i ƒë·∫∑t Ca B√°o C√°o (Admin)</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <input type="text" id="shift-name" placeholder="T√™n ca (vd: Ca 1)" style="flex: 1; min-width: 120px;">
                    <label>T·ª´:</label>
                    <input type="time" id="shift-start-time" style="width: 100px;">
                    <label>ƒê·∫øn:</label>
                    <input type="time" id="shift-end-time" style="width: 100px;">
                    <label style="display: flex; align-items: center; gap: 4px; background: #fff; padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc;">
                        <input type="checkbox" id="shift-is-next-day"> K·∫øt th√∫c h√¥m sau
                    </label>
                    <button id="save-shift-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">üíæ L∆∞u</button>
                </div>
                <table style="width: 100%;" id="shift-list-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;">T√™n Ca</th>
                            <th>B·∫Øt ƒë·∫ßu</th>
                            <th>K·∫øt th√∫c</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="shift-list-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="footer-placeholder" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script type="module">
    // 1. IMPORT C√ÅC H√ÄM D√ôNG CHUNG
    import { db, onAuth, getRole, showSwal, showLoading, hideLoading, addLog, auth } from "./script.js";
    import { collection, getDocs, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp, setDoc, getDoc, query, where, orderBy, limit, documentId } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { initMenu } from "./menu.js";

    // C√ÅC H√ÄM HELPER TO√ÄN C·ª§C
    // ===== X·ª¨ L√ù NH·∫¨P S·ªê KI·ªÇU VI·ªÜT NAM (LOGIC C≈®) =====
        function parseDisplayValue(str) {
            if (!str) return NaN;
            str = String(str).replace(/\./g, '').replace(',', '.').trim();
            const num = parseFloat(str);
            return isNaN(num) ? NaN : num;
        }

        function formatNumberForDisplay(num) {
            if (num == null || isNaN(num)) return '';
            return new Intl.NumberFormat('vi-VN', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 1
            }).format(num);
        }
        const getVal = (id) => document.getElementById(id)?.value || "";
        // K·∫æT TH√öC HELPER

        // ===== T√çNH TO√ÅN T·ª∞ ƒê·ªòNG (LOGIC C≈®) =====
        function calculateSum(startIds, endIds, resultId) {
            const resultSpan = document.getElementById(resultId);
            let total = 0;
            const isElectric = (startIds.length === 3 && endIds.length === 3);

            if (isElectric) {
                for (let i = 0; i < 3; i++) {
                    const startVal = parseDisplayValue(document.getElementById(startIds[i])?.value);
                    const endVal = parseDisplayValue(document.getElementById(endIds[i])?.value);
                    if (isNaN(startVal) || isNaN(endVal) || endVal < startVal) {
                        resultSpan.textContent = 'L·ªói!'; resultSpan.style.color = 'red'; return;
                    }
                    total += (endVal - startVal);
                }
            } else {
                let startTotal = 0, endTotal = 0;
                startIds.forEach(id => startTotal += parseDisplayValue(document.getElementById(id)?.value));
                endIds.forEach(id => endTotal += parseDisplayValue(document.getElementById(id)?.value));
                if (isNaN(startTotal) || isNaN(endTotal) || endTotal < startTotal) {
                     resultSpan.textContent = 'L·ªói!'; resultSpan.style.color = 'red'; return;
                }
                total = endTotal - startTotal;
            }
            resultSpan.textContent = formatNumberForDisplay(total);
            resultSpan.style.color = '';
        }
        function getChemicalsData() {
            const data = [];
            document.querySelectorAll('#chemicals-table tbody tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 2) {
                    const name = inputs[0].value;
                    const quantity = inputs[1].value;
                    if (name || quantity) { 
                        data.push({ chemicalName: name, quantity: quantity });
                    }
                }
            });
            return data;
        }

        function getBioData() {
            const data = [];
            document.querySelectorAll('#bio-table tbody tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 7) {
                    data.push({
                        time: inputs[0].value,
                        do_anoxic: inputs[1].value,
                        do_aero1: inputs[2].value,
                        do_aero2: inputs[3].value,
                        sv30_anoxic: inputs[4].value,
                        sv30_aero1: inputs[5].value,
                        sv30_aero2: inputs[6].value,
                    });
                }
            });
            return data;
        }

        function getOutputData() {
            const data = [];
            document.querySelectorAll('#output-table tbody tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length === 6) {
                    data.push({
                        time: inputs[0].value,
                        ph: inputs[1].value,
                        cod: inputs[2].value,
                        n: inputs[3].value,
                        tss: inputs[4].value,
                        clo: inputs[5].value,
                    });
                }
            });
            return data;
        }
        /**
         * HELPER 9.1: Chuy·ªÉn ƒë·ªïi URL Google Drive View th√†nh URL Thumbnail
         */
        function getDriveThumbnailUrl(viewUrl) {
            try {
                // Tr√≠ch xu·∫•t ID file t·ª´ URL d·∫°ng ".../d/FILE_ID/view..."
                const match = viewUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    const fileId = match[1];
                    return `https://drive.google.com/thumbnail?id=${fileId}`;
                }
                // N·∫øu kh√¥ng kh·ªõp, tr·∫£ v·ªÅ URL g·ªëc (c√≥ th·ªÉ l√† ƒë·ªãnh d·∫°ng kh√°c)
                return viewUrl; 
            } catch (e) {
                console.error("L·ªói chuy·ªÉn ƒë·ªïi URL Drive:", e, viewUrl);
                return viewUrl; // Tr·∫£ v·ªÅ g·ªëc n·∫øu l·ªói
            }
        }
        /**
         * HELPER 9.2: Chuy·ªÉn ƒë·ªïi URL Google Drive View th√†nh URL xem tr·ª±c ti·∫øp (ƒê·ªô ph√¢n gi·∫£i cao)
         */
        function getDriveDirectUrl(viewUrl) {
            try {
                // Tr√≠ch xu·∫•t ID file t·ª´ URL d·∫°ng ".../d/FILE_ID/view..."
                const match = viewUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    const fileId = match[1];
                    // D√πng "uc" (user content) ƒë·ªÉ l·∫•y link tr·ª±c ti·∫øp
                    return `https://drive.google.com/uc?id=${fileId}`;
                }
                return viewUrl; // Tr·∫£ v·ªÅ g·ªëc n·∫øu kh√¥ng kh·ªõp
            } catch (e) {
                return viewUrl;
            }
        }
        /**
         * HELPER 9.3: L·∫•y ·∫£nh thumbnail K√çCH TH∆Ø·ªöC L·ªöN (ƒë·ªÉ xem)
         */
        function getDriveLargePreviewUrl(viewUrl, width = 1200) {
            try {
                // Tr√≠ch xu·∫•t ID file
                const match = viewUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    const fileId = match[1];
                    // Th√™m tham s·ªë &sz=w[width] ƒë·ªÉ y√™u c·∫ßu ·∫£nh r·ªông [width] pixel
                    return `https://drive.google.com/thumbnail?id=${fileId}&sz=w${width}`;
                }
                return viewUrl; // Tr·∫£ v·ªÅ g·ªëc n·∫øu kh√¥ng kh·ªõp
            } catch (e) {
                return viewUrl;
            }
        }
        // --- K·∫æT TH√öC H√ÄM M·ªöI ---

    // 2. T·∫¢I C√ÅC TH√ÄNH PH·∫¶N GIAO DI·ªÜN CHUNG
    fetch("menu.html").then(r => r.text()).then(h => {
        document.getElementById("menu-placeholder").innerHTML = h;
        initMenu();
        
    });
    fetch("modal.html").then(r => r.text()).then(h => {
        document.getElementById("loading-placeholder").innerHTML = h;
    });
    fetch("footer.html").then(r => r.text()).then(h => {
        document.getElementById("footer-placeholder").innerHTML = h;
    });

    const notLogged = document.getElementById("notLogged");
    const pageContent = document.getElementById("pageContent");

    let userRole = "user"; // Bi·∫øn l∆∞u vai tr√≤
    let allReportShifts = []; // Bi·∫øn l∆∞u tr·ªØ t·∫•t c·∫£ c√°c ca b√°o c√°o
    const shiftConfigDiv = document.getElementById("shiftConfig");

    let autoplanTimes = new Set(); // Stores unique 'HH:MM' times from autoplan
    let allPatternsData = [];
    let allStaffNames = [];
    let allShiftRules = [];
    let refDate = null;


    // 3. KI·ªÇM TRA TR·∫†NG TH√ÅI ƒêƒÇNG NH·∫¨P (ƒê√É C·∫¨P NH·∫¨T)
    onAuth(async (user) => {
        if (!user) {
            notLogged.style.display = "block";
            pageContent.style.display = "none";
            document.getElementById("footer-placeholder").style.display = "none";
            // Kh√¥ng c·∫ßn hideLoading() ·ªü ƒë√¢y v√¨ ch√∫ng ta ch∆∞a b·∫≠t n√≥
            return;
        }

        // 1. ·∫®n th√¥ng b√°o l·ªói "ch∆∞a ƒëƒÉng nh·∫≠p"
        notLogged.style.display = "none"; 

        // 2. Hi·ªÉn th·ªã n·ªôi dung trang v√† footer
        pageContent.style.display = "block";
        document.getElementById("footer-placeholder").style.display = "block";

        // 3. L·∫•y vai tr√≤ c·ªßa user v√† hi·ªÉn th·ªã ph·∫ßn c·ªßa admin (n·∫øu c√≥)
        // ‚≠êÔ∏è T·∫£i song song Role v√† WorkPatterns ‚≠êÔ∏è
        const [role, patternsResult] = await Promise.all([
            getRole(user.email),
            loadWorkPatterns() // G·ªçi h√†m t·∫£i ·ªü ƒë√¢y
        ]);

        userRole = role; // G√°n vai tr√≤
        if (userRole === "admin") {
            shiftConfigDiv.classList.add("admin-visible");
        }

        // Ch·∫°y c√°c h√†m kh·ªüi t·∫°o (truy·ªÅn 'true' ƒë·ªÉ b√°o hi·ªáu patterns ƒë√£ ƒë∆∞·ª£c t·∫£i)
        initializeReportPage(true); 
        setupShiftAdminListeners();
    });

    // ===================================================================
    // H√ÄM KH·ªûI T·∫†O CH√çNH C·ª¶A TRANG B√ÅO C√ÅO
    // ===================================================================
    async function initializeReportPage(patternsLoaded = false) {
        document.querySelectorAll('.number-input').forEach(input => {
            input.addEventListener('focus', e => {
                const raw = parseDisplayValue(e.target.value);
                e.target.value = !isNaN(raw) ? String(raw).replace('.', ',') : '';
            });
            input.addEventListener('blur', e => {
                const val = parseDisplayValue(e.target.value);
                e.target.value = isNaN(val) ? '' : formatNumberForDisplay(val);
                e.target.dispatchEvent(new Event('change', { bubbles: true }));
            });
        });
        
        
        
        // ===== C√ÄI ƒê·∫∂T BAN ƒê·∫¶U (LOGIC C≈®) =====
        function setupPage() {
            //document.getElementById('reportDate').valueAsDate = new Date();
            const currentHour = new Date().getHours();
            //document.getElementById('shiftSelect').value = (currentHour >= 6 && currentHour < 18) ? 'ngay' : 'dem';
            updatePrintMargins();
        }
        
        // --- CH·∫†Y C√ÅC H√ÄM KH·ªûI T·∫†O ---
        setupPage();
        // Ch·ªâ t·∫£i n·∫øu 'onAuth' ch∆∞a t·∫£i
        if (!patternsLoaded) {
            await loadWorkPatterns(); 
        }
        populateStaffDropdowns();
        
        

        // G·∫Øn s·ª± ki·ªán
        document.getElementById('reportDate').addEventListener('change', onShiftOrDateChange);
        document.getElementById('shiftSelect').addEventListener('change', onShiftOrDateChange);

        //document.getElementById('save-report-btn').addEventListener('click', saveReport);

        document.addEventListener('change', function(e) {
            const target = e.target;
            if (target.classList.contains('calc-dien')) {
                 calculateSum(['dien-bt-dau', 'dien-cd-dau', 'dien-td-dau'], ['dien-bt-cuoi', 'dien-cd-cuoi', 'dien-td-cuoi'], 'dien-sl');
            } else if (target.classList.contains('calc-nuoc')) {
                calculateSum(['nuoc-dau'], ['nuoc-cuoi'], 'nuoc-sl');
            } else if (target.classList.contains('calc-flow-in')) {
                calculateSum(['flow-in-start'], ['flow-in-end'], 'flow-in-total');
            } else if (target.classList.contains('calc-flow-out')) {
                calculateSum(['flow-out-start'], ['flow-out-end'], 'flow-out-total');
            }
        });
    }
    // ===== 5 H√ÄM (updatePrintMargins, loadWorkPatterns, ...)
    function updatePrintMargins() {
                const shift = document.getElementById('shiftSelect').value;
                const styleElement = document.getElementById('print-styles');
                styleElement.innerHTML = (shift === 'ngay')
                    ? '@page { margin: 0.5cm 1cm 0.5cm 2.5cm; }'
                    : '@page { margin: 0.5cm 2.5cm 0.5cm 1cm; }';
    }
            
    // ===== LOGIC M·ªöI: LI√äN K·∫æT D·ªÆ LI·ªÜU T·ª™ AUTOPLAN =====
        
        async function loadWorkPatterns() {
            try {
                const querySnapshot = await getDocs(collection(db, "work_patterns"));
            allPatternsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // L·ªçc v√† t√≠nh to√°n tr∆∞·ªõc d·ªØ li·ªáu xoay ca
            allShiftRules = allPatternsData.filter(p => p.type === 'shift_rotation');
            if (allShiftRules.length > 0) {
                 const sortedAllRules = [...allShiftRules].sort(sortShiftRules);
                 refDate = new Date(sortedAllRules[0].patternStartDate + 'T00:00:00');
            }

            const staffNameSet = new Set(allPatternsData.map(p => p.displayName).filter(Boolean));
            allStaffNames = Array.from(staffNameSet).sort((a, b) => a.localeCompare(b));
            // --- M√É M·ªöI: Thu th·∫≠p c√°c m·ªëc gi·ªù t·ª´ Autoplan ---
            autoplanTimes.clear(); // X√≥a c≈© tr∆∞·ªõc khi t·∫£i l·∫°i
            allPatternsData.forEach(pattern => {
                if (pattern.startTime) autoplanTimes.add(pattern.startTime);
                if (pattern.endTime) autoplanTimes.add(pattern.endTime);
            });
            // --- K·∫æT TH√öC M√É M·ªöI ---
        } catch (error) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu work_patterns:", error);
                showSwal("error", "L·ªói T·∫£i D·ªØ Li·ªáu", "Kh√¥ng th·ªÉ t·∫£i ƒë∆∞·ª£c l·ªãch l√†m vi·ªác c·ªßa nh√¢n vi√™n.");
            }
        }

        function populateStaffDropdowns() {
            const staffSelects = document.querySelectorAll('.staff-select');
            let optionsHtml = '<option value="">--- Ch·ªçn nh√¢n vi√™n ---</option>';
            allStaffNames.forEach(name => {
                optionsHtml += `<option value="${name}">${name}</option>`;
            });
            staffSelects.forEach(select => { select.innerHTML = optionsHtml; });
        }
        
        // ===== H√ÄM LOGIC M·ªöI (V5.1: B·ªé L·ªåC V6, CH·ªà D√ôNG OVERLAP) =====
        async function updateStaffForSelectedShift() {
            const selectedDate = new Date(document.getElementById('reportDate').value + "T00:00:00");
            const selectedShiftId = document.getElementById('shiftSelect').value;

            if (!selectedDate || !selectedShiftId || allReportShifts.length === 0 || allPatternsData.length === 0) {
                return; // Ch∆∞a ƒë·ªß d·ªØ li·ªáu
            }

            const nextDay = new Date(selectedDate);
            nextDay.setDate(selectedDate.getDate() + 1);

            // 1. T√åM KHUNG GI·ªú CA GIAO (CA ƒê∆Ø·ª¢C CH·ªåN)
            const currentReportShift = allReportShifts.find(s => s.id === selectedShiftId);
            if (!currentReportShift) return;
            const Khung_Giao = getReportShiftTimeRange(currentReportShift, selectedDate);

            // 2. T√åM KHUNG GI·ªú CA NH·∫¨N (CA K·∫æ TI·∫æP)
            const { shift: nextReportShift, isForNextDay } = findNextReportShift(currentReportShift, allReportShifts);
            let Khung_Nhan = null;
            if (nextReportShift) {
                const nhanDate = isForNextDay ? nextDay : selectedDate;
                Khung_Nhan = getReportShiftTimeRange(nextReportShift, nhanDate);
            }

            // 3. T√åM NH√ÇN VI√äN
            const handoverStaff = new Set();
            const receivingStaff = new Set();

            const yesterday = new Date(selectedDate);
            yesterday.setDate(selectedDate.getDate() - 1);
            
            // M·ªü r·ªông c·ª≠a s·ªï ph√¢n t√≠ch 4 ng√†y ƒë·ªÉ b·∫Øt ca 24h
            const dayBeforeYesterday = new Date(selectedDate);
            dayBeforeYesterday.setDate(selectedDate.getDate() - 2);
            
            const datesToAnalyze = [dayBeforeYesterday, yesterday, selectedDate, nextDay];

            for (const pattern of allPatternsData) {
                // L·∫∑p qua 4 ng√†y ƒë·ªÉ t√¨m t·∫•t c·∫£ c√°c ca l√†m vi·ªác c·ªßa nh√¢n vi√™n n√†y
                for (const date of datesToAnalyze) {
                    const personalShift = getPersonalShiftForDate(pattern, date, allShiftRules, refDate);
                    
                    if (personalShift) {
                        // So s√°nh v·ªõi ca GIAO
                        if (Khung_Giao && checkOverlap(personalShift, Khung_Giao)) {
                            handoverStaff.add(pattern.displayName);
                        }
                        // So s√°nh v·ªõi ca NH·∫¨N (Logic V5 ƒë∆°n gi·∫£n)
                        if (Khung_Nhan && checkOverlap(personalShift, Khung_Nhan)) {
                            receivingStaff.add(pattern.displayName);
                        }
                    }
                }
            } // H·∫øt v√≤ng l·∫∑p pattern

            // 4. L·ªçc tr√πng l·∫∑p v√† ƒëi·ªÅn v√†o dropdown
            const finalHandover = Array.from(handoverStaff);
            const finalReceiving = Array.from(receivingStaff);

            [1, 2, 3].forEach(i => {
                document.getElementById(`handover-staff-${i}`).value = finalHandover[i - 1] || "";
                document.getElementById(`receiving-staff-${i}`).value = finalReceiving[i - 1] || "";
            });
        }
        /**
         * H√ÄM X·ª¨ L√ù CH√çNH KHI ƒê·ªîI NG√ÄY HO·∫∂C CA
         */
        async function onShiftOrDateChange() {
            clearForm();
            // 1. C·∫≠p nh·∫≠t UI ph·ª•
            const shiftSelect = document.getElementById('shiftSelect');
            updatePrintMargins(); //

            // 2. C·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n
            await updateStaffForSelectedShift(); //

            // 3. Ch·∫°y Smart Auto-fill
            const reportDate = document.getElementById('reportDate').value;
            const shiftId = shiftSelect.value;
            // --- TH√äM 2 D√íNG M·ªöI N√ÄY ---
            const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
            const shiftStartTime = selectedOption.dataset.start || "00:00";
            // --- K·∫æT TH√öC D√íNG M·ªöI ---
            const currentShift = allReportShifts.find(s => s.id === shiftId);
            const currentDate = new Date(reportDate + "T00:00:00");
            

            if(reportDate && shiftId && currentShift) {
            const reportId = `${reportDate}_${shiftStartTime}_${shiftId}`; // <-- ID M·ªöI
            await smartAutoFill(reportId, currentShift, currentDate); // Ch·ªù auto-fill xong
            }
        }
    // ===================================================================
    // H√ÄM M·ªöI: L·∫ÆNG NGHE, HI·ªÇN TH·ªä, V√Ä QU·∫¢N L√ù C√ÅC CA B√ÅO C√ÅO (LOGIC V4)
    // ===================================================================
    function setupShiftAdminListeners() {
        const shiftSelect = document.getElementById('shiftSelect');
        const shiftListBody = document.getElementById('shift-list-body');

        // L·∫Øng nghe collection 'report_shifts'
        onSnapshot(collection(db, "report_shifts"), (snapshot) => {
            allReportShifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // S·∫Øp x·∫øp c√°c ca theo gi·ªù b·∫Øt ƒë·∫ßu
            allReportShifts.sort((a, b) => a.startTime.localeCompare(b.startTime));

            // X√≥a s·∫°ch 2 danh s√°ch (user v√† admin)
            shiftSelect.innerHTML = '<option value="">--- Ch·ªçn ca b√°o c√°o ---</option>';
            shiftListBody.innerHTML = '';

            allReportShifts.forEach(shift => {
                const shiftLabel = `${shift.name} (${shift.startTime} - ${shift.endTime}${shift.isNextDay ? " *" : ""})`;

                // 1. ƒêi·ªÅn v√†o Dropdown c·ªßa User
                const option = document.createElement('option');
                option.value = shift.id;
                option.textContent = shiftLabel;
                option.dataset.start = shift.startTime;
                option.dataset.end = shift.endTime;
                option.dataset.nextday = shift.isNextDay;
                shiftSelect.appendChild(option);

                // 3. ƒêi·ªÅn v√†o B·∫£ng c·ªßa Admin (n·∫øu l√† admin)
                if (userRole === 'admin') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="text-align: left;">${shift.name}</td>
                        <td>${shift.startTime}</td>
                        <td>${shift.endTime}${shift.isNextDay ? " (h√¥m sau)" : ""}</td>
                        <td><button data-id="${shift.id}" class="delete-shift-btn" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button></td>
                    `;
                    shiftListBody.appendChild(tr);
                }
            });

            // --- LOGIC T·ª∞ ƒê·ªòNG CH·ªåN CA V·ª™A K·∫æT TH√öC (V4) ---
            const now = new Date(); // Gi·ªù hi·ªán t·∫°i
            let selectedShiftId = null;
            let selectedDate = null; // Ng√†y b·∫Øt ƒë·∫ßu c·ªßa ca ƒë∆∞·ª£c ch·ªçn

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const dayBeforeYesterday = new Date(today);
            dayBeforeYesterday.setDate(today.getDate() - 2);

            // Ch√∫ng ta c·∫ßn ki·ªÉm tra c√°c ca b·∫Øt ƒë·∫ßu t·ª´ 2 ng√†y tr∆∞·ªõc
            const datesToTest = [dayBeforeYesterday, yesterday, today];
            let potentialShifts = []; // Danh s√°ch c√°c ca ƒë√£ k·∫øt th√∫c

            for (const shift of allReportShifts) {
                // L·∫∑p qua c√°c ca ƒë√£ c√†i ƒë·∫∑t
                for (const date of datesToTest) {
                    // T·∫°o khung gi·ªù th·ª±c t·∫ø c·ªßa ca (vd: Ca 2 ng√†y 19/10)
                    const range = getReportShiftTimeRange(shift, date);

                    // --- LOGIC V4.1 (M·ªü c·ª≠a s·ªï b√°o c√°o s·ªõm 1 gi·ªù) ---
                    
                    // T√≠nh th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu cho ph√©p b√°o c√°o (1 gi·ªù tr∆∞·ªõc khi ca k·∫øt th√∫c)
                    // (1 gi·ªù = 60 ph√∫t * 60 gi√¢y * 1000 ms = 3600000 ms)
                    const reportingStartTime = new Date(range.end.getTime() - 3600000); 

                    // Ki·ªÉm tra xem 'now' c√≥ n·∫±m trong c·ª≠a s·ªï b√°o c√°o kh√¥ng
                    // (t·ª©c l√† sau khi ƒë∆∞·ª£c ph√©p b√°o c√°o)
                    if (now >= reportingStartTime) {
                        potentialShifts.push({
                            id: shift.id,
                            date: date, // Ng√†y b·∫Øt ƒë·∫ßu c·ªßa ca
                            end: range.end // Th·ªùi ƒëi·ªÉm k·∫øt th√∫c th·ª±c t·∫ø
                        });
                    }
                }
            }

            // T√¨m ca v·ª´a k·∫øt th√∫c g·∫ßn ƒë√¢y nh·∫•t
            if (potentialShifts.length > 0) {
                // S·∫Øp x·∫øp c√°c ca ƒë√£ k·∫øt th√∫c theo th·ªùi gian k·∫øt th√∫c gi·∫£m d·∫ßn
                potentialShifts.sort((a, b) => b.end - a.end);
                
                // Ch·ªçn ca ƒë·∫ßu ti√™n (ca k·∫øt th√∫c g·∫ßn nh·∫•t)
                selectedShiftId = potentialShifts[0].id;
                selectedDate = potentialShifts[0].date;
            }
            // --- K·∫æT TH√öC LOGIC V4 ---

            // X·ª≠ l√Ω n√∫t x√≥a c·ªßa Admin (v·ªõi SweetAlert2)
            document.querySelectorAll('.delete-shift-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;

                    // ‚≠êÔ∏è B∆Ø·ªöC 1: L·∫§Y TH√îNG TIN CA B·ªä X√ìA ‚≠êÔ∏è
                    const shiftToDelete = allReportShifts.find(s => s.id === id);
                    const shiftName = shiftToDelete ? shiftToDelete.name : "Kh√¥ng r√µ";
                    const shiftTime = shiftToDelete ? `${shiftToDelete.startTime}-${shiftToDelete.endTime}` : "N/A";
                    
                    Swal.fire({
                        title: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a "${shiftName}"?`, // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
                        text: "B·∫°n s·∫Ω kh√¥ng th·ªÉ ho√†n t√°c h√†nh ƒë·ªông n√†y!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'V√¢ng, x√≥a n√≥!',
                        cancelButtonText: 'H·ªßy'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const userEmail = auth.currentUser ? auth.currentUser.email : "admin_unknown";
                            try {
                                await deleteDoc(doc(db, "report_shifts", id));
                                
                                // ‚≠êÔ∏è B∆Ø·ªöC 2: G·ª¨I LOG ƒê·∫¶Y ƒê·ª¶ ‚≠êÔ∏è
                                addLog("admin_delete_shift_success", { 
                                    shiftId: id,
                                    shiftName: shiftName, // <-- TH√äM T√äN
                                    time: shiftTime,    // <-- TH√äM GI·ªú
                                    email: userEmail 
                                });
                                showSwal("success", "ƒê√£ x√≥a ca.");
                            } catch (error) {
                                // ‚≠êÔ∏è B∆Ø·ªöC 2 (L·ªñI): G·ª¨I LOG L·ªñI ƒê·∫¶Y ƒê·ª¶ ‚≠êÔ∏è
                                addLog("admin_delete_shift_failure", { 
                                    shiftId: id, 
                                    shiftName: shiftName, // <-- TH√äM T√äN
                                    error: error.message,
                                    email: userEmail 
                                });
                                showSwal("error", "L·ªói khi x√≥a ca", error.message);
                            }
                        }
                    });
                });
            });

            // --- C·∫¨P NH·∫¨T GIAO DI·ªÜN ---
            // 1. C·∫≠p nh·∫≠t NG√ÄY tr∆∞·ªõc
            if (selectedDate) {
                // Chuy·ªÉn Date object v·ªÅ ƒë·ªãnh d·∫°ng YYYY-MM-DD
                document.getElementById('reportDate').value = selectedDate.toLocaleDateString('en-CA');
            } else {
                // N·∫øu kh√¥ng c√≥ ca n√†o k·∫øt th√∫c, d√πng ng√†y h√¥m nay
                document.getElementById('reportDate').valueAsDate = new Date();
            }

            // 2. C·∫≠p nh·∫≠t CA
            if (selectedShiftId) {
                shiftSelect.value = selectedShiftId;
            } else if (allReportShifts.length > 0) {
                 // N·∫øu kh√¥ng t√¨m th·∫•y, ch·ªçn ca ƒë·∫ßu ti√™n
                shiftSelect.value = allReportShifts[0].id;
            }

            // K√≠ch ho·∫°t h√†m x·ª≠ l√Ω ch√≠nh ƒë·ªÉ t·∫£i nh√¢n vi√™n V√Ä auto-fill
            onShiftOrDateChange();
        });

        // X·ª≠ l√Ω n√∫t "L∆∞u" c·ªßa Admin (N√¢ng c·∫•p V5 - C·∫£nh b√°o m√¢u thu·∫´n)
        document.getElementById('save-shift-btn').addEventListener('click', async () => {
            const data = {
                name: document.getElementById('shift-name').value,
                startTime: document.getElementById('shift-start-time').value,
                endTime: document.getElementById('shift-end-time').value,
                isNextDay: document.getElementById('shift-is-next-day').checked
            };

            if (!data.name || !data.startTime || !data.endTime) {
                return showSwal("error", "Thi·∫øu th√¥ng tin", "Vui l√≤ng nh·∫≠p T√™n, Gi·ªù b·∫Øt ƒë·∫ßu v√† Gi·ªù k·∫øt th√∫c.");
            }

            // --- LOGIC VALIDATION (GI·∫¢I PH√ÅP 2) ---
            let warnings = [];

            // 1. Ki·ªÉm tra startTime
            if (!autoplanTimes.has(data.startTime)) {
                const closestStart = findClosestTime(data.startTime, autoplanTimes);
                warnings.push(`Gi·ªù b·∫Øt ƒë·∫ßu '<b>${data.startTime}</b>' kh√¥ng kh·ªõp v·ªõi l·ªãch autoplan (g·∫ßn nh·∫•t l√† '<b>${closestStart}</b>').`);
            }
            // 2. Ki·ªÉm tra endTime
            if (!autoplanTimes.has(data.endTime)) {
                const closestEnd = findClosestTime(data.endTime, autoplanTimes);
                warnings.push(`Gi·ªù k·∫øt th√∫c '<b>${data.endTime}</b>' kh√¥ng kh·ªõp v·ªõi l·ªãch autoplan (g·∫ßn nh·∫•t l√† '<b>${closestEnd}</b>').`);
            }

            // H√†m l∆∞u (t√°ch ra ƒë·ªÉ g·ªçi l·∫°i)
            const saveAction = async () => {
                const userEmail = auth.currentUser ? auth.currentUser.email : "admin_unknown";
                try {
                    // S·ª≠a: L·∫•y docRef ƒë·ªÉ c√≥ ID
                    const docRef = await addDoc(collection(db, "report_shifts"), data);
                    
                    // ‚≠êÔ∏è V·ªä TR√ç CH√àN LOG ‚≠êÔ∏è
                        addLog("admin_create_shift_success", { 
                        shiftId: docRef.id, 
                        shiftName: data.name, 
                        time: `${data.startTime}-${data.endTime}`,
                        email: userEmail 
                    });

                    showSwal("success", "ƒê√£ l∆∞u ca.");
                    // X√≥a tr·ªëng form
                    document.getElementById('shift-name').value = '';
                    document.getElementById('shift-start-time').value = '';
                    document.getElementById('shift-end-time').value = '';
                    document.getElementById('shift-is-next-day').checked = false;
                } catch (error) {
                    // ‚≠êÔ∏è V·ªä TR√ç CH√àN LOG L·ªñI ‚≠êÔ∏è
                     addLog("admin_create_shift_failure", { 
                        shiftName: data.name, 
                        error: error.message,
                        email: userEmail 
                    });
                    showSwal("error", "L·ªói khi l∆∞u ca", error.message);
                }
            };

            // 3. Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu c√≥
            if (warnings.length > 0) {
                Swal.fire({
                    title: '‚ö†Ô∏è C·∫£nh b√°o M√¢u thu·∫´n!',
                    html: `
                        <p>C√°c m·ªëc th·ªùi gian b·∫°n nh·∫≠p c√≥ th·ªÉ g√¢y l·ªói ƒëi·ªÅn t√™n nh√¢n vi√™n:</p>
                        <ul style="text-align: left; margin-left: 20px;">
                            ${warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                        <p style="margin-top: 15px;">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u?</p>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'V·∫´n L∆∞u',
                    cancelButtonText: 'H·ªßy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        saveAction(); // V·∫´n l∆∞u
                    }
                });
            } else {
                saveAction(); // Kh√¥ng c√≥ c·∫£nh b√°o, l∆∞u lu√¥n
            }
            // --- K·∫æT TH√öC VALIDATION ---
        });
    }
    //
    /**
         * Helper 1: Ki·ªÉm tra quy t·∫Øc c√≤n hi·ªáu l·ª±c
         */
        const isRuleActiveOnDate = (rule, date) => {
            const startDate = new Date(rule.patternStartDate + 'T00:00:00');
            const endDate = rule.patternEndDate ? new Date(rule.patternEndDate + 'T00:00:00') : null;
            if (date < startDate) return false;
            if (endDate && date > endDate) return false;
            return true;
        };
        
        /**
         * Helper 2 (M·ªöI): Logic s·∫Øp x·∫øp xoay ca 3 c·∫•p
         * ∆Øu ti√™n 1: Ng√†y b·∫Øt ƒë·∫ßu (s·ªõm nh·∫•t tr∆∞·ªõc)
         * ∆Øu ti√™n 2: Gi·ªù b·∫Øt ƒë·∫ßu (s·ªõm nh·∫•t tr∆∞·ªõc)
         * ∆Øu ti√™n 3: T√™n A-Z
         */
        const sortShiftRules = (a, b) => {
            // 1. So s√°nh Ng√†y
            const dateA = new Date(a.patternStartDate);
            const dateB = new Date(b.patternStartDate);
            if (dateA - dateB !== 0) {
                return dateA - dateB;
            }

            // 2. So s√°nh Gi·ªù (n·∫øu Ng√†y tr√πng)
            const timeA = a.startTime || "00:00";
            const timeB = b.startTime || "00:00";
            if (timeA.localeCompare(timeB) !== 0) {
                return timeA.localeCompare(timeB);
            }

            // 3. So s√°nh T√™n (n·∫øu c·∫£ Ng√†y v√† Gi·ªù tr√πng)
            return (a.displayName || "").localeCompare(b.displayName || "");
        };

        function getDaysDifference(date1, date2) {
            const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.round((d1 - d2) / (1000 * 60 * 60 * 24));
        }
    // ===================================================================
    // H√ÄM HELPER CHO LOGIC M·ªöI
    // ===================================================================

    /**
     * HELPER 1: Ki·ªÉm tra 2 khung gi·ªù (Date object) c√≥ ch·ªìng l·∫•n (overlap) kh√¥ng.
     * Logic: A b·∫Øt ƒë·∫ßu TR∆Ø·ªöC khi B k·∫øt th√∫c V√Ä A k·∫øt th√∫c SAU khi B b·∫Øt ƒë·∫ßu.
     */
    function checkOverlap(rangeA, rangeB) {
        if (!rangeA || !rangeB) return false;
        return rangeA.start < rangeB.end && rangeA.end > rangeB.start;
    }

    /**
     * HELPER 2: "Tr√¨nh th√¥ng d·ªãch" (Interpreter)
     * Sao ch√©p t·ª´ autoplan.html v√† ƒëi·ªÅu ch·ªânh.
     * Tr·∫£ v·ªÅ khung gi·ªù l√†m vi·ªác C√Å NH√ÇN (Date object) c·ªßa 1 ng∆∞·ªùi v√†o 1 ng√†y c·ª• th·ªÉ.
     */
    function getPersonalShiftForDate(userPattern, dateToCheck, allShiftRules, refDate) {
        // 1. Ki·ªÉm tra quy t·∫Øc c√≤n hi·ªáu l·ª±c kh√¥ng
        const startDate = new Date(userPattern.patternStartDate + 'T00:00:00');
        const endDate = userPattern.patternEndDate ? new Date(userPattern.patternEndDate + 'T23:59:59') : null;

        // Chu·∫©n h√≥a dateToCheck v·ªÅ ƒë·∫ßu ng√†y
        const checkDate = new Date(dateToCheck.getFullYear(), dateToCheck.getMonth(), dateToCheck.getDate());

        if (checkDate < startDate) return null;
        if (endDate && checkDate > endDate) return null;

        const shiftStart = new Date(checkDate);
        const shiftEnd = new Date(checkDate);
        let isWorking = false;

        // 2. X·ª≠ l√Ω L·ªãch C·ªë ƒë·ªãnh (administrative)
        if (userPattern.type === "administrative") {
            const dayOfWeek = checkDate.getDay() === 0 ? 8 : checkDate.getDay() + 1;
            if (Array.isArray(userPattern.workDaysOfWeek) && userPattern.workDaysOfWeek.includes(dayOfWeek)) {
                isWorking = true;
                const [startH, startM] = (userPattern.startTime || "00:00").split(':').map(Number);
                const [endH, endM] = (userPattern.endTime || "00:00").split(':').map(Number);

                // === ƒêO·∫†N M√É M·ªöI (T·ª∞ SUY LU·∫¨N) ===
                shiftStart.setHours(startH, startM, 0, 0);
                shiftEnd.setHours(endH, endM, 0, 0);

                // T·ª± ƒë·ªông ph√°t hi·ªán ca g·ªëi ƒë·∫ßu N·∫æU gi·ªù k·∫øt th√∫c < gi·ªù b·∫Øt ƒë·∫ßu
                // (v√≠ d·ª•: 06:00 < 17:00)
                if ( (endH < startH) || (endH === startH && endM < startM) ) {
                    shiftEnd.setDate(shiftEnd.getDate() + 1);
                }
                // Ho·∫∑c, T·ª∞ ƒê·ªòNG x·ª≠ l√Ω ca 24h (v√≠ d·ª•: 07:30 -> 07:30)
                else if (startH === endH && startM === endM && (startH !== 0 || startM !== 0)) {
                    shiftEnd.setDate(shiftEnd.getDate() + 1);
                }
            }
        }
        // 3. X·ª≠ l√Ω L·ªãch Xoay V√≤ng (shift_rotation)
        else if (userPattern.type === "shift_rotation" && refDate) {
            // L·ªçc ra c√°c quy t·∫Øc xoay ca C√íN HI·ªÜU L·ª∞C v√†o ng√†y checkDate
            const membersToday = allShiftRules.filter(rule => {
                const rStart = new Date(rule.patternStartDate + 'T00:00:00');
                const rEnd = rule.patternEndDate ? new Date(rule.patternEndDate + 'T23:59:59') : null;
                if (checkDate < rStart) return false;
                if (rEnd && checkDate > rEnd) return false;
                return true;
            });

            if (membersToday.length > 0) {
                // S·∫Øp x·∫øp l·∫°i danh s√°ch C√íN HI·ªÜU L·ª∞C
                membersToday.sort(sortShiftRules); // C·∫ßn h√†m sortShiftRules

                const n_today = membersToday.length;
                const daysSinceToday = getDaysDifference(checkDate, refDate); // C·∫ßn h√†m getDaysDifference
                const workerIndexToday = (daysSinceToday % n_today + n_today) % n_today;
                const workerToday = membersToday[workerIndexToday];

                if (workerToday && workerToday.displayName === userPattern.displayName) {
                    isWorking = true;
                    const [startH, startM] = (workerToday.startTime || "00:00").split(':').map(Number);
                    const [endH, endM] = (workerToday.endTime || "00:00").split(':').map(Number);

                    // === ƒêO·∫†N M√É M·ªöI (T·ª∞ SUY LU·∫¨N) ===
                    shiftStart.setHours(startH, startM, 0, 0);
                    shiftEnd.setHours(endH, endM, 0, 0);

                    // T·ª± ƒë·ªông ph√°t hi·ªán ca g·ªëi ƒë·∫ßu N·∫æU gi·ªù k·∫øt th√∫c < gi·ªù b·∫Øt ƒë·∫ßu
                    // (v√≠ d·ª•: 06:00 < 17:00)
                    if ( (endH < startH) || (endH === startH && endM < startM) ) {
                        shiftEnd.setDate(shiftEnd.getDate() + 1);
                    }
                    // Ho·∫∑c, T·ª∞ ƒê·ªòNG x·ª≠ l√Ω ca 24h (v√≠ d·ª•: 07:30 -> 07:30)
                    else if (startH === endH && startM === endM && (startH !== 0 || startM !== 0)) {
                        shiftEnd.setDate(shiftEnd.getDate() + 1);
                    }
                }
            }
        }

        if (isWorking) {
            return { start: shiftStart, end: shiftEnd };
        }
        return null;
    }

    /**
     * HELPER 3: T√¨m ca b√°o c√°o li·ªÅn tr∆∞·ªõc (Previous Reporting Shift)
     * Logic "T√¨m ki·∫øm Th√¥ng minh"
     */
    function findPreviousReportShift(currentShift, allShifts) {
        if (allShifts.length < 2) return { shift: null, isForPreviousDay: false }; // Kh√¥ng c√≥ ca tr∆∞·ªõc

        // S·∫Øp x·∫øp c√°c ca theo gi·ªù b·∫Øt ƒë·∫ßu
        const sortedShifts = [...allShifts].sort((a, b) => a.startTime.localeCompare(b.startTime));

        // T√¨m index c·ªßa ca hi·ªán t·∫°i
        const currentIndex = sortedShifts.findIndex(s => s.id === currentShift.id);

        if (currentIndex > 0) {
            // Ca tr∆∞·ªõc l√† ca ·ªü index-1 c·ªßa C√ôNG NG√ÄY
            return { shift: sortedShifts[currentIndex - 1], isForPreviousDay: false };
        } else {
            // Ca hi·ªán t·∫°i l√† ca ƒë·∫ßu ti√™n trong ng√†y (index 0)
            // V·∫≠y ca tr∆∞·ªõc l√† ca CU·ªêI C√ôNG (sortedShifts.length - 1) c·ªßa NG√ÄY H√îM TR∆Ø·ªöC
            return { shift: sortedShifts[sortedShifts.length - 1], isForPreviousDay: true };
        }
    }
    /**
     * HELPER 3.5: T√¨m ca b√°o c√°o li·ªÅn K·∫æ TI·∫æP
     */
    function findNextReportShift(currentShift, allShifts) {
        if (allShifts.length < 2) return { shift: null, isForNextDay: false };

        // S·∫Øp x·∫øp c√°c ca theo gi·ªù b·∫Øt ƒë·∫ßu
        const sortedShifts = [...allShifts].sort((a, b) => a.startTime.localeCompare(b.startTime));
        
        // T√¨m index c·ªßa ca hi·ªán t·∫°i
        const currentIndex = sortedShifts.findIndex(s => s.id === currentShift.id);

        if (currentIndex < (sortedShifts.length - 1)) {
            // Ca k·∫ø ti·∫øp l√† ca ·ªü index+1 c·ªßa C√ôNG NG√ÄY
            return { shift: sortedShifts[currentIndex + 1], isForNextDay: false };
        } else {
            // Ca hi·ªán t·∫°i l√† ca cu·ªëi c√πng trong ng√†y (index cu·ªëi)
            // V·∫≠y ca k·∫ø ti·∫øp l√† ca ƒê·∫¶U TI√äN (index 0) c·ªßa NG√ÄY H√îM SAU
            return { shift: sortedShifts[0], isForNextDay: true };
        }
    }

    /**
     * HELPER 4: H√†m t·∫°o khung gi·ªù Date object t·ª´ Ca B√°o C√°o
     */
    function getReportShiftTimeRange(reportShift, referenceDate) {
        const [startH, startM] = reportShift.startTime.split(':').map(Number);
        const [endH, endM] = reportShift.endTime.split(':').map(Number);

        const startDate = new Date(referenceDate);
        startDate.setHours(startH, startM, 0, 0);

        const endDate = new Date(referenceDate);
        endDate.setHours(endH, endM, 0, 0);

        // --- LOGIC M·ªöI (T·ª∞ SUY LU·∫¨N) ---
        // T·ª± ƒë·ªông ph√°t hi·ªán ca g·ªëi ƒë·∫ßu N·∫æU gi·ªù k·∫øt th√∫c < gi·ªù b·∫Øt ƒë·∫ßu
        // (v√≠ d·ª•: 07:30 < 17:00 l√† SAI, 06:00 < 17:00 l√† ƒê√öNG)
        if ( (endH < startH) || (endH === startH && endM < startM) ) {
             endDate.setDate(endDate.getDate() + 1);
        }
        // Ho·∫∑c, T·ª∞ ƒê·ªòNG x·ª≠ l√Ω ca 24h (v√≠ d·ª•: 07:30 -> 07:30)
        else if (startH === endH && startM === endM && (startH !== 0 || startM !== 0)) {
             endDate.setDate(endDate.getDate() + 1);
        }
        // --- K·∫æT TH√öC LOGIC M·ªöI ---

        return { start: startDate, end: endDate };
    }
    /**
     * HELPER 5: T√¨m th·ªùi gian g·∫ßn nh·∫•t
     * (Chuy·ªÉn ƒë·ªïi 'HH:MM' sang ph√∫t ƒë·ªÉ so s√°nh)
     */
    function timeToMins(timeStr) { // "HH:MM"
        if (!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    function findClosestTime(targetTime, timeSet) {
        if (timeSet.size === 0) return "kh√¥ng r√µ";

        const targetMins = timeToMins(targetTime);
        let closestTime = "";
        let minDiff = Infinity;

        for (const time of timeSet) {
            const diff = Math.abs(timeToMins(time) - targetMins);
            if (diff < minDiff) {
                minDiff = diff;
                closestTime = time;
            }
        }
        return closestTime;
    }
    /**
     * HELPER 6: Ki·ªÉm tra d·ªØ li·ªáu 2 CHI·ªÄU (Logic "LAI" V10 - V√° l·ªói G√°p & Ch·ªëng h·ªèng d·ªØ li·ªáu)
     */
    async function saveReport() {
        showLoading("ƒêang ki·ªÉm tra d·ªØ li·ªáu..."); 

        const reportDate = getVal('reportDate');
        const shiftId = getVal('shiftSelect');
        const shiftSelectEl = document.getElementById('shiftSelect');
        const selectedOption = shiftSelectEl.options[shiftSelectEl.selectedIndex];
        const currentShiftStartTime = selectedOption.dataset.start || "00:00";

        // --- (C√°c ki·ªÉm tra c∆° b·∫£n gi·ªØ nguy√™n) ---
        if (!reportDate || !shiftId) {
            hideLoading();
            return showSwal("error", "Thi·∫øu th√¥ng tin", "Vui l√≤ng ch·ªçn Ng√†y v√† Ca tr·ª±c tr∆∞·ªõc khi l∆∞u.");
        }
        const notes = document.querySelector('.notes-section textarea').value.trim();
        if (!notes) {
            hideLoading();
            return showSwal("error", "Thi·∫øu N·ªôi dung Ca tr·ª±c", "Vui l√≤ng ghi l·∫°i n·ªôi dung ca tr·ª±c v√† nh·ªØng ƒëi·ªÅu ch·ªânh c√¥ng ngh·ªá (n·∫øu c√≥) tr∆∞·ªõc khi l∆∞u.");
        }
        const newFilesCount = document.getElementById('report-images').files.length;
        const existingImagesCount = document.querySelectorAll('#existing-images > div').length;
        const totalImages = newFilesCount + existingImagesCount;
        if (totalImages === 0) {
            hideLoading();
            return showSwal("error", "Thi·∫øu H√¨nh ·∫£nh ƒê√≠nh k√®m", "B√°o c√°o b·∫Øt bu·ªôc ph·∫£i c√≥ √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh.");
        }
        
        const currentReportId = `${reportDate}_${currentShiftStartTime}_${shiftId}`;
        
        // --- B·∫ÆT ƒê·∫¶U LOGIC VALIDATION (V10) ---
        
        // 1. L·∫•y th√¥ng tin ca hi·ªán t·∫°i
        const currentShift = allReportShifts.find(s => s.id === shiftId);
        const currentDate = new Date(reportDate + "T00:00:00");

        // 2. T√åM L√ôI (C·∫£ 2 c√°ch)
        const { shift: prevShift, isForPreviousDay } = findPreviousReportShift(currentShift, allReportShifts);
        let expectedPrevId = null;
        if (prevShift) {
            const prevDate = new Date(currentDate);
            if (isForPreviousDay) prevDate.setDate(prevDate.getDate() - 1);
            const prevReportDateStr = prevDate.toLocaleDateString('en-CA');
            const prevShiftStartTime = prevShift.startTime || "00:00";
            expectedPrevId = `${prevReportDateStr}_${prevShiftStartTime}_${prevShift.id}`;
        }
        // Truy v·∫•n t√¨m "g·∫ßn nh·∫•t" (fallback)
        const q_prev_nearest = query(collection(db, "shift_reports"), 
                                where(documentId(), "<", currentReportId), 
                                orderBy(documentId(), "desc"),
                                limit(1));
        
        // 3. T√åM TI·∫æN (C·∫£ 2 c√°ch)
        const { shift: nextShift, isForNextDay } = findNextReportShift(currentShift, allReportShifts);
        let expectedNextId = null;
        if (nextShift) {
            const nextDate = new Date(currentDate);
            if (isForNextDay) nextDate.setDate(nextDate.getDate() + 1);
            const nextReportDateStr = nextDate.toLocaleDateString('en-CA');
            const nextShiftStartTime = nextShift.startTime || "00:00";
            expectedNextId = `${nextReportDateStr}_${nextShiftStartTime}_${nextShift.id}`;
        }
        // Truy v·∫•n t√¨m "g·∫ßn nh·∫•t" (fallback)
        const q_next_nearest = query(collection(db, "shift_reports"), 
                                where(documentId(), ">", currentReportId), 
                                orderBy(documentId(), "asc"),
                                limit(1));

        let issues = [];

        try {
            // 4. Ch·∫°y 4 truy v·∫•n song song
            const [
                theoreticalPrevSnap, // Ca li·ªÅn k·ªÅ (L√Ω thuy·∫øt)
                nearestPrevSnap,     // Ca g·∫ßn nh·∫•t (Th·ª±c t·∫ø)
                theoreticalNextSnap, // Ca li·ªÅn k·ªÅ (L√Ω thuy·∫øt)
                nearestNextSnap      // Ca g·∫ßn nh·∫•t (Th·ª±c t·∫ø)
            ] = await Promise.all([
                (expectedPrevId ? getDoc(doc(db, "shift_reports", expectedPrevId)) : Promise.resolve(null)),
                getDocs(q_prev_nearest),
                (expectedNextId ? getDoc(doc(db, "shift_reports", expectedNextId)) : Promise.resolve(null)),
                getDocs(q_next_nearest)
            ]);
            
            // 5. H√†m ki·ªÉm tra L√ôI (v·ªõi ch·∫ø ƒë·ªô 'strict' v√† 'loose')
            const checkMeterBackwards = (currentId, prevValueStr, name, mode) => {
                const currentVal = parseDisplayValue(getVal(currentId));
                const prevVal = parseDisplayValue(prevValueStr);
                if (isNaN(currentVal) || isNaN(prevVal)) return;

                if (mode === 'strict' && currentVal !== prevVal) {
                    const diff = currentVal - prevVal;
                    issues.push(`‚ö†Ô∏è **${name} (ƒê·∫ßu ca)** (${formatNumberForDisplay(currentVal)}) kh√¥ng kh·ªõp **Cu·ªëi ca li·ªÅn k·ªÅ** (${formatNumberForDisplay(prevVal)}) (Ch√™nh l·ªách: ${formatNumberForDisplay(diff)})`);
                
                } else if (mode === 'loose' && currentVal < prevVal) {
                    issues.push(`‚ùå **${name} (ƒê·∫ßu ca)** (${formatNumberForDisplay(currentVal)}) nh·ªè h∆°n **Cu·ªëi ca g·∫ßn nh·∫•t** (${formatNumberForDisplay(prevVal)}) (Ph√°t hi·ªán b√°o c√°o tr·ªëng)`);
                }
            };
            
            // 6. Logic L√ôI (V10)
            if (theoreticalPrevSnap && theoreticalPrevSnap.exists()) {
                // *** CASE 1: KH√îNG C√ì G√ÅP ***
                // T√¨m th·∫•y ca li·ªÅn k·ªÅ (Ca 2, Ng√†y 25). Ph·∫£i so s√°nh NGHI√äM NG·∫∂T (strict).
                const prevMeters = theoreticalPrevSnap.data().meters;
                checkMeterBackwards('dien-bt-dau', prevMeters.dien_bt_cuoi, 'ƒêi·ªán BT', 'strict');
                checkMeterBackwards('dien-cd-dau', prevMeters.dien_cd_cuoi, 'ƒêi·ªán Cƒê', 'strict');
                checkMeterBackwards('dien-td-dau', prevMeters.dien_td_cuoi, 'ƒêi·ªán Tƒê', 'strict');
                checkMeterBackwards('nuoc-dau', prevMeters.nuoc_cuoi, 'N∆∞·ªõc c·∫•p', 'strict');
                checkMeterBackwards('flow-in-start', prevMeters.flow_in_end, 'ƒê·∫ßu v√†o', 'strict');
                checkMeterBackwards('flow-out-start', prevMeters.flow_out_end, 'ƒê·∫ßu ra', 'strict');

            } else if (nearestPrevSnap && !nearestPrevSnap.empty) {
                // *** CASE 2: C√ì G√ÅP (Tr∆∞·ªùng h·ª£p c·ªßa b·∫°n) ***
                // KH√îNG t√¨m th·∫•y ca li·ªÅn k·ªÅ (Ca 2, Ng√†y 25), 
                // NH∆ØNG t√¨m th·∫•y ca g·∫ßn nh·∫•t (Ca 2, Ng√†y 24).
                // Ch·ªâ so s√°nh L·ªéNG (loose) (>=).
                const nearestMeters = nearestPrevSnap.docs[0].data().meters;
                checkMeterBackwards('dien-bt-dau', nearestMeters.dien_bt_cuoi, 'ƒêi·ªán BT', 'loose');
                checkMeterBackwards('dien-cd-dau', nearestMeters.dien_cd_cuoi, 'ƒêi·ªán Cƒê', 'loose');
                checkMeterBackwards('dien-td-dau', nearestMeters.dien_td_cuoi, 'ƒêi·ªán Tƒê', 'loose');
                checkMeterBackwards('nuoc-dau', nearestMeters.nuoc_cuoi, 'N∆∞·ªõc c·∫•p', 'loose');
                checkMeterBackwards('flow-in-start', nearestMeters.flow_in_end, 'ƒê·∫ßu v√†o', 'loose');
                checkMeterBackwards('flow-out-start', nearestMeters.flow_out_end, 'ƒê·∫ßu ra', 'loose');
            }
            // (N·∫øu kh√¥ng r∆°i v√†o 2 case tr√™n, t·ª©c l√† b√°o c√°o ƒë·∫ßu ti√™n, kh√¥ng c·∫ßn ki·ªÉm tra)

            // 7. H√†m ki·ªÉm tra TI·∫æN (T∆∞∆°ng t·ª±)
            const checkMeterForwards = (currentId, nextValueStr, name, mode) => {
                const currentVal = parseDisplayValue(getVal(currentId));
                const nextVal = parseDisplayValue(nextValueStr);
                if (isNaN(currentVal) || isNaN(nextVal)) return;

                if (mode === 'strict' && currentVal !== nextVal) {
                    const diff = nextVal - currentVal;
                    issues.push(`‚ö†Ô∏è **${name} (Cu·ªëi ca)** (${formatNumberForDisplay(currentVal)}) kh√¥ng kh·ªõp **ƒê·∫ßu ca li·ªÅn k·ªÅ** (${formatNumberForDisplay(nextVal)}) (Ch√™nh l·ªách: ${formatNumberForDisplay(diff)})`);
                
                } else if (mode === 'loose' && currentVal > nextVal) {
                    issues.push(`‚ùå **${name} (Cu·ªëi ca)** (${formatNumberForDisplay(currentVal)}) l·ªõn h∆°n **ƒê·∫ßu ca g·∫ßn nh·∫•t** (${formatNumberForDisplay(nextVal)}) (Ph√°t hi·ªán b√°o c√°o tr·ªëng)`);
                }
            };
            
            // 8. Logic TI·∫æN (V10)
            if (theoreticalNextSnap && theoreticalNextSnap.exists()) {
                // *** CASE 3: KH√îNG C√ì G√ÅP (TI·∫æN) ***
                const nextMeters = theoreticalNextSnap.data().meters;
                checkMeterForwards('dien-bt-cuoi', nextMeters.dien_bt_dau, 'ƒêi·ªán BT', 'strict');
                checkMeterForwards('dien-cd-cuoi', nextMeters.dien_cd_dau, 'ƒêi·ªán Cƒê', 'strict');
                checkMeterForwards('dien-td-cuoi', nextMeters.dien_td_dau, 'ƒêi·ªán Tƒê', 'strict');
                checkMeterForwards('nuoc-cuoi', nextMeters.nuoc_dau, 'N∆∞·ªõc c·∫•p', 'strict');
                checkMeterForwards('flow-in-end', nextMeters.flow_in_start, 'ƒê·∫ßu v√†o', 'strict');
                checkMeterForwards('flow-out-end', nextMeters.flow_out_start, 'ƒê·∫ßu ra', 'strict');

            } else if (nearestNextSnap && !nearestNextSnap.empty) {
                // *** CASE 4: C√ì G√ÅP (TI·∫æN) ***
                const nearestMeters = nearestNextSnap.docs[0].data().meters;
                checkMeterForwards('dien-bt-cuoi', nearestMeters.dien_bt_dau, 'ƒêi·ªán BT', 'loose');
                checkMeterForwards('dien-cd-cuoi', nearestMeters.dien_cd_dau, 'ƒêi·ªán Cƒê', 'loose');
                checkMeterForwards('dien-td-cuoi', nearestMeters.dien_td_dau, 'ƒêi·ªán Tƒê', 'loose');
                checkMeterForwards('nuoc-cuoi', nearestMeters.nuoc_dau, 'N∆∞·ªõc c·∫•p', 'loose');
                checkMeterForwards('flow-in-end', nearestMeters.flow_in_start, 'ƒê·∫ßu v√†o', 'loose');
                checkMeterForwards('flow-out-end', nearestMeters.flow_out_start, 'ƒê·∫ßu ra', 'loose');
            }

        } catch (error) {
            hideLoading();
            console.error("L·ªói khi truy v·∫•n so s√°nh:", error);
            showSwal("error", "L·ªói truy v·∫•n", "Kh√¥ng th·ªÉ ki·ªÉm tra d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i. " + error.message);
            return;
        }
        
        hideLoading(); // T·∫Øt loading sau khi ki·ªÉm tra xong


        // 9. X·ª≠ l√Ω k·∫øt qu·∫£ ki·ªÉm tra (ƒê√É T√çCH H·ª¢P KI·ªÇM TRA N·ªòI B·ªò)
        const internalIssues = []; // Khai b√°o m·∫£ng l·ªói n·ªôi b·ªô
        // H√†m ki·ªÉm tra n·ªôi b·ªô (cu·ªëi >= ƒë·∫ßu)
        const checkInternalConsistency = (startId, endId, name) => {
            const startVal = parseDisplayValue(getVal(startId));
            const endVal = parseDisplayValue(getVal(endId));
            // Ch·ªâ th√™m l·ªói n·∫øu cu·ªëi < ƒë·∫ßu V√Ä c·∫£ hai ƒë·ªÅu l√† s·ªë h·ª£p l·ªá
            if (!isNaN(startVal) && !isNaN(endVal) && endVal < startVal) {
                internalIssues.push(`‚ùå **${name}:** Cu·ªëi ca (${formatNumberForDisplay(endVal)}) < ƒê·∫ßu ca (${formatNumberForDisplay(startVal)})`);
            }
            // (T√πy ch·ªçn) Th√™m ki·ªÉm tra n·∫øu m·ªôt trong hai gi√° tr·ªã b·ªã thi·∫øu/kh√¥ng h·ª£p l·ªá
            // else if (isNaN(startVal) || isNaN(endVal)) {
            //     internalIssues.push(`‚ùì **${name}:** Thi·∫øu ch·ªâ s·ªë ƒë·∫ßu ho·∫∑c cu·ªëi ca.`);
            // }
        };

        // Th·ª±c hi·ªán ki·ªÉm tra n·ªôi b·ªô cho t·∫•t c·∫£ c√°c c·∫∑p
        checkInternalConsistency('dien-bt-dau', 'dien-bt-cuoi', 'ƒêi·ªán BT');
        checkInternalConsistency('dien-cd-dau', 'dien-cd-cuoi', 'ƒêi·ªán Cƒê');
        checkInternalConsistency('dien-td-dau', 'dien-td-cuoi', 'ƒêi·ªán Tƒê');
        checkInternalConsistency('nuoc-dau', 'nuoc-cuoi', 'N∆∞·ªõc c·∫•p');
        checkInternalConsistency('flow-in-start', 'flow-in-end', 'ƒê·∫ßu v√†o');
        checkInternalConsistency('flow-out-start', 'flow-out-end', 'ƒê·∫ßu ra');

        // G·ªôp c·∫£ hai lo·∫°i l·ªói: l·ªói so s√°nh v·ªõi ca li·ªÅn k·ªÅ (issues) v√† l·ªói n·ªôi b·ªô (internalIssues)
        const allIssues = [...issues, ...internalIssues];

        // Ki·ªÉm tra xem c√≥ b·∫•t k·ª≥ l·ªói n√†o kh√¥ng (t·ª´ c·∫£ hai ngu·ªìn)
        if (allIssues.length > 0) {
            // --- Hi·ªÉn th·ªã h·ªôp tho·∫°i x√°c nh·∫≠n ---
            let swalTitle = '‚ö†Ô∏è C·∫£nh b√°o s·ªë li·ªáu!';
            let swalHtml = '';
            let swalIcon = 'warning'; // M·∫∑c ƒë·ªãnh l√† c·∫£nh b√°o

            // ƒêi·ªÅu ch·ªânh ti√™u ƒë·ªÅ, n·ªôi dung v√† icon d·ª±a tr√™n lo·∫°i l·ªói
            if (internalIssues.length > 0) {
                swalTitle = 'üö´ L·ªói S·ªë li·ªáu Nh·∫≠p!';
                swalIcon = 'error'; // N√¢ng l√™n th√†nh l·ªói n·∫øu c√≥ 'cu·ªëi < ƒë·∫ßu'
                swalHtml += `Ph√°t hi·ªán ch·ªâ s·ªë cu·ªëi ca nh·ªè h∆°n ƒë·∫ßu ca:<br>
                           <div style="text-align: left; margin-top: 5px; padding-left: 15px; max-height: 100px; overflow-y: auto; background: #ffebee; border: 1px solid #e57373; padding: 5px; border-radius: 4px;">
                           ${internalIssues.join('<br>')}
                           </div>`;
                 if (issues.length > 0) { // N·∫øu c√≥ c·∫£ hai lo·∫°i l·ªói
                     swalTitle = 'üö´ L·ªói & C·∫£nh b√°o S·ªë li·ªáu!'; // Ti√™u ƒë·ªÅ k·∫øt h·ª£p
                     swalHtml += `<br>ƒê·ªìng th·ªùi c√≥ m√¢u thu·∫´n v·ªõi ca li·ªÅn k·ªÅ/g·∫ßn nh·∫•t:<br>
                                <div style="text-align: left; margin-top: 5px; padding-left: 15px; max-height: 100px; overflow-y: auto; background: #fff9e6; border: 1px solid #ffcc80; padding: 5px; border-radius: 4px;">
                                ${issues.join('<br>')}
                                </div>`;
                 }
            } else { // Ch·ªâ c√≥ l·ªói 'issues' (so s√°nh li·ªÅn k·ªÅ)
                swalHtml += `Ph√°t hi·ªán m√¢u thu·∫´n v·ªõi ca li·ªÅn k·ªÅ ho·∫∑c g·∫ßn nh·∫•t:<br>
                           <div style="text-align: left; margin-top: 10px; padding-left: 20px; max-height: 150px; overflow-y: auto;">
                           ${issues.join('<br>')}
                           </div>`;
            }

            // Th√™m c√¢u h·ªèi x√°c nh·∫≠n v√†o cu·ªëi
            swalHtml += `<br><b>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u?</b>
                        <br><small>(Ch·ªâ x√°c nh·∫≠n n·∫øu ƒë√£ thay th·∫ø/s·ª≠a ch·ªØa ƒë·ªìng h·ªì ho·∫∑c s·ªë li·ªáu l√† ch√≠nh x√°c).</small>`;

            // G·ªçi Swal.fire v·ªõi th√¥ng tin ƒë√£ chu·∫©n b·ªã
            const result = await Swal.fire({
                title: swalTitle,
                html: swalHtml,
                icon: swalIcon,
                showCancelButton: true,
                confirmButtonColor: '#3085d6', // ƒê·ªïi m√†u n√∫t x√°c nh·∫≠n n·∫øu c·∫ßn
                cancelButtonColor: '#d33',
                confirmButtonText: 'V·∫´n L∆∞u',
                cancelButtonText: 'H·ªßy'
            });

            // X·ª≠ l√Ω k·∫øt qu·∫£ x√°c nh·∫≠n
            if (result.isConfirmed) {
                // (T√πy ch·ªçn) C√≥ th·ªÉ gi·ªØ l·∫°i ki·ªÉm tra cu·ªëi ca ·ªü ƒë√¢y ƒë·ªÉ th√™m m·ªôt l·ªõp an to√†n,
                // nh∆∞ng n·∫øu checkInternalConsistency ƒë√£ ƒë·ªß th√¨ kh√¥ng c·∫ßn.
                const flowInEndVal = getVal('flow-in-end');
                if (!flowInEndVal || isNaN(parseDisplayValue(flowInEndVal))) { // Ki·ªÉm tra NaN ch·∫∑t ch·∫Ω h∆°n
                    hideLoading();
                    return showSwal("error", "Thi·∫øu d·ªØ li·ªáu Cu·ªëi ca", "Vui l√≤ng nh·∫≠p ch·ªâ s·ªë cu·ªëi ca h·ª£p l·ªá cho ƒê·ªìng h·ªì ƒê·∫ßu v√†o.");
                }
                proceedToSave(); // L∆∞u n·∫øu ng∆∞·ªùi d√πng x√°c nh·∫≠n
            }
             // N·∫øu nh·∫•n H·ªßy, kh√¥ng l√†m g√¨ c·∫£ (h√†m s·∫Ω k·∫øt th√∫c)

        } else {
            // --- Kh√¥ng c√≥ l·ªói n√†o ---
            // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc kh√°c (n·∫øu c·∫ßn) v√† l∆∞u
            const flowInEndVal = getVal('flow-in-end'); // V√≠ d·ª• ki·ªÉm tra 1 tr∆∞·ªùng
            if (!flowInEndVal || isNaN(parseDisplayValue(flowInEndVal))) {
                hideLoading();
                return showSwal("error", "Thi·∫øu d·ªØ li·ªáu Cu·ªëi ca", "Vui l√≤ng nh·∫≠p ch·ªâ s·ªë cu·ªëi ca h·ª£p l·ªá cho ƒê·ªìng h·ªì ƒê·∫ßu v√†o.");
            }
            proceedToSave(); // L∆∞u khi kh√¥ng c√≥ l·ªói
        }
    }

    /**
     * HELPER 6.5: Ti·∫øn h√†nh l∆∞u (Phi√™n b·∫£n ƒê√É S·ª¨A L·ªñI x·ª≠ l√Ω ·∫£nh)
     */
    async function proceedToSave() {
        showLoading("ƒêang x·ª≠ l√Ω b√°o c√°o..."); 

        // --- 1. L·∫§Y ID V√Ä CHU·∫®N B·ªä (Gi·ªØ nguy√™n) ---
        const reportDate = getVal('reportDate');
        const shiftId = getVal('shiftSelect');
        const shiftSelectEl = document.getElementById('shiftSelect');
        const selectedOption = shiftSelectEl.options[shiftSelectEl.selectedIndex];
        const shiftStartTime = selectedOption.dataset.start || "00:00";
        const reportId = `${reportDate}_${shiftStartTime}_${shiftId}`;
        
        const docRef = doc(db, "shift_reports", reportId);
        
        // Bu·ªôc t√≠nh to√°n l·∫°i t·ªïng (Gi·ªØ nguy√™n)
        calculateSum(['dien-bt-dau', 'dien-cd-dau', 'dien-td-dau'], ['dien-bt-cuoi', 'dien-cd-cuoi', 'dien-td-cuoi'], 'dien-sl');
        calculateSum(['nuoc-dau'], ['nuoc-cuoi'], 'nuoc-sl');
        calculateSum(['flow-in-start'], ['flow-in-end'], 'flow-in-total');
        calculateSum(['flow-out-start'], ['flow-out-end'], 'flow-out-total');
        
        let newUploadedFiles = []; // M·∫£ng ch·ª©a file V·ª™A T·∫¢I L√äN (ƒë·ªÉ rollback)
        let oldImageIdsFromDb = []; // ƒê·ªïi t√™n: ƒê√¢y l√† c√°c ID ·∫£nh g·ªëc t·ª´ DB

        const rootFolderId = "1Q_LmzYCD-NWRtmba02SSqVSzhMEIHEpo"; // ID TH∆Ø M·ª§C G·ªêC 
        const subFolderId = await ensureReportFolderOnGAS(reportId, rootFolderId);

        try {
            // --- 2. THU TH·∫¨P D·ªÆ LI·ªÜU (T·∫°m th·ªùi) (Gi·ªØ nguy√™n) ---
            const reportData = {
                reportDate: reportDate,
                shiftId: shiftId,
                shiftName: selectedOption.text,
                shiftStartTime: shiftStartTime,
                handoverStaff: [getVal('handover-staff-1'), getVal('handover-staff-2'), getVal('handover-staff-3')],
                receivingStaff: [getVal('receiving-staff-1'), getVal('receiving-staff-2'), getVal('receiving-staff-3')],
                meters: {
                    dien_bt_dau: getVal('dien-bt-dau'), dien_cd_dau: getVal('dien-cd-dau'), dien_td_dau: getVal('dien-td-dau'),
                    dien_bt_cuoi: getVal('dien-bt-cuoi'), dien_cd_cuoi: getVal('dien-cd-cuoi'), dien_td_cuoi: getVal('dien-td-cuoi'),
                    dien_sl: document.getElementById('dien-sl').textContent,
                    nuoc_dau: getVal('nuoc-dau'), nuoc_cuoi: getVal('nuoc-cuoi'), nuoc_sl: document.getElementById('nuoc-sl').textContent,
                    flow_in_start: getVal('flow-in-start'), flow_in_end: getVal('flow-in-end'), flow_in_total: document.getElementById('flow-in-total').textContent,
                    flow_out_start: getVal('flow-out-start'), flow_out_end: getVal('flow-out-end'), flow_out_total: document.getElementById('flow-out-total').textContent,
                },
                chemicals: getChemicalsData(),
                bioSystem: getBioData(),
                outputWater: getOutputData(),
                notes: document.querySelector('.notes-section textarea').value,
                // KH√îNG th√™m images/imageIds ·ªü ƒë√¢y
            };

            // --- 3. B∆Ø·ªöC UPLOAD (Nguy√™n t·ª≠) (Gi·ªØ nguy√™n) ---
            const files = document.getElementById('report-images').files;

            if (files.length > 0) {


                // B∆∞·ªõc 2: Upload song song v√†o ID th∆∞ m·ª•c con ƒë√≥ (subFolderId ƒë√£ c√≥)
                const uploadPromises = [];
                for (const file of files) {
                    uploadPromises.push(
                        uploadFileToGAS_Report(file, subFolderId) 
                    );
                }
                newUploadedFiles = await Promise.all(uploadPromises);
            }
            
            // --- 4. B∆Ø·ªöC L·∫§Y ·∫¢NH C≈® V√Ä ·∫¢NH C√íN GI·ªÆ L·∫†I (*** PH·∫¶N S·ª¨A L·ªñI ***) ---
            
            // 4a. L·∫•y danh s√°ch ID ·∫£nh c≈© t·ª´ DB (ƒë·ªÉ so s√°nh d·ªçn d·∫πp)
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                oldImageIdsFromDb = docSnap.data().imageIds || [];
            }

            // 4b. L·∫•y danh s√°ch ·∫£nh ng∆∞·ªùi d√πng MU·ªêN GI·ªÆ L·∫†I t·ª´ giao di·ªán
            const keptImages = [];
            document.querySelectorAll('#existing-images > div').forEach(imgDiv => {
                // Ch·ªâ l·∫•y nh·ªØng ·∫£nh c√≤n t·ªìn t·∫°i tr√™n giao di·ªán
                if (imgDiv.dataset.id && imgDiv.dataset.url) {
                    keptImages.push({
                        id: imgDiv.dataset.id,
                        url: imgDiv.dataset.url
                    });
                }
            });

            // --- 5. L∆ØU V√ÄO FIRESTORE (Ghi ƒë√®) (*** PH·∫¶N S·ª¨A L·ªñI ***) ---
            
            // 5a. K·∫øt h·ª£p ·∫£nh C≈® (ƒë√£ gi·ªØ) v√† ·∫£nh M·ªöI
            const finalImages = [...keptImages, ...newUploadedFiles];

            // 5b. Th√™m m·∫£ng file T·ªîNG H·ª¢P v√†o data
            reportData.images = finalImages.map(f => f.url);
            reportData.imageIds = finalImages.map(f => f.id);
            reportData.lastSaved = serverTimestamp();

            await setDoc(docRef, reportData); // Ghi ƒë√® to√†n b·ªô v·ªõi danh s√°ch ·∫£nh ƒê√öNG

            // ‚≠êÔ∏è V·ªä TR√ç CH√àN LOG L∆ØU TH√ÄNH C√îNG ‚≠êÔ∏è
            const isUpdate = docSnap.exists(); // Bi·∫øn n√†y ƒë√£ ƒë∆∞·ª£c l·∫•y ·ªü (4a)
            const userEmail = auth.currentUser ? auth.currentUser.email : "unknown";
            addLog(
                isUpdate ? "report_update_success" : "report_create_success", 
                { 
                    reportId: reportId, 
                    date: reportDate,
                    shift: shiftId,
                    receivingStaff: reportData.receivingStaff.filter(name => name),
                    email: userEmail 
                }
            );

            // ‚≠êÔ∏è V·ªä TR√ç CH√àN LOGIC L∆ØU FILE HTML (M·ªöI) ‚≠êÔ∏è
            const printReadyHTML = prepareHtmlForSaving(); 
            generateReportFile(reportId, subFolderId, printReadyHTML, "html");

            // --- 6. D·ªåN D·∫∏P CU·ªêI C√ôNG (*** PH·∫¶N S·ª¨A L·ªñI ***) ---
            
            // 6a. T·∫°o Set c√°c ·∫£nh C√íN GI·ªÆ L·∫†I (ƒë·ªÉ tra c·ª©u nhanh)
            const finalImageIdSet = new Set(reportData.imageIds);

            // 6b. T√¨m c√°c ·∫£nh c·∫ßn x√≥a (·∫£nh c√≥ trong DB c≈© NH∆ØNG KH√îNG c√≥ trong danh s√°ch cu·ªëi c√πng)
            const idsToDelete = oldImageIdsFromDb.filter(oldId => !finalImageIdSet.has(oldId));

            if (idsToDelete.length > 0) {
                const deletePromises = [];
                for (const idToDel of idsToDelete) {
                    // D√πng Helper 11
                    deletePromises.push(deleteFileFromGAS_Report(idToDel));
                }
                // Ch·∫°y d·ªçn d·∫πp, kh√¥ng c·∫ßn ch·ªù (ho·∫∑c d√πng allSettled ƒë·ªÉ log l·ªói)
                Promise.allSettled(deletePromises).then(results => {
                    results.forEach((res, idx) => {
                        if (res.status === 'rejected') {
                            console.warn(`L·ªói d·ªçn d·∫πp file c≈© ${idsToDelete[idx]}:`, res.reason);
                        }
                    });
                });
            }

            // --- 7. TH√ÄNH C√îNG ---
            hideLoading();
            showSwal("success", "ƒê√£ l∆∞u th√†nh c√¥ng!", `ƒê√£ l∆∞u b√°o c√°o cho ${reportData.shiftName} ng√†y ${reportDate}.`);
            document.getElementById('report-images').value = null; // X√≥a file input

            // --- B·ªî SUNG (QUAN TR·ªåNG): T·∫¢I L·∫†I FORM V·ªÄ CH·∫æ ƒê·ªò CH·ªà XEM ---
            // Vi·ªác n√†y s·∫Ω x√≥a ·∫£nh c≈©, v·∫Ω l·∫°i danh s√°ch ·∫£nh ƒê√öNG v√† kh√≥a form
            populateFormWithData(reportData, 'read-only');


        } catch (error) {
            // --- 8. X·ª¨ L√ù L·ªñI (ROLLBACK) (Gi·ªØ nguy√™n) ---
            console.error("L·ªói nghi√™m tr·ªçng khi l∆∞u b√°o c√°o:", error);
            // ‚≠êÔ∏è V·ªä TR√ç CH√àN LOG L∆ØU TH·∫§T B·∫†I ‚≠êÔ∏è
            addLog(
                "report_save_failure", 
                { 
                    reportId: reportId, 
                    error: error.message,
                    hasNewFiles: newUploadedFiles.length > 0 // ƒê·ªÉ bi·∫øt c√≥ rollback kh√¥ng
                }
            );
            
            if (newUploadedFiles.length > 0) {
                hideLoading();
                showLoading(`L·ªói! ƒêang rollback (x√≥a ${newUploadedFiles.length} file r√°c)...`);
                
                const deletePromises = [];
                for (const file of newUploadedFiles) {
                    deletePromises.push(deleteFileFromGAS_Report(file.id)); // Helper 11
                }
                
                await Promise.allSettled(deletePromises); // Ch·ªù x√≥a xong
                
                hideLoading();
                showSwal("error", "L∆∞u b√°o c√°o th·∫•t b·∫°i!", `ƒê√£ x·∫£y ra l·ªói: ${error.message}. C√°c file v·ª´a t·∫£i l√™n ƒë√£ ƒë∆∞·ª£c d·ªçn d·∫πp.`);
            
            } else {
                // L·ªói x·∫£y ra ngay l√∫c upload (ho·∫∑c tr∆∞·ªõc ƒë√≥)
                hideLoading();
                showSwal("error", "L∆∞u b√°o c√°o th·∫•t b·∫°i!", error.message);
            }
        }
    }
    /**
     * HELPER 7 (N√¢ng c·∫•p v9): Auto-fill "th√¥ng minh" (ƒê√£ v√° l·ªói UX cho L·ªó h·ªïng G√°p)
     */
    async function smartAutoFill(currentReportId, currentShift, currentDate, modeEditing = false) { 
        showLoading("ƒêang t·∫£i d·ªØ li·ªáu b√°o c√°o...");

        // 1. T√¨m ID ca tr∆∞·ªõc v√† sau (Logic n√†y r·∫•t nhanh, kh√¥ng c·∫ßn await)
        const { shift: prevShift, isForPreviousDay } = findPreviousReportShift(currentShift, allReportShifts);
        let expectedPrevId = null;
        let prevShiftName = "N/A";
        if (prevShift) {
            const prevDate = new Date(currentDate);
            if (isForPreviousDay) prevDate.setDate(prevDate.getDate() - 1);
            const prevReportDateStr = prevDate.toLocaleDateString('en-CA');
            const prevShiftStartTime = prevShift.startTime || "00:00";
            expectedPrevId = `${prevReportDateStr}_${prevShiftStartTime}_${prevShift.id}`;
            prevShiftName = `${prevShift.name} (${prevReportDateStr})`;
        }
        
        const { shift: nextShift, isForNextDay } = findNextReportShift(currentShift, allReportShifts);
        let expectedNextId = null;
        let nextShiftName = "N/A";
        if (nextShift) {
            const nextDate = new Date(currentDate);
            if (isForNextDay) nextDate.setDate(nextDate.getDate() + 1);
            const nextReportDateStr = nextDate.toLocaleDateString('en-CA');
            const nextShiftStartTime = nextShift.startTime || "00:00";
            expectedNextId = `${nextReportDateStr}_${nextShiftStartTime}_${nextShift.id}`;
            nextShiftName = `${nextShift.name} (${nextReportDateStr})`;
        }

        // 2. Khai b√°o 3 bi·∫øn ch·ª©a k·∫øt qu·∫£
        let reportSnap = null;
        let prevSnap = null;
        let nextSnap = null;

        try {
            // 3. T·∫£i song song C·∫¢ 3 b√°o c√°o
            const promises = [
                getDoc(doc(db, "shift_reports", currentReportId)) // (Index 0: Ca hi·ªán t·∫°i)
            ];

            if (expectedPrevId) {
                promises.push(getDoc(doc(db, "shift_reports", expectedPrevId))); // (Index 1: Ca tr∆∞·ªõc)
            } else {
                promises.push(Promise.resolve(null)); // ƒê·∫©y null v√†o ƒë·ªÉ gi·ªØ v·ªã tr√≠
            }

            if (expectedNextId) {
                promises.push(getDoc(doc(db, "shift_reports", expectedNextId))); // (Index 2: Ca sau)
            } else {
                promises.push(Promise.resolve(null)); // ƒê·∫©y null v√†o ƒë·ªÉ gi·ªØ v·ªã tr√≠
            }

            // 4. Ch·ªù 1 l·∫ßn duy nh·∫•t cho c·∫£ 3
            [reportSnap, prevSnap, nextSnap] = await Promise.all(promises);

        } catch (error) {
            hideLoading();
            console.error("L·ªói khi truy v·∫•n k·∫πp (song song):", error);
            showSwal("error", "L·ªói truy v·∫•n", "Kh√¥ng th·ªÉ t√¨m d·ªØ li·ªáu ca. " + error.message);
            return;
        }

        // 5. X·ª≠ l√Ω k·∫øt qu·∫£ (Code n√†y gi·ªëng h·ªát code c≈©)
        if (reportSnap.exists() && modeEditing !== 'meter-fill-only') {
            // Ch·∫ø ƒë·ªô M·∫∂C ƒê·ªäNH (read-only): T·∫£i to√†n b·ªô form
            const data = reportSnap.data();
            const userEmail = auth.currentUser ? auth.currentUser.email : "unknown";
            addLog("report_view_existing", {
                reportId: currentReportId,
                date: data.reportDate,
                shift: data.shiftId,
                email: userEmail
            });
            populateFormWithData(data, 'read-only'); 
            hideLoading();
            showSwal("info", "ƒê√£ t·∫£i b√°o c√°o", "ƒê√£ t·∫£i d·ªØ li·ªáu c·ªßa ca n√†y t·ª´ c∆° s·ªü d·ªØ li·ªáu.");
            return;
        }

        // --- K·∫æT TH√öC CODE M·ªöI THAY TH·∫æ ---

        // 6. X·ª≠ l√Ω k·∫øt qu·∫£ (LOGIC V9)
        const hasPrevData = prevSnap && prevSnap.exists();
        const hasNextData = nextSnap && nextSnap.exists();
        let dataToFill = { meters: {} };
        let fillMode = 'auto-fill'; 
        let swalTitle = "ƒê√£ t·∫£i ca m·ªõi";
        let swalMessage = "Vui l√≤ng nh·∫≠p s·ªë li·ªáu.";
        let swalIcon = "info";

        // 7. X·ª≠ l√Ω ƒëi·ªÅn d·ªØ li·ªáu
        if (hasPrevData) {
            // C√ì T√åM TH·∫§Y CA TR∆Ø·ªöC -> T·ª± ƒë·ªông ƒëi·ªÅn ƒë·∫ßu ca
            const prevMeters = prevSnap.data().meters;
            dataToFill.meters.dien_bt_dau = prevMeters.dien_bt_cuoi;
            dataToFill.meters.dien_cd_dau = prevMeters.dien_cd_cuoi;
            dataToFill.meters.dien_td_dau = prevMeters.dien_td_cuoi;
            dataToFill.meters.nuoc_dau = prevMeters.nuoc_cuoi;
            dataToFill.meters.flow_in_start = prevMeters.flow_in_end;
            dataToFill.meters.flow_out_start = prevMeters.flow_out_end;
            
            swalTitle = "ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn";
            swalMessage = "C√°c ch·ªâ s·ªë ƒë·∫ßu ca ƒë√£ ƒë∆∞·ª£c l·∫•y t·ª´ ca tr∆∞·ªõc.";
            swalIcon = "success";

        } else if (expectedPrevId) {
            // C√ì CA TR∆Ø·ªöC V·ªÄ M·∫∂T L√ù THUY·∫æT, NH∆ØNG KH√îNG T√åM TH·∫§Y D·ªÆ LI·ªÜU
            // ‚≠êÔ∏è ƒê√ÇY L√Ä PH·∫¶N S·ª¨A L·ªñI UX ‚≠êÔ∏è
            swalTitle = "B√°o c√°o b·ªã thi·∫øu!";
            swalMessage = `Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c·ªßa ca li·ªÅn k·ªÅ (${prevShiftName}). Vui l√≤ng nh·∫≠p ch·ªâ s·ªë ƒë·∫ßu ca th·ªß c√¥ng.`;
            swalIcon = "warning";
        
        } else {
            // Kh√¥ng c√≥ ca tr∆∞·ªõc v·ªÅ m·∫∑t l√Ω thuy·∫øt
            swalTitle = "Ca m·ªõi";
            swalMessage = "Kh√¥ng c√≥ ca tr∆∞·ªõc, vui l√≤ng nh·∫≠p ch·ªâ s·ªë ƒë·∫ßu ca th·ªß c√¥ng.";
            swalIcon = "info";
        }

        if (hasNextData) {
            // C√ì T√åM TH·∫§Y CA SAU -> T·ª± ƒë·ªông ƒëi·ªÅn cu·ªëi ca
            const nextMeters = nextSnap.data().meters;
            dataToFill.meters.dien_bt_cuoi = nextMeters.dien_bt_dau;
            dataToFill.meters.dien_cd_cuoi = nextMeters.dien_cd_dau;
            dataToFill.meters.dien_td_cuoi = nextMeters.dien_td_dau;
            dataToFill.meters.nuoc_cuoi = nextMeters.nuoc_dau;
            dataToFill.meters.flow_in_end = nextMeters.flow_in_start;
            dataToFill.meters.flow_out_end = nextMeters.flow_out_start;

            fillMode = 'sandwich-fill'; // ‚≠êÔ∏è S·ª¨A V9: Chuy·ªÉn sang sandwich-fill
            
            if (hasPrevData) {
                // Tr∆∞·ªùng h·ª£p k·∫πp ƒë·ªß (c√≥ c·∫£ tr∆∞·ªõc v√† sau)
                swalTitle = "B√°o c√°o b·ªï sung (K·∫πp)";
                swalMessage = "ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn v√† kh√≥a ch·ªâ s·ªë ƒë·∫ßu/cu·ªëi ca.";
                swalIcon = "success";

            } else {
                // B·ªã k·∫πp nh∆∞ng thi·∫øu ca tr∆∞·ªõc (V√ç D·ª§ C·ª¶A B·∫†N)
                swalTitle = "B√°o c√°o b·ªï sung (Thi·∫øu)";
                swalMessage = `ƒê√£ kh√≥a ch·ªâ s·ªë cu·ªëi ca (t·ª´ ca sau), nh∆∞ng ca tr∆∞·ªõc (${prevShiftName}) b·ªã thi·∫øu. Vui l√≤ng nh·∫≠p ƒë·∫ßu ca.`;
                swalIcon = "warning"; // ‚≠êÔ∏è S·ª¨A V9: C·∫£nh b√°o
            }
        }

        // 8. G·ªçi h√†m populate
        populateFormWithData(dataToFill, fillMode); 
        
        hideLoading();
        // 9. Ch·ªâ th√¥ng b√°o n·∫øu kh√¥ng ·ªü ch·∫ø ƒë·ªô s·ª≠a
        if (modeEditing !== 'meter-fill-only') {
            // G·ªçi h√†m v·ªõi m·ªôt ƒë·ªëi t∆∞·ª£ng options
            showSwal(swalIcon, swalTitle, {
                html: swalMessage,  // ‚≠êÔ∏è Truy·ªÅn n·ªôi dung v√†o thu·ªôc t√≠nh 'html'
                timer: 4000         // ‚≠êÔ∏è Cho 4 gi√¢y ƒë·ªÉ ƒë·ªçc
            });
        }
    }
    /**
     * HELPER 8: D·ªçn d·∫πp (reset) to√†n b·ªô bi·ªÉu m·∫´u
     */
    function clearForm() {
        // K√≠ch ho·∫°t l·∫°i c√°c √¥ (ph√≤ng khi ƒëang ·ªü ch·∫ø ƒë·ªô "ch·ªâ xem")
        document.querySelectorAll('.container input, .container select, .container textarea').forEach(el => {
            el.disabled = false;
        });
        // D·ªçn d·∫πp c√°c √¥ input m√©t
        const meterInputs = ['dien-bt-dau', 'dien-cd-dau', 'dien-td-dau', 'dien-bt-cuoi', 'dien-cd-cuoi', 'dien-td-cuoi', 'nuoc-dau', 'nuoc-cuoi', 'flow-in-start', 'flow-in-end', 'flow-out-start', 'flow-out-end'];
        meterInputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });

        // D·ªçn d·∫πp c√°c √¥ span t√≠nh to√°n
        const spanOutputs = ['dien-sl', 'nuoc-sl', 'flow-in-total', 'flow-out-total'];
        spanOutputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '0';
        });

        // D·ªçn d·∫πp c√°c b·∫£ng ƒë·ªông (ch·ªâ d·ªçn n·ªôi dung, gi·ªØ 2 d√≤ng m·∫´u)
        ['bio-table', 'output-table'].forEach(tableId => {
            document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
                row.querySelectorAll('input').forEach(input => input.value = '');
            });
        });
        // D·ªçn b·∫£ng h√≥a ch·∫•t
        document.querySelectorAll('#chemicals-table tbody tr').forEach(row => {
            const inputs = row.querySelectorAll('input');
            if(inputs[0] && inputs[0].placeholder.includes("kh√°c")) {
                inputs[0].value = ''; // Ch·ªâ x√≥a d√≤ng "kh√°c"
            }
            if(inputs[1]) inputs[1].value = ''; // Lu√¥n x√≥a s·ªë l∆∞·ª£ng
        });

        // D·ªçn ghi ch√∫
        const notesTextArea = document.querySelector('.notes-section textarea');
        if (notesTextArea) notesTextArea.value = '';

        document.getElementById('existing-images').innerHTML = '';

        // RESET N√öT L∆ØU V·ªÄ TR·∫†NG TH√ÅI BAN ƒê·∫¶U
        const saveBtn = document.getElementById('save-report-btn');
        saveBtn.textContent = 'üíæ L∆∞u B√°o c√°o';
        saveBtn.style.display = 'block';
        saveBtn.onclick = saveReport; // ‚≠êÔ∏è LU√îN G√ÅN L·∫†I H√ÄM saveReport ‚≠êÔ∏è
    }
    /**
     * HELPER 9: ƒê·ªï d·ªØ li·ªáu (populate) - Ch·∫ø ƒë·ªô CH·ªà XEM th·ª±c s·ª±
     * mode: 'read-only' | 'sandwich-fill' | 'auto-fill'
     * (ƒê√£ s·ª≠a logic kh√≥a 'sandwich-fill' ƒë·ªÉ x·ª≠ l√Ω ca b·ªã thi·∫øu)
     */
    function populateFormWithData(data, mode = 'read-only') {
        const isReadOnlyMode = (mode === 'read-only');
        // H√†m helper ƒë·ªÉ set gi√° tr·ªã
        const setAndBlur = (id, value) => {
            const el = document.getElementById(id);
            // ‚≠êÔ∏è S·ª¨A 2: Cho ph√©p ƒëi·ªÅn chu·ªói r·ªóng ("")
            if (el && value != null) { 
                el.value = value;
                // G·ª≠i c·∫£ s·ª± ki·ªán blur V√Ä change
                el.dispatchEvent(new Event('blur', { bubbles: true })); 
                el.dispatchEvent(new Event('change', { bubbles: true }));
            }
        };

        // Danh s√°ch T·∫§T C·∫¢ c√°c √¥ m√©t
        const meterInputIds = [
            'dien-bt-dau', 'dien-cd-dau', 'dien-td-dau', 'dien-bt-cuoi', 'dien-cd-cuoi', 'dien-td-cuoi',
            'nuoc-dau', 'nuoc-cuoi', 'flow-in-start', 'flow-in-end', 'flow-out-start', 'flow-out-end'
        ];

        // 1. LU√îN LU√îN ƒëi·ªÅn c√°c ch·ªâ s·ªë m√©t (n·∫øu c√≥ trong dataToFill)
        // √Åp d·ª•ng cho c·∫£ 3 ch·∫ø ƒë·ªô
        if (data.meters) {
            Object.keys(data.meters).forEach(key => {
                const id = key.replace(/_/g, '-'); 
                const el = document.getElementById(id);
                if (el && el.tagName === 'INPUT') {
                    setAndBlur(id, data.meters[key]);
                } else if (el && el.tagName === 'SPAN') {
                    // C·∫≠p nh·∫≠t c√°c √¥ span t√≠nh to√°n (n·∫øu l√† read-only)
                    if (mode === 'read-only') el.textContent = data.meters[key];
                }
            });
        }

        // --- 2. X·ª¨ L√ù KH√ìA √î (ƒê√É S·ª¨A LOGIC V9) ---
        meterInputIds.forEach(id => { // M·ªü kh√≥a t·∫•t c·∫£ tr∆∞·ªõc
            const el = document.getElementById(id);
            if (el) el.disabled = false;
        });
        
        // ‚≠êÔ∏è B·∫ÆT ƒê·∫¶U S·ª¨A L·ªñI ‚≠êÔ∏è
        if (mode === 'sandwich-fill') { // Kh√≥a khi l√† sandwich
            
            // LOGIC M·ªöI: Ch·ªâ kh√≥a nh·ªØng √¥ C√ì D·ªÆ LI·ªÜU.
            // ƒêi·ªÅu n√†y cho ph√©p tr∆∞·ªùng h·ª£p "k·∫πp thi·∫øu" (v√≠ d·ª•: thi·∫øu ca tr∆∞·ªõc)
            // kh√≥a "cu·ªëi ca" (ƒë√£ ƒëi·ªÅn) nh∆∞ng v·∫´n m·ªü "ƒë·∫ßu ca" (b·ªã tr·ªëng).
            meterInputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.value) { // Ch·ªâ kh√≥a n·∫øu √¥ C√ì gi√° tr·ªã
                        el.disabled = true;
                    } else {
                        el.disabled = false; // ƒê·ªÉ m·ªü n·∫øu √¥ r·ªóng
                    }
                }
            });
            // ‚≠êÔ∏è K·∫æT TH√öC S·ª¨A L·ªñI ‚≠êÔ∏è

            // T√≠nh to√°n l·∫°i t·ªïng (v·∫´n gi·ªØ nguy√™n)
            calculateSum(['dien-bt-dau', 'dien-cd-dau', 'dien-td-dau'], ['dien-bt-cuoi', 'dien-cd-cuoi', 'dien-td-cuoi'], 'dien-sl');
            calculateSum(['nuoc-dau'], ['nuoc-cuoi'], 'nuoc-sl');
            calculateSum(['flow-in-start'], ['flow-in-end'], 'flow-in-total');
            calculateSum(['flow-out-start'], ['flow-out-end'], 'flow-out-total');
        }

        // --- 3. ƒêI·ªÄN PH·∫¶N C√íN L·∫†I V√Ä KH√ìA (N·∫æU L√Ä READ-ONLY) ---
        const existingImagesContainer = document.getElementById('existing-images');
        if (mode === 'read-only') {
            existingImagesContainer.innerHTML = '';
            // ƒêi·ªÅn Nh√¢n vi√™n
            [1, 2, 3].forEach(i => {
                document.getElementById(`handover-staff-${i}`).value = (data.handoverStaff && data.handoverStaff[i - 1]) || "";
                document.getElementById(`receiving-staff-${i}`).value = (data.receivingStaff && data.receivingStaff[i - 1]) || "";
            });

            // H√≥a ch·∫•t
            if (data.chemicals) {
                const rows = document.querySelectorAll('#chemicals-table tbody tr');
                data.chemicals.forEach((chem, index) => {
                    if (rows[index]) {
                        rows[index].querySelectorAll('input')[0].value = chem.chemicalName;
                        rows[index].querySelectorAll('input')[1].value = chem.quantity;
                    }
                });
            }
            // Sinh h·ªçc
            if (data.bioSystem) {
                const rows = document.querySelectorAll('#bio-table tbody tr');
                data.bioSystem.forEach((bio, index) => {
                    if (rows[index]) {
                        const inputs = rows[index].querySelectorAll('input');
                        inputs[0].value = bio.time;
                        inputs[1].value = bio.do_anoxic;
                        inputs[2].value = bio.do_aero1;
                        inputs[3].value = bio.do_aero2;
                        inputs[4].value = bio.sv30_anoxic;
                        inputs[5].value = bio.sv30_aero1;
                        inputs[6].value = bio.sv30_aero2;
                    }
                });
            }
            // N∆∞·ªõc ƒë·∫ßu ra
            if (data.outputWater) {
                const rows = document.querySelectorAll('#output-table tbody tr');
                data.outputWater.forEach((out, index) => {
                    if (rows[index]) {
                        const inputs = rows[index].querySelectorAll('input');
                        inputs[0].value = out.time;
                        inputs[1].value = out.ph;
                        inputs[2].value = out.cod;
                        inputs[3].value = out.n;
                        inputs[4].value = out.tss;
                        inputs[5].value = out.clo;
                    }
                });
            }

            // Ghi ch√∫
            const notesTextArea = document.querySelector('.notes-section textarea');
            if (notesTextArea && data.notes) {
                notesTextArea.value = data.notes;
            }

            // *** HI·ªÇN TH·ªä ·∫¢NH ƒê√çNH K√àM HI·ªÜN C√ì (ƒê√É S·ª¨A L·ªñI XEM ·∫¢NH) ***
            
            if (data.images && data.imageIds && data.images.length === data.imageIds.length) {
                
                data.images.forEach((imageUrl, index) => {
                    const imageId = data.imageIds[index];
                    
                    const imgDiv = document.createElement('div');
                    imgDiv.style.border = '1px solid #ccc';
                    imgDiv.style.padding = '3px';
                    imgDiv.style.borderRadius = '4px';
                    imgDiv.dataset.id = imageId; // V·∫´n l∆∞u ID
                    imgDiv.dataset.url = imageUrl; // V·∫´n l∆∞u URL

                    // --- B·ªé TH·∫∫ A, TH√äM S·ª∞ KI·ªÜN ONCLICK ƒê·ªÇ M·ªû MODAL ---
                    const img = document.createElement('img');
                    img.src = getDriveThumbnailUrl(imageUrl); // D√πng thumbnail cho nhanh
                    img.style.width = '100px';
                    img.style.height = '100px';
                    img.style.objectFit = 'cover';
                    img.style.display = 'block';
                    img.style.cursor = 'pointer'; // Th√™m con tr·ªè chu·ªôt
                    img.title = "Nh·∫•n ƒë·ªÉ xem ·∫£nh"; // Th√™m g·ª£i √Ω

                    // Th√™m s·ª± ki·ªán onclick ƒë·ªÉ m·ªü SweetAlert2 (ƒê√É S·ª¨A L·ªñI IFRAME - V6)
                    img.onclick = () => {
                        // 1. S·ª¨ D·ª§NG HELPER ƒê√É C√ì ƒë·ªÉ l·∫•y link ·∫£nh tr·ª±c ti·∫øp
                        const directImageUrl = getDriveLargePreviewUrl(imageUrl, 1200); 

                        Swal.fire({
                            width: '90vw', 
                            padding: '0.25em',
                            // 2. S·ª¨ D·ª§NG <img> thay v√¨ <iframe>
                            html: `
                                <img 
                                    src="${directImageUrl}" 
                                    style="
                                        width: 100%;          /* T·ª± ƒë·ªông l·∫•p ƒë·∫ßy chi·ªÅu r·ªông modal */
                                        max-height: 85vh;     /* Gi·ªõi h·∫°n chi·ªÅu cao */
                                        object-fit: contain;  /* ƒê·∫£m b·∫£o xem ƒë∆∞·ª£c to√†n b·ªô ·∫£nh, kh√¥ng b·ªã c·∫Øt */
                                    "
                                />
                            `,
                            showConfirmButton: false,
                            showCloseButton: true,
                            backdrop: `rgba(0,0,0,0.7)`
                        });
                    };
                    imgDiv.appendChild(img); // ƒê∆∞a th·∫≥ng img v√†o div
                    
                    // KH√îNG TH√äM N√öT X√ìA ·ªû CH·∫æ ƒê·ªò N√ÄY

                    existingImagesContainer.appendChild(imgDiv);
                });
            }

            // *** CHUY·ªÇN SANG CH·∫æ ƒê·ªò "CH·ªà XEM" (KH√ìA M·ªåI TH·ª®) ***
            document.querySelectorAll('.container input, .container select, .container textarea').forEach(el => {
                // KH√îNG kh√≥a input file ƒë·ªÉ h·ªç c√≥ th·ªÉ CH·ªåN file m·ªõi KHI nh·∫•n S·ª≠a
                if (el.id !== 'report-images') { 
                    el.disabled = true;
                }
            });
            // K√≠ch ho·∫°t l·∫°i c√°c n√∫t ƒëi·ªÅu khi·ªÉn ch√≠nh
            document.getElementById('reportDate').disabled = false;
            document.getElementById('shiftSelect').disabled = false;
            
            // *** ƒê·ªîI N√öT L∆ØU TH√ÄNH N√öT S·ª¨A ***
            const saveBtn = document.getElementById('save-report-btn');
            saveBtn.textContent = 'üìù S·ª≠a B√°o c√°o';
            saveBtn.style.display = 'block'; 
            // G·∫Øn s·ª± ki·ªán ƒë·ªÉ k√≠ch ho·∫°t ch·∫ø ƒë·ªô s·ª≠a (s·∫Ω l√†m ·ªü b∆∞·ªõc sau)
            saveBtn.onclick = enableEditMode; 
        }
    }
    /**
     * HELPER 9.5: K√≠ch ho·∫°t ch·∫ø ƒë·ªô s·ª≠a b√°o c√°o
     * Logic: M·ªü kh√≥a form, th√™m n√∫t x√≥a ·∫£nh, v√† g·ªçi auto-fill CH·ªà cho ch·ªâ s·ªë m√©t.
     */
    async function enableEditMode() { 
        
        // ‚≠êÔ∏è S·ª¨A L·ªñI: Chuy·ªÉn 4 d√≤ng khai b√°o n√†y T·ª™ CU·ªêI H√ÄM L√äN ƒê√ÇY ‚≠êÔ∏è
        const reportDate = document.getElementById('reportDate').value;
        const shiftSelectEl = document.getElementById('shiftSelect');
        const shiftId = shiftSelectEl.value;
        const selectedOption = shiftSelectEl.options[shiftSelectEl.selectedIndex];

        // ‚≠êÔ∏è V·ªä TR√ç CH√àN LOG (Gi·ªù ƒë√£ an to√†n) ‚≠êÔ∏è        
        if (selectedOption && shiftId) {
            const shiftStartTime = selectedOption.dataset.start || "00:00";
            const currentReportId = `${reportDate}_${shiftStartTime}_${shiftId}`;
                
            const userEmail = auth.currentUser ? auth.currentUser.email : "unknown";
            addLog("report_edit_initiated", { 
                reportId: currentReportId,
                date: reportDate,
                shift: shiftId,
                email: userEmail
            });
        }       
        
        // 1. M·ªü kh√≥a t·∫•t c·∫£ c√°c √¥ input/select/textarea (tr·ª´ Ng√†y v√† Ca)
        document.querySelectorAll('.container input, .container select, .container textarea').forEach(el => {
            if (el.id !== 'reportDate' && el.id !== 'shiftSelect') {
                el.disabled = false;
            }
        });

        // 2. Th√™m n√∫t x√≥a (üóëÔ∏è) v√†o c√°c ·∫£nh hi·ªán c√≥ (Gi·ªØ nguy√™n)
        document.querySelectorAll('#existing-images > div').forEach(imgDiv => {
            if (!imgDiv.querySelector('.remove-image-btn')) {
                imgDiv.style.position = 'relative';
                 const removeBtn = document.createElement('button');
                 removeBtn.textContent = 'üóëÔ∏è';
                 removeBtn.className = 'remove-image-btn'; 
                 removeBtn.style.position = 'absolute';
                 removeBtn.style.top = '0px';
                 removeBtn.style.right = '0px';
                 removeBtn.style.background = 'rgba(255, 0, 0, 0.7)';
                 removeBtn.style.color = 'white';
                 removeBtn.style.border = 'none';
                 removeBtn.style.borderRadius = '0 3px 0 3px';
                 removeBtn.style.cursor = 'pointer';
                 removeBtn.style.fontSize = '14px';
                 removeBtn.style.lineHeight = '1';
                 removeBtn.onclick = () => {
                     imgDiv.remove();
                 };
                 imgDiv.appendChild(removeBtn);
            }
        });

        // 3. ƒê·ªïi n√∫t "S·ª≠a" th√†nh n√∫t "L∆∞u Thay ƒê·ªïi" v√† g√°n l·∫°i s·ª± ki·ªán saveReport
        const saveBtn = document.getElementById('save-report-btn');
        saveBtn.textContent = 'üíæ L∆∞u Thay ƒê·ªïi';
        saveBtn.onclick = saveReport; // G√°n l·∫°i h√†m saveReport g·ªëc
        
        // 4. K√≠ch ho·∫°t logic Auto-fill CH·ªà cho ch·ªâ s·ªë m√©t
        
        // ‚≠êÔ∏è S·ª¨A L·ªñI: X√≥a 4 d√≤ng 'const' ·ªü ƒë√¢y v√¨ ch√∫ng ƒë√£ ƒë∆∞·ª£c chuy·ªÉn l√™n tr√™n
        
        if (reportDate && shiftId) { // B√¢y gi·ªù ch·ªâ c·∫ßn d√πng l·∫°i bi·∫øn
            const currentReportId = `${reportDate}_${selectedOption.dataset.start || "00:00"}_${shiftId}`; // ƒê∆°n gi·∫£n h√≥a
            const currentShift = allReportShifts.find(s => s.id === shiftId);
            const currentDate = new Date(reportDate + "T00:00:00");
            
            // ‚≠êÔ∏è S·ª¨A ƒê·ªîI QUAN TR·ªåNG: D√πng 'meter-fill-only' ƒë·ªÉ KH√îNG x√≥a/v·∫Ω l·∫°i ·∫£nh ‚≠êÔ∏è
            await smartAutoFill(currentReportId, currentShift, currentDate, 'meter-fill-only');
        }
    }

    // L·∫•y URL c·ªßa Google Apps Script (t·ª´ script.js)
    const DRIVE_API_URL = "https://script.google.com/macros/s/AKfycbwuNTOBpbG2Zla8V6MLRLVY_xoRPhqZS6DT6YImnw9YCOZhJARQ1mSrNLEPZvM33PwqaA/exec";

    /**
     * HELPER 10: T·∫£i 1 file (ƒë√£ s·ª≠a)
     * G·ª≠i file l√™n GAS v√†o m·ªôt ID th∆∞ m·ª•c con c·ª• th·ªÉ.
     */
    async function uploadFileToGAS_Report(file, targetFolderId) { // <-- S·ª≠a tham s·ªë
        const user = auth.currentUser;
        if (!user) throw new Error("Ch∆∞a ƒëƒÉng nh·∫≠p");

        const idToken = await user.getIdToken();

        // H√†m toBase64 (gi·ªØ nguy√™n)
        const toBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.onerror = (error) => reject(error);
        });

        const base64 = await toBase64(file);

        // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi (S·ª¨A L·∫†I)
        const body = new URLSearchParams();
        body.append("idToken", idToken);
        body.append("action", "uploadReportImage"); // Action c≈©
        body.append("file", base64);
        body.append("name", file.name); 
        body.append("type", file.type);
        body.append("targetFolderId", targetFolderId); // ‚≠êÔ∏è G·ª≠i ID th∆∞ m·ª•c con
        // (X√≥a 2 d√≤ng "folderId" v√† "reportId" c≈©)

        const res = await fetch(DRIVE_API_URL, { method: "POST", body });
        const result = await res.json();

        if (result.error) {
            addLog("report_upload_failure", { email: user.email, file: file.name, error: result.error });
            throw new Error(result.error);
        }

        addLog("report_upload_success", { email: user.email, file: file.name, fileId: result.id });
        return { url: result.link, id: result.id };
    }
    /**
     * HELPER 10.5: G·ªçi GAS ƒë·ªÉ "ƒê·∫£m b·∫£o th∆∞ m·ª•c t·ªìn t·∫°i"
     * S·∫Ω ch·∫°y 1 l·∫ßn, d√πng LockService an to√†n tr√™n server.
     */
    async function ensureReportFolderOnGAS(reportId, rootFolderId) {
        const user = auth.currentUser;
        if (!user) throw new Error("Ch∆∞a ƒëƒÉng nh·∫≠p");
        const idToken = await user.getIdToken();

        const body = new URLSearchParams();
        body.append("idToken", idToken);
        body.append("action", "ensureReportFolder"); // ‚≠êÔ∏è ACTION M·ªöI
        body.append("folderId", rootFolderId);     // Th∆∞ m·ª•c g·ªëc
        body.append("reportId", reportId);         // T√™n b√°o c√°o

        const res = await fetch(DRIVE_API_URL, { method: "POST", body });
        const result = await res.json();

        if (result.error || !result.success) {
            throw new Error(result.error || "Kh√¥ng th·ªÉ t·∫°o th∆∞ m·ª•c b√°o c√°o");
        }

        return result.id; // Tr·∫£ v·ªÅ ID th∆∞ m·ª•c con
    }
    /**
     * HELPER 11: X√≥a 1 file (t√πy bi·∫øn cho B√°o C√°o Ca)
     * G·ªçi action "delete" tr√™n Google Apps Script (gs7.txt)
     */
    async function deleteFileFromGAS_Report(fileId) {
        const user = auth.currentUser;
        if (!user) throw new Error("Ch∆∞a ƒëƒÉng nh·∫≠p");

        const idToken = await user.getIdToken();
        
        const body = new URLSearchParams();
        body.append("idToken", idToken);
        body.append("action", "delete"); // ‚≠êÔ∏è D√πng action "delete" ƒë√£ c√≥
        body.append("fileId", fileId);

        const res = await fetch(DRIVE_API_URL, { method: "POST", body });
        const result = await res.json();
        
        if (result.error) {
            addLog("report_delete_failure", { email: user.email, fileId, error: result.error });
            throw new Error(result.error);
        }
        
        addLog("report_delete_success", { email: user.email, fileId });
        return result;
    }
    /**
     * HELPER 12: G·ªçi GAS ƒë·ªÉ t·∫°o v√† l∆∞u file HTML/TEXT l∆∞u tr·ªØ
     */
    async function generateReportFile(reportId, folderId, content, fileType = "html") {
        const user = auth.currentUser;
        if (!user) return console.error("L·ªói l∆∞u file: Ch∆∞a ƒëƒÉng nh·∫≠p.");

        try {
            const idToken = await user.getIdToken();

            const body = new URLSearchParams();
            body.append("idToken", idToken);
            body.append("action", "createReportFile"); // ‚≠êÔ∏è ACTION M·ªöI TR√äN GAS
            body.append("reportId", reportId);
            body.append("folderId", folderId);
            body.append("content", content); // N·ªôi dung file
            body.append("fileType", fileType); // Lo·∫°i file (HTML)
            
            // Ch·∫°y fetch kh√¥ng c·∫ßn ch·ªù k·∫øt qu·∫£ (t·ªëi ∆∞u t·ªëc ƒë·ªô)
            const res = await fetch(DRIVE_API_URL, { method: "POST", body });
            const result = await res.json();

            if (result.error || !result.success) {
                console.error("L·ªói GAS khi t·∫°o file l∆∞u tr·ªØ:", result.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh");
                addLog("file_creation_failure", { reportId, error: result.error, email: user.email });
            } else {
                 console.log(`ƒê√£ t·∫°o v√† l∆∞u file l∆∞u tr·ªØ: ${result.link}`);
                 addLog("file_creation_success", { reportId, fileId: result.id, email: user.email });
            }

        } catch (error) {
            console.error("L·ªói k·∫øt n·ªëi khi t·∫°o file l∆∞u tr·ªØ:", error);
            addLog("file_creation_connection_error", { reportId, error: error.message, email: user.email });
        }
    }
    /**
     * HELPER X: Chu·∫©n b·ªã HTML b·∫±ng c√°ch √°p d·ª•ng CSS In (onbeforeprint) cho m·ª•c ƒë√≠ch l∆∞u file.
     * T√°i c·∫•u tr√∫c ƒë·ªÉ t·ªëi ∆∞u b·ªë c·ª•c vƒÉn b·∫£n cho file l∆∞u tr·ªØ.
     */
    function prepareHtmlForSaving() {
        
        // 1. CH·∫†Y LOGIC ONBEFOREPRINT (t·∫°o c√°c span thay th·∫ø cho input, ·∫©n c√°c ph·∫ßn t·ª≠ kh√¥ng c·∫ßn thi·∫øt)
        window.onbeforeprint(); 

        // 2. L·∫§Y N·ªòI DUNG HTML ƒê√É THAY ƒê·ªîI
        const contentDiv = document.getElementById('pageContent');
        let htmlContent = contentDiv.outerHTML; 

        // 3. HO√ÄN T√ÅC ONBEFOREPRINT NGAY L·∫¨P T·ª®C
        window.onafterprint(); 

        // 4. TR·∫¢ V·ªÄ CHU·ªñI HTML T·ªêI GI·∫¢N V√Ä C√ì B·ªê C·ª§C (ƒê√É C·∫ÆT ƒê√îI TH·∫∫ ƒê√ìNG)
        // ƒê√¢y l√† n∆°i √°p d·ª•ng c√°c quy t·∫Øc CSS ƒë·ªÉ t·∫°o b·ªë c·ª•c thu·∫≠n m·∫Øt
        const shiftName = document.getElementById('shiftSelect').options[document.getElementById('shiftSelect').selectedIndex].text;
        
        return `
            <!DOCTYPE html>
            <html lang="vi">
            <head>
                <meta charset="UTF-8">
                <title>B√°o c√°o ${getVal('reportDate')} - ${shiftName}</title>
                <style>
                    /* --- CSS C∆† B·∫¢N ƒê·ªÇ THU·∫¨N M·∫ÆT --- */
                    body { 
                        font-family: 'Times New Roman', Times, serif; 
                        font-size: 12pt; /* K√≠ch th∆∞·ªõc ch·ªØ chu·∫©n vƒÉn b·∫£n */
                        line-height: 1.3;
                        margin: 0; padding: 0; 
                    }

                    /* ‚≠êÔ∏è S·ª¨A 1: CANH GI·ªÆA TI√äU ƒê·ªÄ ‚≠êÔ∏è */
                    header { 
                        text-align: center; 
                        margin-bottom: 10px; /* Gi·∫£m margin cho g·ªçn */
                    }
                    header h2 {
                        text-align: center; 
                        font-size: 18px; 
                    }
                    
                    /* ‚≠êÔ∏è KH·∫ÆC PH·ª§C L·ªñI CƒÇN CH·ªàNH HEADER ‚≠êÔ∏è */
                    .header-info { 
                        display: flex; /* B·∫≠t Flexbox ƒë·ªÉ x·∫øp ngang */
                        justify-content: space-between; /* ƒê·∫©y "Ng√†y" v√† "Ca tr·ª±c" ra hai b√™n */
                        align-items: flex-start; /* CƒÉn tr√™n c√πng */
                        margin-bottom: 10px;
                        padding: 0 5px;
                        font-weight: bold; /* Th√™m font-weight v√¨ n√≥ b·ªã m·∫•t khi ·∫©n input */
                    }
                    .header-info div {
                        /* ƒê·∫£m b·∫£o c√°c kh·ªëi con kh√¥ng chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
                        display: inline-flex; /* D√πng inline-flex cho c√°c kh·ªëi Ng√†y/Ca tr·ª±c */
                        gap: 8px; /* Gi·ªØ kho·∫£ng c√°ch gi·ªØa label v√† gi√° tr·ªã */
                    }
                    
                    /* ‚≠êÔ∏è KH·∫ÆC PH·ª§C L·ªñI CƒÇN CH·ªàNH B·∫¢NG STAFF ‚≠êÔ∏è */
                    .staff-section {
                        display: flex; /* B·∫≠t Flexbox ƒë·ªÉ x·∫øp 2 b·∫£ng ngang nhau */
                        gap: 10px;      /* Kho·∫£ng c√°ch gi·ªØa 2 b·∫£ng */
                        margin-bottom: 10px;
                    }
                    .staff-table {
                        flex: 1; /* Cho ph√©p m·ªói b·∫£ng chi·∫øm 50% */
                        table-layout: auto; /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt */
                    }

                    /* ‚≠êÔ∏è S·ª¨A 2: VI·ªÄN LI·ªÄN CHO √î K√ù T√äN ‚≠êÔ∏è */
                    .staff-table td:last-child { 
                        border: 1px solid #000 !important; /* √Åp d·ª•ng vi·ªÅn li·ªÅn cho √¥ */
                        border-bottom: 1px solid #000 !important; 
                        height: 30px; 
                    }

                    /* ‚≠êÔ∏è KH·∫ÆC PH·ª§C L·ªñI QUAN TR·ªåNG: ·∫®n input g·ªëc, hi·ªán span ‚≠êÔ∏è */
                    .container input, 
                    .container select, 
                    .container textarea {
                        display: none !important; /* ·∫®n to√†n b·ªô input/select/textarea g·ªëc */
                    }
                    .print-only-span { 
                        display: block !important; 
                        color: #000 !important;
                        padding: 0; /* ƒê√£ c√≥ ·ªü d∆∞·ªõi, nh∆∞ng th√™m ·ªü ƒë√¢y ƒë·ªÉ ∆∞u ti√™n */
                    }
                    /* C·∫ßn s·ª≠a l·∫°i cho c√°c √¥ header */
                    .header-info .print-only-span {
                        display: inline !important; /* ƒê·∫£m b·∫£o gi√° tr·ªã x·∫øp ngang h√†ng v·ªõi label */
                        width: auto !important;
                    }
                    
                    /* --- C√ÅC QUY T·∫ÆC B·∫¢NG V√Ä KHUNG --- */
                    @page { 
                        size: A4; 
                        margin: 2.5cm 2cm 2.5cm 2.5cm; /* CƒÉn l·ªÅ chu·∫©n A4 */
                    }
                    .main-container, .container, #pageContent {
                        width: 100%; max-width: 750px; 
                        margin: 0 auto; padding: 10px;
                        box-shadow: none; border: none; background: #fff;
                    }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 8px; table-layout: fixed; }
                    th, td { border: 1px solid #000; padding: 5px; text-align: center; vertical-align: top; }
                    th { background-color: #f0f0f0; }

                    /* ƒêi·ªÅu ch·ªânh c√°c ph·∫ßn t·ª≠ ƒë√£ chuy·ªÉn th√†nh SPAN */
                    .staff-table td:last-child { border: none; border-bottom: 1px dotted #000; height: 30px; }

                    /* ·∫®N TO√ÄN B·ªò C√ÅC PH·∫¶N T·ª¨ GIAO DI·ªÜN KH√îNG C·∫¶N THI·∫æT */
                    .print-button, #menu-placeholder, #footer-placeholder, #shiftConfig, 
                    #image-title, #existing-images, #report-images, .action-row, .form-group {
                        display: none !important; 
                    }
                    .notes-section .print-only-span {
                        min-height: 100px;
                        border: 1px solid #999;
                        padding: 5px;
                        text-align: left;
                        white-space: pre-wrap; 
                    }
                </style>
            </head>
            <body>
                ${htmlContent}
            </body` + `>
            </html` + `>
        `;
    }

// --- B·ªî SUNG LOGIC IN ·∫§N (V4 - GI·∫¢I PH√ÅP T·∫†O SPAN) ---
    
    // H√†m n√†y s·∫Ω x√≥a c√°c span "ch·ªâ-ƒë·ªÉ-in"
    function removePrintSpans() {
        document.querySelectorAll('.print-only-span').forEach(span => span.remove());
    }

    window.onbeforeprint = function() {
        
        // 1. D·ªçn d·∫πp c≈© (n·∫øu c√≥)
        removePrintSpans(); 
        
        // 2. M·ªü kh√≥a t·∫°m th·ªùi (v·∫´n c·∫ßn thi·∫øt cho ch·∫ø ƒë·ªô "ch·ªâ xem")
        let disabledElements = [];
        document.querySelectorAll('.container input:disabled, .container select:disabled, .container textarea:disabled').forEach(el => {
            el.disabled = false;
            disabledElements.push(el); 
        });

        // 3. T·∫°o SPAN cho INPUT v√† TEXTAREA (ƒê√£ s·ª≠a ƒë·ªãnh d·∫°ng ng√†y)
        document.querySelectorAll('.container input, .container textarea').forEach(el => {
            let val = el.value || '...'; // L·∫•y gi√° tr·ªã m·∫∑c ƒë·ªãnh

            // --- B·∫ÆT ƒê·∫¶U S·ª¨A L·ªñI ƒê·ªäNH D·∫†NG NG√ÄY IN ---
            if (el.id === 'reportDate' && el.value) {
                try {
                    const parts = el.value.split('-'); // ["2025", "10", "23"]
                    val = `${parts[2]}/${parts[1]}/${parts[0]}`; // "23/10/2025"
                } catch (e) {
                    val = el.value; // N·∫øu l·ªói, gi·ªØ nguy√™n
                }
            }
            // --- K·∫æT TH√öC S·ª¨A L·ªñI ---

            const span = document.createElement('span');
            span.textContent = val;
            span.className = 'print-only-span'; // ƒê·∫∑t class ƒë·ªÉ CSS
            
            // CƒÉn l·ªÅ cho SPAN d·ª±a tr√™n class c·ªßa INPUT
            if (el.classList.contains('number-input')) {
                span.style.textAlign = 'right';
            } else if (el.classList.contains('input-small')) {
                span.style.textAlign = 'center';
            }
            
            // Ch√®n span v√†o ngay sau input/textarea
            el.parentNode.insertBefore(span, el.nextSibling);
        });
        
        // 4. T·∫°o SPAN cho SELECT (ƒê√£ s·ª≠a l·ªói "Ch·ªçn nh√¢n vi√™n")
        document.querySelectorAll('.container select').forEach(el => {
            let val = ''; // M·∫∑c ƒë·ªãnh l√† chu·ªói r·ªóng

            // Ch·ªâ l·∫•y text n·∫øu value KH√îNG R·ªñNG (t·ª©c l√† kh√¥ng ph·∫£i "--- Ch·ªçn nh√¢n vi√™n ---")
            if (el.value !== "" && el.selectedIndex >= 0 && el.options[el.selectedIndex]) { 
                 val = el.options[el.selectedIndex].text;
            }
            
            const span = document.createElement('span');
            span.textContent = val; // S·∫Ω l√† "" n·∫øu kh√¥ng ch·ªçn
            span.className = 'print-only-span';
            span.style.textAlign = 'left';
            span.style.paddingLeft = '5px';
            el.parentNode.insertBefore(span, el.nextSibling);
        });

        // 5. Kh√≥a l·∫°i c√°c √¥ ƒë√£ m·ªü
        disabledElements.forEach(el => el.disabled = true);
        
    };

    // 6. D·ªçn d·∫πp SAU KHI IN
    window.onafterprint = function() {
        removePrintSpans(); // X√≥a t·∫•t c·∫£ c√°c span ƒë√£ t·∫°o
    };
    // --- K·∫æT TH√öC LOGIC IN ·∫§N V4 ---
    
</script>

</body>
</html>
