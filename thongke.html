<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ªëng K√™ B√°o C√°o Ca</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    /* --- T√ôY CH·ªàNH MODAL PH√ÇN T√çCH --- */

    /* TƒÉng ƒë·ªô r·ªông modal */
    #analysisModal .modal-content-config {
        width: 90% !important;        /* R·ªông 90% m√†n h√¨nh */
        max-width: 1200px !important; /* Gi·ªõi h·∫°n t·ªëi ƒëa 1200px */
        margin: 10vh auto !important; /* ƒê·∫©y modal l√™n cao h∆°n m·ªôt ch√∫t (10% chi·ªÅu cao viewport) */
    }

    /* Canh gi·ªØa ti√™u ƒë·ªÅ b·∫£ng trong modal */
    #analysisTable thead th {
        text-align: center !important;
    }
    /* CSS cho c·∫£nh b√°o t·ª´ "kh√¥ng" trong modal ph√¢n t√≠ch */
    #analysisTable td.has-negation {
        background-color: #fff3cd !important; /* M√†u v√†ng nh·∫°t */
        font-weight: bold;
    }
    /* ·∫®n footer m·∫∑c ƒë·ªãnh */
    #footer-placeholder {
        display: none;
    }
    /* --- ƒêI·ªÄU CH·ªàNH ƒê·ªò R·ªòNG C·ªòT B·∫¢NG CH√çNH --- */
    #summaryTable {
        table-layout: fixed; /* QUAN TR·ªåNG: Bu·ªôc b·∫£ng tu√¢n th·ªß ƒë·ªô r·ªông c·ªôt */
        width: 100%;       /* ƒê·∫£m b·∫£o b·∫£ng chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
    }

    #summaryTable th:nth-child(1) { width: 15%; } /* C·ªôt 1: Ch·ªâ s·ªë */
    #summaryTable th:nth-child(2), /* C·ªôt 2: T·ªïng tu·∫ßn */
    #summaryTable th:nth-child(4), /* C·ªôt 4: T·ªïng th√°ng */
    #summaryTable th:nth-child(6), /* C·ªôt 6: T·ªïng nƒÉm */
    #summaryTable th:nth-child(8)  { width: 8%; } /* C·ªôt 8: T·ªïng K·ª≥ (·∫©n) */

    #summaryTable th:nth-child(3), /* C·ªôt 3: TB tu·∫ßn */
    #summaryTable th:nth-child(5), /* C·ªôt 5: TB th√°ng */
    #summaryTable th:nth-child(7), /* C·ªôt 7: TB nƒÉm */
    #summaryTable th:nth-child(9)  { width: 8%; } /* C·ªôt 9: TB K·ª≥ (·∫©n) */

    #summaryTable th:nth-child(10) { width: 21%; } /* C·ªôt 10: Ghi ch√∫ */

    /* ƒê·∫£m b·∫£o n·ªôi dung c√≥ th·ªÉ xu·ªëng d√≤ng n·∫øu c·∫ßn */
    #summaryTable td {
        word-wrap: break-word;
        white-space: normal;
    }
    /* --- CƒÇN CH·ªàNH B·∫¢NG CHI TI·∫æT --- */
    #detailsTable thead th {
        text-align: center !important; /* CƒÉn gi·ªØa t·∫•t c·∫£ ti√™u ƒë·ªÅ c·ªôt */
    }

    #detailsTable tbody td {
        text-align: right; /* M·∫∑c ƒë·ªãnh: CƒÉn ph·∫£i cho c√°c c·ªôt s·ªë li·ªáu */
        vertical-align: middle; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    }

    #detailsTable tbody td:nth-child(1), /* C·ªôt 1: STT */
    #detailsTable tbody td:nth-child(2), /* C·ªôt 2: Ng√†y */
    #detailsTable tbody td:nth-child(8) { /* C·ªôt 8: Ghi ch√∫ */
        text-align: center !important; /* CƒÉn gi·ªØa c√°c c·ªôt n√†y */
    }
    /* CƒÉn tr√°i ri√™ng cho c·ªôt Ghi ch√∫ n·∫øu mu·ªën ƒë·ªçc d·ªÖ h∆°n */
    /*
    #detailsTable tbody td:nth-child(8) {
        text-align: left !important;
    }
    */
    /* B·ªè l·ªÅ d∆∞·ªõi c·ªßa ti√™u ƒë·ªÅ b·∫£ng chi ti·∫øt */
    #detailsTableContainer h4 {
        margin-bottom: 0;
        padding-bottom: 2px; /* Gi·∫£m padding n·∫øu c·∫ßn */
    }

    /* ƒê·∫£m b·∫£o div cu·ªôn v√† b·∫£ng kh√¥ng c√≥ l·ªÅ/ƒë·ªám tr√™n */
    #detailsScrollWrapper, #detailsTable {
        margin-top: 0 !important;
        padding-top: 0 !important;
        border-spacing: 0 !important; /* X√≥a kho·∫£ng c√°ch gi·ªØa vi·ªÅn √¥ (n·∫øu c√≥) */
    }

    /* T·ªëi ∆∞u l·∫°i sticky header m·ªôt ch√∫t */
    #detailsTableHeader {
        position: sticky;
        top: 0;
        background-color: #f2f2f2; /* Gi·ªØ m√†u n·ªÅn */
        z-index: 1;
        /* Th√™m outline ƒë·ªÉ debug (c√≥ th·ªÉ x√≥a sau) */
        /* outline: 1px solid red; */
    }
    /* CSS c∆° b·∫£n cho b·∫£ng th·ªëng k√™ */
    #summaryTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    #summaryTable th,
    #summaryTable td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: right; /* CƒÉn ph·∫£i s·ªë li·ªáu */
        vertical-align: top;
    }
    #summaryTable th:first-child,
    #summaryTable td:first-child {
        text-align: left; /* CƒÉn tr√°i c·ªôt Ch·ªâ s·ªë */
        font-weight: bold;
        width: 25%; /* C·ªë ƒë·ªãnh ƒë·ªô r·ªông c·ªôt Ch·ªâ s·ªë */
    }
    #summaryTable th {
        background-color: #f2f2f2;
    }
    /* In nghi√™ng t√™n h√≥a ch·∫•t chu·∫©n */
    #summaryTable .chemical-sub-item td:first-child {
        font-weight: normal; /* B·ªè in ƒë·∫≠m */
        font-style: italic;  /* √Åp d·ª•ng in nghi√™ng */
    }
    /* Style cho d√≤ng h√≥a ch·∫•t con */
    .chemical-sub-item td:first-child {
        padding-left: 20px;
        font-weight: normal;
    }
    /* CƒÉn gi·ªØa ti√™u ƒë·ªÅ c·ªôt */
     #summaryTable thead th {
        text-align: center !important;
     }

     /* Responsive cho b·∫£ng (v√≠ d·ª• ƒë∆°n gi·∫£n) */
     @media (max-width: 768px) {
        h2 {
          font-size: 1.2rem;
          margin-bottom: 10px;
        }
        
        .card-body {
          padding: 10px;
        }
        
        /* Filter box mobile - 1 h√†ng ngang c·ª±c g·ªçn gi·ªëng datatable */
        .filter-box {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 4px;
          margin-bottom: 8px;
          flex-wrap: nowrap;
        }
        
        .filter-box label {
          font-size: 0;
          line-height: 0;
          display: inline-flex;
          align-items: center;
          flex-shrink: 1;
        }
        
        .filter-box input[type="date"] {
          width: 90px !important;
          font-size: 11px !important;
          padding: 4px 2px !important;
          height: 27px !important;
          border: 1px solid #ccc;
          border-radius: 4px;
        }
        
        .filter-box select {
          display: none !important;
        }
        
        .filter-box button,
        .filter-box button#applyFilter {
          flex: 0 !important;
          width: 68px !important;
          min-width: 68px !important;
          max-width: 68px !important;
          font-size: 11px !important;
          padding: 4px !important;
          height: 27px !important;
          white-space: nowrap !important;
        }
        
        /* CSS ri√™ng cho thongke-page - ƒë·ªô ∆∞u ti√™n cao h∆°n */
        .filter-box.thongke-page button,
        .filter-box.thongke-page button#applyFilter {
          width: 100px !important;
          min-width: 100px !important;
          max-width: 100px !important;
        }
        
        /* B·∫£ng responsive */
        .table-container {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }
        
        #summaryTable {
          min-width: 700px;
        }
        
        #summaryTable th:first-child,
        #summaryTable td:first-child {
            width: 18% !important; /* Gi·∫£m ƒë·ªô r·ªông c·ªôt ch·ªâ s·ªë tr√™n mobile */
        }
        #summaryTable th,
        #summaryTable td {
            padding: 4px;
            font-size: 11px;
        }
        
        /* Modal mobile */
        #analysisModal .modal-content-config {
          width: 95% !important;
          margin: 2% auto !important;
          max-height: 95vh !important;
          padding: 10px !important;
        }
        
        #analysisTable {
          font-size: 11px;
        }
        
        #analysisTable th,
        #analysisTable td {
          padding: 4px;
        }
        
        /* Font size cho c·∫£nh b√°o v√† checkbox */
        #accuracyWarning {
          font-size: 11px !important;
        }
        
        label:has(#viewDetailsCheckbox) {
          font-size: 11px !important;
        }
     }

  </style>
</head>
<body>
  <div id="menu-placeholder"></div>
  <div id="loading-placeholder"></div>
  <div id="alert-placeholder"></div>

  <div id="notLogged" style="display:none; text-align:center; padding: 20px;">
    <h2>‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.</h2>
  </div>

  <div id="pageContent" style="display:none;">
    <h2>üìà Th·ªëng K√™ B√°o C√°o Ca Tr·ª±c</h2>
    <div class="card-body">

    <div class="filter-box thongke-page">
      <label>T·ª´ ng√†y: <input type="date" id="fromDate"></label>
      <label>ƒê·∫øn ng√†y: <input type="date" id="toDate"></label>
      <label>NƒÉm nhanh:
        <select id="yearSelect">
          <option value="">--Ch·ªçn nƒÉm--</option>
          </select>
      </label>
      <button id="applyFilter" type="button">üìä Xem Th·ªëng K√™</button>
      <button type="button" id="openAnalysisModal" class="admin-only" style="display:none; ">‚öôÔ∏è Ph√¢n t√≠ch B√°o c√°o</button>
    </div>
    <div class="note" id="filterNote" style="font-style: italic; margin-bottom: 10px; color: #444;"></div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1px;">
        <div id="accuracyWarning" style="display:none; color: red; font-style: italic; padding: 5px; flex-grow: 1; margin-right: 15px;">
            ‚ö†Ô∏è D·ªØ li·ªáu c√≥ th·ªÉ thi·∫øu ch√≠nh x√°c.
        </div>
        <label style="flex-shrink: 0;"> <input type="checkbox" id="viewDetailsCheckbox"> Xem chi ti·∫øt
        </label>
    </div>

    <div id="analysisModal" class="modal" style="display: none;">
      <div class="modal-content-config"> <span class="close-btn" id="closeAnalysisModal">&times;</span>
        <h2>üìä Ph√¢n t√≠ch b√°o c√°o</h2>
        <div id="analysisModalContent" style="max-height: 60vh; overflow-y: auto;">
            <p>ƒêang t·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu...</p>
            <table id="analysisTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead id="analysisTableHeader"> <tr style="background-color: #f0f0f0;">
                        <th style="width: 12%; text-align: center;">Ng√†y</th>
                        <th style="width: 15%; text-align: center;">Ca</th>
                        <th style="width: 43%; text-align: left;">N·ªôi dung B√°o c√°o</th> <th style="width: 30%; text-align: left;">K·∫øt qu·∫£ ph√¢n t√≠ch</th> </tr>
                </thead>
                <tbody id="analysisTableBody">
                    </tbody>
            </table>
        </div>
         <div style="text-align:center; margin-top: 20px;">
            <button id="closeAnalysisModalBottom" style="padding: 8px 20px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">ƒê√≥ng</button>
        </div>
      </div>
    </div>
    <div class="table-container">
    <table id="summaryTable">
      <thead>
        <tr>
          <th>C√°c ch·ªâ s·ªë</th>
          <th id="col-week-total">T·ªïng tu·∫ßn</th>
          <th id="col-week-avg">Trung b√¨nh tu·∫ßn</th>
          <th id="col-month-total">T·ªïng th√°ng</th>
          <th id="col-month-avg">Trung b√¨nh th√°ng</th>
          <th id="col-year-total">T·ªïng nƒÉm</th>
          <th id="col-year-avg">Trung b√¨nh nƒÉm</th>
          <th id="col-period-total" style="display:none;">T·ªïng K·ª≥</th>
          <th id="col-period-avg" style="display:none;">Trung b√¨nh K·ª≥</th>
          <th>Ghi ch√∫</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>ƒêi·ªán (kWh)</td>
          <td id="dien-tong-tuan"></td> <td id="dien-tb-tuan"></td>
          <td id="dien-tong-thang"></td> <td id="dien-tb-thang"></td>
          <td id="dien-tong-nam"></td> <td id="dien-tb-nam"></td>
          <td id="dien-tong-ky" style="display:none;"></td> <td id="dien-tb-ky" style="display:none;"></td>
          <td id="dien-ghichu" rowspan="4"></td> </tr>
        <tr>
          <td>N∆∞·ªõc c·∫•p (m¬≥)</td>
          <td id="nuoc-tong-tuan"></td> <td id="nuoc-tb-tuan"></td>
          <td id="nuoc-tong-thang"></td> <td id="nuoc-tb-thang"></td>
          <td id="nuoc-tong-nam"></td> <td id="nuoc-tb-nam"></td>
          <td id="nuoc-tong-ky" style="display:none;"></td> <td id="nuoc-tb-ky" style="display:none;"></td>
        </tr>
        <tr>
          <td>L∆∞u l∆∞·ª£ng ƒê·∫ßu v√†o (m¬≥)</td>
          <td id="flow_in-tong-tuan"></td> <td id="flow_in-tb-tuan"></td>
          <td id="flow_in-tong-thang"></td> <td id="flow_in-tb-thang"></td>
          <td id="flow_in-tong-nam"></td> <td id="flow_in-tb-nam"></td>
          <td id="flow_in-tong-ky" style="display:none;"></td> <td id="flow_in-tb-ky" style="display:none;"></td>
        </tr>
        <tr>
          <td>L∆∞u l∆∞·ª£ng ƒê·∫ßu ra (m¬≥)</td>
          <td id="flow_out-tong-tuan"></td> <td id="flow_out-tb-tuan"></td>
          <td id="flow_out-tong-thang"></td> <td id="flow_out-tb-thang"></td>
          <td id="flow_out-tong-nam"></td> <td id="flow_out-tb-nam"></td>
          <td id="flow_out-tong-ky" style="display:none;"></td> <td id="flow_out-tb-ky" style="display:none;"></td>
        </tr>
        <tr>
          <td>H√≥a ch·∫•t (Kg)</td>
          <td id="chem-tong-tuan"></td> <td id="chem-tb-tuan"></td>
          <td id="chem-tong-thang"></td> <td id="chem-tb-thang"></td>
          <td id="chem-tong-nam"></td> <td id="chem-tb-nam"></td>
          <td id="chem-tong-ky" style="display:none;"></td> <td id="chem-tb-ky" style="display:none;"></td>
          <td id="chem-ghichu"></td>
        </tr>
        <tr class="chemical-sub-item">
          <td>+ Polymer Anion</td>
          <td id="Polymer Anion-tong-tuan"></td> <td id="Polymer Anion-tb-tuan"></td>
          <td id="Polymer Anion-tong-thang"></td> <td id="Polymer Anion-tb-thang"></td>
          <td id="Polymer Anion-tong-nam"></td> <td id="Polymer Anion-tb-nam"></td>
          <td id="Polymer Anion-tong-ky" style="display:none;"></td> <td id="Polymer Anion-tb-ky" style="display:none;"></td>
          <td></td> </tr>
         <tr class="chemical-sub-item">
          <td>+ PAC</td>
          <td id="PAC-tong-tuan"></td> <td id="PAC-tb-tuan"></td>
          <td id="PAC-tong-thang"></td> <td id="PAC-tb-thang"></td>
          <td id="PAC-tong-nam"></td> <td id="PAC-tb-nam"></td>
          <td id="PAC-tong-ky" style="display:none;"></td> <td id="PAC-tb-ky" style="display:none;"></td>
          <td></td>
        </tr>
         <tr class="chemical-sub-item">
          <td>+ Chlorine</td>
          <td id="Chlorine-tong-tuan"></td> <td id="Chlorine-tb-tuan"></td>
          <td id="Chlorine-tong-thang"></td> <td id="Chlorine-tb-thang"></td>
          <td id="Chlorine-tong-nam"></td> <td id="Chlorine-tb-nam"></td>
          <td id="Chlorine-tong-ky" style="display:none;"></td> <td id="Chlorine-tb-ky" style="display:none;"></td>
          <td></td>
        </tr>
         <tr class="chemical-sub-item">
          <td>+ Polymer Cation</td>
          <td id="Polymer Cation-tong-tuan"></td> <td id="Polymer Cation-tb-tuan"></td>
          <td id="Polymer Cation-tong-thang"></td> <td id="Polymer Cation-tb-thang"></td>
          <td id="Polymer Cation-tong-nam"></td> <td id="Polymer Cation-tb-nam"></td>
          <td id="Polymer Cation-tong-ky" style="display:none;"></td> <td id="Polymer Cation-tb-ky" style="display:none;"></td>
          <td></td>
        </tr>
        </tbody>
      <tbody id="other-chemicals-body"></tbody>
    </table>
    </div>
    <div id="detailsTableContainer" style="display: none; margin-top: 20px;">
            <h4>Chi ti·∫øt theo ng√†y:</h4>
            <div id="detailsScrollWrapper" style="max-height: 250px; overflow-y: auto; border: 1px solid #ccc; position: relative;">
                <table id="detailsTable" style="width: 100%; border-collapse: collapse;">
                    <thead id="detailsTableHeader" style="position: sticky; top: 0; background-color: #f2f2f2; z-index: 1;">
                        <tr>
                            <th style="width: 50px;">STT</th>
                            <th>Ng√†y</th>
                            <th>ƒêi·ªán (kWh)</th>
                            <th>N∆∞·ªõc c·∫•p (m¬≥)</th>
                            <th>L∆∞u l∆∞·ª£ng ƒê·∫ßu v√†o (m¬≥)</th>
                            <th>L∆∞u l∆∞·ª£ng ƒê·∫ßu ra (m¬≥)</th>
                            <th>H√≥a ch·∫•t (Kg)</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody id="detailsTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>

<div id="analysisModal" class="modal" style="display: none;">
      <div class="modal-content-config"> <span class="close-btn" id="closeAnalysisModal">&times;</span>
        <h2>üìä Ph√¢n t√≠ch 7 B√°o c√°o G·∫ßn nh·∫•t</h2>
        <div id="analysisModalContent" style="max-height: 60vh; overflow-y: auto;">
            <p>ƒêang t·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu...</p>
            <table id="analysisTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead id="analysisTableHeader"> <tr style="background-color: #f0f0f0;">
                        <th style="width: 12%; text-align: center;">Ng√†y</th>
                        <th style="width: 15%; text-align: center;">Ca</th>
                        <th style="width: 43%; text-align: left;">N·ªôi dung B√°o c√°o</th> <th style="width: 30%; text-align: left;">K·∫øt qu·∫£ ph√¢n t√≠ch</th> </tr>
                </thead>
                <tbody id="analysisTableBody">
                    </tbody>
            </table>
        </div>
         <div style="text-align:center; margin-top: 20px;">
            <button id="closeAnalysisModalBottom" style="padding: 8px 20px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">ƒê√≥ng</button>
        </div>
      </div>
    </div>

<div id="footer-placeholder"></div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script type="module">
    // --- IMPORT ---
    import { db, onAuth, getRole, showLoading, hideLoading, showSwal } from "./script.js";
    import { collection, getDocs, query, orderBy, where, limit  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { initMenu } from "./menu.js";

    // --- T·∫¢I GIAO DI·ªÜN CHUNG ---
    fetch("menu.html").then(r => r.text()).then(h => document.getElementById("menu-placeholder").innerHTML = h).then(initMenu);
    fetch("modal.html").then(r => r.text()).then(h => document.getElementById("loading-placeholder").innerHTML = h);
    fetch("footer.html").then(r => r.text()).then(h => document.getElementById("footer-placeholder").innerHTML = h);

    // --- THAM CHI·∫æU DOM ---
    const notLogged = document.getElementById("notLogged");
    const content = document.getElementById("pageContent");
    const fromInput = document.getElementById("fromDate");
    const toInput = document.getElementById("toDate");
    const yearSelect = document.getElementById("yearSelect");
    const applyFilterBtn = document.getElementById("applyFilter");
    const filterNote = document.getElementById("filterNote");
    const accuracyWarningDiv = document.getElementById("accuracyWarning");
    const otherChemicalsBody = document.getElementById("other-chemicals-body");
    const footerPlaceholder = document.getElementById("footer-placeholder");

    // üîÅ D√ôNG let cho c√°c ph·∫ßn t·ª≠ c√≥ th·ªÉ g√°n l·∫°i
    let viewDetailsCheckbox = document.getElementById('viewDetailsCheckbox');
    let detailsTableContainer = document.getElementById('detailsTableContainer');
    let detailsTableBody = document.getElementById('detailsTableBody');
    let openAnalysisModalBtn = document.getElementById('openAnalysisModal');
    let analysisModal = document.getElementById('analysisModal');
    let closeAnalysisModalBtn = document.getElementById('closeAnalysisModal');
    let closeAnalysisModalBottomBtn = document.getElementById('closeAnalysisModalBottom');
    let analysisModalContent = document.getElementById('analysisModalContent');
    let analysisTableBody = document.getElementById('analysisTableBody');

    
    // --- BI·∫æN TO√ÄN C·ª§C ---
    let allReportsData = []; // L∆∞u tr·ªØ t·∫•t c·∫£ b√°o c√°o ƒë√£ t·∫£i
    let currentFilter = { from: null, to: null }; // L∆∞u tr·∫°ng th√°i b·ªô l·ªçc ng√†y
    let initialLoad = true; // C·ªù cho l·∫ßn t·∫£i ƒë·∫ßu ti√™n
    const standardChemicals = ['polymer anion', 'pac', 'chlorine', 'polymer cation']; // Chu·∫©n h√≥a t√™n
    let allRulesData = []; // L∆∞u tr·ªØ work_rules
    let allManualJobsData = []; // L∆∞u tr·ªØ manual_jobs

    // --- H√ÄM HELPER ---
    function formatISODate(d) {
      if (!d || !(d instanceof Date)) return ""; // Th√™m ki·ªÉm tra
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
    // ‚≠ê D√ÅN H√ÄM M·ªöI V√ÄO ƒê√ÇY
    function calculatePeriodData(periodType, allReportsData) {
        console.log(`Calculating data for: ${periodType}`);
        let startDate, endDate, startDateStr, endDateStr;
        const now = new Date();

        if (periodType === 'week') {
            startDate = getStartOfWeek(now);
            endDate = getEndOfWeek(now);
        } else if (periodType === 'month') {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        } else { // 'year' or default
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear(), 11, 31);
        }
        startDateStr = formatISODate(startDate);
        endDateStr = formatISODate(endDate);

        // L·ªçc d·ªØ li·ªáu b√°o c√°o
        const periodReports = allReportsData.filter(r => {
            const reportDate = r.reportDate;
            return reportDate && reportDate >= startDateStr && reportDate <= endDateStr;
        });

        // G·ªçi h√†m t√≠nh to√°n
        const summaryData = calculateSummary(periodReports, startDateStr, endDateStr);
        return summaryData;
    }
    // ‚≠ê K·∫æT TH√öC H√ÄM M·ªöI
    // Copy t·ª´ baocao.html
    function formatNumberForDisplay(num, fractionDigits = 1) {
        if (num == null || isNaN(num)) return '';
        // S·ª≠a: Lu√¥n hi·ªÉn th·ªã √≠t nh·∫•t 0 ch·ªØ s·ªë th·∫≠p ph√¢n, t·ªëi ƒëa 'fractionDigits'
        return new Intl.NumberFormat('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: fractionDigits
        }).format(num);
    }
    // Copy t·ª´ baocao.html
    function parseDisplayValue(str) {
        if (!str) return NaN;
        str = String(str).replace(/\./g, '').replace(',', '.').trim();
        const num = parseFloat(str);
        return isNaN(num) ? NaN : num;
    }

    function normalizeChemicalName(name) { return name ? name.toLowerCase().trim() : ""; }

    // ‚≠êÔ∏è H√ÄM M·ªöI: T√≠nh th·ªùi ƒëi·ªÉm k·∫øt th√∫c th·ª±c t·∫ø c·ªßa ca
    function getShiftEndTime(report) {
        if (!report || !report.reportDate || !report.shiftEndTime) return null;
        try {
            const [endH, endM] = report.shiftEndTime.split(':').map(Number);
            const endDate = new Date(report.reportDate + "T00:00:00"); // B·∫Øt ƒë·∫ßu t·ª´ ng√†y b√°o c√°o
            endDate.setHours(endH, endM, 0, 0);
            if (report.isShiftNextDay) { // N·∫øu ca k·∫øt th√∫c v√†o h√¥m sau
                endDate.setDate(endDate.getDate() + 1);
            }
            return endDate;
        } catch (e) {
            console.error("L·ªói t√≠nh shiftEndTime cho:", report, e);
            return null;
        }
    }

    // ‚≠êÔ∏è H√ÄM M·ªöI: L·∫•y ng√†y ƒë·∫ßu tu·∫ßn (Th·ª© 2)
    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay(); // Ch·ªß nh·∫≠t = 0, Th·ª© 2 = 1,...
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // ƒêi·ªÅu ch·ªânh v·ªÅ Th·ª© 2
        return new Date(d.setDate(diff));
    }

    // ‚≠êÔ∏è H√ÄM M·ªöI: L·∫•y ng√†y cu·ªëi tu·∫ßn (Ch·ªß nh·∫≠t)
    function getEndOfWeek(date) {
        const d = new Date(date);
        const startOfWeek = getStartOfWeek(d); // L·∫•y ng√†y ƒë·∫ßu tu·∫ßn (Th·ª© 2)
        startOfWeek.setDate(startOfWeek.getDate() + 6); // C·ªông th√™m 6 ng√†y ra Ch·ªß nh·∫≠t
        return startOfWeek;
    }

    // --- H√ÄM T√çNH TO√ÅN CHI TI·∫æT THEO NG√ÄY ---
    function calculateDailyDetails(periodReports) {
        const dailyData = {}; // { 'YYYY-MM-DD': { date: '...', dien: 0, ..., chemicals: {}, notes: [] } }

        if (!periodReports || periodReports.length === 0) {
            return []; // Tr·∫£ v·ªÅ m·∫£ng r·ªóng n·∫øu kh√¥ng c√≥ b√°o c√°o
        }

        // 1. Nh√≥m c√°c b√°o c√°o theo ng√†y (d·ª±a v√†o reportDate)
        periodReports.forEach(report => {
            const dateStr = report.reportDate;
            if (!dateStr) return; // B·ªè qua n·∫øu kh√¥ng c√≥ ng√†y

            // N·∫øu ch∆∞a c√≥ m·ª•c cho ng√†y n√†y, t·∫°o m·ªõi
            if (!dailyData[dateStr]) {
                dailyData[dateStr] = {
                    date: dateStr,
                    dien: 0, nuoc: 0, flow_in: 0, flow_out: 0,
                    chemicals: {}, // { normalizedName: quantity }
                    notes: new Set(), // D√πng Set ƒë·ªÉ tr√°nh ghi ch√∫ tr√πng l·∫∑p
                    reportsOnDay: [] // L∆∞u t·∫°m c√°c b√°o c√°o c·ªßa ng√†y n√†y
                };
            }
            // Th√™m b√°o c√°o v√†o ng√†y t∆∞∆°ng ·ª©ng
            dailyData[dateStr].reportsOnDay.push(report);
        });

        // 2. T√≠nh to√°n s·ªë li·ªáu t·ªïng h·ª£p cho t·ª´ng ng√†y
        Object.keys(dailyData).forEach(dateStr => {
            const dayInfo = dailyData[dateStr];
            // S·∫Øp x·∫øp c√°c b√°o c√°o trong ng√†y theo gi·ªù b·∫Øt ƒë·∫ßu ca
            const reports = dayInfo.reportsOnDay; // D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c sort s·∫µn t·ª´ fetchReportsForPeriod

            if (reports.length > 0) {
                const firstMeters = reports[0].meters || {}; // Ch·ªâ s·ªë ƒë·∫ßu ca 1
                const lastMeters = reports[reports.length - 1].meters || {}; // Ch·ªâ s·ªë cu·ªëi ca cu·ªëi c√πng trong ng√†y

                // H√†m t√≠nh t·ªïng trong ng√†y (t·ª´ ƒë·∫ßu ca 1 ƒë·∫øn cu·ªëi ca cu·ªëi)
                const calcDailyTotal = (startKey, endKey) => {
                    const startVal = parseFloat(firstMeters[startKey]);
                    const endVal = parseFloat(lastMeters[endKey]);
                    if (!isNaN(startVal) && !isNaN(endVal) && endVal >= startVal) {
                        return endVal - startVal;
                    }
                    // ‚≠ê S·ª≠a: Tr·∫£ v·ªÅ null thay v√¨ 0 khi l·ªói ‚≠ê
                    console.warn(`calcDailyTotal failed for ${startKey}/${endKey} on date ${dayInfo.date}`);
                    return null;
                };

                // T√≠nh t·ªïng ƒëi·ªán (c·ªông 3 pha)
                const dien_bt = calcDailyTotal('dien_bt_dau', 'dien_bt_cuoi');
                const dien_cd = calcDailyTotal('dien_cd_dau', 'dien_cd_cuoi');
                const dien_td = calcDailyTotal('dien_td_dau', 'dien_td_cuoi');
                dayInfo.dien = dien_bt + dien_cd + dien_td;

                dayInfo.nuoc = calcDailyTotal('nuoc_dau', 'nuoc_cuoi');
                dayInfo.flow_in = calcDailyTotal('flow_in_start', 'flow_in_end');
                dayInfo.flow_out = calcDailyTotal('flow_out_start', 'flow_out_end');

                
                // T√≠nh t·ªïng ƒëi·ªán (ch·ªâ c·ªông c√°c gi√° tr·ªã kh√¥ng null)
                dayInfo.dien = [dien_bt, dien_cd, dien_td].reduce((sum, val) => sum + (val === null ? 0 : val), 0);
                // N·∫øu c·∫£ 3 pha ƒë·ªÅu null, t·ªïng ƒëi·ªán c≈©ng l√† null
                if(dien_bt === null && dien_cd === null && dien_td === null) dayInfo.dien = null;

                // ‚≠ê S·ª≠a: Ki·ªÉm tra gi√° tr·ªã null v√† th√™m ghi ch√∫ ‚≠ê
                if (dayInfo.dien === null) dayInfo.notes.add("L·ªói t√≠nh ti√™u th·ª• ƒêi·ªán ng√†y!");
                if (dayInfo.nuoc === null) dayInfo.notes.add("L·ªói t√≠nh Kh·ªëi l∆∞·ª£ng N∆∞·ªõc c·∫•p ng√†y!");
                if (dayInfo.flow_in === null) dayInfo.notes.add("L·ªói t√≠nh Kh·ªëi l∆∞·ª£ng ƒë·ªìng h·ªì V√†o ng√†y!");
                if (dayInfo.flow_out === null) dayInfo.notes.add("L·ªói t√≠nh Kh·ªëi l∆∞·ª£ng ƒë·ªìng h·ªì Ra ng√†y!");

                // --- ‚≠ê TH√äM KH·ªêI C·∫¢NH B√ÅO M·ªöI T·∫†I ƒê√ÇY ‚≠ê ---
                if (dayInfo.dien === 0) dayInfo.notes.add("T·ªïng Ti√™u th·ª• ƒêi·ªán c·∫£ ng√†y b·∫±ng 0!");
                if (dayInfo.nuoc === 0) dayInfo.notes.add("T·ªïng Kh·ªëi l∆∞·ª£ng N∆∞·ªõc c·∫•p c·∫£ ng√†y b·∫±ng 0!");
                if (dayInfo.flow_in === 0) dayInfo.notes.add("T·ªïng Kh·ªëi l∆∞·ª£ng ƒê·ªìng h·ªì ƒë·∫ßu V√†o c·∫£ ng√†y b·∫±ng 0!");
                if (dayInfo.flow_out === 0) dayInfo.notes.add("T·ªïng Kh·ªëi l∆∞·ª£ng ƒê·ªìng h·ªì ƒë·∫ßu Ra c·∫£ ng√†y b·∫±ng 0!");
                // --- K·∫æT TH√öC KH·ªêI C·∫¢NH B√ÅO M·ªöI ---


                // T·ªïng h·ª£p h√≥a ch·∫•t v√† ghi ch√∫ trong ng√†y
                let totalChemDay = 0;
                reports.forEach(report => {
                    // C·ªông d·ªìn h√≥a ch·∫•t
                    (report.chemicals || []).forEach(chem => {
                        const name = normalizeChemicalName(chem.chemicalName);
                        const qty = parseFloat(chem.quantity) || 0;
                        if (name && qty > 0) {
                            dayInfo.chemicals[name] = (dayInfo.chemicals[name] || 0) + qty;
                            totalChemDay += qty;
                        }
                    });
                    // Th√™m ghi ch√∫ n·∫øu c√≥ b·∫•t th∆∞·ªùng
                    if (report.isMeterReset) dayInfo.notes.add("Ph√°t hi·ªán b√°o c√°o Ch·ªâ s·ªë gi·∫£m!");
                    // Ki·ªÉm tra v√≠ d·ª• ch·ªâ s·ªë 0 (c√≥ th·ªÉ th√™m c√°c ki·ªÉm tra kh√°c)
                    if (parseFloat(report.meters?.flow_in_start) === 0 || parseFloat(report.meters?.flow_in_end) === 0) {
                        dayInfo.notes.add("Ph√°t hi·ªán b√°o c√°o Ch·ªâ s·ªë ƒë·ªìng h·ªì b·∫±ng 0!");
                    }
                    // --- ‚≠ê D√ÅN CODE M·ªöI V√ÄO ƒê√ÇY (b√™n trong reports.forEach) ‚≠ê ---
                    const m = report.meters || {};
                    // T√≠nh s·∫£n l∆∞·ª£ng cho ri√™ng ca n√†y
                    const r_flow_in = (parseFloat(m.flow_in_end) - parseFloat(m.flow_in_start));
                    const r_flow_out = (parseFloat(m.flow_out_end) - parseFloat(m.flow_out_start));
                    const r_nuoc = (parseFloat(m.nuoc_cuoi) - parseFloat(m.nuoc_dau));

                    // Ch·ªâ c·∫£nh b√°o n·∫øu t√≠nh to√°n h·ª£p l·ªá (kh√¥ng ph·∫£i NaN) v√† b·∫±ng 0
                    if (!isNaN(r_flow_in) && r_flow_in === 0) dayInfo.notes.add("T·ªïng Kh·ªëi l∆∞·ª£ng ƒë·∫ßu V√†o (ca) b·∫±ng 0!");
                    if (!isNaN(r_flow_out) && r_flow_out === 0) dayInfo.notes.add("T·ªïng Kh·ªëi l∆∞·ª£ng ƒë·∫ßu Ra (ca) b·∫±ng 0!");
                    if (!isNaN(r_nuoc) && r_nuoc === 0) dayInfo.notes.add("T·ªïng Kh·ªëi l∆∞·ª£ng N∆∞·ªõc c·∫•p (ca) b·∫±ng 0!");

                    // T√≠nh ƒëi·ªán cho ri√™ng ca n√†y
                    const r_dien_bt = (parseFloat(m.dien_bt_cuoi) - parseFloat(m.dien_bt_dau));
                    const r_dien_cd = (parseFloat(m.dien_cd_cuoi) - parseFloat(m.dien_cd_dau));
                    const r_dien_td = (parseFloat(m.dien_td_cuoi) - parseFloat(m.dien_td_dau));

                    // T√≠nh t·ªïng, coi NaN l√† 0
                    const r_dien_total = (isNaN(r_dien_bt) ? 0 : r_dien_bt) + 
                                        (isNaN(r_dien_cd) ? 0 : r_dien_cd) + 
                                        (isNaN(r_dien_td) ? 0 : r_dien_td);

                    // Ch·ªâ c·∫£nh b√°o n·∫øu c·∫£ 3 pha ƒë·ªÅu l√† s·ªë h·ª£p l·ªá V√Ä t·ªïng b·∫±ng 0
                    if (!isNaN(r_dien_bt) && !isNaN(r_dien_cd) && !isNaN(r_dien_td) && r_dien_total === 0) {
                        dayInfo.notes.add("T·ªïng Ti√™u th·ª• ƒêi·ªán (ca) b·∫±ng 0!");
                    }
                    // --- ‚≠ê K·∫æT TH√öC CODE M·ªöI ‚≠ê ---
                });
                dayInfo.totalChemicals = totalChemDay; // L∆∞u t·ªïng h√≥a ch·∫•t c·ªßa ng√†y
            }
            delete dayInfo.reportsOnDay; // X√≥a m·∫£ng b√°o c√°o th√¥ sau khi t√≠nh xong
        });

        // 3. Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng th√†nh m·∫£ng v√† s·∫Øp x·∫øp (ng√†y m·ªõi nh·∫•t l√™n ƒë·∫ßu)
        const sortedDetails = Object.values(dailyData).sort((a, b) => b.date.localeCompare(a.date));

        return sortedDetails;
    }
    // --- H√ÄM T√çNH TO√ÅN CH√çNH (ƒê√£ s·ª≠a ƒë·ªÉ c·ªông d·ªìn theo ng√†y) ---
    function calculateSummary(periodReports, periodStartDateStr, periodEndDateStr) {
        console.log("Calculating summary by summing daily details for:", periodStartDateStr, "to", periodEndDateStr);
        showLoading("ƒêang t·ªïng h·ª£p d·ªØ li·ªáu...");
        let summaryData = {
            dien: { total: 0, avg: null }, // Kh·ªüi t·∫°o total = 0
            nuoc: { total: 0, avg: null },
            flow_in: { total: 0, avg: null },
            flow_out: { total: 0, avg: null },
            chemicals: {},
            notes: [],
            daysWithReports: 0,
            isInaccurate: false
        };
        let isInaccurate = false; // V·∫´n d√πng c·ªù n√†y

        if (periodReports.length === 0) {
            hideLoading();
            // Reset totals v·ªÅ null n·∫øu kh√¥ng c√≥ report
            summaryData.dien.total = null;
            summaryData.nuoc.total = null;
            summaryData.flow_in.total = null;
            summaryData.flow_out.total = null;
            return summaryData;
        }

        // --- 1. KI·ªÇM TRA NG√ÄY ƒê·∫¶U/CU·ªêI K·ª≤ C√ì B√ÅO C√ÅO KH√îNG (ƒê·ªÉ set isInaccurate) ---
        const hasReportOnStartDate = periodReports.some(r => r.reportDate === periodStartDateStr);
        const hasReportOnEndDate = periodReports.some(r => r.reportDate === periodEndDateStr);
        if (!hasReportOnStartDate || !hasReportOnEndDate) {
            isInaccurate = true;
            console.warn("Missing reports on start or end date of the period.");
        }
         summaryData.isInaccurate = isInaccurate; // C·∫≠p nh·∫≠t c·ªù

        // --- 2. G·ªåI H√ÄM T√çNH CHI TI·∫æT THEO NG√ÄY ---
        // H√†m n√†y tr·∫£ v·ªÅ m·∫£ng c√°c object, m·ªói object l√† t·ªïng c·ªßa 1 ng√†y
        const dailyDetails = calculateDailyDetails(periodReports);
        summaryData.daysWithReports = dailyDetails.length; // L·∫•y s·ªë ng√†y th·ª±c t·∫ø c√≥ d·ªØ li·ªáu

        // --- 3. C·ªòNG D·ªíN K·∫æT QU·∫¢ T·ª™NG NG√ÄY ---
        let hasDailyError = false; // C·ªù ki·ªÉm tra l·ªói t·ª´ng ng√†y
            dailyDetails.forEach(dayInfo => {
                // ‚≠ê S·ª≠a: Ch·ªâ c·ªông n·∫øu gi√° tr·ªã kh√¥ng ph·∫£i null ‚≠ê
                if (dayInfo.dien !== null) summaryData.dien.total += (dayInfo.dien || 0); else hasDailyError = true;
                if (dayInfo.nuoc !== null) summaryData.nuoc.total += (dayInfo.nuoc || 0); else hasDailyError = true;
                if (dayInfo.flow_in !== null) summaryData.flow_in.total += (dayInfo.flow_in || 0); else hasDailyError = true;
                if (dayInfo.flow_out !== null) summaryData.flow_out.total += (dayInfo.flow_out || 0); else hasDailyError = true;

             // T·ªïng h·ª£p h√≥a ch·∫•t (L·∫•y t·ª´ dailyDetails ƒë·ªÉ nh·∫•t qu√°n)
             for (const chemName in dayInfo.chemicals) {
                 const qty = dayInfo.chemicals[chemName] || 0;
                 if (qty > 0) {
                     if (!summaryData.chemicals[chemName]) {
                         summaryData.chemicals[chemName] = { total: 0, avg: null };
                     }
                     summaryData.chemicals[chemName].total += qty;
                 }
             }
             // T·ªïng h·ª£p ghi ch√∫ t·ª´ t·ª´ng ng√†y
             dayInfo.notes.forEach(note => summaryData.notes.push(note)); // C√≥ th·ªÉ b·ªã tr√πng, d√πng Set n·∫øu mu·ªën unique
        });
        // ‚≠ê S·ª≠a: N·∫øu c√≥ l·ªói ng√†y, ƒë·∫∑t t·ªïng k·ª≥ = null ‚≠ê
        if (hasDailyError) {
            if (summaryData.dien.total === 0 && dailyDetails.some(d => d.dien === null)) summaryData.dien.total = null;
            if (summaryData.nuoc.total === 0 && dailyDetails.some(d => d.nuoc === null)) summaryData.nuoc.total = null;
            if (summaryData.flow_in.total === 0 && dailyDetails.some(d => d.flow_in === null)) summaryData.flow_in.total = null;
            if (summaryData.flow_out.total === 0 && dailyDetails.some(d => d.flow_out === null)) summaryData.flow_out.total = null;
            summaryData.notes.push("C√≥ ng√†y b·ªã l·ªói s·ªë li·ªáu."); // Th√™m ghi ch√∫ chung
        }

         // --- 4. T√çNH TRUNG B√åNH K·ª≤ ---
         const calculateAvg = (total) => {
             // S·ª≠a: Ki·ªÉm tra total > 0 thay v√¨ !== null, v√† days > 0
             if (total > 0 && summaryData.daysWithReports > 0) {
                 return total / summaryData.daysWithReports;
             }
             // N·∫øu total l√† 0 th√¨ trung b√¨nh c≈©ng l√† 0
             if (total === 0 && summaryData.daysWithReports > 0) {
                 return 0;
             }
             return null; // Tr·∫£ v·ªÅ null n·∫øu kh√¥ng t√≠nh ƒë∆∞·ª£c
         };
         summaryData.dien.avg = calculateAvg(summaryData.dien.total);
         summaryData.nuoc.avg = calculateAvg(summaryData.nuoc.total);
         summaryData.flow_in.avg = calculateAvg(summaryData.flow_in.total);
         summaryData.flow_out.avg = calculateAvg(summaryData.flow_out.total);

         // T√≠nh trung b√¨nh h√≥a ch·∫•t
         let totalAllChemicals = 0;
         for (const name in summaryData.chemicals) {
             const total = summaryData.chemicals[name].total;
             summaryData.chemicals[name].avg = calculateAvg(total);
             totalAllChemicals += total;
         }
         summaryData.chemicals.totalAll = { total: totalAllChemicals, avg: calculateAvg(totalAllChemicals) };


        // --- 5. T·ªîNG H·ª¢P GHI CH√ö (L·∫•y unique) ---
        summaryData.notes = [...new Set(summaryData.notes)]; // L·∫•y c√°c ghi ch√∫ unique t·ª´ dailyDetails

        console.log("Calculation result (summed daily):", summaryData);
        hideLoading();
        return summaryData;
    }

    // --- H√ÄM HI·ªÇN TH·ªä (ƒê√£ s·ª≠a l·ªói ID ti·∫øng Vi·ªát/Anh) ---
    function renderCustomPeriod(summaryData, isCustomPeriod) {
        console.log("Rendering summary:", summaryData, "Custom Period:", isCustomPeriod);
        showLoading("ƒêang c·∫≠p nh·∫≠t b·∫£ng...");

        // ‚≠ê S·ª¨A L·ªñI: H√†m t·∫°o ID d√πng ti·∫øng Vi·ªát (tong, tb) ƒë·ªÉ kh·ªõp HTML
        const getCellId = (metric, typeVietnamese, period) => `${metric}-${typeVietnamese}-${period}`; // vd: dien-tong-tuan

        // H√†m c·∫≠p nh·∫≠t √¥ (Gi·ªØ nguy√™n)
        const updateCell = (id, value, fractionDigits = 1) => {
            const cell = document.getElementById(id);
            console.log(`Updating cell: ID=${id}, Value=${value}`);
            if (cell) {
                cell.textContent = formatNumberForDisplay(value, fractionDigits);
            } else {
                 console.warn("Kh√¥ng t√¨m th·∫•y cell ID:", id);
            }
        };

        // --- 1. C·∫¨P NH·∫¨T ƒêI·ªÜN, N∆Ø·ªöC, L∆ØU L∆Ø·ª¢NG (ƒê√É S·ª¨A) ---
        const metrics = ['dien', 'nuoc', 'flow_in', 'flow_out'];
        const periods = ['tuan', 'thang', 'nam', 'ky'];
        // ‚≠ê S·ª¨A L·ªñI: Map gi·ªØa t√™n HTML (Vi·ªát) v√† t√™n data (Anh)
        const typesMap = {
            tong: 'total', // ID HTML 'tong' t∆∞∆°ng ·ª©ng v·ªõi data key 'total'
            tb: 'avg'      // ID HTML 'tb' t∆∞∆°ng ·ª©ng v·ªõi data key 'avg'
        };

        metrics.forEach(metric => {
            periods.forEach(period => {
                // L·∫∑p qua c√°c key ti·∫øng Vi·ªát (tong, tb)
                Object.keys(typesMap).forEach(typeVietnamese => {
                    // L·∫•y t√™n key ti·∫øng Anh t∆∞∆°ng ·ª©ng ƒë·ªÉ ƒë·ªçc data
                    const typeEnglish = typesMap[typeVietnamese];
                    // ƒê·ªçc gi√° tr·ªã t·ª´ summaryData b·∫±ng key ti·∫øng Anh
                    const value = summaryData[metric]?.[typeEnglish] ?? null;
                    // G·ªçi updateCell v·ªõi ID ti·∫øng Vi·ªát
                    updateCell(getCellId(metric, typeVietnamese, period), value, (metric === 'dien' ? 0 : 1));
                });
            });
        });

        // --- 2. C·∫¨P NH·∫¨T H√ìA CH·∫§T (ƒê√É S·ª¨A) ---
        // C·∫≠p nh·∫≠t d√≤ng T·ªïng h√≥a ch·∫•t
        periods.forEach(period => {
             Object.keys(typesMap).forEach(typeVietnamese => {
                 const typeEnglish = typesMap[typeVietnamese];
                 const value = summaryData.chemicals.totalAll?.[typeEnglish] ?? null;
                 updateCell(getCellId('chem', typeVietnamese, period), value);
             });
        });

        // C·∫≠p nh·∫≠t h√≥a ch·∫•t chu·∫©n
        const standardChemicalHtmlNames = ['Polymer Anion', 'PAC', 'Chlorine', 'Polymer Cation'];
        standardChemicalHtmlNames.forEach(htmlName => {
            const normalizedDataName = normalizeChemicalName(htmlName);
             periods.forEach(period => {
                Object.keys(typesMap).forEach(typeVietnamese => {
                    const typeEnglish = typesMap[typeVietnamese];
                    const value = summaryData.chemicals[normalizedDataName]?.[typeEnglish] ?? null;
                    updateCell(getCellId(htmlName, typeVietnamese, period), value);
                });
             });
        });

        // T·∫°o v√† c·∫≠p nh·∫≠t h√≥a ch·∫•t kh√°c
        otherChemicalsBody.innerHTML = '';
        let otherChemicalsHtml = '';
        const sortedChemNames = Object.keys(summaryData.chemicals).sort();

        sortedChemNames.forEach(name => {
            if (name !== 'totalAll' && !standardChemicals.includes(name)) {
                otherChemicalsHtml += `<tr class="chemical-sub-item"><td>+ ${name.charAt(0).toUpperCase() + name.slice(1)}</td>`;
                periods.forEach(period => {
                    Object.keys(typesMap).forEach(typeVietnamese => { // L·∫∑p qua tong, tb
                        const typeEnglish = typesMap[typeVietnamese]; // L·∫•y total, avg
                        const value = summaryData.chemicals[name]?.[typeEnglish] ?? null; // ƒê·ªçc data
                        const displayValue = formatNumberForDisplay(value);
                        const isHidden = (period === 'ky' && !isCustomPeriod) || (period !== 'ky' && isCustomPeriod);
                        // Cell ID v·∫´n d√πng tong/tb (nh∆∞ng kh√¥ng c·∫ßn ID v√¨ t·∫°o ƒë·ªông)
                        otherChemicalsHtml += `<td style="${isHidden ? 'display:none;' : ''}">${displayValue}</td>`;
                    });
                });
                otherChemicalsHtml += `<td></td></tr>`;
            }
        });
        otherChemicalsBody.innerHTML = otherChemicalsHtml;


        // --- 3. C·∫¨P NH·∫¨T GHI CH√ö (Gi·ªØ nguy√™n) ---
        const notesHtml = summaryData.notes.length > 0 ? summaryData.notes.join('<br>') : '';
        const dienGhichuCell = document.getElementById('dien-ghichu');
        if(dienGhichuCell) dienGhichuCell.innerHTML = notesHtml;
        const chemGhichuCell = document.getElementById('chem-ghichu');
        // if(chemGhichuCell) chemGhichuCell.innerHTML = ...;

        // --- 5. HI·ªÇN TH·ªä/·∫®N C·∫¢NH B√ÅO (Gi·ªØ nguy√™n) ---
        accuracyWarningDiv.style.display = summaryData.isInaccurate ? 'block' : 'none';

        hideLoading();
    }

    // ‚≠ê D√ÅN H√ÄM M·ªöI HO√ÄN TO√ÄN N√ÄY V√ÄO
    function renderSummary(weekData, monthData, yearData) {
        console.log("Rendering summary for Week, Month, Year");
        showLoading("ƒêang c·∫≠p nh·∫≠t b·∫£ng...");

        const updateCell = (id, value, fractionDigits = 1) => {
            const cell = document.getElementById(id);
            if (cell) {
                cell.textContent = formatNumberForDisplay(value, fractionDigits);
            } else {
                 console.warn("Kh√¥ng t√¨m th·∫•y cell ID:", id);
            }
        };
        
        const dataMap = {
            'tuan': weekData,
            'thang': monthData,
            'nam': yearData
        };
        const metrics = ['dien', 'nuoc', 'flow_in', 'flow_out'];
        const typesMap = { tong: 'total', tb: 'avg' };
        const periods = ['tuan', 'thang', 'nam']; // Ch·ªâ 3 c·ªôt
        const standardChemicalHtmlNames = ['Polymer Anion', 'PAC', 'Chlorine', 'Polymer Cation'];
        
        // --- 1. C·∫¨P NH·∫¨T ƒêI·ªÜN, N∆Ø·ªöC, L∆ØU L∆Ø·ª¢NG ---
        metrics.forEach(metric => {
            periods.forEach(period => { // l·∫∑p qua tuan, thang, nam
                const periodData = dataMap[period]; // L·∫•y ƒë√∫ng data (weekData, monthData...)
                if (!periodData) return; // S·ª¨A "continue" TH√ÄNH "return"
                Object.keys(typesMap).forEach(typeVietnamese => {
                    const typeEnglish = typesMap[typeVietnamese];
                    const value = periodData[metric]?.[typeEnglish] ?? null;
                    updateCell(`${metric}-${typeVietnamese}-${period}`, value, (metric === 'dien' ? 0 : 1));
                });
            });
        });

        // --- 2. C·∫¨P NH·∫¨T H√ìA CH·∫§T ---
        // C·∫≠p nh·∫≠t d√≤ng T·ªïng h√≥a ch·∫•t
        periods.forEach(period => {
             const periodData = dataMap[period];
             if (!periodData) return; // S·ª¨A "continue" TH√ÄNH "return"
             Object.keys(typesMap).forEach(typeVietnamese => {
                 const typeEnglish = typesMap[typeVietnamese];
                 const value = periodData.chemicals.totalAll?.[typeEnglish] ?? null;
                 updateCell(`chem-${typeVietnamese}-${period}`, value);
             });
        });

        // C·∫≠p nh·∫≠t h√≥a ch·∫•t chu·∫©n
        standardChemicalHtmlNames.forEach(htmlName => {
            const normalizedDataName = normalizeChemicalName(htmlName);
             periods.forEach(period => {
                const periodData = dataMap[period];
                if (!periodData) return; // S·ª¨A "continue" TH√ÄNH "return"
                Object.keys(typesMap).forEach(typeVietnamese => {
                    const typeEnglish = typesMap[typeVietnamese];
                    const value = periodData.chemicals[normalizedDataName]?.[typeEnglish] ?? null;
                    updateCell(`${htmlName}-${typeVietnamese}-${period}`, value);
                });
             });
        });

        // T·∫°o v√† c·∫≠p nh·∫≠t h√≥a ch·∫•t kh√°c (G·ªôp data t·ª´ c·∫£ 3 k·ª≥)
        let allOtherChemNames = new Set();
        [weekData, monthData, yearData].forEach(data => {
            if (data && data.chemicals) {
                Object.keys(data.chemicals).forEach(name => {
                    if (name !== 'totalAll' && !standardChemicals.includes(name)) {
                        allOtherChemNames.add(name);
                    }
                });
            }
        });

        otherChemicalsBody.innerHTML = '';
        let otherChemicalsHtml = '';
        const sortedChemNames = [...allOtherChemNames].sort();

        sortedChemNames.forEach(name => {
            otherChemicalsHtml += `<tr class="chemical-sub-item"><td>+ ${name.charAt(0).toUpperCase() + name.slice(1)}</td>`;
            periods.forEach(period => { // l·∫∑p qua tuan, thang, nam
                const periodData = dataMap[period];
                Object.keys(typesMap).forEach(typeVietnamese => { // L·∫∑p qua tong, tb
                    const typeEnglish = typesMap[typeVietnamese];
                    const value = periodData?.chemicals[name]?.[typeEnglish] ?? null;
                    const displayValue = formatNumberForDisplay(value);
                    otherChemicalsHtml += `<td>${displayValue}</td>`;
                });
            });
            otherChemicalsHtml += `<td></td></tr>`;
        });
        otherChemicalsBody.innerHTML = otherChemicalsHtml;


        // --- 3. C·∫¨P NH·∫¨T GHI CH√ö (L·∫•y c·ªßa nƒÉm) ---
        const notesHtml = yearData?.notes.length > 0 ? yearData.notes.join('<br>') : '';
        const dienGhichuCell = document.getElementById('dien-ghichu');
        if(dienGhichuCell) dienGhichuCell.innerHTML = notesHtml;

        // --- 4. HI·ªÇN TH·ªä C·ªòT (Lu√¥n hi·ªán 3 c·ªôt, ·∫©n 1) ---
        document.querySelectorAll('[id^="col-week"], [id*="-tong-tuan"], [id*="-tb-tuan"]').forEach(el => el.style.display = '');
        document.querySelectorAll('[id^="col-month"], [id*="-tong-thang"], [id*="-tb-thang"]').forEach(el => el.style.display = '');
        document.querySelectorAll('[id^="col-year"], [id*="-tong-nam"], [id*="-tb-nam"]').forEach(el => el.style.display = '');
        document.querySelectorAll('[id^="col-period"], [id*="-tong-ky"], [id*="-tb-ky"]').forEach(el => el.style.display = 'none');

        // --- 5. HI·ªÇN TH·ªä C·∫¢NH B√ÅO (Hi·ªán n·∫øu 1 trong 3 b·ªã) ---
        const isInaccurate = weekData?.isInaccurate || monthData?.isInaccurate || yearData?.isInaccurate;
        accuracyWarningDiv.style.display = isInaccurate ? 'block' : 'none';

        hideLoading();
    }
    // ‚≠ê K·∫æT TH√öC H√ÄM M·ªöI
    // --- H√ÄM HI·ªÇN TH·ªä B·∫¢NG CHI TI·∫æT ---
    function renderDetailsTable(dailyDetails) {
        detailsTableBody.innerHTML = ''; // X√≥a n·ªôi dung c≈©

        if (!dailyDetails || dailyDetails.length === 0) {
            detailsTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt cho k·ª≥ n√†y.</td></tr>';
            return;
        }

        let html = '';
        // Kh√¥ng gi·ªõi h·∫°n s·ªë d√≤ng, CSS s·∫Ω x·ª≠ l√Ω cu·ªôn
        dailyDetails.forEach((dayInfo, index) => {
            const notesString = Array.from(dayInfo.notes).join(', '); // N·ªëi c√°c ghi ch√∫ l·∫°i
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${new Date(dayInfo.date + "T00:00:00").toLocaleDateString('vi-VN')}</td>
                    <td>${formatNumberForDisplay(dayInfo.dien, 0)}</td>
                    <td>${formatNumberForDisplay(dayInfo.nuoc, 1)}</td>
                    <td>${formatNumberForDisplay(dayInfo.flow_in, 1)}</td>
                    <td>${formatNumberForDisplay(dayInfo.flow_out, 1)}</td>
                    <td>${formatNumberForDisplay(dayInfo.totalChemicals, 1)}</td>
                    <td style="text-align: left;">${notesString}</td>
                </tr>
            `;
        });

        detailsTableBody.innerHTML = html;
        // Ph·∫ßn cu·ªôn ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω b·∫±ng CSS (max-height v√† overflow-y: auto) tr√™n div cha
    }

    // --- H√ÄM T·ªîNG H·ª¢P (ƒê√£ ho√†n thi·ªán) ---
    function calculateAndRenderSummary(periodType = 'year', customStartDate = null, customEndDate = null) {
        console.log("Trigger calculateAndRenderSummary for:", periodType);
        showLoading("ƒêang x√°c ƒë·ªãnh k·ª≥ v√† l·ªçc d·ªØ li·ªáu...");

        let startDate, endDate, startDateStr, endDateStr;
        const now = new Date();
        const isCustomPeriod = (periodType === 'custom');

        if (isCustomPeriod) {
        // ∆Øu ti√™n ng√†y ƒë∆∞·ª£c truy·ªÅn v√†o t·ª´ applyDateFilter
        if (customStartDate && customEndDate) {
            startDateStr = customStartDate;
            endDateStr = customEndDate;
        } else {
            // Fallback (d√πng cho l·∫ßn t·∫£i ƒë·∫ßu)
            startDateStr = currentFilter.from;
            endDateStr = currentFilter.to;
        }
        if (!startDateStr || !endDateStr) {
                 hideLoading();
                 return showSwal("info", "Vui l√≤ng ch·ªçn Kho·∫£ng Th·ªùi Gian L·ªçc.");
            }
            startDate = new Date(startDateStr + "T00:00:00");
            endDate = new Date(endDateStr + "T00:00:00");
        } else {
            // T√≠nh cho tu·∫ßn/th√°ng/nƒÉm hi·ªán t·∫°i
            if (periodType === 'week') {
                startDate = getStartOfWeek(now); // Th·ª© 2
                endDate = getEndOfWeek(now);     // Ch·ªß nh·∫≠t
            } else if (periodType === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1); // Ng√†y ƒë·∫ßu th√°ng
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); // Ng√†y cu·ªëi th√°ng
            } else { // year or default
                startDate = new Date(now.getFullYear(), 0, 1); // Ng√†y ƒë·∫ßu nƒÉm
                endDate = new Date(now.getFullYear(), 11, 31); // Ng√†y cu·ªëi nƒÉm
            }
            startDateStr = formatISODate(startDate);
            endDateStr = formatISODate(endDate);
        }

        if (!startDate || !endDate) {
            hideLoading();
            console.error("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh kho·∫£ng th·ªùi gian.");
            return;
        }

        // L·ªçc d·ªØ li·ªáu b√°o c√°o cho k·ª≥ n√†y (D√ôNG reportDate)
        let periodReports;

        // CH·ªà L·ªåC N·∫æU L√Ä K·ª≤ T√ôY CH·ªàNH ('custom')
        // (V√¨ onAuth ƒë√£ t·ª± l·ªçc cho 'week', 'month', 'year' r·ªìi)
        if (isCustomPeriod) {
            console.log("calculateAndRenderSummary: L·ªçc client-side cho k·ª≥ t√πy ch·ªânh...");
            periodReports = allReportsData.filter(r => {
                const reportDate = r.reportDate;
                return reportDate && reportDate >= startDateStr && reportDate <= endDateStr;
            });
        } else {
            // N·∫øu kh√¥ng ph·∫£i 'custom' (v√≠ d·ª• 'week'/'month'/'year' g·ªçi t·ª´ onAuth)
            // th√¨ allReportsData ƒë√£ ƒë∆∞·ª£c l·ªçc s·∫µn b·ªüi calculatePeriodData
            console.log("calculateAndRenderSummary: S·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l·ªçc tr∆∞·ªõc.");
            periodReports = allReportsData; // D√ôNG LU√îN, KH√îNG L·ªåC L·∫†I
        }

        // D·ªÆ LI·ªÜU ƒê√É ƒê∆Ø·ª¢C S·∫ÆP X·∫æP T·ª™ fetchReportsForPeriod


        const summaryData = calculateSummary(periodReports, startDateStr, endDateStr);
        // S·ª¨A TH√ÄNH 'renderCustomPeriod' KHI L√Ä K·ª≤ T√ôY CH·ªàNH
        if (isCustomPeriod) {
            renderCustomPeriod(summaryData, isCustomPeriod); // <--- G·ªåI H√ÄM RENDER ƒê√öNG
        } else {
            // (Ph·∫ßn n√†y hi·ªán kh√¥ng d√πng t·ªõi, v√¨ onAuth g·ªçi renderSummary ri√™ng,
            // nh∆∞ng ƒë·ªÉ ƒë√¢y cho logic ƒë·∫ßy ƒë·ªß n·∫øu b·∫°n g·ªçi 'week'/'month'/'year' sau n√†y)
            console.warn("calculateAndRenderSummary ƒë∆∞·ª£c g·ªçi v·ªõi k·ª≥ kh√¥ng ph·∫£i 'custom'");
            // ƒê·ªÉ tr√°nh l·ªói, ta c√≥ th·ªÉ render n√≥ v√†o c·ªôt 'ky'
            renderCustomPeriod(summaryData, isCustomPeriod);
        }
        // ‚≠ê T√çNH TO√ÅN V√Ä HI·ªÇN TH·ªä B·∫¢NG CHI TI·∫æT (M·ªöI) ‚≠ê
        const dailyDetails = calculateDailyDetails(periodReports);
        renderDetailsTable(dailyDetails);
        // ‚≠ê K·∫æT TH√öC PH·∫¶N M·ªöI ‚≠ê

        // C·∫≠p nh·∫≠t filterNote
        filterNote.textContent = `ƒêang xem th·ªëng k√™ t·ª´ ${startDate.toLocaleDateString('vi-VN')} ƒë·∫øn ${endDate.toLocaleDateString('vi-VN')}`;
        // ‚≠ê TH√äM 4 D√íNG N√ÄY ƒê·ªÇ ·∫®N/HI·ªÜN C·ªòT
        document.querySelectorAll('[id^="col-week"], [id*="-tong-tuan"], [id*="-tb-tuan"]').forEach(el => el.style.display = 'none');
        document.querySelectorAll('[id^="col-month"], [id*="-tong-thang"], [id*="-tb-thang"]').forEach(el => el.style.display = 'none');
        document.querySelectorAll('[id^="col-year"], [id*="-tong-nam"], [id*="-tb-nam"]').forEach(el => el.style.display = 'none');
        document.querySelectorAll('[id^="col-period"], [id*="-tong-ky"], [id*="-tb-ky"]').forEach(el => el.style.display = '');
        hideLoading(); // ƒê·∫£m b·∫£o loading t·∫Øt
    }


    // --- X·ª¨ L√ù B·ªò L·ªåC (ƒê√É S·ª¨A) ---
    async function applyDateFilter() {
        const fromVal = fromInput.value;
        const toVal = toInput.value;
        const yearVal = yearSelect.value;
        initialLoad = false; // ƒê√°nh d·∫•u l√† kh√¥ng c√≤n load l·∫ßn ƒë·∫ßu

        let startDateStr, endDateStr;

        if (yearVal) {
            startDateStr = `${yearVal}-01-01`;
            endDateStr = `${yearVal}-12-31`;
            fromInput.value = ""; toInput.value = "";
        } else if (fromVal && toVal) {
            startDateStr = fromVal;
            endDateStr = toVal;
        } else {
            return showSwal("info", "Vui l√≤ng ch·ªçn NƒÉm ho·∫∑c C·∫£ Ng√†y b·∫Øt ƒë·∫ßu v√† Ng√†y k·∫øt th√∫c.");
        }

        // --- T·ªêI ∆ØU CACHE ---
        let needsFetch = false;
        // currentFilter l∆∞u ph·∫°m vi data ƒëang c√≥ trong 'allReportsData'
        // Ki·ªÉm tra xem cache c√≥ t·ªìn t·∫°i kh√¥ng, v√† ng√†y m·ªõi c√≥ n·∫±m NGO√ÄI cache kh√¥ng
        if (!currentFilter.from || !currentFilter.to || startDateStr < currentFilter.from || endDateStr > currentFilter.to) {
            needsFetch = true;
        }

        try {
            if (needsFetch) {
                console.log("Cache Miss. ƒêang T·∫¢I D·ªÆ LI·ªÜU M·ªöI t·ª´ Firebase...");
                // T·∫£i d·ªØ li·ªáu m·ªõi v√† c·∫≠p nh·∫≠t cache
                allReportsData = await fetchReportsForPeriod(startDateStr, endDateStr);
                currentFilter.from = startDateStr; // C·∫≠p nh·∫≠t ph·∫°m vi cache
                currentFilter.to = endDateStr;
            } else {
                console.log("Cache Hit. D√πng d·ªØ li·ªáu ƒë√£ t·∫£i, ch·ªâ l·ªçc ph√≠a client.");
                // D·ªØ li·ªáu ƒë√£ c√≥ trong allReportsData, kh√¥ng c·∫ßn l√†m g√¨
            }

            // G·ªçi h√†m t√≠nh to√°n cho k·ª≥ t√πy ch·ªânh, truy·ªÅn ng√†y v√†o
            // H√†m n√†y b√¢y gi·ªù s·∫Ω l·ªçc t·ª´ 'allReportsData'
            calculateAndRenderSummary('custom', startDateStr, endDateStr);

        } catch (error) {
            console.error("L·ªói khi √°p d·ª•ng b·ªô l·ªçc:", error);
            showSwal("error", "L·ªói l·ªçc d·ªØ li·ªáu", error.message);
            hideLoading();
        }
        // --- K·∫æT TH√öC T·ªêI ∆ØU ---
    }
    applyFilterBtn.addEventListener("click", applyDateFilter);
    yearSelect.addEventListener("change", () => {
        if(yearSelect.value) { fromInput.value = ""; toInput.value = ""; }
    });
    [fromInput, toInput].forEach(el => {
        el.addEventListener("change", () => { if(yearSelect.value) yearSelect.value = ""; });
    });

    // --- H√ÄM X·ª¨ L√ù KHI M·ªû MODAL PH√ÇN T√çCH (ƒê√£ s·ª≠a logic l·∫•y 7 ng√†y) ---
    async function openAnalysisModalHandler() {
        analysisModal.style.display = "block";
        analysisModalContent.innerHTML = '<p>ƒêang t·∫£i v√† ph√¢n t√≠ch d·ªØ li·ªáu...</p>';
        showLoading("ƒêang t·∫£i d·ªØ li·ªáu 7 ng√†y g·∫ßn nh·∫•t...");

        try {
            // 1. X√°c ƒë·ªãnh kho·∫£ng 7 ng√†y g·∫ßn nh·∫•t
            const today = new Date();
            const endDate = new Date(today); // Ng√†y k·∫øt th√∫c l√† h√¥m nay
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 6); // L√πi l·∫°i 6 ng√†y -> T·ªïng c·ªông 7 ng√†y

            const startDateStr = formatISODate(startDate);
            const endDateStr = formatISODate(endDate);

            console.log(`Analyzing reports from ${startDateStr} to ${endDateStr}`);

            // 2. L·∫•y T·∫§T C·∫¢ b√°o c√°o trong kho·∫£ng 7 ng√†y ƒë√≥
            const reportsQuery = query(
                collection(db, "shift_reports"),
                where("reportDate", ">=", startDateStr),
                where("reportDate", "<=", endDateStr),
                orderBy("reportDate", "desc"), // S·∫Øp x·∫øp s·∫µn ƒë·ªÉ d·ªÖ x·ª≠ l√Ω
                orderBy("shiftStartTime", "desc")
            );
            const reportSnapshot = await getDocs(reportsQuery);
            // L∆∞u t·∫•t c·∫£ b√°o c√°o t√¨m th·∫•y trong 7 ng√†y
            const reportsInPeriod = reportSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 3. L·∫•y d·ªØ li·ªáu Autoplan ((Song song))
            const dataPromises = [];
            if (allRulesData.length === 0) {
                dataPromises.push(getDocs(collection(db, "work_rules")));
            } else {
                dataPromises.push(Promise.resolve(null)); // ƒê·∫©y 1 promise r·ªóng ƒë·ªÉ gi·ªØ v·ªã tr√≠
            }

            if (allManualJobsData.length === 0) {
                dataPromises.push(getDocs(collection(db, "manual_jobs")));
            } else {
                dataPromises.push(Promise.resolve(null)); // ƒê·∫©y 1 promise r·ªóng
            }

            const [rulesSnapshot, manualJobsSnapshot] = await Promise.all(dataPromises);

            if (rulesSnapshot) { // Ch·ªâ g√°n n·∫øu ch√∫ng ta th·ª±c s·ª± ƒë√£ t·∫£i
                allRulesData = rulesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }
            if (manualJobsSnapshot) { // Ch·ªâ g√°n n·∫øu ch√∫ng ta th·ª±c s·ª± ƒë√£ t·∫£i
                allManualJobsData = manualJobsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            // 4. Ph√¢n t√≠ch (H√†m analyzeReports c·∫ßn ƒë∆∞·ª£c s·ª≠a ƒë·ªïi)
            // Truy·ªÅn c·∫£ kho·∫£ng ng√†y ƒë·ªÉ h√†m ph√¢n t√≠ch bi·∫øt ng√†y n√†o b·ªã thi·∫øu
            const analysisResults = analyzeReportsByDate(reportsInPeriod, startDate, endDate, allRulesData, allManualJobsData);

            // 5. Hi·ªÉn th·ªã (H√†m renderAnalysisModal c≈©ng c·∫ßn s·ª≠a)
            renderAnalysisModal(analysisResults);

        } catch (error) {
            console.error("L·ªói khi ph√¢n t√≠ch b√°o c√°o:", error);
            analysisModalContent.innerHTML = `<p style="color:red;">L·ªói: ${error.message}</p>`;
            showSwal("error", "L·ªói ph√¢n t√≠ch", error.message);
        } finally {
            hideLoading();
        }
    }
    // --- H√ÄM HELPER: CHU·∫®N H√ìA VƒÇN B·∫¢N (B·ªè d·∫•u, lowercase) ---
    function normalizeText(str) {
        if (!str) return "";
        return str
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/ƒë/g, "d"); // X·ª≠ l√Ω ch·ªØ 'ƒë'
    }

    // --- H√ÄM HELPER: TR√çCH XU·∫§T T·ª™ KH√ìA ƒê∆†N GI·∫¢N (ƒê√É S·ª¨A) ---
    function extractKeywords(jobName) {
        if (!jobName) return [];
        const normalized = normalizeText(jobName);
        // ‚≠ê B∆Ø·ªöC M·ªöI: Lo·∫°i b·ªè c√°c d·∫•u c√¢u ph·ªï bi·∫øn ‚≠ê
        const cleanedText = normalized.replace(/[.,;()"']/g, ''); // X√≥a .,;()"
        // T√°ch theo kho·∫£ng tr·∫Øng t·ª´ chu·ªói ƒë√£ ƒë∆∞·ª£c l√†m s·∫°ch
        return cleanedText.split(/\s+/).filter(word => word.length > 0);
    }

    // --- H√ÄM HELPER: KI·ªÇM TRA QUY T·∫ÆC AUTOPLAN (C·∫ßn copy t·ª´ autoplan.html n·∫øu ch∆∞a c√≥) ---
    // Gi·∫£ s·ª≠ h√†m getWeekOfMonth(date) v√† ruleMatchesDate(rule, d) ƒë√£ t·ªìn t·∫°i
    // Th√™m helper: ki·ªÉm tra 1 rule c√≥ ph√π h·ª£p v·ªõi ng√†y d kh√¥ng
    function ruleMatchesDate(rule, d) {
        const dayNum = d.getDate();                    // ng√†y trong th√°ng (1..31)
        const monthNum = d.getMonth() + 1;             // th√°ng (1..12)
        const weekOfMonth = getWeekOfMonth(d);         // h√†m b·∫°n ƒë√£ c√≥
        const weekDay = d.getDay() === 0 ? 8 : d.getDay() + 1; // mapping: CN -> 8, T2..T7 -> 2..7

        // Ng√†y c·ª• th·ªÉ trong th√°ng (dom)
        if (rule.dom && rule.dom !== "" && rule.dom !== String(dayNum)) return false;

        // Th·ª©
        if (rule.day && rule.day !== "" && rule.day !== "all") {
            // rule.day c√≥ th·ªÉ l∆∞u l√† string '8' cho CN ho·∫∑c s·ªë kh√°c
            if (Number(rule.day) !== Number(weekDay)) return false;
        }

        // Tu·∫ßn trong th√°ng
        if (rule.week && rule.week !== "" && rule.week !== "all") {
            if (Number(rule.week) !== Number(weekOfMonth)) return false;
        }

        // Th√°ng
        if (rule.month && rule.month !== "" && rule.month !== "all") {
            if (Number(rule.month) !== Number(monthNum)) return false;
        }

        return true;
    }
    //
    function getWeekOfMonth(date) {
        const day = date.getDate();
        return Math.ceil(day / 7);
    }

    // --- H√ÄM PH√ÇN T√çCH THEO NG√ÄY (M·ªöI - Thay th·∫ø analyzeReports) ---
    function analyzeReportsByDate(reportsInPeriod, startDate, endDate, rules, manualJobs) {
        const results = [];
        // Nh√≥m c√°c b√°o c√°o ƒë√£ t·∫£i v·ªÅ theo ng√†y ƒë·ªÉ truy c·∫≠p nhanh
        const reportsByDate = {};
        reportsInPeriod.forEach(r => {
            if (!reportsByDate[r.reportDate]) {
                reportsByDate[r.reportDate] = [];
            }
            reportsByDate[r.reportDate].push(r);
        });

        // L·∫∑p qua 7 ng√†y g·∫ßn nh·∫•t, t·ª´ m·ªõi ƒë·∫øn c≈©
        for (let i = 0; i <= 6; i++) {
            const currentDate = new Date(endDate);
            currentDate.setDate(endDate.getDate() - i);
            const currentDateStr = formatISODate(currentDate);

            // 1. T√¨m c√¥ng vi·ªác d·ª± ki·∫øn cho ng√†y n√†y
            let expectedJobsDetails = [];
            const matchedRules = rules.filter(rule => ruleMatchesDate(rule, currentDate));
            matchedRules.forEach(rule => expectedJobsDetails.push({ name: rule.job || "N/A", keywords: extractKeywords(rule.job) }));
            const matchedManualJobs = manualJobs.filter(job => job.date === currentDateStr);
            matchedManualJobs.forEach(job => expectedJobsDetails.push({ name: job.job || "N/A", keywords: extractKeywords(job.job) }));
            const expectedJobNames = expectedJobsDetails.map(j => j.name); // L·∫•y t√™n ƒë·ªÉ hi·ªÉn th·ªã tooltip

            // 2. T√¨m b√°o c√°o th·ª±c t·∫ø cho ng√†y n√†y
            const actualReports = reportsByDate[currentDateStr] || [];

            if (actualReports.length === 0) {
                // --- TR∆Ø·ªúNG H·ª¢P NG√ÄY B·ªä THI·∫æU B√ÅO C√ÅO ---
                results.push({
                    date: currentDateStr,
                    report: null, // ƒê√°nh d·∫•u l√† thi·∫øu b√°o c√°o
                    expectedJobs: expectedJobNames,
                    notes: "",
                    result: "‚ùå THI·∫æU B√ÅO C√ÅO",
                    containsNegation: false,
                    analysisNote: expectedJobNames.length > 0 ? `D·ª± ki·∫øn c√≥ ${expectedJobNames.length} CV.` : "Kh√¥ng c√≥ CV d·ª± ki·∫øn."
                });
            } else {
                // --- TR∆Ø·ªúNG H·ª¢P NG√ÄY C√ì B√ÅO C√ÅO ---
                // S·∫Øp x·∫øp c√°c b√°o c√°o trong ng√†y theo ca
                actualReports.sort((a, b) => (a.shiftStartTime || "00:00").localeCompare(b.shiftStartTime || "00:00"));

                // Ph√¢n t√≠ch t·ª´ng b√°o c√°o trong ng√†y
                actualReports.forEach(report => {
                    const notes = report.notes || "";
                    const normalizedNotes = normalizeText(notes);
                    const containsNegation = normalizedNotes.includes(" khong ");
                    let score = 0;
                    let maxScore = expectedJobsDetails.length * 2;
                    let matchedKeywordsCount = 0;
                    let analysisNote = "";

                    // So s√°nh v√† t√≠nh ƒëi·ªÉm (Logic gi·ªØ nguy√™n t·ª´ analyzeReports)
                    if (expectedJobsDetails.length === 0) {
                         if(notes.trim()) analysisNote += "C√≥ ghi ch√∫ CV ngo√†i l·ªãch?";
                    } else {
                        expectedJobsDetails.forEach(jobDetail => {
                            let jobScore = 0;
                            if (jobDetail.keywords.length > 0) {
                                let keywordsFound = 0;
                                jobDetail.keywords.forEach(kw => {
                                    if (normalizedNotes.includes(kw)) keywordsFound++;
                                });
                                matchedKeywordsCount += keywordsFound;
                                if (keywordsFound === jobDetail.keywords.length) jobScore = 2;
                                else if (keywordsFound > 0) jobScore = 1;
                            } else {
                                if (normalizedNotes.includes(normalizeText(jobDetail.name))) jobScore = 1;
                            }
                            score += jobScore;
                        });
                    }

                    // ƒê√°nh gi√° k·∫øt qu·∫£ (Logic gi·ªØ nguy√™n)
                    let resultText = "Kh√¥ng x√°c ƒë·ªãnh";
                    if (expectedJobsDetails.length === 0) resultText = "-";
                    else if (maxScore === 0) resultText = score > 0 ? "C√≥ ƒë·ªÅ c·∫≠p?" : "Kh√¥ng ƒë·ªÅ c·∫≠p";
                    else {
                        const percentage = (score / maxScore) * 100;
                        if (percentage >= 80) resultText = "‚úÖ ƒê·∫ßy ƒë·ªß";
                        else if (percentage >= 40) resultText = "‚ö†Ô∏è C√≥ ƒë·ªÅ c·∫≠p / Thi·∫øu";
                        else resultText = "‚ùå Kh√¥ng ƒë·ªÅ c·∫≠p";
                    }
                    if (containsNegation) {
                        resultText += " (C√≥ 'kh√¥ng')";
                        analysisNote = "N·ªôi dung c√≥ ch·ª©a t·ª´ 'kh√¥ng'. C·∫ßn xem x√©t k·ªπ.";
                    } else if (expectedJobsDetails.length > 0 && matchedKeywordsCount === 0 && score === 0) {
                         analysisNote = "Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a n√†o kh·ªõp.";
                    }

                    results.push({
                        date: currentDateStr, // Th√™m ng√†y v√†o k·∫øt qu·∫£
                        report: report, // Gi·ªØ l·∫°i b√°o c√°o g·ªëc
                        expectedJobs: expectedJobNames,
                        notes: notes,
                        result: resultText,
                        containsNegation: containsNegation,
                        analysisNote: analysisNote
                    });
                });
            }
        } // K·∫øt th√∫c v√≤ng l·∫∑p 7 ng√†y

        return results; // M·∫£ng n√†y gi·ªù ch·ª©a c·∫£ b√°o c√°o th·ª±c t·∫ø v√† th√¥ng tin ng√†y thi·∫øu
    }

    // --- H√ÄM HI·ªÇN TH·ªä K·∫æT QU·∫¢ PH√ÇN T√çCH L√äN MODAL (ƒê√£ x·ª≠ l√Ω ng√†y thi·∫øu) ---
    function renderAnalysisModal(analysisResults) {
        // ... (Ph·∫ßn ki·ªÉm tra r·ªóng v√† t√°i t·∫°o b·∫£ng gi·ªØ nguy√™n) ...
        analysisModalContent.innerHTML = `
            <table id="analysisTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                         <th style="width: 12%; text-align: center;">Ng√†y</th>
                         <th style="width: 15%; text-align: center;">Ca</th>
                         <th style="width: 43%; text-align: left;">N·ªôi dung B√°o c√°o</th>
                         <th style="width: 30%; text-align: left;">K·∫øt qu·∫£ ph√¢n t√≠ch</th>
                    </tr>
                </thead>
                <tbody id="analysisTableBody"></tbody>
            </table>`;
        const newTableBody = document.getElementById('analysisTableBody');

        let tableHtml = "";
        analysisResults.forEach(item => {
            const report = item.report;
            const expectedJobsTooltip = item.expectedJobs.length > 0
                ? `CV d·ª± ki·∫øn:\n- ${item.expectedJobs.join('\n- ')}`
                : "Kh√¥ng c√≥ CV d·ª± ki·∫øn";
            const negationClass = item.containsNegation ? "has-negation" : "";

            if (report === null) {
                // --- HI·ªÇN TH·ªä H√ÄNG CHO NG√ÄY B·ªä THI·∫æU (S·ª≠a l·∫°i c√≤n 4 c·ªôt) ---
                tableHtml += `
                    <tr style="background-color: #ffebee;">
                        <td style="text-align: center;">${new Date(item.date + "T00:00:00").toLocaleDateString('vi-VN')}</td>
                        <td style="text-align: center;">-</td>
                        <td style="text-align: left; font-style: italic;">(Kh√¥ng c√≥ b√°o c√°o)</td>
                        <td style="text-align: left;">
                            <span style="font-weight: bold;" title="${expectedJobsTooltip}">${item.result}</span>
                            ${item.analysisNote ? `<br><i style="font-size: 0.9em;">${item.analysisNote}</i>` : ''}
                        </td>
                    </tr>
                `;
            } else {
                // --- HI·ªÇN TH·ªä H√ÄNG CHO NG√ÄY C√ì B√ÅO C√ÅO (S·ª≠a l·∫°i c√≤n 4 c·ªôt) ---
                const shortNotes = item.notes.length > 150 ? item.notes.substring(0, 147) + "..." : item.notes;
                // G·ªôp K·∫øt qu·∫£ v√† Ghi ch√∫ (Logic c≈© ƒë√£ ƒë√∫ng)
                let resultAndNoteHtml = `<span class="${negationClass}" title="${expectedJobsTooltip}">${item.result}</span>`;
                if (item.analysisNote) {
                    resultAndNoteHtml += `<br><i style="font-size: 0.9em;">${item.analysisNote}</i>`;
                }

                tableHtml += `
                    <tr>
                        <td style="text-align: center;">${report.reportDate || "N/A"}</td>
                        <td style="text-align: center;">${report.shiftName || "N/A"}</td>
                        <td style="text-align: left; white-space: pre-wrap;" title="${item.notes}">${shortNotes}</td>
                        <td style="text-align: left; white-space: pre-wrap;">${resultAndNoteHtml}</td>
                    </tr>
                `;
            }
        });

        newTableBody.innerHTML = tableHtml;
    }
    // --- H√ÄM M·ªöI: T·∫£i d·ªØ li·ªáu b√°o c√°o cho m·ªôt kho·∫£ng th·ªùi gian ---
    async function fetchReportsForPeriod(startDateStr, endDateStr) {
        showLoading("ƒêang t·∫£i d·ªØ li·ªáu...");
        try {
            // T·∫°o truy v·∫•n v·ªõi ƒëi·ªÅu ki·ªán where v√† orderBy
            const q = query(
                collection(db, "shift_reports"),
                where("reportDate", ">=", startDateStr), // L·ªõn h∆°n ho·∫∑c b·∫±ng ng√†y b·∫Øt ƒë·∫ßu
                where("reportDate", "<=", endDateStr),   // Nh·ªè h∆°n ho·∫∑c b·∫±ng ng√†y k·∫øt th√∫c
                orderBy("reportDate"),                   // V·∫´n s·∫Øp x·∫øp ƒë·ªÉ t√≠nh to√°n
                orderBy("shiftStartTime")
            );
            const querySnapshot = await getDocs(q);
            const reports = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log(`ƒê√£ t·∫£i ${reports.length} b√°o c√°o cho k·ª≥ ${startDateStr} - ${endDateStr}.`);
            return reports; // Tr·∫£ v·ªÅ m·∫£ng b√°o c√°o ƒë√£ l·ªçc
        } catch (error) {
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu theo k·ª≥:", error);
            showSwal("error", "L·ªói t·∫£i d·ªØ li·ªáu", error.message);
            // Quan tr·ªçng: N√©m l·ªói ra ngo√†i ƒë·ªÉ h√†m g·ªçi n√≥ (onAuth, applyDateFilter) bi·∫øt v√† d·ª´ng l·∫°i
            throw error; // Ho·∫∑c return []; n·∫øu b·∫°n mu·ªën ti·∫øp t·ª•c d√π l·ªói
        } finally {
            // T·∫Øt loading s·∫Ω do h√†m g·ªçi n√≥ (calculateAndRenderSummary) th·ª±c hi·ªán
            // hideLoading(); // Kh√¥ng n√™n g·ªçi ·ªü ƒë√¢y
        }
    }
    // --- H√ÄM CH√çNH KHI ƒêƒÇNG NH·∫¨P (ƒê√É S·ª¨A L·∫†I V·ªä TR√ç LISTENER) ---
  onAuth(async (user) => {
      if (user) {
          notLogged.style.display = "none";
          content.style.display = "block";
          if (footerPlaceholder) footerPlaceholder.style.display = "block";
          let userRole = null; // Khai b√°o userRole ·ªü ph·∫°m vi h√†m onAuth

          // ‚≠ê S·ª¨A L·ªñI: B·ªè 'const' ƒë·ªÉ c·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c ‚≠ê
          openAnalysisModalBtn = document.getElementById('openAnalysisModal');
          analysisModal = document.getElementById('analysisModal'); // <-- C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c
          closeAnalysisModalBtn = document.getElementById('closeAnalysisModal');
          closeAnalysisModalBottomBtn = document.getElementById('closeAnalysisModalBottom');
          analysisModalContent = document.getElementById('analysisModalContent');
          analysisTableBody = document.getElementById('analysisTableBody');
          // C≈©ng b·ªè const cho c√°c bi·∫øn checkbox chi ti·∫øt n·∫øu b·∫°n di chuy·ªÉn ch√∫ng v√†o ƒë√¢y
          viewDetailsCheckbox = document.getElementById('viewDetailsCheckbox');
          detailsTableContainer = document.getElementById('detailsTableContainer');
          // ‚≠ê K·∫æT TH√öC S·ª¨A L·ªñI ‚≠ê

          try {
              // L·∫•y vai tr√≤ ng∆∞·ªùi d√πng TR∆Ø·ªöC
              userRole = await getRole(user.email);

              // --- B·∫ÆT ƒê·∫¶U THAY TH·∫æ T·ª™ ƒê√ÇY ---
              showLoading("ƒêang t·∫£i danh s√°ch nƒÉm...");
              
              // 1. T·∫°o 2 truy v·∫•n (query) si√™u nh·∫π
              const newestReportQuery = query(
                  collection(db, "shift_reports"),
                  orderBy("reportDate", "desc"), // S·∫Øp x·∫øp gi·∫£m d·∫ßn
                  limit(1) // Ch·ªâ l·∫•y 1
              );
              const oldestReportQuery = query(
                  collection(db, "shift_reports"),
                  orderBy("reportDate", "asc"), // S·∫Øp x·∫øp tƒÉng d·∫ßn
                  limit(1) // Ch·ªâ l·∫•y 1
              );

              // 2. Th·ª±c thi 2 truy v·∫•n n√†y song song
              const [newestSnapshot, oldestSnapshot] = await Promise.all([
                  getDocs(newestReportQuery),
                  getDocs(oldestReportQuery)
              ]);

              let years = []; // Kh·ªüi t·∫°o m·∫£ng years r·ªóng

              // 3. X·ª≠ l√Ω k·∫øt qu·∫£ (ch·ªâ khi c·∫£ 2 ƒë·ªÅu c√≥ d·ªØ li·ªáu)
              if (!newestSnapshot.empty && !oldestSnapshot.empty) {
                  const newestDateStr = newestSnapshot.docs[0].data().reportDate;
                  const oldestDateStr = oldestSnapshot.docs[0].data().reportDate;

                  const newestYear = parseInt(newestDateStr.substring(0, 4));
                  const oldestYear = parseInt(oldestDateStr.substring(0, 4));

                  // 4. T·∫°o m·∫£ng 'years' t·ª´ nƒÉm m·ªõi nh·∫•t -> c≈© nh·∫•t
                  for (let y = newestYear; y >= oldestYear; y--) {
                      years.push(y.toString());
                  }
                  // 'years' b√¢y gi·ªù l√† ['2025', '2024', '2023', ...]
              } else {
                  console.log("Kh√¥ng t√¨m th·∫•y b√°o c√°o n√†o trong CSDL.");
              }
              // --- K·∫æT TH√öC PH·∫¶N THAY TH·∫æ ---
              yearSelect.innerHTML = `<option value="">--Ch·ªçn nƒÉm--</option>`; // X√≥a c√°c option c≈© tr∆∞·ªõc khi th√™m
              years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

              let initialStartDateStr, initialEndDateStr;

              // X·ª≠ l√Ω t·∫£i l·∫ßn ƒë·∫ßu (nƒÉm hi·ªán t·∫°i)
              if (initialLoad) {
                  const currentYear = new Date().getFullYear().toString();
                  if (years.includes(currentYear)) {
                      yearSelect.value = currentYear;
                      initialStartDateStr = `${currentYear}-01-01`;
                      const now = new Date();
                      if (now.getFullYear().toString() === currentYear) {
                          initialEndDateStr = formatISODate(now);
                      } else {
                          initialEndDateStr = `${currentYear}-12-31`;
                      }
                  } else if (years.length > 0) { // N·∫øu kh√¥ng c√≥ nƒÉm hi·ªán t·∫°i, l·∫•y nƒÉm m·ªõi nh·∫•t
                      const latestYear = years[0];
                      yearSelect.value = latestYear;
                      initialStartDateStr = `${latestYear}-01-01`;
                      initialEndDateStr = `${latestYear}-12-31`;
                  } else {
                      filterNote.textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu b√°o c√°o n√†o.";
                      hideLoading();
                      return; // D·ª´ng n·∫øu kh√¥ng c√≥ nƒÉm n√†o
                  }

                  // T·∫£i d·ªØ li·ªáu ch·ªâ cho nƒÉm hi·ªán t·∫°i
                  allReportsData = await fetchReportsForPeriod(initialStartDateStr, initialEndDateStr);
                  currentFilter.from = initialStartDateStr;
                  currentFilter.to = initialEndDateStr;

                // === B·∫ÆT ƒê·∫¶U S·ª¨A T·ª™ ƒê√ÇY ===

                // G·ªçi h√†m t√≠nh to√°n 3 L·∫¶N
                const weekData = calculatePeriodData('week', allReportsData);
                const monthData = calculatePeriodData('month', allReportsData);
                const yearData = calculatePeriodData('year', allReportsData);

                // G·ªçi h√†m render m·ªõi (render c·∫£ 3 c·ªôt)
                renderSummary(weekData, monthData, yearData);

                // T√≠nh v√† render b·∫£ng chi ti·∫øt (cho NƒÇM)
                // (allReportsData ƒë√£ ƒë∆∞·ª£c l·ªçc cho c·∫£ nƒÉm)
                const dailyDetailsYear = calculateDailyDetails(allReportsData); 
                renderDetailsTable(dailyDetailsYear);

                initialLoad = false;
                // === K·∫æT TH√öC S·ª¨A ===
            } // K·∫øt th√∫c if(initialLoad)

              // === DI CHUY·ªÇN C√ÅC LISTENER V√ÄO ƒê√ÇY ===

              // --- LISTENER CHO CHECKBOX XEM CHI TI·∫æT ---
              // ƒê·∫£m b·∫£o ch·ªâ g·∫Øn listener M·ªòT L·∫¶N
              if (viewDetailsCheckbox && !viewDetailsCheckbox.dataset.listenerAttached) {
                  viewDetailsCheckbox.addEventListener('change', () => {
                      detailsTableContainer.style.display = viewDetailsCheckbox.checked ? 'block' : 'none';
                  });
                  viewDetailsCheckbox.dataset.listenerAttached = 'true'; // ƒê√°nh d·∫•u ƒë√£ g·∫Øn
              }

              // --- G·∫ÆN S·ª∞ KI·ªÜN CHO MODAL PH√ÇN T√çCH ---
              // ƒê·∫£m b·∫£o ch·ªâ g·∫Øn listener M·ªòT L·∫¶N
              if (openAnalysisModalBtn && userRole === 'admin' && !openAnalysisModalBtn.dataset.listenerAttached) {
                  openAnalysisModalBtn.style.display = 'inline-block'; // Hi·ªán n√∫t
                  openAnalysisModalBtn.addEventListener('click', openAnalysisModalHandler);
                  openAnalysisModalBtn.dataset.listenerAttached = 'true'; // ƒê√°nh d·∫•u ƒë√£ g·∫Øn
              }
              // G·∫Øn listener ƒë√≥ng modal (c√≥ th·ªÉ g·∫Øn nhi·ªÅu l·∫ßn nh∆∞ng kh√¥ng sao)
              if (analysisModal && closeAnalysisModalBtn && closeAnalysisModalBottomBtn) {
                  const closeModal = () => { analysisModal.style.display = "none"; };
                  // Ki·ªÉm tra tr∆∞·ªõc khi g·∫Øn ƒë·ªÉ tr√°nh g·∫Øn l·∫∑p l·∫°i n·∫øu onAuth ch·∫°y l·∫°i
                  if (!closeAnalysisModalBtn.dataset.listenerAttached) {
                     closeAnalysisModalBtn.addEventListener('click', closeModal);
                     closeAnalysisModalBtn.dataset.listenerAttached = 'true';
                  }
                   if (!closeAnalysisModalBottomBtn.dataset.listenerAttached) {
                     closeAnalysisModalBottomBtn.addEventListener('click', closeModal);
                     closeAnalysisModalBottomBtn.dataset.listenerAttached = 'true';
                   }
                  // Listener ƒë√≥ng khi click ngo√†i (an to√†n khi g·∫Øn nhi·ªÅu l·∫ßn)
                  window.addEventListener('click', (event) => {
                      if (event.target == analysisModal) {
                          closeModal();
                      }
                  });
              }
              // === K·∫æT TH√öC DI CHUY·ªÇN LISTENER ===

          } catch (error) {
              console.error("L·ªói khi kh·ªüi t·∫°o ho·∫∑c g·∫Øn listener:", error);
              showSwal("error", "L·ªói kh·ªüi t·∫°o", error.message);
              filterNote.textContent = "L·ªói t·∫£i d·ªØ li·ªáu ho·∫∑c kh·ªüi t·∫°o.";
              hideLoading();
          }
           // hideLoading() n√™n ƒë∆∞·ª£c g·ªçi cu·ªëi c√πng trong calculateAndRenderSummary ho·∫∑c fetchReportsForPeriod

      } else {
          // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p
          notLogged.style.display = "block";
          content.style.display = "none";
          if (footerPlaceholder) footerPlaceholder.style.display = "block";
          // C√≥ th·ªÉ th√™m code reset c√°c bi·∫øn global ·ªü ƒë√¢y n·∫øu c·∫ßn
          allReportsData = [];
          initialLoad = true;
          currentFilter = { from: null, to: null };
          // X√≥a c√°c option nƒÉm c≈©
          if(yearSelect) yearSelect.innerHTML = '<option value="">--Ch·ªçn nƒÉm--</option>';
      }
  }); // <-- ƒê√≥ng h√†m onAuth
  </script>
</body>
</html>
