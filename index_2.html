<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G·ª≠i b√°o c√°o</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* Scrollable container for holiday settings (match statistics.html look) */
    .quota-scroll {
      max-height: calc(5 * 40px + 0px);
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      padding: 0;
      background: #fff;
    }
    .quota-scroll table { margin: 0; width: 100%; border-collapse: collapse; }
    .quota-scroll thead th { position: sticky; top: 0px; background-color: #f0f0f0; z-index: 3; box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1); padding: 8px; border: 1px solid #ccc; }
    .quota-scroll tbody tr td { padding: 8px; border: 1px solid #ccc; }
    .quota-scroll table th:first-child,
    .quota-scroll table td:first-child {
      width: 50px;
      max-width: 50px;
      text-align: center;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="menu-placeholder"></div>
  <div id="loading-placeholder"></div>
  <div id="alert-placeholder"></div>

  <div id="notLogged" style="display:none;">
    ‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.
  </div>

  <div id="pageContent" style="display:none;">
    <div class="form-style-1">          
      <div class="card-body">
        <form id="registrationForm_2" data-collection="reports_2" data-folder-id="1548M2LcAD4FETW65VPDHaHxs-b33HVaq" 
              onsubmit="submitForm(event, this.id, this.dataset.collection, this.dataset.folderId)">
          <div class="form-group form-field">
            <label for="c_ty">T√™n C√¥ng ty:</label>
            <select class="form-control" id="c_ty" name="c_ty" required>
              <option value="" disabled selected>- Ch·ªçn c√¥ng ty -</option>
              <option value="Amicogen">Amicogen</option>
              <option value="·∫§n ƒê·ªô D∆∞∆°ng">·∫§n ƒê·ªô D∆∞∆°ng</option>
              <option value="C√° Vi·ªát Nam">C√° Vi·ªát Nam</option>
              <option value="ƒê·∫°i T√¢y D∆∞∆°ng">ƒê·∫°i T√¢y D∆∞∆°ng</option>
              <option value="NTSF">NTSF</option>
              <option value="Hi·ªáp Ph√∫">Hi·ªáp Ph√∫</option>
              <option value="Honoroad">Honoroad</option>
              <option value="T√¢n C·∫£ng">T√¢n C·∫£ng</option>
              <option value="VNPT">VNPT</option>
              <option value="Petec">Petec</option>
            </select>
          </div>
          <div class="form-group form-field">
            <label for="ngay_nghi">Ng√†y ngh·ªâ:</label>
            <input type="text" class="form-control" placeholder=" Cho ph√©p ch·ªçn nhi·ªÅu ng√†y..." id="ngay_nghi" name="ngay_nghi">
          </div>
          <div class="form-group form-field">
            <label for="ngay_lam_db">Ng√†y l√†m ƒë·∫∑c bi·ªát:</label>
            <input type="text" class="form-control" placeholder=" Ng√†y, th√°ng, nƒÉm ... " id="ngay_lam_db" name="ngay_lam_db">
          </div>
          <div class="form-group form-field">
            <label for="ghi_chu">Ghi ch√∫:</label>
            <textarea class="form-control" placeholder="" id="ghi_chu" name="ghi_chu"></textarea>
          </div>
          <div class="form-group form-field">
            <label for="file">ƒê√≠nh k√®m th√¥ng b√°o</label>
            <input type="file" id="file_2" class="form-control-file" accept="image/*">
          </div>
        </form>
        <br>
        <div class="form-group text-center">
          <button type="submit" class="submit-btn" form="registrationForm_2">G·ª≠i th√¥ng tin</button>
        </div>    
      </div>
    </div>
  </div>

  <div id="defaultHolidaySettings" class="admin-settings" style="display:none;">
    
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
      
      <h3 style="margin: 0;">‚öôÔ∏è C√†i ƒë·∫∑t ng√†y ngh·ªâ m·∫∑c ƒë·ªãnh theo c√¥ng ty</h3>
      
      <button id="saveHolidayConfig">L∆∞u c√†i ƒë·∫∑t ng√†y ngh·ªâ</button>
    </div>
    <div class="quota-scroll">
      <table id="holidaySettingsTable">
        <thead>
          <tr>
            <th>STT</th>
            <th>C√¥ng ty</th>
            <th>Ng√†y ngh·ªâ m·∫∑c ƒë·ªãnh</th>
          </tr>
        </thead>
        <tbody id="holidaySettingsBody"></tbody>
      </table>
    </div>
  </div>
<div id="footer-placeholder"></div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script type="module">
    import { collection, getDocs, addDoc, deleteDoc, doc, query, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { onAuth, addReport, showLoading, hideLoading, showSwal, promptForReAuth, db, getRole, showConfirmSwal} from "./script.js";
    import { initMenu } from "./menu.js";

    let fpNgayLamDB; 
    let userRole = null;
    let companies = [];
    let loggedInUserEmail = null; 


    // ================== LOAD DANH S√ÅCH C√îNG TY ==================
    async function loadCompanies() {
      // ƒê√£ s·ª≠a ƒë·ªÉ l·∫•y t·ª´ reports_1 theo y√™u c·∫ßu c·ªßa b·∫°n
      const snap = await getDocs(collection(db, "reports_1")); 
      const set = new Set();
      snap.forEach(d => {
        const data = d.data();
        // Gi·∫£ ƒë·ªãnh tr∆∞·ªùng t√™n c√¥ng ty l√† 'company' ho·∫∑c 'c_ty'
        if (data.company) set.add(data.company);
        else if (data.c_ty) set.add(data.c_ty); 
      });
      companies = Array.from(set).sort(); // S·∫Øp x·∫øp cho d·ªÖ nh√¨n
      renderHolidaySettings();
    }

    // ================== RENDER GIAO DI·ªÜN ==================
    function renderHolidaySettings() {
      // Logic render giao di·ªán
      const tbody = document.getElementById("holidaySettingsBody");
      tbody.innerHTML = "";
      companies.forEach((c, idx) => {
        tbody.innerHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${c}</td>
            <td>
              <select data-company="${c}" class="holiday-select">
                <option value="none">N/A</option>
                <option value="sat">Th·ª© 7</option>
                <option value="sun">Ch·ªß Nh·∫≠t</option>
                <option value="sat-sun">Th·ª© 7 & CN</option>
              </select>
            </td>
          </tr>
        `;
      });
    }

    // ================== MENU + MODAL ==================
    fetch("menu.html").then(r => r.text()).then(h => {
      document.getElementById("menu-placeholder").innerHTML = h;
      initMenu();
    });
    fetch("modal.html").then(r => r.text()).then(h => {
      document.getElementById("loading-placeholder").innerHTML = h;
    });
    // T·∫¢I FOOTER (th√™m ƒëo·∫°n n√†y v√†o)
    fetch("footer.html").then(r => r.text()).then(h => {
        document.getElementById("footer-placeholder").innerHTML = h;
    });

    const notLogged = document.getElementById("notLogged");
    const content = document.getElementById("pageContent");

    // ================== CHECK LOGIN ==================
    onAuth(user => {
      // Logic check login
      if (user) {
        notLogged.style.display = "none";
        content.style.display = "block";
      } else {
        notLogged.style.display = "block";
        content.style.display = "none";
      }
    });

    // ================== FLATPICKR ==================
    function capitalizeFirstLetter(str) {
      if (!str) return "";
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Logic kh·ªüi t·∫°o flatpickr
      flatpickr("#ngay_nghi", {
        mode: "multiple",
        dateFormat: "Y-m-d",
        maxDate: "today",
      });

      const inputField = document.getElementById('ghi_chu');
      inputField.addEventListener('input', function() {
        inputField.value = capitalizeFirstLetter(inputField.value);
      });

      fpNgayLamDB = flatpickr("#ngay_lam_db", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        allowInput: true,
        disableMobile: "true",
        clickOpens: false
      });

      const ngayLamDBInput = document.getElementById("ngay_lam_db");
      ngayLamDBInput.addEventListener("click", async function (e) {
        e.preventDefault();
        const isVerified = await promptForReAuth();
        if (isVerified) {
          fpNgayLamDB.open();
        } else {
          ngayLamDBInput.blur();
        }
      });
    });

    // ================== SAVE CONFIG (ƒê√É KH·∫ÆC PH·ª§C L·ªñI NGHI√äM TR·ªåNG) ==================
document.getElementById("saveHolidayConfig").addEventListener("click", async () => {
  // 1. CHECK QUY·ªÄN
  if (userRole !== "admin") {
    showSwal("error", "B·∫°n kh√¥ng c√≥ quy·ªÅn!");
    return;
  }

  showLoading("ƒêang x·ª≠ l√Ω c√†i ƒë·∫∑t ng√†y ngh·ªâ m·∫∑c ƒë·ªãnh...");

  let totalErrorList = [];
  const adminEmail = loggedInUserEmail || "admin@gmail.com";
  const newDefaultHolidays = {};
  const selects = document.querySelectorAll(".holiday-select");

  try {
    // L·∫•y config c≈© t·ª´ Firestore
    const ref = doc(db, "settings", "reportConfig");
    const snap = await getDoc(ref);
    const savedConfig = snap.exists() ? (snap.data().defaultHolidays || {}) : {};

    // ============ V√íNG L·∫∂P C√îNG TY ============
    for (const sel of selects) {
      const company = sel.dataset.company;
      const value = sel.value;
      newDefaultHolidays[company] = value; // lu√¥n l∆∞u v√†o config m·ªõi

      // üö® N·∫øu kh√¥ng thay ƒë·ªïi so v·ªõi config c≈© th√¨ b·ªè qua, kh√¥ng ƒë·ª•ng t·ªõi reports_2
      if (savedConfig[company] === value) {
        continue;
      }

      let companyErrorList = [];

      if (value === "none") {
        // X√ìA NG√ÄY NGH·ªà M·∫∂C ƒê·ªäNH
        const q = query(
          collection(db, "reports_2"),
          where("company", "==", company),
          where("isDefaultHoliday", "==", true)
        );
        const snap = await getDocs(q);
        const deletePromises = [];

        snap.forEach(d => {
          deletePromises.push(
            deleteDoc(doc(db, "reports_2", d.id)).catch(e => {
              companyErrorList.push(`L·ªói x√≥a ng√†y ${d.data().ngay_nghi} (${e.message})`);
            })
          );
        });

        await Promise.all(deletePromises);
      } else {
        // SINH NG√ÄY NGH·ªà
        const year = new Date().getFullYear();
        const dates = generateHolidayDates(year, value);

        for (const dateStr of dates) {
          // KI·ªÇM TRA TR√ôNG
          const qHoliday = query(
            collection(db, "reports_2"),
            where("company", "==", company),
            where("ngay_nghi", "==", dateStr)
          );
          const snapHoliday = await getDocs(qHoliday);

          const qSpecial = query(
            collection(db, "reports_2"),
            where("company", "==", company),
            where("ngay_lam_db", "==", dateStr)
          );
          const snapSpecial = await getDocs(qSpecial);

          let existingDoc = null;
          let existingData = null;

          if (!snapHoliday.empty) {
            existingDoc = snapHoliday.docs[0];
            existingData = existingDoc.data();
          } else if (!snapSpecial.empty) {
            existingDoc = snapSpecial.docs[0];
            existingData = existingDoc.data();
          }

          const newRecordData = {
            company,
            ngay_nghi: dateStr,
            isDefaultHoliday: true,
            isSpecialWorkday: false,
            createdAt: new Date(),
            createdBy: adminEmail,
            ghi_chu: "m·∫∑c ƒë·ªãnh"
          };

          if (existingDoc) {
            // TR√ôNG ‚Üí X√ÅC NH·∫¨N GHI ƒê√à
            hideLoading();
            const existingType = existingData.isSpecialWorkday
              ? "Ng√†y l√†m ƒê·∫∑c bi·ªát"
              : (existingData.isDefaultHoliday ? "Ng√†y ngh·ªâ M·∫∑c ƒë·ªãnh" : "Ng√†y ngh·ªâ Th·ªß c√¥ng");

            const isConfirmed = await showConfirmSwal(
              "X√°c nh·∫≠n ghi ƒë√®",
              `[ADMIN] Ng√†y ${dateStr} c·ªßa ${company} ƒë√£ t·ªìn t·∫°i (lo·∫°i: ${existingType}).<br><br>B·∫°n c√≥ mu·ªën ghi ƒë√® b·∫±ng Ng√†y ngh·ªâ M·∫∑c ƒë·ªãnh kh√¥ng?`,
              "C√≥",
              "Kh√¥ng"
            );

            showLoading("ƒêang x·ª≠ l√Ω c√†i ƒë·∫∑t ng√†y ngh·ªâ...");

            if (isConfirmed) {
              try {
                await deleteDoc(doc(db, "reports_2", existingDoc.id));
                await addDoc(collection(db, "reports_2"), newRecordData);
              } catch (e) {
                companyErrorList.push(`L·ªói ghi ƒë√® ng√†y ${dateStr}`);
              }
            }
          } else {
            // KH√îNG TR√ôNG ‚Üí TH√äM M·ªöI
            try {
              await addDoc(collection(db, "reports_2"), newRecordData);
            } catch (e) {
              companyErrorList.push(`L·ªói th√™m m·ªõi ng√†y ${dateStr}`);
            }
          }
        }
      }

      if (companyErrorList.length > 0) {
        totalErrorList.push(`C√¥ng ty ${company}: ${companyErrorList.join(", ")}`);
      }
    }

    // ============ LU√îN L∆ØU CONFIG T·ªîNG ============
    try {
      await setDoc(ref, { defaultHolidays: newDefaultHolidays }, { merge: true });

      if (totalErrorList.length > 0) {
        let errorMsg = `Ho√†n t·∫•t c√†i ƒë·∫∑t v·ªõi m·ªôt s·ªë l·ªói:\n\n${totalErrorList.join("\n")}`;
        showSwal("warning", "C·∫≠p nh·∫≠t ho√†n t·∫•t V·ªöI L·ªñI", { message: errorMsg, timer: 10000, showConfirmButton: true });
      } else {
        showSwal("success", "C·∫≠p nh·∫≠t th√†nh c√¥ng!");
      }
    } catch (e) {
      console.error("L·ªói l∆∞u c·∫•u h√¨nh t·ªïng v√†o Firestore:", e);
      showSwal("error", "C·∫≠p nh·∫≠t C√ì V·∫§N ƒê·ªÄ", { message: e.message, timer: 10000 });
    }
  } catch (error) {
    console.error("L·ªói nghi√™m tr·ªçng trong qu√° tr√¨nh l∆∞u c√†i ƒë·∫∑t:", error);
    showSwal("error", "L·ªói nghi√™m tr·ªçng", { message: error.message, timer: 10000 });
  } finally {
    hideLoading();
  }
});


    // ================== SINH NG√ÄY NGH·ªà ==================
    function generateHolidayDates(year, type) {
      // Logic sinh ng√†y ngh·ªâ
      const dates = [];
      const start = new Date(`${year}-01-01`);
      const end = new Date(`${year}-12-31`);

      let dayIndexes = [];
      if (type === "sat") dayIndexes = [6];
      if (type === "sun") dayIndexes = [0];
      if (type === "sat-sun") dayIndexes = [0, 6];

      let d = new Date(start);
      while (d <= end) {
        if (dayIndexes.includes(d.getDay())) {
          dates.push(d.toISOString().split("T")[0]);
        }
        d.setDate(d.getDate() + 1);
      }
      return dates;
    }

    // ================== CHECK ADMIN ==================
    onAuth(async (user) => {
      console.log("onAuth callback:", user);
      // Logic check admin
      if (!user) {
        userRole = null;
        loggedInUserEmail = null;   // <--- reset khi ch∆∞a login
        document.getElementById("defaultHolidaySettings").style.display = "none";
        return;
      }
      try { userRole = await getRole(user.email); }
      catch(e){ userRole = null; }

      loggedInUserEmail = user.email;  // <--- l∆∞u l·∫°i email user ƒëang ƒëƒÉng nh·∫≠p

      if (userRole === "admin") {
        document.getElementById("defaultHolidaySettings").style.display = "block";
        await loadCompanies();

        // load config ƒë√£ l∆∞u
        const ref = doc(db, "settings", "reportConfig");
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const savedConfig = snap.data().defaultHolidays || {};
          console.log("Saved config:", savedConfig);
          document.querySelectorAll(".holiday-select").forEach(sel => {
            console.log("Company:", sel.dataset.company, "Config value:", savedConfig[sel.dataset.company]);
            const company = sel.dataset.company;
            if (savedConfig[company]) {
              sel.value = savedConfig[company];
            }
          });
        }
      } else {
        document.getElementById("defaultHolidaySettings").style.display = "none";
      }
    });

  </script>
</body>
</html>
