<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nh·∫≠t k√Ω h·ªá th·ªëng</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  
  <style>
    /* C·ªë ƒë·ªãnh layout cho b·∫£ng */
    #logsTable {
      table-layout: fixed;
      width: 100%;
      word-wrap: break-word; /* ƒê·∫£m b·∫£o t·ª´ d√†i nh·∫•t c≈©ng s·∫Ω ƒë∆∞·ª£c xu·ªëng d√≤ng */
    }

    /* Thi·∫øt l·∫≠p ƒë·ªô r·ªông c·ª• th·ªÉ cho t·ª´ng c·ªôt v√† cƒÉn ch·ªânh */
    #logsTable th:nth-child(1), #logsTable td:nth-child(1) { width: 15%; } /* C·ªôt Th·ªùi gian */
    #logsTable th:nth-child(2), #logsTable td:nth-child(2) { width: 15%; } /* C·ªôt Ng∆∞·ªùi d√πng */
    #logsTable th:nth-child(3), #logsTable td:nth-child(3) { width: 20%; } /* C·ªôt H√†nh ƒë·ªông */
    #logsTable th:nth-child(4), #logsTable td:nth-child(4) { width: 50%; } /* C·ªôt Chi ti·∫øt */
    
    /* CƒÉn gi·ªØa ti√™u ƒë·ªÅ v√† cƒÉn tr√°i n·ªôi dung */
    #logsTable th {
      text-align: center;
      background-color: #e8ebf5;
      padding: 12px 8px;
    }
    
    #logsTable td {
      text-align: left;
      padding: 8px;
    }


    /* ƒê·∫£m b·∫£o n·ªôi dung trong c√°c √¥ c√≥ th·ªÉ xu·ªëng d√≤ng */
    #logsTable td {
      white-space: normal !important; /* Ghi ƒë√® c√°c style kh√°c ƒë·ªÉ bu·ªôc xu·ªëng d√≤ng */
      vertical-align: top; /* CƒÉn n·ªôi dung l√™n tr√™n c√πng c·ªßa √¥ cho d·ªÖ ƒë·ªçc */
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      #displayCount {
        font-size: 11px !important;
        padding: 4px !important;
        height: 24px !important;
      }
      
      label[for="displayCount"] {
        font-size: 11px !important;
      }
    }
    
  </style>
  </head>
<body>
  <div id="menu-placeholder"></div>
  
  <div id="notLogged" style="display:none;">
    ‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.
  </div>

  <div id="noPermission" style="display:none;">
    üö´ B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.
  </div>

  <div id="pageContent" style="display:none;">
    <h2>üìú Nh·∫≠t k√Ω h·ªá th·ªëng</h2>
    <div class="card-body"> 

  <div class="filter-box">
    <label>T·ª´ ng√†y: <input type="date" id="startDateInput"></label>
    <label>ƒê·∫øn ng√†y: <input type="date" id="endDateInput"></label>
    <label style="white-space:nowrap;">H√†nh ƒë·ªông:</label>
    <select id="actionFilter"><option value="">--T·∫•t c·∫£--</option></select>
    <label style="white-space:nowrap;">Ng∆∞·ªùi d√πng:</label>
    <select id="userFilter"><option value="">--T·∫•t c·∫£--</option></select>
    <button id="toggleFilterBtn" type="button">√Åp d·ª•ng</button>
  </div>
  <div class="note" id="defaultDateRange" style="font-style: italic; margin-bottom: 10px; color: #444;"></div>
    
    <form>
      <div style="margin-bottom: 12px;">
        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm nh·∫≠t k√Ω..." style="width: 100%; padding: 8px;">
      </div>
        <table id="logsTable">
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>Ng∆∞·ªùi d√πng</th>
              <th>H√†nh ƒë·ªông</th>
              <th>Chi ti·∫øt</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
    </form>
        <div style="text-align: right; margin-top: 10px;">
        <label for="displayCount">Hi·ªÉn th·ªã:</label>
        <select id="displayCount">
            <option value="7">7 d√≤ng</option>
            <option value="20">20 d√≤ng</option>
            <option value="all">To√†n b·ªô</option>
        </select>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script type="module">
    import { initMenu } from "./menu.js";
    import { db, onAuth, getRole } from "./script.js";
    import {
      collection,
      query,
      orderBy,
      where,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // Load menu
    fetch("menu.html")
      .then(r => r.text())
      .then(h => {
        document.getElementById("menu-placeholder").innerHTML = h;
        initMenu();
      });

  const notLogged = document.getElementById("notLogged");
  const noPermission = document.getElementById("noPermission");
  const content = document.getElementById("pageContent");
  const tbody = document.querySelector("#logsTable tbody");
  const searchInput = document.getElementById("searchInput");
  const displayCountSelect = document.getElementById("displayCount");
  const startDateInput = document.getElementById('startDateInput');
  const endDateInput = document.getElementById('endDateInput');
  const actionFilter = document.getElementById('actionFilter');
  const userFilter = document.getElementById('userFilter');
  const toggleFilterBtn = document.getElementById('toggleFilterBtn');

  let allLogs = []; 
  let unsubscribeLogs = null; // store current onSnapshot unsubscribe fn

    const filterAndRenderLogs = (logs, query, limit) => {
        const lowerCaseQuery = query.toLowerCase().trim();
        const filteredLogs = logs.filter(log => {
            const searchContent = [
                log.createdAt?.toDate ? log.createdAt.toDate().toLocaleString() : "",
                log.email,
                log.action,
                log.company,
                log.chi_so,
                log.ngay_ghi,
                log.ghi_chu,
                log.fileId,
                log.error_code,
                log.userAgent,
                log.job,
                log.note,
                log.displayName,
                log.user, 
                log.deletedRule?.job,
                log.deletedJob?.job,
                log.deletedPattern?.displayName
            ].map(field => field ? field.toString().toLowerCase() : "").join(" ");
            
            return searchContent.includes(lowerCaseQuery);
        });
        
        let finalData = filteredLogs;
        if (lowerCaseQuery === "" && limit !== "all") {
            finalData = filteredLogs.slice(0, parseInt(limit));
        }

          tbody.innerHTML = "";
          finalData.forEach(log => {
            const time = log.createdAt?.toDate
                ? log.createdAt.toDate().toLocaleString('vi-VN')
                : "";
            
            // T·ª´ ƒëi·ªÉn chuy·ªÉn ƒë·ªïi action -> ti·∫øng Vi·ªát
            const actionTooltips = {
                // ƒêƒÉng nh·∫≠p & X√°c th·ª±c
                "login_success": "ƒêƒÉng nh·∫≠p th√†nh c√¥ng",
                "login_failure": "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i",
                "logout": "ƒêƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng",

                // Qu·∫£n l√Ω quy t·∫Øc c√¥ng vi·ªác
                "admin_create_work_rule": "Admin t·∫°o quy t·∫Øc c√¥ng vi·ªác m·ªõi",
                "admin_delete_work_rule": "Admin x√≥a quy t·∫Øc c√¥ng vi·ªác",
                "admin_create_manual_job": "Admin t·∫°o c√¥ng vi·ªác th·ªß c√¥ng",
                "admin_delete_manual_job": "Admin x√≥a c√¥ng vi·ªác th·ªß c√¥ng",
                "admin_create_work_pattern": "Admin t·∫°o m·∫´u l·ªãch l√†m vi·ªác",
                "admin_delete_work_pattern": "Admin x√≥a m·∫´u l·ªãch l√†m vi·ªác",
                "apps_script_add_user_success": "Th√™m ng∆∞·ªùi d√πng qua Apps Script th√†nh c√¥ng",

                // B√°o c√°o ca tr·ª±c - Thao t√°c ch√≠nh
                "report_create_success": "T·∫°o b√°o c√°o ca tr·ª±c m·ªõi th√†nh c√¥ng",
                "report_update_success": "C·∫≠p nh·∫≠t b√°o c√°o ca tr·ª±c th√†nh c√¥ng",
                "report_save_failure": "L·ªói khi l∆∞u b√°o c√°o ca tr·ª±c",
                "report_view_existing": "Xem b√°o c√°o ca tr·ª±c hi·ªán c√≥",
                "report_edit_initiated": "B·∫Øt ƒë·∫ßu ch·ªânh s·ª≠a b√°o c√°o ca tr·ª±c",

                // B√°o c√°o ca tr·ª±c - Qu·∫£n l√Ω file
                "report_upload_success": "T·∫£i l√™n file ƒë√≠nh k√®m th√†nh c√¥ng",
                "report_upload_failure": "L·ªói khi t·∫£i l√™n file ƒë√≠nh k√®m",
                "report_delete_success": "X√≥a file ƒë√≠nh k√®m th√†nh c√¥ng",
                "report_delete_failure": "L·ªói khi x√≥a file ƒë√≠nh k√®m",
                "file_creation_success": "T·∫°o file HTML th√†nh c√¥ng",
                "file_creation_failure": "L·ªói khi t·∫°o file HTML",
                "file_creation_connection_error": "L·ªói k·∫øt n·ªëi khi t·∫°o file HTML",

                // Qu·∫£n l√Ω ca l√†m vi·ªác
                "admin_create_shift_success": "Admin t·∫°o ca l√†m vi·ªác m·ªõi th√†nh c√¥ng",
                "admin_create_shift_failure": "L·ªói khi Admin t·∫°o ca l√†m vi·ªác m·ªõi",
                "admin_delete_shift_success": "Admin x√≥a ca l√†m vi·ªác th√†nh c√¥ng",
                "admin_delete_shift_failure": "L·ªói khi Admin x√≥a ca l√†m vi·ªác",

                // Qu·∫£n l√Ω d·ªØ li·ªáu ch·ªâ s·ªë
                "indicator_entry": "Nh·∫≠p li·ªáu ch·ªâ s·ªë m·ªõi",
                "indicator_edit": "Ch·ªânh s·ª≠a ch·ªâ s·ªë",
                "indicator_delete": "X√≥a ch·ªâ s·ªë",

                // Qu·∫£n l√Ω file & t√†i li·ªáu
                "file_upload": "T·∫£i l√™n file m·ªõi",
                "file_download": "T·∫£i xu·ªëng file",
                "file_delete": "X√≥a file",
                "file_rename": "ƒê·ªïi t√™n file",
                
                // Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                "user_role_update": "C·∫≠p nh·∫≠t quy·ªÅn ng∆∞·ªùi d√πng",
                "user_profile_update": "C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n",
                "user_password_change": "Thay ƒë·ªïi m·∫≠t kh·∫©u",
                "user_disable": "V√¥ hi·ªáu h√≥a t√†i kho·∫£n",
                "user_enable": "K√≠ch ho·∫°t t√†i kho·∫£n",

                // C·∫•u h√¨nh h·ªá th·ªëng
                "system_config_update": "C·∫≠p nh·∫≠t c·∫•u h√¨nh h·ªá th·ªëng",
                "backup_created": "T·∫°o b·∫£n sao l∆∞u d·ªØ li·ªáu",
                "restore_completed": "Kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ b·∫£n sao l∆∞u"
            };
            
            let details = "";            switch (log.action) {
                case "login_success":
                    details = `ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Thi·∫øt b·ªã: ${log.userAgent || "N/A"}`;
                    break;
                case "login_failure":
                    details = `L·ªói ƒëƒÉng nh·∫≠p: ${log.error_code || "N/A"}. Thi·∫øt b·ªã: ${log.userAgent || "N/A"}`;
                    break;
                case "logout":
                    details = `ƒêƒÉng xu·∫•t th√†nh c√¥ng.`;
                    break;
                case "admin_create_work_rule":
                    details = `
                        <b>C√¥ng vi·ªác:</b> ${log.job || "N/A"}<br>
                        <b>Ng√†y c·ª• th·ªÉ:</b> ${log.date || "-"}<br>
                        <b>Ghi ch√∫:</b> ${log.note || "-"}
                    `;
                    break;
                case "admin_delete_work_rule":
                    details = `ƒê√£ x√≥a quy t·∫Øc: <b>${log.deletedRule?.job || "N/A"}</b>`;
                    break;
                case "admin_create_manual_job":
                    details = `
                        <b>C√¥ng vi·ªác:</b> ${log.job || "N/A"}<br>
                        <b>Ng√†y:</b> ${log.date || "N/A"}<br>
                        <b>Ghi ch√∫:</b> ${log.note || "-"}
                    `;
                    break;
                case "admin_delete_manual_job":
                    details = `ƒê√£ x√≥a c√¥ng vi·ªác th·ªß c√¥ng: <b>${log.deletedJob?.job || "N/A"}</b>`;
                    break;
                case "admin_create_work_pattern":
                    details = `
                        <b>T√™n hi·ªÉn th·ªã:</b> ${log.displayName || "N/A"}<br>
                        <b>Nh√¢n vi√™n:</b> ${log.user || "N/A"}<br>
                        <b>Lo·∫°i:</b> ${log.type || "N/A"}<br>
                        <b>Ng√†y Bƒê:</b> ${log.patternStartDate || "N/A"}
                    `;
                    break;
                case "admin_delete_work_pattern":
                    details = `ƒê√£ x√≥a quy t·∫Øc c·ªßa: <b>${log.deletedPattern?.displayName || "N/A"}</b>`;
                    break;
                case "apps_script_add_user_success":
                    details = `G·ª≠i y√™u c·∫ßu Apps Script th√†nh c√¥ng cho: <b>${log.targetUser || "N/A"}</b>`;
                    break;
                // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è B·∫ÆT ƒê·∫¶U KH·ªêI CODE C·∫¶N D√ÅN ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è

                // --- B√ÅO C√ÅO CA TR·ª∞C (H√ÄNH ƒê·ªòNG) ---
                case "report_create_success":
                case "report_update_success":
                    details = `
                        <b>ReportID:</b> ${log.reportId || "N/A"}<br>
                        <b>Ng√†y:</b> ${log.date || "N/A"}<br>
                        <b>Ca:</b> ${log.shift || "N/A"}<br>
                        <b>Ng∆∞·ªùi nh·∫≠n ca:</b> ${log.receivingStaff ? log.receivingStaff.join(', ') : "N/A"}
                    `;
                    break;
                case "report_save_failure":
                    details = `
                        <b>ReportID:</b> ${log.reportId || "N/A"}<br>
                        <b style="color:red;">L·ªói:</b> ${log.error || "N/A"}<br>
                        <b>C√≥ file m·ªõi:</b> ${log.hasNewFiles ? "C√≥" : "Kh√¥ng"}
                    `;
                    break;
                case "report_view_existing":
                case "report_edit_initiated":
                    details = `
                        <b>ReportID:</b> ${log.reportId || "N/A"}<br>
                        <b>Ng√†y:</b> ${log.date || "N/A"}<br>
                        <b>Ca:</b> ${log.shift || "N/A"}
                    `;
                    break;

                // --- B√ÅO C√ÅO CA TR·ª∞C (QU·∫¢N L√ù FILE) ---
                case "report_upload_success":
                    details = `
                        <b>File:</b> ${log.file || "N/A"}<br>
                        <b>FileID:</b> ${log.fileId || "N/A"}
                    `;
                    break;
                case "report_upload_failure":
                    details = `
                        <b>File:</b> ${log.file || "N/A"}<br>
                        <b style="color:red;">L·ªói:</b> ${log.error || "N/A"}
                    `;
                    break;
                case "report_delete_success":
                    details = `<b>ƒê√£ x√≥a FileID:</b> ${log.fileId || "N/A"}`;
                    break;
                case "report_delete_failure":
                    details = `
                        <b>FileID:</b> ${log.fileId || "N/A"}<br>
                        <b style="color:red;">L·ªói x√≥a:</b> ${log.error || "N/A"}
                    `;
                    break;
                case "file_creation_success":
                    details = `
                        <b>ReportID:</b> ${log.reportId || "N/A"}<br>
                        <b>FileID (HTML):</b> ${log.fileId || "N/A"}
                    `;
                    break;
                case "file_creation_failure":
                case "file_creation_connection_error":
                     details = `
                        <b>ReportID:</b> ${log.reportId || "N/A"}<br>
                        <b style="color:red;">L·ªói t·∫°o file HTML:</b> ${log.error || "N/A"}
                    `;
                    break;

                // --- ADMIN QU·∫¢N L√ù CA ---
                case "admin_create_shift_success":
                    details = `
                        <b>ShiftID:</b> ${log.shiftId || "N/A"}<br>
                        <b>T√™n ca:</b> ${log.shiftName || "N/A"}<br>
                        <b>Th·ªùi gian:</b> ${log.time || "N/A"}
                    `;
                    break;
                case "admin_create_shift_failure":
                    details = `
                        <b>T√™n ca:</b> ${log.shiftName || "N/A"}<br>
                        <b style="color:red;">L·ªói:</b> ${log.error || "N/A"}
                    `;
                    break;
                case "admin_delete_shift_success":
                    details = `
                    <b>ShiftID:</b> ${log.shiftId || "N/A"}<br>    
                    <b>ƒê√£ x√≥a ca:</b> ${log.shiftName || "N/A"}<br>  
                    <b>Th·ªùi gian:</b> ${log.time || "N/A"}    
                    `;
                    break;
                case "admin_delete_shift_failure":
                    details = `
                    <b>ShiftID:</b> ${log.shiftId || "N/A"}<br>    
                    <b>T√™n ca:</b> ${log.shiftName || "N/A"}<br>   
                    <b style="color:red;">L·ªói:</b> ${log.error || "N/A"}
                    `;
                    break;

                default:
                    details = `
                        ${log.company ? "<b>Cty:</b> " + log.company + "<br>" : ""}
                        ${log.chi_so ? "<b>Ch·ªâ s·ªë:</b> " + log.chi_so + "<br>" : ""}
                        ${log.ngay_ghi ? "<b>Ng√†y ghi:</b> " + log.ngay_ghi + "<br>" : ""}
                        ${log.ghi_chu ? "<b>N·ªôi dung:</b> " + log.ghi_chu + "<br>" : ""}
                        ${log.fileId ? "<b>FileId:</b> " + log.fileId + "<br>" : ""}
                        ${log.fileUrl ? `<a href="${log.fileUrl}" target="_blank">Xem file</a>` : ""}
                    `;
                    break;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${time}</td>
                <td>${log.email || ""}</td>
                <td title="${actionTooltips[log.action] || log.action || ""}">${log.action || ""}</td>
                <td>${details.trim() ? details : 'Kh√¥ng c√≥ chi ti·∫øt'}</td>
            `;
            tbody.appendChild(tr);
        });
    };

    onAuth(async user => {
      if (user) {
        const role = await getRole(user.email);
        if (role === "admin") {
          notLogged.style.display = "none";
          noPermission.style.display = "none";
          content.style.display = "block";
          
          // helper: build query based on date inputs
          function buildLogsQuery() {
            const coll = collection(db, "logs");
            const startVal = startDateInput.value;
            const endVal = endDateInput.value;
            const clauses = [];
            
            // Ng√†y b·∫Øt ƒë·∫ßu: n·∫øu kh√¥ng c√≥ th√¨ l·∫•y 1/1 c·ªßa nƒÉm hi·ªán t·∫°i
            const currentYear = new Date().getFullYear();
            const startDate = startVal ? 
              new Date(startVal + 'T00:00:00') : 
              new Date(currentYear, 0, 1, 0, 0, 0); // 1/1 nƒÉm hi·ªán t·∫°i
            clauses.push(where('createdAt', '>=', startDate));
            
            // Ng√†y k·∫øt th√∫c: n·∫øu kh√¥ng c√≥ th√¨ l·∫•y ng√†y hi·ªán t·∫°i
            const endDate = endVal ? 
              new Date(endVal + 'T23:59:59') : 
              new Date(new Date().setHours(23, 59, 59, 999)); // ng√†y hi·ªán t·∫°i 23:59:59
            clauses.push(where('createdAt', '<=', endDate));
            // Filter by action and user if selected (use server-side where when possible)
            const actionVal = actionFilter ? actionFilter.value : '';
            const userVal = userFilter ? userFilter.value : '';
            if (actionVal) {
              clauses.push(where('action', '==', actionVal));
            }
            if (userVal) {
              clauses.push(where('email', '==', userVal));
            }
            // Always order by createdAt desc
            if (clauses.length > 0) {
              return query(coll, ...clauses, orderBy('createdAt', 'desc'));
            }
            return query(coll, orderBy('createdAt', 'desc'));
          }

          // Refresh realtime listener safely
          function refreshLogsListener() {
            // validate date range
            if (startDateInput.value && endDateInput.value) {
              const s = new Date(startDateInput.value + 'T00:00:00');
              const e = new Date(endDateInput.value + 'T23:59:59');
              if (s > e) {
                Swal.fire('L·ªói', 'Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng ng√†y k·∫øt th√∫c.', 'error');
                return;
              }
            }

            if (typeof unsubscribeLogs === 'function') {
              try { unsubscribeLogs(); } catch (err) { /* ignore */ }
              unsubscribeLogs = null;
            }

            const q = buildLogsQuery();
            unsubscribeLogs = onSnapshot(q, (snapshot) => {
              allLogs = snapshot.docs.map(doc => ({...doc.data(), id: doc.id }));
              populateFilterOptions(allLogs);
              filterAndRenderLogs(allLogs, searchInput.value, displayCountSelect.value);
            });
          }

          // initial listener
          refreshLogsListener();

          // Populate selects helper (unique actions and emails)
          function populateFilterOptions(logs) {
            if (!Array.isArray(logs)) return;
            const actions = new Set();
            const users = new Set();
            logs.forEach(l => {
              if (l.action) actions.add(l.action);
              if (l.email) users.add(l.email);
            });
            // clear existing but keep empty option
            if (actionFilter) {
              const prev = actionFilter.value;
              actionFilter.innerHTML = '<option value="">--T·∫•t c·∫£--</option>' + Array.from(actions).sort().map(a => `<option value="${a}">${a}</option>`).join('');
              if (Array.from(actions).includes(prev)) actionFilter.value = prev;
            }
            if (userFilter) {
              const prevU = userFilter.value;
              userFilter.innerHTML = '<option value="">--T·∫•t c·∫£--</option>' + Array.from(users).sort().map(u => `<option value="${u}">${u}</option>`).join('');
              if (Array.from(users).includes(prevU)) userFilter.value = prevU;
            }
          }
          // H√†m c·∫≠p nh·∫≠t text hi·ªÉn th·ªã kho·∫£ng th·ªùi gian
          function updateDateRangeText() {
            const defaultSpan = document.getElementById('defaultDateRange');
            const startVal = startDateInput.value;
            const endVal = endDateInput.value;
            const currentYear = new Date().getFullYear();
            
            let startText = startVal ? new Date(startVal).toLocaleDateString('vi-VN') : `1/1/${currentYear}`;
            let endText = endVal ? new Date(endVal).toLocaleDateString('vi-VN') : new Date().toLocaleDateString('vi-VN');
            
            if (!startVal || !endVal) {
              defaultSpan.textContent = `ƒêang xem d·ªØ li·ªáu t·ª´ ${startText} ƒë·∫øn ${endText}`;
            } else {
              defaultSpan.textContent = `ƒêang xem d·ªØ li·ªáu t·ª´ ${startText} ƒë·∫øn ${endText}`;
            }
          }

          // C·∫≠p nh·∫≠t text khi trang load v√† khi gi√° tr·ªã thay ƒë·ªïi
          updateDateRangeText();
          startDateInput.addEventListener('change', updateDateRangeText);
          endDateInput.addEventListener('change', updateDateRangeText);

          // wire up toggle button (√Åp d·ª•ng <-> B·ªè l·ªçc)
          // initial state: not active
          if (toggleFilterBtn) toggleFilterBtn.dataset.active = 'false';

          toggleFilterBtn.addEventListener('click', () => {
            const isActive = toggleFilterBtn.dataset.active === 'true';
            if (isActive) {
              // Clear filters (behave like previous "X√≥a")
              startDateInput.value = '';
              endDateInput.value = '';
              if (actionFilter) actionFilter.value = '';
              if (userFilter) userFilter.value = '';
              toggleFilterBtn.dataset.active = 'false';
              toggleFilterBtn.textContent = '√Åp d·ª•ng';
              toggleFilterBtn.style.background = '#3498db';
              // refresh to listener without filters
              refreshLogsListener();
            } else {
              // Apply current filter values
              // validate date range
              if (startDateInput.value && endDateInput.value) {
                const s = new Date(startDateInput.value + 'T00:00:00');
                const e = new Date(endDateInput.value + 'T23:59:59');
                if (s > e) {
                  Swal.fire('L·ªói', 'Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng ng√†y k·∫øt th√∫c.', 'error');
                  return;
                }
              }
              toggleFilterBtn.dataset.active = 'true';
              toggleFilterBtn.textContent = 'B·ªè l·ªçc';
              // change color to indicate active filter (neutral)
              toggleFilterBtn.style.background = '#777';
              // refresh listener with current filters
              refreshLogsListener();
            }
          });

          // Note: selects (action/user) do NOT auto-apply; user must click √Åp d·ª•ng to activate filters.

          searchInput.addEventListener("input", () => {
            filterAndRenderLogs(allLogs, searchInput.value, displayCountSelect.value);
          });

          displayCountSelect.addEventListener("change", () => {
            filterAndRenderLogs(allLogs, searchInput.value, displayCountSelect.value);
          });

        } else {
          notLogged.style.display = "none";
          noPermission.style.display = "block";
          content.style.display = "none";
        }
      } else {
        notLogged.style.display = "block";
        noPermission.style.display = "none";
        content.style.display = "none";
      }
    });

  </script>
</body>
</html>
