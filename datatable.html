<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·∫£ng d·ªØ li·ªáu</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    /* üÜï CSS C·ªê ƒê·ªäNH CHI·ªÄU R·ªòNG CHO C·ªòT STT */
    #dataTable th:first-child,
    #dataTable td:first-child {
        width: 50px;
        min-width: 50px;
        max-width: 50px; 
    }
    
    #dataTable th,
    #dataTable td {
        text-align: center;
        vertical-align: middle;
        padding: 8px;
    }

    .admin-only {
        display: none;
    }

    .admin-visible {
        display: table-cell !important;
    }
    /* üÜï CSS M·ªöI CHO C√ÅC CONTROLS D∆Ø·ªöI B·ªò L·ªåC CH√çNH */
    .controls-row {
        display: flex;
        justify-content: space-between; /* ƒê·∫©y c√°c nh√≥m ƒëi·ªÅu khi·ªÉn ra hai ph√≠a */
        align-items: center; /* CƒÉn ch·ªânh theo chi·ªÅu d·ªçc */
        margin-top: 10px;
        margin-bottom: 10px; /* Th√™m kho·∫£ng c√°ch v·ªõi b·∫£ng b√™n d∆∞·ªõi */
    }

    .left-controls {
        display: flex;
        align-items: center;
        gap: 15px; /* Kho·∫£ng c√°ch gi·ªØa checkbox v√† ghi ch√∫ l·ªçc */
    }

    .right-controls {
        display: flex;
        align-items: center;
    }
    
    /* RESPONSIVE MOBILE */
    @media (max-width: 768px) {
      /* C·ªôt H√†nh ƒë·ªông (c·ªôt 9 - admin-only) */
      #dataTable th:nth-child(9),
      #dataTable td:nth-child(9) {
        width: 65px !important;
        min-width: 65px !important;
        max-width: 65px !important;
        padding: 2px !important;
        overflow: hidden !important;
      }
      
      /* N√∫t X√≥a trong c·ªôt H√†nh ƒë·ªông */
      #dataTable td:nth-child(9) button {
        font-size: 11px !important;
        padding: 4px 6px !important;
        width: 100% !important;
        max-width: 51px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: clip !important;
      }
    }
  </style>
</head>
<body>
  <div id="menu-placeholder"></div>
  <div id="loading-placeholder"></div>
  <div id="alert-placeholder"></div>

  <div id="notLogged" style="display:none;">
    ‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.
  </div>

  <div id="pageContent" style="display:none;">
    <h2>üìä B·∫£ng d·ªØ li·ªáu b√°o c√°o ch·ªâ s·ªë ƒë·ªìng h·ªì</h2>
    <div class="card-body">

    <div class="filter-box">
      <label>T·ª´ ng√†y: <input type="date" id="fromDate"></label>
      <label>ƒê·∫øn ng√†y: <input type="date" id="toDate"></label>
      <label>NƒÉm nhanh:
        <select id="yearSelect">
          <option value="">--Ch·ªçn nƒÉm--</option>
        </select>
      </label>
      <button id="applyFilter" type="button">√Åp d·ª•ng</button>
    </div>
    <div class="note" id="filterNote"></div>
      <form>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm...">
    </div>
        <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>STT</th>
              <th class="admin-only">Ng∆∞·ªùi g·ª≠i</th>
              <th>C√¥ng ty</th>
              <th>Ch·ªâ s·ªë</th>
              <th>Ng√†y ghi</th>
              <th>Ghi ch√∫</th>
              <th>File</th>
              <th class="admin-only">Th·ªùi gian</th>
              <th class="admin-only">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
      </form>
      <div class="controls-row">
        <div class="left-controls">
          <label><input type="checkbox" id="meterResetFilter"> Ch·ªâ xem Ng√†y ch·ªâ s·ªë ƒë·∫∑c bi·ªát</label>
        </div>
        <div class="right-controls">
          <label for="displayCount">Hi·ªÉn th·ªã:</label>
          <select id="displayCount">
              <option value="7">7 d√≤ng</option>
              <option value="20">20 d√≤ng</option>
              <option value="all">To√†n b·ªô</option>
          </select>
        </div>
      </div>
    </div>
<div id="footer-placeholder"></div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script type="module">
    // === 1. IMPORT (ƒê√É S·ª¨A L·ªñI) ===
    
    // Import c√°c h√†m T√ôY CH·ªàNH (custom helpers) t·ª´ file script.js
    import { auth, onAuth, deleteReport, getRole, showLoading, hideLoading, showSwal, showConfirmSwal, 
             getReportsByDate, db } from "./script.js";
             
    // Import c√°c h√†m G·ªêC (native) c·ªßa Firebase SDK
    import { collection, query, where, orderBy, getDocs, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    
    // Import menu
    import { initMenu } from "./menu.js";

    // === 2. T·∫¢I GIAO DI·ªÜN CHUNG ===
    fetch("menu.html").then(r => r.text()).then(h => {
      document.getElementById("menu-placeholder").innerHTML = h;
      initMenu();
    });
    fetch("modal.html").then(r => r.text()).then(h => {
      document.getElementById("loading-placeholder").innerHTML = h;
    });
    fetch("footer.html").then(r => r.text()).then(h => {
        document.getElementById("footer-placeholder").innerHTML = h;
    });

    // === 3. THAM CHI·∫æU DOM V√Ä BI·∫æN TO√ÄN C·ª§C ===
    const notLogged = document.getElementById("notLogged");
    const content   = document.getElementById("pageContent");
    const tbody     = document.querySelector("#dataTable tbody");
    const searchInput = document.getElementById("searchInput");
    const displayCountSelect = document.getElementById("displayCount");
    const fromInput = document.getElementById("fromDate");
    const toInput = document.getElementById("toDate");
    const yearSelect = document.getElementById("yearSelect");
    const applyFilterBtn = document.getElementById("applyFilter");
    const filterNote = document.getElementById("filterNote"); 
    const meterResetFilterInput = document.getElementById("meterResetFilter"); 
    
    let currentFilter = { from: null, to: null };
    let initialLoad = true;
    let allSearchData = []; // M·∫£ng n√†y gi·ªù s·∫Ω l∆∞u k·∫øt qu·∫£ ƒë√£ l·ªçc
    let userRole = null;
    let realtimeListener = null; // ‚≠êÔ∏è Listener ƒë·ªÉ cleanup

    // === 4. C√ÅC H√ÄM TI·ªÜN √çCH (Gi·ªØ nguy√™n) ===
    function formatISODate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
    function getRecordDate(record) {
        return record.ngay_ghi;
    }
    const formatTimestamp = (timestamp) => {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\//g, '/');
    };
    
    // === 5. C√ÅC H√ÄM RENDER V√Ä S·ª∞ KI·ªÜN (Gi·ªØ nguy√™n) ===
    const attachDeleteEventListeners = () => {
      document.querySelectorAll(".delBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
              const id = btn.dataset.id;
              const isConfirmed = await showConfirmSwal(
                  "X√°c nh·∫≠n x√≥a b√°o c√°o",
                  "B·∫°n c√≥ ch·∫Øc mu·ªën **X√≥a vƒ©nh vi·ªÖn** kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.",
                  "C√≥, x√≥a b√°o c√°o", "Kh√¥ng, h·ªßy b·ªè", "error"
              );
              if (isConfirmed) {
                  showLoading("ƒêang x√≥a d·ªØ li·ªáu...");
                  try {
                      await deleteReport("reports_1", id);
                      showSwal("success", "ƒê√£ x√≥a b√°o c√°o!");
                      // T·∫£i l·∫°i d·ªØ li·ªáu sau khi x√≥a
                      await fetchAndRenderData(); 
                  } catch (err) {
                      console.error("L·ªói khi x√≥a b√°o c√°o:", err);
                      showSwal("error", "L·ªói khi x√≥a", "Kh√¥ng th·ªÉ x√≥a b√°o c√°o. Vui l√≤ng th·ª≠ l·∫°i.");
                  } finally {
                      hideLoading();
                  }
              }
          });
      });
    };

    // H√†m render (Gi·ªØ nguy√™n, kh√¥ng thay ƒë·ªïi)
    const filterAndRenderData = (data, query, limit) => {
        const isMeterResetFilterActive = meterResetFilterInput ? meterResetFilterInput.checked : false;
        let fromDate = null;
        let toDate = null;
        const now = new Date();
        const currentYearStart = formatISODate(new Date(now.getFullYear(), 0, 1)); 
        if (currentFilter.from) fromDate = new Date(currentFilter.from); 
        else fromDate = new Date(currentYearStart); 
        if (currentFilter.to) toDate = new Date(currentFilter.to);
        else toDate = now; 
        toDate.setHours(23,59,59,999);
        
        // L∆∞u √Ω: filterByDate ch·ªâ ch·∫°y tr√™n m·∫£ng data ƒë√£ ƒë∆∞·ª£c l·ªçc b·ªüi Firebase
        let filteredByDate = data.filter(r => {
            const dateString = getRecordDate(r);
            if (!dateString) return false; 
            const d = new Date(dateString);
            if (isNaN(d)) return false; 
            // L·ªåC B·ªî SUNG: Ki·ªÉm tra tr·∫°ng th√°i Ch·ªâ s·ªë ƒë·∫∑c bi·ªát (ƒê√É M·ªû R·ªòNG)
            if (isMeterResetFilterActive) {
                // Ki·ªÉm tra xem b·∫£n ghi n√†y c√≥ "ƒë·∫∑c bi·ªát" hay kh√¥ng
                const isReset = r.isMeterReset === true;
                const isAutoInit = r.ghi_chu === "Chi so khoi tao tu dong (Auto-Init)";

                // N·∫øu n√≥ KH√îNG ph·∫£i l√† 'Reset' V√Ä KH√îNG ph·∫£i l√† 'Auto-Init', th√¨ ·∫©n n√≥ ƒëi
                if (!isReset && !isAutoInit) {
                    return false; 
                }
                // N·∫øu n√≥ l√† 1 trong 2 (ho·∫∑c c·∫£ 2), n√≥ s·∫Ω v∆∞·ª£t qua b·ªô l·ªçc v√† ƒë∆∞·ª£c hi·ªÉn th·ªã
            }
            // Vi·ªác l·ªçc ng√†y ƒë√£ ƒë∆∞·ª£c Firebase l√†m, nh∆∞ng ki·ªÉm tra n√†y v·∫´n t·ªët
            return d >= fromDate && d <= toDate; 
        });
        
        filterNote.textContent = `ƒêang xem d·ªØ li·ªáu t·ª´ ${fromDate.toLocaleDateString('vi-VN')} ƒë·∫øn ${toDate.toLocaleDateString('vi-VN')}`;
        
        const lowerCaseQuery = query.toLowerCase().trim();
        const isAdmin = userRole === "admin";

        const filteredData = filteredByDate.filter(item => { 
            const searchString = [
                item.createdBy, item.company, item.ghi_chu, getRecordDate(item), item.chi_so ? item.chi_so.toString() : ""
            ].map(field => field ? field.toString().toLowerCase() : "").join(" ");
            return searchString.includes(lowerCaseQuery);
        });
        
        // S·∫Øp x·∫øp ƒë√£ ƒë∆∞·ª£c Firebase orderBy lo, nh∆∞ng sort l·∫°i an to√†n
        filteredData.sort((a, b) => {
            const dateA = new Date(getRecordDate(a) || 0);
            const dateB = new Date(getRecordDate(b) || 0);
            return dateB - dateA; // M·ªõi nh·∫•t l√™n ƒë·∫ßu
        });
        
        let finalData = filteredData;
        // ‚≠êÔ∏è B·ªé LOGIC slice V√å ƒê√É LIMIT ·ªû FIREBASE
        // Hi·ªÉn th·ªã t·∫•t c·∫£ data ƒë√£ ƒë∆∞·ª£c Firebase limit

        let html = "";
        let sttCounter = 1; 
        finalData.forEach(r => {
            const fileLink = r.fileUrl ? `<a href="${r.fileUrl}" target="_blank">Link</a>` : "";
            const formattedTime = formatTimestamp(r.updatedAt || r.createdAt);
            let combinedGhiChu = r.ghi_chu || "";
            if (r.isMeterReset) {
                combinedGhiChu += `<br>(Ch·ªâ s·ªë ƒêB: ${r.ngay_ghi})`; 
            }
            html += `
                <tr>
                    <td>${sttCounter++}</td> 
                    <td class="admin-only">${r.createdBy || ""}</td> 
                    <td>${r.company || ""}</td>                     
                    <td>${r.chi_so != null ? r.chi_so.toLocaleString('vi-VN') : 0}</td>                      
                    <td>${r.ngay_ghi || ""}</td>                   
                    <td>${combinedGhiChu}</td>                      
                    <td>${fileLink}</td>                           
                    <td class="admin-only">${formattedTime}</td>     
                    <td class="admin-only"><button type="button" data-id="${r.id}" class="delBtn">X√≥a</button></td> 
                </tr>`;
        });
        tbody.innerHTML = html;
        attachDeleteEventListeners();
        document.querySelectorAll("#dataTable th.admin-only, #dataTable td.admin-only").forEach(el => {
            el.style.display = isAdmin ? "table-cell" : "none";
        });
    };

    // === 6. H√ÄM T·∫¢I D·ªÆ LI·ªÜU M·ªöI (T·ª´ l·∫ßn tr∆∞·ªõc) ===
    async function fetchAndRenderData() {
        // ‚≠êÔ∏è 1. H·ª¶Y LISTENER C≈® (n·∫øu c√≥)
        if (realtimeListener) {
            realtimeListener();
            realtimeListener = null;
        }

        // 2. L·∫•y ng√†y t·ª´ b·ªô l·ªçc
        const fromVal = fromInput.value;
        const toVal = toInput.value;
        const yearVal = yearSelect.value;
        
        let startDate, endDate;
        const todayISO = formatISODate(new Date());
        const currentYearStart = new Date().getFullYear() + '-01-01';

        if (yearVal) {
            startDate = `${yearVal}-01-01`;
            endDate = `${yearVal}-12-31`;
            // C·∫≠p nh·∫≠t bi·∫øn global filter
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else if (fromVal && toVal) {
            startDate = fromVal;
            endDate = toVal;
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else if (toVal) {
            startDate = currentYearStart;
            endDate = toVal;
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else if (fromVal) {
            startDate = fromVal;
            endDate = todayISO;
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else {
            // N·∫øu kh√¥ng c√≥ g√¨ ƒë∆∞·ª£c ch·ªçn, d√πng m·∫∑c ƒë·ªãnh
            startDate = currentFilter.from || currentYearStart;
            endDate = currentFilter.to || todayISO;
        }

        // ‚≠êÔ∏è 2. T·∫¢I D·ªÆ LI·ªÜU B·∫∞NG getDocs (1 L·∫¶N)
        const selectedLimit = displayCountSelect.value;
        allSearchData = await getReportsByDate("reports_1", "ngay_ghi", startDate, endDate, selectedLimit);

        // ‚≠êÔ∏è 3. B·∫¨T REAL-TIME LISTENER (Ch·ªâ l·∫Øng nghe data M·ªöI trong kho·∫£ng ng√†y)
        let q = query(
            collection(db, "reports_1"),
            where("ngay_ghi", ">=", startDate),
            where("ngay_ghi", "<=", endDate),
            orderBy("ngay_ghi", "desc")
        );
        
        if (selectedLimit && selectedLimit !== "all") {
            q = query(q, limit(parseInt(selectedLimit)));
        }
        
        realtimeListener = onSnapshot(q, (snapshot) => {
            // C·∫≠p nh·∫≠t allSearchData v·ªõi data m·ªõi
            allSearchData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Render l·∫°i b·∫£ng
            filterAndRenderData(allSearchData, searchInput.value, "all");
        });

        // 4. Render d·ªØ li·ªáu ban ƒë·∫ßu (KH√îNG C·∫¶N n·ªØa v√¨ onSnapshot s·∫Ω trigger)
        // filterAndRenderData(allSearchData, searchInput.value, "all");
    }
    
    // === 7. B·ªò X·ª¨ L√ù S·ª∞ KI·ªÜN L·ªåC (ƒê√É S·ª¨A) ===
    function resetYearSelectIfEditingDates() {
      if (yearSelect && yearSelect.value !== "") yearSelect.value = "";
    }
    [fromInput, toInput].forEach(el => {
      if (!el) return;
      el.addEventListener("focus", resetYearSelectIfEditingDates);
      el.addEventListener("input", resetYearSelectIfEditingDates);
      el.addEventListener("change", resetYearSelectIfEditingDates);
    });

    if(applyFilterBtn) {
        applyFilterBtn.addEventListener("click", (e) => {
            e.preventDefault();
            fetchAndRenderData(); // G·ªçi h√†m m·ªõi
        });
    }

    if(yearSelect) {
        yearSelect.addEventListener("change", (e) => {
            // T·ª± ƒë·ªông t·∫£i l·∫°i khi ch·ªçn nƒÉm
            fetchAndRenderData(); 
        });
    }

    if (meterResetFilterInput) {
        meterResetFilterInput.addEventListener("change", () => {
            // Ch·ªâ render l·∫°i, kh√¥ng t·∫£i l·∫°i
            filterAndRenderData(allSearchData, searchInput.value, displayCountSelect.value);
        });
    }

    // === 8. H√ÄM ON AUTH (ƒê√É S·ª¨A L·ªñI TRUY V·∫§N - PHI√äN B·∫¢N CU·ªêI) ===
    onAuth(async (user) => {
        if (user) {
            notLogged.style.display = "none";
            // (content.style.display = "none" - M·∫∑c ƒë·ªãnh ·∫©n)
            
            try {
                // 1. C√†i ƒë·∫∑t UI Admin
                userRole = await getRole(user.email);
                const isAdmin = userRole === "admin";
                
                document.querySelectorAll("#dataTable th.admin-only").forEach(th => {
                    th.style.display = isAdmin ? "table-cell" : "none";
                });
                const formElement = document.querySelector('#pageContent form'); 
                if (formElement) {
                    formElement.addEventListener('submit', (e) => e.preventDefault());
                }

                // --- 2. T·∫¢I DANH S√ÅCH NƒÇM (ƒê√É T·ªêI ∆ØU - T·ªêN 2 L∆Ø·ª¢T ƒê·ªåC) ---
                showLoading("ƒêang t·∫£i danh s√°ch nƒÉm..."); 

                // ‚≠êÔ∏è S·ª¨A L·ªñI: Quay l·∫°i d√πng 2 truy v·∫•n limit(1) ‚≠êÔ∏è
                const newestReportQuery = query(
                    collection(db, "reports_1"),
                    orderBy("ngay_ghi", "desc"), 
                    limit(1) // Ch·ªâ l·∫•y 1 b·∫£n ghi m·ªõi nh·∫•t
                );
                const oldestReportQuery = query(
                    collection(db, "reports_1"),
                    orderBy("ngay_ghi", "asc"),  
                    limit(1) // Ch·ªâ l·∫•y 1 b·∫£n ghi c≈© nh·∫•t
                );

                const [newestSnapshot, oldestSnapshot] = await Promise.all([
                    getDocs(newestReportQuery),
                    getDocs(oldestReportQuery)
                ]);
                // --- K·∫æT TH√öC S·ª¨A L·ªñI ---

                let years = []; 

                if (!newestSnapshot.empty && !oldestSnapshot.empty) {
                    const newestDateStr = newestSnapshot.docs[0].data().ngay_ghi;
                    const oldestDateStr = oldestSnapshot.docs[0].data().ngay_ghi;

                    const newestYear = parseInt(newestDateStr.substring(0, 4));
                    const oldestYear = parseInt(oldestDateStr.substring(0, 4));

                    for (let y = newestYear; y >= oldestYear; y--) {
                        years.push(y.toString());
                    }
                } else {
                     console.log("Kh√¥ng c√≥ d·ªØ li·ªáu trong 'reports_1' ƒë·ªÉ t·∫°o danh s√°ch nƒÉm.");
                }
                
                const ys = document.getElementById("yearSelect");
                if(ys) {
                  ys.innerHTML = `<option value="">--Ch·ªçn nƒÉm--</option>`;
                  years.forEach(y => ys.innerHTML += `<option value="${y}">${y}</option>`);
                }

                // 3. Thi·∫øt l·∫≠p b·ªô l·ªçc m·∫∑c ƒë·ªãnh (Gi·ªØ nguy√™n)
                if(initialLoad) {
                    const currentYear = new Date().getFullYear().toString();
                    if (years.includes(currentYear) && ys) {
                      const todayISO = formatISODate(new Date());
                      const currentYearStart = currentYear + '-01-01';
                      ys.value = currentYear;
                      currentFilter.from = currentYearStart;
                      currentFilter.to = todayISO; 
                    } else if (years.length > 0) {
                        ys.value = years[0];
                        currentFilter.from = `${years[0]}-01-01`;
                        currentFilter.to = `${years[0]}-12-31`;
                    }
                    initialLoad = false;
                }

                // 4. T·∫£i d·ªØ li·ªáu ch√≠nh (L·∫ßn ƒë·∫ßu)
                await fetchAndRenderData(); 
                
                // 5. HI·ªÇN TH·ªä N·ªòI DUNG (Ch·ªëng gi·∫≠t)
                content.style.display = "block"; 
                hideLoading(); // ·∫®n loading sau khi ƒë√£ render

            } catch (err) {
                 showSwal("error", "L·ªói t·∫£i d·ªØ li·ªáu", err.message);
                 console.error("L·ªói onAuth:", err); // Th√™m log l·ªói chi ti·∫øt
                 hideLoading(); 
            }
            
            // 6. G·∫Øn listener (Gi·ªØ nguy√™n)
            searchInput.addEventListener("input", () => {
                filterAndRenderData(allSearchData, searchInput.value, "all");
            });
            displayCountSelect.addEventListener("change", () => {
                // ‚≠êÔ∏è KHI THAY ƒê·ªîI LIMIT ‚Üí T·∫¢I L·∫†I DATA T·ª™ FIREBASE
                fetchAndRenderData();
            });

        } else {
            notLogged.style.display = "block";
            content.style.display = "none";
            hideLoading(); 
        }
    });
  </script>
</body>
</html>
