<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·∫£ng d·ªØ li·ªáu</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    /* CSS C·ªê ƒê·ªäNH CHI·ªÄU R·ªòNG CHO C·ªòT STT */
    #dataTable th:first-child,
    #dataTable td:first-child {
        width: 50px;
        min-width: 50px;
        max-width: 50px; 
    }
    
    #dataTable th,
    #dataTable td {
        text-align: center;
        vertical-align: middle;
        padding: 8px;
    }

    .admin-only {
        display: none;
    }

    .admin-visible {
        display: table-cell !important;
    }
    /* CSS M·ªöI CHO C√ÅC CONTROLS D∆Ø·ªöI B·ªò L·ªåC CH√çNH */
    .controls-row {
        display: flex;
        justify-content: space-between; /* ƒê·∫©y c√°c nh√≥m ƒëi·ªÅu khi·ªÉn ra hai ph√≠a */
        align-items: center; /* CƒÉn ch·ªânh theo chi·ªÅu d·ªçc */
        margin-top: 10px;
    }

    .left-controls {
        display: flex;
        align-items: center;
        gap: 15px; /* Kho·∫£ng c√°ch gi·ªØa checkbox v√† ghi ch√∫ l·ªçc */
    }

    .right-controls {
        display: flex;
        align-items: center;
    }
    
    /* RESPONSIVE MOBILE */
    @media (max-width: 768px) {
      .table-reports-2 {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      .table-reports-2 table {
        min-width: 410px !important;
      }
      
      .table-reports-2 #dataTable th,
      .table-reports-2 #dataTable td {
        padding: 4px 2px !important;
        font-size: 11px !important;
      }
      
      /* STT */
      .table-reports-2 #dataTable th:nth-child(1),
      .table-reports-2 #dataTable td:nth-child(1) {
        width: 30px !important;
        min-width: 30px !important;
        max-width: 30px !important;
      }
      
      /* C√¥ng ty (c·ªôt 3 v√¨ c·ªôt 2 l√† admin-only) */
      .table-reports-2 #dataTable th:nth-child(3),
      .table-reports-2 #dataTable td:nth-child(3) {
        width: 110px !important;
        min-width: 110px !important;
        max-width: 110px !important;
        white-space: normal !important;
        word-wrap: break-word !important;
      }
      
      /* Ng√†y ngh·ªâ (c·ªôt 4) */
      .table-reports-2 #dataTable th:nth-child(4),
      .table-reports-2 #dataTable td:nth-child(4) {
        width: 75px !important;
        min-width: 75px !important;
        max-width: 75px !important;
      }
      
      /* Ghi ch√∫ (c·ªôt 5) */
      .table-reports-2 #dataTable th:nth-child(5),
      .table-reports-2 #dataTable td:nth-child(5) {
        width: 155px !important;
        min-width: 155px !important;
        max-width: 155px !important;
        white-space: normal !important;
        word-wrap: break-word !important;
      }
      
      /* File/Link (c·ªôt 6) */
      .table-reports-2 #dataTable th:nth-child(6),
      .table-reports-2 #dataTable td:nth-child(6) {
        width: 40px !important;
        min-width: 40px !important;
        max-width: 40px !important;
        font-size: 10px !important;
        padding: 2px 1px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      
      .controls-row {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      
      .left-controls,
      .right-controls {
        width: 100%;
        justify-content: space-between;
      }
    }
        
  </style>
</head>
<body>
  <div id="menu-placeholder"></div>
  <div id="loading-placeholder"></div>
  <div id="alert-placeholder"></div>

  <div id="notLogged" style="display:none;">
    ‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.
  </div>

  <div id="pageContent" style="display:none;">
    <h2>üìä B·∫£ng d·ªØ li·ªáu b√°o c√°o ng√†y ngh·ªâ </h2>
    <div class="card-body">

    <div class="filter-box">
      <label>T·ª´ ng√†y: <input type="date" id="fromDate"></label>
      <label>ƒê·∫øn ng√†y: <input type="date" id="toDate"></label>
      <label>NƒÉm nhanh:
        <select id="yearSelect">
          <option value="">--Ch·ªçn nƒÉm--</option>
        </select>
      </label>
      <button id="applyFilter" type="button">√Åp d·ª•ng</button>
    </div>
    <div class="note" id="filterNote"></div>
      <form>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm...">
    </div>
        <div class="table-container table-reports-2">
        <table id="dataTable">
          <thead>
            <tr>
              <th>STT</th>
              <th class="admin-only">Ng∆∞·ªùi g·ª≠i</th>
              <th>C√¥ng ty</th>
              <th>Ng√†y ngh·ªâ</th>
              <th>Ghi ch√∫</th>
              <th>File</th>
              <th class="admin-only">Th·ªùi gian</th>
              <th class="admin-only">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        </div>
      </form>
      
      <div class="controls-row">
        <div class="left-controls">
          <label><input type="checkbox" id="specialWorkdayFilter"> Ch·ªâ xem Ng√†y l√†m ƒë·∫∑c bi·ªát</label>
        </div>
        <div class="right-controls">
          <label for="displayCount">Hi·ªÉn th·ªã:</label>
          <select id="displayCount">
              <option value="7">7 d√≤ng</option>
              <option value="20">20 d√≤ng</option>
              <option value="all">To√†n b·ªô</option>
          </select>
        </div>
      </div>
    </div>
  </div>
<div id="footer-placeholder" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script type="module">
    // === 1. IMPORT ===
    import { auth, onAuth, deleteReport, getRole, showLoading, hideLoading, showSwal, showConfirmSwal, 
             getReportsByDate, db } from "./script.js";
    import { collection, query, where, orderBy, getDocs, limit, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { initMenu } from "./menu.js";

    // === 2. T·∫¢I GIAO DI·ªÜN CHUNG ===
    fetch("menu.html").then(r => r.text()).then(h => {
      document.getElementById("menu-placeholder").innerHTML = h;
      initMenu();
    });
    fetch("modal.html").then(r => r.text()).then(h => {
      document.getElementById("loading-placeholder").innerHTML = h;
    });
    
    // (Footer s·∫Ω ƒë∆∞·ª£c t·∫£i b√™n trong onAuth)

    // === 3. THAM CHI·∫æU DOM V√Ä BI·∫æN TO√ÄN C·ª§C ===
    const notLogged = document.getElementById("notLogged");
    const content   = document.getElementById("pageContent");
    const footer = document.getElementById("footer-placeholder");
    const tbody     = document.querySelector("#dataTable tbody");
    const searchInput = document.getElementById("searchInput");
    const displayCountSelect = document.getElementById("displayCount");
    const fromInput = document.getElementById("fromDate");
    const toInput = document.getElementById("toDate");
    const yearSelect = document.getElementById("yearSelect");
    const applyFilterBtn = document.getElementById("applyFilter");
    const filterNote = document.getElementById("filterNote"); 
    const specialWorkdayFilterInput = document.getElementById("specialWorkdayFilter"); 
    
    let currentFilter = { from: null, to: null };
    let initialLoad = true;
    let allSearchData = []; 
    let userRole = null;

    // === 4. C√ÅC H√ÄM TI·ªÜN √çCH ===
    function formatISODate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
    function getRecordDate(record) {
        return record.ngay_nghi || record.ngay_lam_db;
    }
    const formatTimestamp = (timestamp) => {
        if (!timestamp) return "";
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\//g, '/');
    };
    
    // === 5. C√ÅC H√ÄM RENDER V√Ä S·ª∞ KI·ªÜN ===
    const attachDeleteEventListeners = () => {
      document.querySelectorAll(".delBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
              const id = btn.dataset.id;
              const isConfirmed = await showConfirmSwal(
                  "X√°c nh·∫≠n x√≥a b√°o c√°o",
                  "B·∫°n c√≥ ch·∫Øc mu·ªën **X√≥a vƒ©nh vi·ªÖn** kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.",
                  "C√≥, x√≥a b√°o c√°o", "Kh√¥ng, h·ªßy b·ªè", "error"
              );
              if (isConfirmed) {
                  showLoading("ƒêang x√≥a d·ªØ li·ªáu...");
                  try {
                      await deleteReport("reports_2", id); 
                      showSwal("success", "ƒê√£ x√≥a b√°o c√°o!");
                      await fetchAndRenderData(); // T·∫£i l·∫°i data sau khi x√≥a
                  } catch (err) {
                      console.error("L·ªói khi x√≥a b√°o c√°o:", err);
                      showSwal("error", "L·ªói khi x√≥a", "Kh√¥ng th·ªÉ x√≥a b√°o c√°o. Vui l√≤ng th·ª≠ l·∫°i.");
                  } finally {
                      hideLoading();
                  }
              }
          });
      });
    };

    const filterAndRenderData = (data, query, limit) => {
        const isSpecialWorkdayFilterActive = specialWorkdayFilterInput ? specialWorkdayFilterInput.checked : false;
        let fromDate = null;
        let toDate = null;
        const now = new Date();
        const currentYearStart = formatISODate(new Date(now.getFullYear(), 0, 1)); 
        if (currentFilter.from) fromDate = new Date(currentFilter.from); 
        else fromDate = new Date(currentYearStart); 
        if (currentFilter.to) toDate = new Date(currentFilter.to);
        else toDate = now; 
        toDate.setHours(23,59,59,999);
        
        // L·ªçc theo checkbox
        let filteredByDate = data.filter(r => {
            const dateString = getRecordDate(r); 
            if (!dateString) return false; 
            const d = new Date(dateString);
            if (isNaN(d)) return false; 
            
            if (isSpecialWorkdayFilterActive && !r.isSpecialWorkday) {
                return false;
            }
            // (L·ªçc theo ng√†y ƒë√£ ƒë∆∞·ª£c Firebase x·ª≠ l√Ω, kh√¥ng c·∫ßn l·ªçc l·∫°i)
            return true;
        });
        
        filterNote.textContent = `ƒêang xem d·ªØ li·ªáu t·ª´ ${new Date(currentFilter.from).toLocaleDateString('vi-VN')} ƒë·∫øn ${new Date(currentFilter.to).toLocaleDateString('vi-VN')}`;
        
        // L·ªçc theo t√¨m ki·∫øm
        const lowerCaseQuery = query.toLowerCase().trim();
        const isAdmin = userRole === "admin";
        const filteredData = filteredByDate.filter(item => { 
            const searchString = [
                item.createdBy, item.company, item.ghi_chu, getRecordDate(item)
            ].map(field => field ? field.toString().toLowerCase() : "").join(" ");
            return searchString.includes(lowerCaseQuery);
        });
        
        // S·∫Øp x·∫øp
        filteredData.sort((a, b) => {
            const dateA = new Date(getRecordDate(a) || 0);
            const dateB = new Date(getRecordDate(b) || 0);
            return dateB - dateA; // M·ªõi nh·∫•t l√™n ƒë·∫ßu
        });
        
        // Gi·ªõi h·∫°n
        let finalData = filteredData;
        if (lowerCaseQuery === "" && limit !== "all") {
            finalData = filteredData.slice(0, parseInt(limit));
        }

        // Render
        let html = "";
        let sttCounter = 1; 
        finalData.forEach(r => {
            const fileLink = r.fileUrl ? `<a href="${r.fileUrl}" target="_blank">Link</a>` : "";
            const formattedTime = formatTimestamp(r.updatedAt || r.createdAt);
            let combinedGhiChu = r.ghi_chu || "";
            if (r.ngay_lam_db) {
                combinedGhiChu += `<br>(Ng√†y l√†m ƒêB: ${r.ngay_lam_db})`; 
            }
            const displayDate = r.ngay_nghi || ""; 

            html += `
                <tr>
                    <td>${sttCounter++}</td> 
                    <td class="admin-only">${r.createdBy || ""}</td>
                    <td>${r.company || ""}</td>
                    <td>${displayDate}</td> 
                    <td>${combinedGhiChu}</td> 
                    <td>${fileLink}</td>
                    <td class="admin-only">${formattedTime}</td>
                    <td class="admin-only"><button type="button" data-id="${r.id}" class="delBtn">X√≥a</button></td>
                </tr>`;
        });
        tbody.innerHTML = html;
        attachDeleteEventListeners();
        document.querySelectorAll("#dataTable th.admin-only, #dataTable td.admin-only").forEach(el => {
            el.style.display = isAdmin ? "table-cell" : "none";
        });
    };

    // === 6. H√ÄM T·∫¢I D·ªÆ LI·ªÜU M·ªöI ===
    async function fetchAndRenderData() {
        // 1. L·∫•y ng√†y
        const fromVal = fromInput.value;
        const toVal = toInput.value;
        const yearVal = yearSelect.value;
        
        let startDate, endDate;
        const todayISO = formatISODate(new Date());
        const currentYearStart = new Date().getFullYear() + '-01-01';

        if (yearVal) {
            startDate = `${yearVal}-01-01`;
            endDate = `${yearVal}-12-31`;
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else if (fromVal && toVal) {
            startDate = fromVal;
            endDate = toVal;
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else if (toVal) {
            startDate = currentYearStart;
            endDate = toVal;
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else if (fromVal) {
            startDate = fromVal;
            endDate = todayISO;
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        } else {
            startDate = currentFilter.from || currentYearStart;
            endDate = currentFilter.to || todayISO;
            // C·∫≠p nh·∫≠t l·∫°i filter to√†n c·ª•c
            currentFilter.from = startDate;
            currentFilter.to = endDate;
        }
        
        // 2. B·∫≠t loading
        showLoading("ƒêang t·∫£i d·ªØ li·ªáu...");
        try {
            // 3. Ch·∫°y 2 truy v·∫•n
            const q1 = query(
                collection(db, "reports_2"),
                where("ngay_nghi", ">=", startDate),
                where("ngay_nghi", "<=", endDate)
            );
            const q2 = query(
                collection(db, "reports_2"),
                where("ngay_lam_db", ">=", startDate),
                where("ngay_lam_db", "<=", endDate)
            );

            const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
            
            const reportsMap = new Map();
            snap1.docs.forEach(doc => reportsMap.set(doc.id, { id: doc.id, ...doc.data() }));
            snap2.docs.forEach(doc => reportsMap.set(doc.id, { id: doc.id, ...doc.data() }));

            allSearchData = Array.from(reportsMap.values());
            
        } catch (err) {
             console.error("L·ªói khi t·∫£i reports_2:", err);
             showSwal("error", "L·ªói t·∫£i d·ªØ li·ªáu", err.message);
             allSearchData = [];
        } 
        // 4. KH√îNG t·∫Øt loading ·ªü ƒë√¢y

        // 5. Render (v·∫´n b·ªã che)
        filterAndRenderData(allSearchData, searchInput.value, displayCountSelect.value);
    }
    
    // === 7. B·ªò X·ª¨ L√ù S·ª∞ KI·ªÜN L·ªåC ===
    function resetYearSelectIfEditingDates() {
      if (yearSelect && yearSelect.value !== "") yearSelect.value = "";
    }
    [fromInput, toInput].forEach(el => {
      if (!el) return;
      el.addEventListener("focus", resetYearSelectIfEditingDates);
      el.addEventListener("input", resetYearSelectIfEditingDates);
      el.addEventListener("change", resetYearSelectIfEditingDates);
    });

    if(applyFilterBtn) {
        applyFilterBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            await fetchAndRenderData(); // T·∫£i data
            hideLoading(); // T·∫Øt loading SAU KHI data t·∫£i xong
        });
    }

    if(yearSelect) {
        yearSelect.addEventListener("change", async (e) => {
            await fetchAndRenderData(); // T·∫£i data
            hideLoading(); // T·∫Øt loading SAU KHI data t·∫£i xong
        });
    }

    if (specialWorkdayFilterInput) {
        specialWorkdayFilterInput.addEventListener("change", () => {
            // Ch·ªâ render l·∫°i, kh√¥ng t·∫£i l·∫°i
            filterAndRenderData(allSearchData, searchInput.value, displayCountSelect.value);
        });
    }

    // === 8. H√ÄM ON AUTH (ƒê√É S·ª¨A L·ªñI FOOTER V√Ä T·∫¢I NƒÇM) ===
    onAuth(async (user) => {
        if (user) {
            notLogged.style.display = "none";
            
            // T·∫£i footer nh∆∞ng ch∆∞a hi·ªÉn th·ªã
            fetch("footer.html").then(r => r.text()).then(h => {
                if (footer) footer.innerHTML = h;
            });
            
            showLoading("ƒêang t·∫£i c·∫•u h√¨nh..."); 
            
            try {
                // 1. C√†i ƒë·∫∑t UI Admin
                userRole = await getRole(user.email);
                const isAdmin = userRole === "admin";
                document.querySelectorAll("#dataTable th.admin-only").forEach(th => {
                    th.style.display = isAdmin ? "table-cell" : "none";
                });
                const formElement = document.querySelector('#pageContent form'); 
                if (formElement) {
                    formElement.addEventListener('submit', (e) => e.preventDefault());
                }

                // --- 2. T·∫¢I DANH S√ÅCH NƒÇM T·ª∞ ƒê·ªòNG (C√ÅCH ƒê∆†N GI·∫¢N H∆†N) ---
                let years = [];
                try {
                    // L·∫•y T·∫§T C·∫¢ documents (kh√¥ng orderBy ƒë·ªÉ tr√°nh l·ªói index)
                    const allDocsSnap = await getDocs(collection(db, "reports_2"));
                    
                    const yearsSet = new Set();
                    allDocsSnap.docs.forEach(doc => {
                        const data = doc.data();
                        // L·∫•y nƒÉm t·ª´ ngay_nghi
                        if (data.ngay_nghi) {
                            try {
                                const year = new Date(data.ngay_nghi).getFullYear();
                                if (!isNaN(year) && year > 2000 && year < 2100) {
                                    yearsSet.add(year);
                                }
                            } catch (e) {
                                console.warn('Invalid ngay_nghi:', data.ngay_nghi);
                            }
                        }
                        // L·∫•y nƒÉm t·ª´ ngay_lam_db
                        if (data.ngay_lam_db) {
                            try {
                                const year = new Date(data.ngay_lam_db).getFullYear();
                                if (!isNaN(year) && year > 2000 && year < 2100) {
                                    yearsSet.add(year);
                                }
                            } catch (e) {
                                console.warn('Invalid ngay_lam_db:', data.ngay_lam_db);
                            }
                        }
                    });
                    
                    // Chuy·ªÉn Set th√†nh Array v√† s·∫Øp x·∫øp gi·∫£m d·∫ßn
                    years = Array.from(yearsSet).sort((a, b) => b - a).map(y => y.toString());
                    
                    // N·∫øu kh√¥ng c√≥ nƒÉm n√†o, d√πng nƒÉm hi·ªán t·∫°i
                    if (years.length === 0) {
                        years = [new Date().getFullYear().toString()];
                    }
                } catch (error) {
                    console.error('L·ªói t·∫£i danh s√°ch nƒÉm:', error);
                    // Fallback: D√πng 3 nƒÉm g·∫ßn ƒë√¢y
                    const currentYear = new Date().getFullYear();
                    years = [currentYear, currentYear - 1, currentYear - 2].map(y => y.toString());
                }
                
                const ys = document.getElementById("yearSelect");
                if(ys) {
                    ys.innerHTML = `<option value="">--Ch·ªçn nƒÉm--</option>`;
                    years.forEach(y => {
                        ys.innerHTML += `<option value="${y}">${y}</option>`;
                    });
                }
                // --- K·∫æT TH√öC T·∫¢I NƒÇM ---

                // 3. Thi·∫øt l·∫≠p b·ªô l·ªçc m·∫∑c ƒë·ªãnh
                if(initialLoad) {
                    const currentYear = new Date().getFullYear().toString();
                    if (years.includes(currentYear) && ys) {
                      const todayISO = formatISODate(new Date());
                      const currentYearStart = currentYear + '-01-01';
                      ys.value = currentYear;
                      currentFilter.from = currentYearStart;
                      currentFilter.to = todayISO; 
                    } else if (years.length > 0) {
                        ys.value = years[0];
                        currentFilter.from = `${years[0]}-01-01`;
                        currentFilter.to = `${years[0]}-12-31`;
                    }
                    initialLoad = false;
                }

                // 4. T·∫£i d·ªØ li·ªáu ch√≠nh (L·∫ßn ƒë·∫ßu)
                // (H√†m n√†y s·∫Ω b·∫≠t loading, nh∆∞ng kh√¥ng t·∫Øt n√≥)
                await fetchAndRenderData(); 
                
                // 5. HI·ªÇN TH·ªä N·ªòI DUNG V√Ä FOOTER
                content.style.display = "block"; 
                if (footer) footer.style.display = "block";

            } catch (err) {
                 showSwal("error", "L·ªói t·∫£i d·ªØ li·ªáu", err.message);
                 console.error("L·ªói onAuth:", err); 
                 if (footer) footer.style.display = "none";
            } finally {
                // 6. Lu√¥n t·∫Øt loading T·ªîNG ·ªü cu·ªëi c√πng
                hideLoading(); 
            }
            
            // 7. G·∫Øn listener
            searchInput.addEventListener("input", () => {
                filterAndRenderData(allSearchData, searchInput.value, displayCountSelect.value);
            });
            displayCountSelect.addEventListener("change", () => {
                filterAndRenderData(allSearchData, searchInput.value, displayCountSelect.value);
            });

        } else {
            notLogged.style.display = "block";
            content.style.display = "none";
            if (footer) footer.style.display = "none"; 
            hideLoading(); 
        }
    });
  </script>
</body>
</html>
