<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B√°o c√°o th·ªëng k√™</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    /* CSS C≈® (GI·ªÆ NGUY√äN) */
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    #reportTable th { text-align: center; vertical-align: middle; background: #034892; color: white; } 
    #reportTable td:first-child { text-align: left; } 
    #reportTable td:not(:first-child) { text-align: center; } 
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    
    .toggle-btn { cursor: pointer; margin-left: 8px; color: rgba(0, 0, 255, 0.527); }
    .child-row { display: none; background: #f0f0f0; } 
    /* Compact filter row: use flex layout so controls are tighter and responsive */
    .filter-box {
      margin: 8px 0; /* reduce vertical gap */
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px; /* consistent spacing between controls */
    }
    /* remove per-control right margin (gap handles spacing), increase padding for click targets */
    .filter-box input, .filter-box select {
      margin-right: 0;
      padding: 6px 8px;
      box-sizing: border-box;
      height: 34px;
    }
    .note { font-style: italic; margin-bottom: 10px; color: #444; }
    .admin-settings { border: 1px solid #ccc; padding: 10px; margin-top: 20px; display: none; }
    .admin-settings h3 { margin-top: 0; }
    tr.current-row td { font-weight: bold; }
    tr.past-row td { font-size: 0.85em; color: #444; }
    tr.total-current-row { background: #eef6ff; }
    tr.detail-current-row { background: white !important; }

    #quotaMultipliersSetting table { width: 100%; }
    #quotaMultipliersSetting th, #quotaMultipliersSetting td { padding: 4px 8px; }
    .pdf-only { display: none; }


/* ================= TOGGLE SWITCH 3 N·∫§C ================= */
:root {
  --toggle-height: 35px;       /* Chi·ªÅu cao c√¥ng t·∫Øc */
  --label-width: 85px;        /* Chi·ªÅu r·ªông m·ªói n·∫•c */
  --gap: 2px;                  /* Kho·∫£ng c√°ch gi·ªØa c√°c n·∫•c */
  --accent1: #2b9df4;
  --accent2: #0362b7;
  --muted: #dbe9f8;
  --text: #034892;
}

/* Container ch√≠nh */
.switch-3-n {
  position: relative;
  display: flex;
  width: calc(var(--label-width) * 3 + var(--gap) * 2);
  height: var(--toggle-height);
  border-radius: 999px;
  background: #f0f6ff;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
  padding: 4px;
  overflow: hidden;
  user-select: none;
}

/* ·∫®n input radio */
.switch-3-n input[type="radio"] {
  display: none;
}

/* Label hi·ªÉn th·ªã text */
.switch-3-n label {
  flex: 0 0 var(--label-width);
  display: flex;                /* D√πng flexbox */
  align-items: center;          /* CƒÉn gi·ªØa d·ªçc */
  justify-content: center;      /* CƒÉn gi·ªØa ngang */
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  z-index: 3;
  color: var(--text);
  transition: color 0.2s;
}

/* Hover nh·∫π */
.switch-3-n label:hover {
  color: #022f65;
}

/* Kh·ªëi tr∆∞·ª£t */
.switch-3-n a {
  position: absolute;
  top: 4px;
  left: 2px;
  width: calc(var(--label-width) - var(--gap));
  height: calc(var(--toggle-height) - 8px);
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  border-radius: 999px;
  z-index: 2;
  box-shadow: 0 4px 1px rgba(0,0,0,0.2);
  transition: transform 0.3s ease;
  transform: translateX(0);
}

/* Label active (radio ƒë∆∞·ª£c ch·ªçn) ‚Üí ch·ªØ m√†u tr·∫Øng */
.switch-3-n input:checked + label {
  color: #fff;
}
    
/* 2. Gi·∫£m kho·∫£ng c√°ch tr√™n b·∫£ng ch√≠nh (B·∫£ng B√°o c√°o th·ªëng k√™) */
#reportTable {
/* Ghi ƒë√® margin-top: 20px; m·∫∑c ƒë·ªãnh c·ªßa th·∫ª table */
    margin-top: 0px !important; 
}

/*ModeToggle */
#reportModeToggle {
    margin: 0 !important; 
    /* D√πng !important ƒë·ªÉ ƒë·∫£m b·∫£o quy t·∫Øc n√†y ghi ƒë√® b·∫•t k·ª≥ margin n√†o kh√°c */
}

/* ƒê·∫£m b·∫£o kh·ªëi ch·ª©a n√≥ c≈©ng kh√¥ng t·∫°o th√™m kho·∫£ng c√°ch th·ª´a */
.toggle-switch-container {
    margin: 0 !important;
}
/* Responsive nh·ªè h∆°n */
@media (max-width: 700px) {
  :root {
    --label-width: 90px;
    --toggle-height: 36px;
  }
  .switch-3-n label {
    font-size: 12px;
  }
}

/* ===== RESPONSIVE CHO MOBILE ===== */
@media (max-width: 768px) {
  h2 {
    font-size: 1.1rem;
    margin-bottom: 8px;
    padding: 0 5px;
  }
  
  .card-body {
    padding: 8px;
  }
  
  /* Filter box mobile - 1 h√†ng ngang c·ª±c g·ªçn */
  .filter-box {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 1px;
    margin-bottom: 8px;
    flex-wrap: nowrap;
  }
  
  .filter-box label {
    font-size: 0;
    line-height: 0;
    display: inline-flex;
    align-items: center;
    flex-shrink: 1;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .filter-box input[type="date"] {
    width: 90px !important;
    font-size: 11px !important;
    padding: 4px 2px !important;
    height: 27px !important;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin: 0 !important;
  }
  
  .filter-box select {
    display: none !important;
  }
  
  .filter-box button {
    flex: 0 !important;
    width: 68px !important;
    min-width: 68px !important;
    max-width: 68px !important;
    font-size: 11px !important;
    padding: 4px !important;
    height: 27px !important;
    white-space: nowrap !important;
    margin-left: 0 !important;
  }
  
  /* N√∫t Xu·∫•t b√°o c√°o r·ªông h∆°n gi·ªëng thongke */
  .filter-box button#exportPDF {
    width: 74px !important;
    min-width: 74px !important;
    max-width: 74px !important;
  }
  
  /* ƒê·ªïi text n√∫t Xu·∫•t b√°o c√°o tr√™n mobile */
  .filter-box button#exportPDF::before {
    content: 'Xu·∫•t b√°o c√°o';
  }
  
  .filter-box button#exportPDF {
    font-size: 0 !important;
  }
  
  .filter-box button#exportPDF::before {
    font-size: 11px !important;
  }
  
  /* B·∫£ng responsive */
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  #reportTable,
  #holidayDetailTable {
    min-width: 600px;
    font-size: 11px;
  }
  
  #reportTable th,
  #reportTable td,
  #holidayDetailTable th,
  #holidayDetailTable td {
    padding: 4px;
    font-size: 11px;
  }
  
  /* Toggle switch mobile - chuy·ªÉn th√†nh select */
  #reportModeToggle {
    display: none !important;
  }
  
  .toggle-switch-container::before {
    content: 'Ch·∫ø ƒë·ªô: ';
    font-size: 11px;
    color: #034892;
    font-weight: 500;
    margin-right: 5px;
  }
  
  .toggle-switch-container::after {
    content: '';
    display: block;
    width: auto;
  }
  
  /* T·∫°o select thay th·∫ø toggle */
  .toggle-switch-container {
    position: relative;
  }
  
  #mobileReportModeSelect {
    display: block !important;
    width: auto !important;
    font-size: 11px !important;
    padding: 4px 8px !important;
    height: 23px !important;
    border: 1px solid #2196F3 !important;
    border-radius: 4px !important;
    background: #e3f2fd !important;
    color: #034892 !important;
    font-weight: 500 !important;
    cursor: pointer !important;
  }
  
  /* Report header controls - chuy·ªÉn note xu·ªëng d∆∞·ªõi filter box */
  .report-header-controls {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 5px;
    margin-top: 5px !important;
    margin-bottom: 5px !important;
  }
  
  .report-header-controls .note {
    text-align: left;
    margin: 0 !important;
    order: 1;
  }
  
  .report-header-controls .toggle-switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    order: 2;
  }
  
  /* Nh√≥m Ch·∫ø ƒë·ªô (label + select) */
  .toggle-switch-container::before {
    content: 'Ch·∫ø ƒë·ªô: ';
    font-size: 11px;
    color: #034892;
    font-weight: 500;
    margin-right: 5px;
    order: 1;
  }
  
  .toggle-switch-container #mobileReportModeSelect {
    order: 2;
  }
  
  /* Di chuy·ªÉn select Nh√≥m c√¥ng ty v√†o toggle-switch-container */
  .toggle-switch-container select#companyGroupFilter {
    order: 3;
    display: block !important;
    width: auto !important;
    font-size: 11px !important;
    padding: 4px 6px !important;
    height: 27px !important;
    border: 1px solid #2196F3 !important;
    border-radius: 4px !important;
    background: #e3f2fd !important;
    color: #034892 !important;
    font-weight: 500 !important;
    margin: 0 !important;
    margin-left: auto !important;
  }
  
  /* Note text */
  .note {
    font-size: 11px !important;
  }
  
  /* Modal mobile */
  #configModal .modal-content-config {
    width: 95% !important;
    margin: 2% auto !important;
    max-height: 95vh !important;
    padding: 10px !important;
  }
  
  /* ·∫®n admin settings tr√™n mobile */
  .admin-settings {
    display: none !important;
  }
  
  /* T·ªëi ∆∞u b·∫£ng chi ti·∫øt ng√†y ngh·ªâ cho mobile */
  #holidayDetailTable {
    min-width: 500px !important;
    font-size: 10px !important;
  }
  
  #holidayDetailTable th {
    padding: 6px 4px !important;
    font-size: 10px !important;
    white-space: nowrap;
  }
  
  #holidayDetailTable td {
    padding: 4px 2px !important;
    font-size: 10px !important;
    white-space: nowrap;
  }
  
  /* C·ªôt ƒë·∫ßu ti√™n (K·ª≥) r·ªông h∆°n m·ªôt ch√∫t tr√™n mobile */
  #holidayDetailTable th:first-child,
  #holidayDetailTable td:first-child {
    min-width: 80px;
    max-width: 80px;
    padding: 4px 2px !important;
  }
  
  /* C√°c c·ªôt c√¥ng ty thu g·ªçn */
  #holidayDetailTable th:not(:first-child),
  #holidayDetailTable td:not(:first-child) {
    min-width: 35px;
    max-width: 60px;
  }
}

    /* B·∫ÆT ƒê·∫¶U CSS M·ªöI: B·∫¢NG CHI TI·∫æT NG√ÄY NGH·ªà */
    #holidayDetailTable {
        margin-top: 10px;
        width: 100%;
        border-collapse: collapse;
    }
    #holidayDetailReport h3 {
        margin-bottom: 5px;
        border-bottom: 2px solid #ccc;
        padding-bottom: 5px;
        color: #034892;
    }
    #holidayDetailTable th {
        background: #034892;
        color: white;
        padding: 18px;
        text-align: center;
        vertical-align: top;
    }
    
    /* Gi·∫£m k√≠ch th∆∞·ªõc c·ªôt K·ª≥ */
    #holidayDetailTable th:first-child,
    #holidayDetailTable td:first-child {
        width: 200px;
        max-width: 200px;
        padding: 8px 4px;
    }
    
    #holidayDetailTable td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
        vertical-align: top;
        white-space: pre-wrap; /* Preserve line breaks */
        font-size: 0.9em;
    }
    /* TH√äM M·ªöI: D√†nh cho h√†ng con trong b·∫£ng chi ti·∫øt */
    .child-row-detail { display: none; }
    /* K·∫øt th√∫c CSS M·ªõi */
  /* Scroll container for quota multipliers: show up to ~4 rows then scroll */
  .quota-scroll {
    /* show ~4 rows by default; keep no inner padding so sticky header is flush */
    max-height: calc(4 * 40px + 0px); /* adjust if row height differs */
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    padding: 0; /* IMPORTANT: remove padding so sticky header aligns to top */
    background: #fff;
  }
  .quota-scroll table { margin: 0; width: 100%; border-collapse: collapse; }
  .quota-scroll thead th { background: transparent; font-weight: 600; }
  .quota-scroll tbody tr td { padding: 8px; border: 1px solid #ccc; }
  /* Make the header sticky so it stays visible while scrolling the quota list
     Match visual style from autoplan: light gray bg, slight shadow, no gap to container */
  .quota-scroll thead th {
    position: sticky;
    top: 0px; /* align to the very top of the scroll container */
    background-color: #f0f0f0; /* match autoplan look */
    z-index: 3;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    padding: 8px;
    border: 1px solid #ccc;
  }
  /* Make the first column (STT) narrow and centered */
  .quota-scroll table th:first-child,
  .quota-scroll table td:first-child {
    width: 50px;
    max-width: 50px;
    text-align: center;
    white-space: nowrap;
  }

    /* üî• GHI ƒê√à CSS CHO MODAL C·∫§U H√åNH (TƒÇNG R·ªòNG, GI·∫¢M CAO) üî• */
    #configModal .modal-content-config {
        /* 1. TƒÇNG B·ªÄ R·ªòNG V√Ä X√ìA GI·ªöI H·∫†N MAX-WIDTH */
        width: 85% !important;        /* TƒÉng b·ªÅ r·ªông l√™n 85% m√†n h√¨nh */
        max-width: 1200px !important;  /* TƒÉng gi·ªõi h·∫°n t·ªëi ƒëa l√™n 1200px (ho·∫∑c x√≥a h·∫≥n b·∫±ng none) */
        
        /* 2. GI·∫¢M CHI·ªÄU CAO T·ªêI ƒêA */
        max-height: 80vh !important;  /* Gi·∫£m chi·ªÅu cao t·ªëi ƒëa xu·ªëng 80% chi·ªÅu cao m√†n h√¨nh */
        
        /* 3. ƒê·∫®Y L√äN CAO H∆†N (T√πy ch·ªçn) */
        margin: 12vh auto !important;   /* Gi·∫£m kho·∫£ng c√°ch t·ª´ ƒë·ªânh xu·ªëng (12% chi·ªÅu cao viewport) */
    }
  </style>
</head>
<body>
  <div id="menu-placeholder"></div>
  <div id="loading-placeholder"></div>
  <div id="alert-placeholder"></div>   
  <div id="notLogged" style="display:none;">
    ‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.
  </div>

  <div id="pageContent" style="display:none;">
  <h2>üìä B√°o c√°o th·ªëng k√™</h2>


  <form>
    <div class="filter-box">
      <label>T·ª´ ng√†y: <input type="date" id="fromDate"></label>
      <label>ƒê·∫øn ng√†y: <input type="date" id="toDate"></label>
      <label>NƒÉm nhanh:
        <select id="yearSelect">
          <option value="">--Ch·ªçn nƒÉm--</option>
        </select>
      </label>
      <label>Nh√≥m c√¥ng ty: 
        <select id="companyGroupFilter">
            <option value="group1">Nh√≥m 1 (ƒë·ªìng h·ªì)</option>
            <option value="group2">Nh√≥m 2 (kho√°n)</option>
            <option value="all">T·∫•t c·∫£ 2 nh√≥m</option>
        </select>
      </label>
      
      <button id="applyFilter">√Åp d·ª•ng</button>
      <button type="button" id="exportPDF">Xu·∫•t b√°o c√°o (PDF)</button>
      <button type="button" id="openConfigModal" class="admin-only" style="display:none;">‚öôÔ∏è C·∫•u h√¨nh</button>
    </div>
    
    <div class="report-header-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px !important; margin-top: 10px !important;">
        <div class="note" id="filterNote" style="margin-bottom: 0; margin-top: 0;"></div>
        <div class="toggle-switch-container">
            <select id="mobileReportModeSelect" style="display: none;">
                <option value="0">Chu·∫©n</option>
                <option value="1">Ng√†y ngh·ªâ</option>
                <option value="2">Chi ti·∫øt</option>
            </select>
            
            <div id="reportModeToggle" class="switch-toggle switch-3-n">
                <input id="mode-normal" name="report-mode" type="radio" value="0" checked />
                <label for="mode-normal">Chu·∫©n</label>

                <input id="mode-count" name="report-mode" type="radio" value="1" />
                <label for="mode-count">Ng√†y ngh·ªâ</label>

                <input id="mode-list" name="report-mode" type="radio" value="2" />
                <label for="mode-list">Chi ti·∫øt</label>
                <a></a>
            </div>
        </div>

    </div>
    <div id="pdfReport"> 
    <div class="pdf-only">
      <h2 style="text-align:center">TRUNG T√ÇM X√ÇY D·ª∞NG H·∫† T·∫¶NG KCN TH·ªêT N·ªêT</h2>
      <h2 style="text-align:left">üìä B√°o c√°o th·ªëng k√™</h2>
    </div>

    <div class="table-container">
    <table id="reportTable">
      <thead>
        <tr>
          <th>L∆∞u l∆∞·ª£ng</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    </div>
    <div id="reportFooterNote" style="margin-top: 10px; font-style: italic; color: #cc0000; display: none;">
    **L∆∞u √Ω:** S·ªë li·ªáu trong ngo·∫∑c ƒë∆°n c·∫°nh ch·ªâ s·ªë kh·ªëi l∆∞·ª£ng l√† ng√†y ngh·ªâ t∆∞∆°ng ·ª©ng. V√≠ d·ª•: 5394 (3) l√† ngh·ªâ 3 ng√†y trong k·ª≥.
    </div>
    <div id="holidayDetailReport" style="display: none;">
        <h3>Chi ti·∫øt Ng√†y ngh·ªâ </h3>
        <div class="table-container">
        <table id="holidayDetailTable">
            <thead>
                </thead>
            <tbody>
                </tbody>
        </table>
        </div>
    </div>

  </div>
  </form>

  <div id="adminSettings" class="admin-settings">
    <h3>‚öôÔ∏è C√†i ƒë·∫∑t ng√†y m·ªëc </h3>
    <label>Ng√†y ƒë·∫ßu tu·∫ßn:
      <select id="weekDayStart">
        <option value="0">Ch·ªß nh·∫≠t</option>
        <option value="1">Th·ª© 2</option>
        <option value="2">Th·ª© 3</option>
        <option value="3">Th·ª© 4</option>
        <option value="4">Th·ª© 5</option>
        <option value="5">Th·ª© 6</option>
        <option value="6">Th·ª© 7</option>
      </select>
    </label>
    <label>Ng√†y ƒë·∫ßu th√°ng:
      <select id="monthDayStart"></select>
    </label>
    <label>Ng√†y cu·ªëi k·ª≥ ph√≠:
      <select id="billingDayStart"></select>
    </label>
    <label>Ng√†y ƒë·∫ßu nƒÉm:
      <select id="yearDayStart"></select>
    </label>
    <button id="saveConfig"> L∆∞u </button>

    <h3>‚öôÔ∏è Danh s√°ch th√™m c√¥ng ty th·ªß c√¥ng</h3>
    <div id="masterListManager">
      <input type="text" id="companyNameInput" placeholder="Nh·∫≠p t√™n c√¥ng ty (v√≠ d·ª•: Nanoco)" style="width: 250px; margin-right: 5px;">
      <button id="addCompanyBtn">+</button>
      <button id="removeCompanyBtn">-</button>
      <div id="currentMasterList" style="margin-top: 10px; font-size: 0.9em;">
        Danh s√°ch hi·ªán t·∫°i: ƒêang t·∫£i...
      </div>
      <p>(Master List d√πng ƒë·ªÉ hi·ªÉn th·ªã c√¥ng ty ch∆∞a c√≥ ch·ªâ s·ªë. Th√™m/X√≥a b·∫±ng c√°ch nh·∫≠p t√™n c√¥ng ty +/-).</p>
    </div>
    <h3>‚öôÔ∏è C√†i ƒë·∫∑t H·ªá s·ªë nh√¢n kho√°n (M·∫∑c ƒë·ªãnh: 0)</h3>
    <div id="quotaMultipliersSetting"></div>  
  </div>

<div id="configModal" class="modal">
  <div class="modal-content-config">
    <span class="close-btn">&times;</span>
    <h2>Th√¥ng tin C·∫•u h√¨nh v√† D·ªØ li·ªáu ƒê·∫∑c bi·ªát</h2>
    <div id="configModalContent">
      <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
  </div>
</div>
<div id="footer-placeholder"></div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
import { doc, getDoc, deleteDoc, addDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import {listenReports, listenCollection, onAuth, getRole, db, showLoading, hideLoading, showSwal, showConfirmSwal, getReportsByDate} from "./script.js";
import { initMenu } from "./menu.js";



// ===============================================
// üî• LOGIC CHO MODAL TH√îNG TIN C·∫§U H√åNH
// ===============================================
// =========================================================================
// H√ÄM T·∫¢I D·ªÆ LI·ªÜU C·∫§U H√åNH (S·ª≠ d·ª•ng 2 ngu·ªìn Firestore)
// =========================================================================
async function fetchReportConfigData() {
    try {
        // =======================================================
        // 1. Ch·ªâ s·ªë ƒê·∫∑c bi·ªát (reports_1) - H·ª£p nh·∫•t 3 ti√™u ch√≠ OR
        // =======================================================

        // 1a. Ch·ªâ s·ªë Reset (isMeterReset=true)
        const q1a = query(collection(db, "reports_1"), where("isMeterReset", "==", true));
        const snap1a = await getDocs(q1a);

        // 1b. Ch·ªâ s·ªë B·∫±ng 0 (chi_so=0)
        // L∆∞u √Ω: ƒê·∫£m b·∫£o tr∆∞·ªùng 'chi_so' t·ªìn t·∫°i v√† l√† ki·ªÉu s·ªë
        const q1b = query(collection(db, "reports_1"), where("chi_so", "==", 0));
        const snap1b = await getDocs(q1b);
        
        // 1c. Ch·ªâ s·ªë Kh·ªüi t·∫°o t·ª± ƒë·ªông (ghi_chu="Chi so khoi tao tu dong (Auto-Init)")
        const q1c = query(collection(db, "reports_1"), where("ghi_chu", "==", "Chi so khoi tao tu dong (Auto-Init)"));
        const snap1c = await getDocs(q1c);
        
        // H·ª£p nh·∫•t k·∫øt qu·∫£ t·ª´ 3 truy v·∫•n v√† lo·∫°i b·ªè tr√πng l·∫∑p d·ª±a tr√™n document ID
        const allSnapDocs = [...snap1a.docs, ...snap1b.docs, ...snap1c.docs];
        const uniqueDocs = [];
        const docIds = new Set();

        allSnapDocs.forEach(d => {
            if (!docIds.has(d.id)) {
                docIds.add(d.id);
                uniqueDocs.push(d);
            }
        });
        
        const specialIndexes = uniqueDocs.map(d => ({ 
            id: d.id, 
            ...d.data(), 
            // ƒê·ªãnh d·∫°ng ng√†y t·∫°o h·ªá th·ªëng
            date: d.data().createdAt ? d.data().createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'
        }));

        // =======================================================
        // 2. Ng√†y l√†m vi·ªác ƒê·∫∑c bi·ªát (reports_2: isSpecialWorkday=true)
        // =======================================================
        const q2 = query(collection(db, "reports_2"), where("isSpecialWorkday", "==", true));
        const snap2 = await getDocs(q2);
        const specialWorkdays = snap2.docs.map(d => ({ 
            id: d.id, 
            ...d.data(),
            date: d.data().createdAt ? d.data().createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'
        }));

        // =======================================================
        // 3. T·∫£i C√†i ƒë·∫∑t C·∫•u h√¨nh (settings & config)
        // =======================================================

        // 3a. L·∫•y defaultHolidays t·ª´ settings/reportConfig
        const settingsHolidayRef = doc(db, "settings", "reportConfig");
        const settingsHolidaySnap = await getDoc(settingsHolidayRef);
        const settingsConfig = settingsHolidaySnap.exists() ? settingsHolidaySnap.data() : {};
        const defaultHolidays = settingsConfig.defaultHolidays || {};

        // 3b. L·∫•y startDaySettings v√† quotaMultipliers t·ª´ config/reportConfig
        const configRef = doc(db, "config", "reportConfig"); 
        const configSnap = await getDoc(configRef);
        const configData = configSnap.exists() ? configSnap.data() : {};

        const quotaMultipliers = configData.quotaMultipliers || {}; 

        const startDaySettings = {
            weekDayStart: configData.weekDayStart !== undefined ? configData.weekDayStart : 'Ch∆∞a c√†i ƒë·∫∑t',
            monthDayStart: configData.monthDayStart !== undefined ? configData.monthDayStart : 'Ch∆∞a c√†i ƒë·∫∑t',
            yearDayStart: configData.yearDayStart !== undefined ? configData.yearDayStart : 'Ch∆∞a c√†i ƒë·∫∑t',
            billingDayStart: configData.billingDayStart !== undefined ? configData.billingDayStart : 'Ch∆∞a c√†i ƒë·∫∑t',
        };
        
        return {
            specialIndexes,
            specialWorkdays,
            defaultHolidays, 
            startDaySettings, 
            quotaMultipliers 
        };

    } catch (error) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu c·∫•u h√¨nh:", error);
        // showSwal l√† h√†m gi·∫£ ƒë·ªãnh hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        showSwal("error", "L·ªói khi t·∫£i d·ªØ li·ªáu c·∫•u h√¨nh: " + error.message);
        return null;
    }
}

// =========================================================================
// H√ÄM RENDER MODAL (Gi·ªØ nguy√™n c·∫•u tr√∫c M·ª•c 1, 2, 3, 4)
// =========================================================================
function renderConfigModal(data) {
    const contentDiv = document.getElementById('configModalContent');
    if (!data) {
        contentDiv.innerHTML = '<p style="color:red;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c·∫•u h√¨nh. Vui l√≤ng ki·ªÉm tra console.</p>';
        return;
    }

    let html = '';

    // =======================================================
    // 1. Ch·ªâ s·ªë ƒë·∫∑c bi·ªát (ƒê√£ c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ m√¥ t·∫£ logic OR)
    // =======================================================
    html += '<div class="modal-section">';
    html += '<h4>1. Ch·ªâ s·ªë ƒê·∫∑c bi·ªát (reports_1: isMeterReset=true **HO·∫∂C chi_so=0 HO·∫∂C ghi_chu="Auto-Init"**)</h4>';
    if (data.specialIndexes.length > 0) {
        html += '<table><thead><tr><th>T√™n C√¥ng ty</th><th>Ch·ªâ s·ªë</th><th>Ng√†y ghi (B√°o c√°o)</th><th>Ng√†y t·∫°o (H·ªá th·ªëng)</th><th>Ghi ch√∫</th></tr></thead><tbody>';
        data.specialIndexes.forEach(item => {
            html += `<tr>
                        <td>${item.company || item.c_ty || 'N/A'}</td>
                        <td>${item.chi_so !== undefined ? item.chi_so.toLocaleString('vi-VN') : 'N/A'}</td>
                        <td>${item.ngay_ghi || 'N/A'}</td>
                        <td>${item.date}</td>
                        <td>${item.ghi_chu || item.note || ''}</td>
                    </tr>`;
        });
        html += '</tbody></table>';
    } else {
        html += '<p>Kh√¥ng c√≥ ch·ªâ s·ªë ƒë·∫∑c bi·ªát n√†o.</p>';
    }
    html += '</div>';

    // =======================================================
    // 2. Ng√†y l√†m vi·ªác ƒë·∫∑c bi·ªát (reports_2: isSpecialWorkday=true)
    // =======================================================
    html += '<div class="modal-section">';
    html += '<h4>2. Ng√†y l√†m vi·ªác ƒê·∫∑c bi·ªát (reports_2: isSpecialWorkday=true)</h4>';
    if (data.specialWorkdays.length > 0) {
        html += '<table><thead><tr><th>T√™n C√¥ng ty</th><th>Ng√†y l√†m vi·ªác ƒë·∫∑c bi·ªát (B√°o c√°o)</th><th>Ng√†y t·∫°o (H·ªá th·ªëng)</th><th>Ghi ch√∫</th></tr></thead><tbody>';
        data.specialWorkdays.forEach(item => {
            html += `<tr>
                        <td>${item.company || item.c_ty || 'N/A'}</td>
                        <td>${item.ngay_lam_db || 'N/A'}</td> 
                        <td>${item.date}</td>
                        <td>${item.ghi_chu || item.note || ''}</td>
                    </tr>`;
        });
        html += '</tbody></table>';
    } else {
        html += '<p>Kh√¥ng c√≥ ng√†y l√†m vi·ªác ƒë·∫∑c bi·ªát n√†o.</p>';
    }
    html += '</div>';

    // =======================================================
    // 3. C√°c c√†i ƒë·∫∑t Ng√†y ƒê·∫ßu K·ª≥
    // =======================================================
    html += '<div class="modal-section">';
    html += '<h4>3. C√°c C√†i ƒë·∫∑t Ng√†y ƒê·∫ßu K·ª≥</h4>';
    const dayNames = ["Ch·ªß nh·∫≠t", "Th·ª© 2", "Th·ª© 3", "Th·ª© 4", "Th·ª© 5", "Th·ª© 6", "Th·ª© 7"];
    html += '<table><tbody>';
    html += `<tr><th>Ng√†y ƒê·∫ßu Tu·∫ßn (weekDayStart)</th><td>${dayNames[data.startDaySettings.weekDayStart] || data.startDaySettings.weekDayStart}</td></tr>`;
    html += `<tr><th>Ng√†y ƒê·∫ßu Th√°ng (monthDayStart)</th><td>Ng√†y ${data.startDaySettings.monthDayStart}</td></tr>`;
    html += `<tr><th>Ng√†y ƒê·∫ßu NƒÉm (yearDayStart)</th><td>Ng√†y ${data.startDaySettings.yearDayStart}</td></tr>`;
    html += `<tr><th>Ng√†y Cu·ªëi K·ª≥ Thu Ph√≠ (billingDayStart)</th><td>Ng√†y ${data.startDaySettings.billingDayStart}</td></tr>`;
    html += '</tbody></table>';
    html += '</div>';
    
    // =======================================================
    // 4. Ng√†y ngh·ªâ M·∫∑c ƒë·ªãnh & H·ªá s·ªë Kho√°n (H·ª£p nh·∫•t t·ª´ 2 ngu·ªìn)
    // =======================================================
    html += '<div class="modal-section">';
    html += '<h4>4. Ng√†y ngh·ªâ M·∫∑c ƒë·ªãnh & H·ªá s·ªë Kho√°n theo C√¥ng ty</h4>';

    const holidayMap = {
        'none': ' ',
        'sun': 'Ch·ªß nh·∫≠t',
        'sat': 'Th·ª© 7',
        'sat-sun': 'Th·ª© 7 & CN',
        'N/A': 'Ch∆∞a c√†i ƒë·∫∑t' 
    };

    // L·∫•y danh s√°ch t·∫•t c·∫£ c√°c c√¥ng ty t·ª´ c·∫£ hai ƒë·ªëi t∆∞·ª£ng
    const allCompanies = new Set([
        ...Object.keys(data.defaultHolidays),
        ...Object.keys(data.quotaMultipliers)
    ]);
    
    // S·∫Øp x·∫øp danh s√°ch c√¥ng ty
    const sortedCompanies = Array.from(allCompanies).sort();

    const configList = sortedCompanies.map(company => {
        // X·ª≠ l√Ω Ng√†y ngh·ªâ M·∫∑c ƒë·ªãnh (t·ª´ settings/reportConfig)
        const holidayCode = data.defaultHolidays[company] || 'N/A';
        const holidayDisplay = holidayMap[holidayCode] || 'M√£ kh√¥ng h·ª£p l·ªá';

        // X·ª≠ l√Ω H·ªá s·ªë Kho√°n (t·ª´ config/reportConfig)
        const quotaValue = data.quotaMultipliers[company] !== undefined 
                             ? data.quotaMultipliers[company] 
                             : 'Ch∆∞a c√†i ƒë·∫∑t';

        return `<tr>
                    <td>${company}</td>
                    <td>${holidayDisplay}</td>
                    <td>${quotaValue}</td>
                </tr>`;
    }).join('');

    if (configList) {
        html += '<table><thead><tr><th>T√™n C√¥ng ty</th><th>Ng√†y ngh·ªâ M·∫∑c ƒë·ªãnh</th><th>H·ªá s·ªë Kho√°n (m3/ng√†y.ƒë√™m)</th></tr></thead><tbody>';
        html += configList;
        html += '</tbody></table>';
    } else {
        html += '<p>Ch∆∞a c√†i ƒë·∫∑t c·∫•u h√¨nh ng√†y ngh·ªâ ho·∫∑c h·ªá s·ªë kho√°n cho c√¥ng ty n√†o.</p>';
    }
    html += '</div>';
    
    contentDiv.innerHTML = html;
}
// =========================================================================
// H√ÄM KH·ªûI T·∫†O MODAL (Gi·ªØ nguy√™n)
// =========================================================================
function setupConfigModal() {
    const modal = document.getElementById('configModal');
    const btn = document.getElementById('openConfigModal');
    const span = document.getElementsByClassName("close-btn")[0];
    const contentDiv = document.getElementById('configModalContent');

    if (btn) {
        btn.onclick = async () => {
            modal.style.display = "block";
            contentDiv.innerHTML = '<p>ƒêang t·∫£i d·ªØ li·ªáu...</p>'; // Reset content
            const data = await fetchReportConfigData();
            renderConfigModal(data);
        }
    }

    if (span) {
        span.onclick = () => {
            modal.style.display = "none";
        }
    }

    window.onclick = (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
}
//


// load menu
    fetch("menu.html").then(r => r.text()).then(h => {
      document.getElementById("menu-placeholder").innerHTML = h;
      if (typeof initMenu === "function") initMenu();
    });    

// load modal loading
    fetch("modal.html").then(r => r.text()).then(h => {
      document.getElementById("loading-placeholder").innerHTML = h;
    });
// T·∫¢I FOOTER (th√™m ƒëo·∫°n n√†y v√†o)
    fetch("footer.html").then(r => r.text()).then(h => {
        document.getElementById("footer-placeholder").innerHTML = h;
    });
    const notLogged = document.getElementById("notLogged");
    const content   = document.getElementById("pageContent");
    const tbody     = document.querySelector("#reportTable tbody");
    const quotaMultipliersSettingDiv = document.getElementById("quotaMultipliersSetting");
    
    // M·ªöI: DOM ref cho b·∫£ng chi ti·∫øt ng√†y ngh·ªâ
    const holidayDetailReportDiv = document.getElementById('holidayDetailReport');
    const holidayDetailTableBody = document.querySelector('#holidayDetailTable tbody');
    const holidayDetailTableHead = document.querySelector('#holidayDetailTable thead');

    let userRole = null;

    // DOM refs
    const theadRow = document.querySelector("#reportTable thead tr");
    const note = document.getElementById("filterNote");

    // DOM refs cho b·ªô l·ªçc
    const fromInput = document.getElementById("fromDate");
    const toInput = document.getElementById("toDate");
    const yearSelect = document.getElementById("yearSelect");
    const applyFilterBtn = document.getElementById("applyFilter");
    const companyGroupFilter = document.getElementById('companyGroupFilter'); 
    
    // DOM ref cho c√¥ng t·∫Øc 3 n·∫•c
    const reportModeToggle = document.getElementById('reportModeToggle');


    // data & config
    let allReports = []; 
    let allHolidayRecords = []; 
    let allProcessedHolidays = {}; 
    let currentFilter = { from: null, to: null };
    let config = { weekDayStart: 0, monthDayStart: 1, billingDayStart: 1, yearDayStart: 1, quotaMultipliers: {} }; 
    let isInitialLoad = true;
    
    let unsubscribeReports1 = null; // Bi·∫øn l∆∞u listener ƒë·ªÉ h·ªßy khi c·∫ßn
    // M·ªöI: Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu chi ti·∫øt ng√†y ngh·ªâ (khi Mode 2 b·∫≠t)
    let allHolidayDetails = { week: [], month: [], billing: [], year: [] }; 

    
    // === MASTER LIST NEW VARIABLES ===
    let allMasterCompanies = [];
    const companyNameInput = document.getElementById("companyNameInput");
    const addCompanyBtn = document.getElementById("addCompanyBtn");
    const removeCompanyBtn = document.getElementById("removeCompanyBtn");
    const currentMasterListDiv = document.getElementById("currentMasterList");
    // === END MASTER LIST NEW VARIABLES ===
    
    // === START: LOGIC L·ªåC THEO NH√ìM C√îNG TY (L·ªçc theo C·ªòT) ===
    const COMPANY_GROUPS = {
        'group1': ['NTSF', '·∫§n ƒê·ªô D∆∞∆°ng', 'ƒê·∫°i T√¢y D∆∞∆°ng', 'Amicogen', 'C√° Vi·ªát Nam' ], 
        'group2': ['VNPT', 'Hi·ªáp Ph√∫', 'Honoroad', 'Tr∆∞·ªùng H·∫£i', 'Petec', 'T√¢n C·∫£ng'], 
        'all': ['NTSF', '·∫§n ƒê·ªô D∆∞∆°ng', 'ƒê·∫°i T√¢y D∆∞∆°ng', 'C√° Vi·ªát Nam', 'Amicogen', 'VNPT', 'Hi·ªáp Ph√∫', 'Honoroad', 'Tr∆∞·ªùng H·∫£i', 'Petec', 'T√¢n C·∫£ng'] 
    };
    
    /**
     * L·ªçc c√°c c·ªôt c·ªßa b·∫£ng chi ti·∫øt ng√†y ngh·ªâ #holidayDetailTable
     */
    function filterHolidayDetailTableByCompanyGroup(companies) {
        const filterSelect = document.getElementById('companyGroupFilter');
        const detailTable = document.getElementById('holidayDetailTable') 
                        || document.getElementById('holidayDetailReport');
        
        // ‚úÖ N·∫øu kh√¥ng c√≥ filterSelect ho·∫∑c b·∫£ng chi ti·∫øt ‚Üí tho√°t ngay
        if (!filterSelect || !detailTable) {
            return;
        }

        const selectedGroup = filterSelect.value;
        const allowedCompanies = COMPANY_GROUPS[selectedGroup] 
            ? COMPANY_GROUPS[selectedGroup].map(c => c.toUpperCase()) 
            : [];

        const theadRow = detailTable.querySelector("thead tr");
        if (!theadRow) return; // th√™m check an to√†n

        const tbodyRows = detailTable.querySelectorAll("tbody tr");
        const companyHeaders = Array.from(theadRow.querySelectorAll('th'));
        const columnVisibility = [true]; // C·ªôt ƒë·∫ßu ti√™n (K·ª≥) lu√¥n hi·ªán

        companyHeaders.slice(1).map(th => th.textContent.trim().toUpperCase())
            .forEach(name => {
                const isAllowed = allowedCompanies.includes(name);
                columnVisibility.push(isAllowed);
            });

        // ·∫®n/Hi·ªán c·ªôt trong THEAD
        companyHeaders.forEach((th, index) => {
            if (index > 0) { 
                th.style.display = columnVisibility[index] ? '' : 'none';
            }
        });

        // ·∫®n/Hi·ªán c·ªôt trong TBODY
        tbodyRows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            if (cells.length === 1) return; 
            cells.forEach((td, index) => {
                if (index > 0) { 
                    td.style.display = columnVisibility[index] ? '' : 'none';
                }
            });
        });
    }



    /**
     * L·ªçc c√°c c·ªôt c·ªßa b·∫£ng #reportTable d·ª±a tr√™n nh√≥m c√¥ng ty ƒë√£ ch·ªçn.
     */
    function filterReportByCompanyGroup() {
        const filterSelect = document.getElementById('companyGroupFilter');
        const reportTable = document.getElementById('reportTable');
        
        if (!filterSelect || !reportTable) return;
        
        const selectedGroup = filterSelect.value;
        const allowedCompanies = COMPANY_GROUPS[selectedGroup] ? COMPANY_GROUPS[selectedGroup].map(c => c.toUpperCase()) : [];

        const theadRow = document.querySelector("#reportTable thead tr");
        const tbodyRows = document.querySelectorAll("#reportTable tbody tr");

        // 1. L·∫•y t√™n c√¥ng ty t·ª´ TH v√† x√°c ƒë·ªãnh kh·∫£ nƒÉng hi·ªÉn th·ªã c·ªßa t·ª´ng c·ªôt
        const companyHeaders = Array.from(theadRow.querySelectorAll('th'));
        const columnVisibility = [true]; // C·ªôt ƒë·∫ßu ti√™n (L∆∞u l∆∞·ª£ng) lu√¥n hi·ªán

        const companies = companyHeaders.slice(1).map(th => th.textContent.trim().toUpperCase());
        companies.forEach(name => {
            const isAllowed = allowedCompanies.includes(name);
            columnVisibility.push(isAllowed);
        });

        // 2. ·∫®n/Hi·ªán c·ªôt trong THEAD
        companyHeaders.forEach((th, index) => {
            if (index > 0) { 
                th.style.display = columnVisibility[index] ? '' : 'none';
            }
        });

        // 3. ·∫®n/Hi·ªán c·ªôt trong TBODY
        tbodyRows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            cells.forEach((td, index) => {
                if (index > 0) { 
                    td.style.display = columnVisibility[index] ? '' : 'none';
                }
            });
        });
        
        // 4. L·ªçc b·∫£ng chi ti·∫øt ng√†y ngh·ªâ (n·∫øu c√≥)
        filterHolidayDetailTableByCompanyGroup(companies);


        console.log(`LOG: ƒê√£ √°p d·ª•ng b·ªô l·ªçc nh√≥m c√¥ng ty: ${selectedGroup}.`);
    }
    // === END: LOGIC L·ªåC THEO NH√ìM C√îNG TY ===
    if (getReportMode() === 2) {
        filterHolidayDetailTableByCompanyGroup();
    }

    // populate month/year/billing selects
    const monthSel = document.getElementById("monthDayStart");
    for (let i=1;i<=28;i++) monthSel.innerHTML += `<option value="${i}">${i}</option>`;

    const billingSel = document.getElementById("billingDayStart"); 
    for (let i=1;i<=31;i++) billingSel.innerHTML += `<option value="${i}">${i}</option>`;

    const yearSel = document.getElementById("yearDayStart");
    for (let i=1;i<=31;i++) yearSel.innerHTML += `<option value="${i}">${i}</option>`;

    // ** FIX L·ªñI TOGGLE: EVENT DELEGATION **
    tbody.addEventListener('click', (e) => {
        const toggleBtn = e.target.closest(".toggle-btn");
        if (!toggleBtn) return;
        
        e.stopPropagation();

        const mainRow = toggleBtn.closest("tr.main-row");
        if (!mainRow) return;

        const target = mainRow.dataset.target;
        const childRows = document.querySelectorAll(`tr[data-parent="${target}"]`);
        
        const isCurrentlyOpen = childRows[0] && childRows[0].style.display === "table-row"; 
        const isNowOpen = !isCurrentlyOpen; 

        childRows.forEach(row => {
            row.style.display = isNowOpen ? "table-row" : "none";
        });

        toggleBtn.textContent = isNowOpen ? "‚ñº" : "‚ñ∂";
    });
    // ** K·∫æT TH√öC FIX L·ªñI TOGGLE **
    
    // LOGIC TOGGLE CHO B·∫¢NG CHI TI·∫æT NG√ÄY NGH·ªà (ƒê·ªíNG B·ªò V·ªöI VISIBLE COUNTS)
    const HOLIDAY_DEFAULT_VISIBLE = { week: 5, month: 2, billing: 2, year: 0 };

    holidayDetailTableBody.addEventListener('click', (e) => {
    const toggleBtn = e.target.closest(".toggle-btn");
    if (!toggleBtn) return;
    e.stopPropagation();

    const targetId = toggleBtn.dataset.targetId;
    if (!targetId) return;

    const childRows = document.querySelectorAll(`tr[data-parent-id="${targetId}"]`);
    if (!childRows || childRows.length === 0) return;

    const isCurrentlyClosed = (toggleBtn.textContent.trim() === '‚ñ∂'); // ‚ñ∂ nghƒ©a l√† ƒëang g·ªçn, b·∫•m ƒë·ªÉ m·ªü

    if (isCurrentlyClosed) {
        // M·ªü: hi·ªán t·∫•t c·∫£ c√°c h√†ng
        childRows.forEach(row => row.style.display = "table-row");
        toggleBtn.textContent = "‚ñº";
        return;
    }

    // ƒê√≥ng: hi·ªÉn th·ªã l·∫°i theo quy t·∫Øc m·∫∑c ƒë·ªãnh cho t·ª´ng lo·∫°i
    const typeKey = targetId.replace("toggle-detail-", ""); // => 'week' | 'month' | 'billing' | 'year'
    const visibleCount = HOLIDAY_DEFAULT_VISIBLE[typeKey] !== undefined ? HOLIDAY_DEFAULT_VISIBLE[typeKey] : childRows.length;

    childRows.forEach((row, index) => {
        if (index < visibleCount) {
        row.style.display = "table-row";
        } else {
        row.style.display = "none";
        }
    });

    toggleBtn.textContent = "‚ñ∂";
    });

    // ** K·∫æT TH√öC LOGIC TOGGLE CHI TI·∫æT NG√ÄY NGH·ªà **

    // ========== UTILS ==========
    function formatISODate(d) {
      if (!(d instanceof Date) || isNaN(d)) return null;
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function formatVNDate(d) {
      if (!(d instanceof Date) || isNaN(d)) return "N/A";
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      return `${dd}/${mm}`;
    }
    function safeFixed(val, digits = 1) { 
      return (typeof val === "number" && !isNaN(val)) ? val.toFixed(digits) : "N/A";
    }
    
    // H√ÄM 1: FORMAT NG√ÄY NGH·ªà CHO TOOLTIP (s·ª≠ d·ª•ng &#10;)
    function formatHolidayDates(dateStrings) {
        if (!dateStrings || dateStrings.length === 0) return '';
        
        dateStrings.sort((a, b) => new Date(a) - new Date(b));

        return "C√°c ng√†y ngh·ªâ:\n" + dateStrings.map(isoDate => {
            const parts = isoDate.split('-');
            const day = parts[2];
            const month = parts[1];
            const year = parts[0];
            return `${day}/${month}/${year}`; 
        }).join('&#10;');
    }
    
    // H√ÄM 2: FORMAT NG√ÄY NGH·ªà CHO CELL (s·ª≠ d·ª•ng <br>)
    function formatHolidayDatesInline(dateStrings) {
        if (!dateStrings || dateStrings.length === 0) return 'Kh√¥ng ngh·ªâ';
        
        dateStrings.sort((a, b) => new Date(a) - new Date(b));

        return dateStrings.map(isoDate => {
            const parts = isoDate.split('-');
            const day = parts[2];
            const month = parts[1];
            const year = parts[0];
            return `${day}/${month}/${year}`; 
        }).join('<br>');
    }

    function getWeekStart(date, weekDayStart) {
      const d = new Date(date);
      const diff = (d.getDay() - weekDayStart + 7) % 7;
      d.setDate(d.getDate() - diff);
      d.setHours(0,0,0,0);
      return d;
    }
    function getMonthStart(date, monthDayStart) {
      const d = new Date(date.getFullYear(), date.getMonth(), monthDayStart);
      d.setHours(0,0,0,0);
      return d;
    }
    function getYearStart(date, yearDayStart) {
      const d = new Date(date.getFullYear(), 0, yearDayStart);
      d.setHours(0,0,0,0);
      return d;
    }

    // H√ÄM 1: Ch·ªâ l·∫•y ch√≠nh x√°c t·∫°i m·ªëc ng√†y.
    function findValueExact(readings, dateMark) {
      const dateMarkStr = formatISODate(dateMark);
      const exactReadings = readings.filter(r => formatISODate(r.date) === dateMarkStr);
      
      if (exactReadings.length === 0) return null;

      exactReadings.sort((a, b) => a.date - b.date); 
      return exactReadings[0].value;
    }

    // H√ÄM 2: L·∫•y b·∫£n ghi (object) g·∫ßn nh·∫•t TR∆Ø·ªöC HO·∫∂C ƒê√öNG M·ªêC.
    function findLatestReadingBeforeOrOnMark(readings, dateMark) {
      const pastReadings = readings.filter(r => r.date <= dateMark); 
      
      if (pastReadings.length === 0) return null;

      pastReadings.sort((a, b) => {
        if (b.date.getTime() !== a.date.getTime()) {
            return b.date - a.date;
        }
        return b.value - a.value; 
      }); 

      return pastReadings[0];
    }
    
// H√ÄM T√çNH T·ªîNG S·ªê NG√ÄY L√ÄM VI·ªÜC (TR·∫¢ V·ªÄ OBJECT CH·ª®A WORKING DAYS, DAY OFFS V√Ä DAY OFF DATES)
function calculateWorkingDays(startDate, endDate, companyName, config, processedHolidayData) {
    const safeCompany = (typeof companyName === 'string') ? companyName.trim() : companyName;

    if (!startDate || !endDate || startDate > endDate) {
        console.log(`LOG: calculateWorkingDays - invalid range for ${safeCompany}`);
        return { workingDays: 0, dayOffsCount: 0, dayOffDates: [] }; 
    }

    const companyHolidays = (processedHolidayData && processedHolidayData[safeCompany]) 
                                ? processedHolidayData[safeCompany] 
                                : { dayOffs: new Set(), specialWorkdays: new Set() };

    let totalDaysInPeriod = 0;
    let specialDayOffs = 0; 
    const dayOffDates = []; 

    const endRange = new Date(endDate);
    endRange.setHours(23, 59, 59, 999);

    let currentDay = new Date(startDate);
    currentDay.setHours(0,0,0,0);

    while (currentDay <= endRange) {
        const currentDayStr = (function(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; })(currentDay);

        totalDaysInPeriod++;

        // n·∫øu reports_2 ghi ng√†y ngh·ªâ th√¨ lu√¥n t√≠nh l√† ngh·ªâ
        if (companyHolidays.dayOffs && companyHolidays.dayOffs.has(currentDayStr)) {
            specialDayOffs++;
            dayOffDates.push(currentDayStr);
        }

        currentDay.setDate(currentDay.getDate() + 1);
    }

    // t√≠nh net = t·ªïng - ngh·ªâ ƒë·∫∑c bi·ªát (M·∫∑c ƒë·ªãnh m·ªçi ng√†y l√† ng√†y l√†m vi·ªác)
    let netWorkingDays = totalDaysInPeriod - specialDayOffs;

    // logic tr·ª´ 1 ƒë·ªÉ ƒë·∫øm kho·∫£ng (gi·ªØ nguy√™n logic c≈©)
    if (netWorkingDays > 0) netWorkingDays -= 1;

    // TR·∫¢ V·ªÄ OBJECT CH·ª®A K·∫æT QU·∫¢
    return { workingDays: netWorkingDays, dayOffsCount: specialDayOffs, dayOffDates };
}


    // ========== H√ÄM CHUNG CHO TU·∫¶N/TH√ÅNG/NƒÇM (NH√ìM 1) ==========
    function getPeriodsInFilter(readings, from, to, type, config, processedHolidayData, companyName) {
      const today = new Date(); 
      today.setHours(23, 59, 59, 999); 
      
      let stepFn, getStartFn;
      if (type === "week") {
        stepFn = d => { const nd = new Date(d); nd.setDate(nd.getDate() + 7); return nd; };
        getStartFn = d => getWeekStart(d, config.weekDayStart);
      } else if (type === "month") {
        stepFn = d => { const nd = new Date(d); nd.setMonth(nd.getMonth() + 1); return nd; };
        getStartFn = d => getMonthStart(d, config.monthDayStart);
      } else {
        stepFn = d => { const nd = new Date(d); nd.setFullYear(nd.getFullYear() + 1); return nd; };
        getStartFn = d => getYearStart(d, config.yearDayStart);
      }

      const periods = [];
      let cursor = new Date(from);
      while (cursor <= to) {
        const start = getStartFn(cursor);
        const end = stepFn(start);
        if (end > from && start <= to) periods.push({ start, end });
        cursor = end;
      }

      const uniq = [];
      const seen = new Set();
      for (const p of periods) {
        const key = formatISODate(p.start);
        if (!seen.has(key)) { uniq.push(p); seen.add(key); }
      }
      uniq.sort((a,b) => b.start - a.start);

      const currentStart = getStartFn(new Date()); 
      const current = uniq.find(p => formatISODate(p.start) === formatISODate(currentStart));
      const result = { current: null, past: [] };


      for (const p of uniq) {
        const isCurrent = current && formatISODate(p.start) === formatISODate(current.start);
        
        const endMarkDate = p.end; 
        
        let startValue, endValue, latestDataDate = null;
        let workingDaysForAvg = 0; 
        let dayOffsCount = 0;      
        let dayOffDates = [];      
        let label = "";
        
        // 1. START VALUE
        startValue = findValueExact(readings, p.start);

        if (isCurrent) {
            // 2A. END VALUE: K·ª≥ HI·ªÜN T·∫†I
            const latestReading = findLatestReadingBeforeOrOnMark(readings, today);

            endValue = latestReading ? latestReading.value : null;
            latestDataDate = latestReading ? latestReading.date : null;

            // --- T√çNH TO√ÅN NG√ÄY L√ÄM VI·ªÜC & NG√ÄY NGH·ªà ---
            
            // 1. T√çNH WORKING DAYS CH·ªà ƒê·∫æN latestDataDate (D√πng cho AVG)
            if (latestDataDate) {
                const avgResult = calculateWorkingDays(p.start, latestDataDate, companyName, config, processedHolidayData);
                workingDaysForAvg = avgResult.workingDays; 
            }

            // 2. T√çNH DAY OFF LU√îN ƒê·∫æN H√îM NAY (D√πng ƒë·ªÉ hi·ªÉn th·ªã)
            const dayOffsResult = calculateWorkingDays(p.start, today, companyName, config, processedHolidayData);
            dayOffsCount = dayOffsResult.dayOffsCount; 
            dayOffDates = dayOffsResult.dayOffDates;   

        } else {
            // 2B. END VALUE: K·ª≥ QU√Å KH·ª®
            endValue = findValueExact(readings, endMarkDate);
            
            // 3B. T√çNH S·ªê NG√ÄY L√ÄM VI·ªÜC (ƒê·∫øn ng√†y tr∆∞·ªõc ng√†y b·∫Øt ƒë·∫ßu k·ª≥ ti·∫øp theo)
            const dayBeforeEndMark = new Date(endMarkDate.getTime()); 
            
            // üî• CH·ªàNH S·ª¨A ·ªû ƒê√ÇY: Tr·ª´ ƒëi M·ªòT NG√ÄY (86400000ms = 1 ng√†y)
            dayBeforeEndMark.setTime(dayBeforeEndMark.getTime() - 86400000); // L√πi 1 ng√†y
            
            const pastResult = calculateWorkingDays(p.start, dayBeforeEndMark, companyName, config, processedHolidayData); 
            
            workingDaysForAvg = pastResult.workingDays;
            dayOffsCount = pastResult.dayOffsCount; 
            dayOffDates = pastResult.dayOffDates;    
        }
        
        // T·∫°o nh√£n
        if (isCurrent) {
          label = type === "week" ? "Tu·∫ßn hi·ªán t·∫°i" : type === "month" ? "Th√°ng hi·ªán t·∫°i" : "NƒÉm hi·ªán t·∫°i";
        } else {
          label = type === "week" ? `Tu·∫ßn: ${formatVNDate(p.start)} - ${formatVNDate(p.end)}` : type === "month" ? `Th√°ng: ${formatVNDate(p.start)} - ${formatVNDate(p.end)}` : `NƒÉm: ${formatVNDate(p.start)} - ${formatVNDate(p.end)}`;
        }

        
        let numericTotal = "N/A";
        
        if (startValue !== null && endValue !== null) {
            let diff = endValue - startValue;
            if (diff < 0) diff = 0; 
            numericTotal = diff; 
        } 
        
        const avg = (typeof numericTotal === "number" && workingDaysForAvg > 0) ? safeFixed(numericTotal/workingDaysForAvg,1) : "N/A";


        if (isCurrent) {
          result.current = { label, total: safeFixed(numericTotal,1), avg, start: p.start, end: p.end, latestDataDate, dayOffsCount, holidayDates: dayOffDates }; 
        } else {
          result.past.push({ label, total: safeFixed(numericTotal,1), avg, start: p.start, end: p.end, latestDataDate, dayOffsCount, holidayDates: dayOffDates }); 
        }
      }

      if (!result.current) {
        result.current = {
          label: type==="week"?"T·ªïng tu·∫ßn hi·ªán t·∫°i":type==="month"?"T·ªïng th√°ng hi·ªán t·∫°i":"NƒÉm hi·ªán t·∫°i",
          total:"N/A", avg:"N/A", dayOffsCount: 0, holidayDates: [] 
        };
      }
      return result;
    }

// ========== H√ÄM CHO K·ª≤ THU PH√ç (BILLING) (NH√ìM 2) ==========
function getBillingPeriodsInFilter(readings, from, to, config, processedHolidayData, companyName) {
    const today = new Date();
    today.setHours(23, 59, 59, 999);
    
    // L·∫•y H·ªá s·ªë nh√¢n kho√°n
    const QUOTA_MULTIPLIER = config.quotaMultipliers[companyName] !== undefined ? Number(config.quotaMultipliers[companyName]) : 0;

    // 1. H√ÄM X√ÅC ƒê·ªäNH NG√ÄY B·∫ÆT ƒê·∫¶U K·ª≤ TI·∫æP THEO (Revert v·ªÅ logic ban ƒë·∫ßu: 16/09 -> 16/10)
    const stepFn = start => { 
        const end = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 0, 0, 0, 0);
        end.setMonth(end.getMonth() + 1);
        return end;
    };

    // 2. H√ÄM X√ÅC ƒê·ªäNH NG√ÄY B·∫ÆT ƒê·∫¶U K·ª≤ HI·ªÜN T·∫†I (ƒê√£ s·ª≠a ƒë·ªïi ƒë·ªÉ 15 l√† ng√†y cu·ªëi k·ª≥)
    const getStartFn = d => {
        const endDay = config.billingDayStart; // V√≠ d·ª•: 15
        
        // A. X√°c ƒë·ªãnh ng√†y k·∫øt th√∫c k·ª≥ (end): L√† ng√†y 15 c·ªßa th√°ng hi·ªán t·∫°i (d)
        let end = new Date(d.getFullYear(), d.getMonth(), endDay, 0, 0, 0, 0);

        // B. N·∫øu ng√†y tham chi·∫øu (d) n·∫±m sau ng√†y 15, th√¨ k·ª≥ thu ph√≠ s·∫Ω k·∫øt th√∫c v√†o th√°ng sau.
        if (d > end) {
             end.setMonth(end.getMonth() + 1);
        }
        
        // C. Ng√†y b·∫Øt ƒë·∫ßu (start) l√† ng√†y 16 c·ªßa th√°ng tr∆∞·ªõc ng√†y k·∫øt th√∫c
        const start = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 0, 0, 0, 0);
        start.setMonth(start.getMonth() - 1); // L√πi v·ªÅ th√°ng tr∆∞·ªõc
        start.setDate(endDay + 1);            // ƒê·∫∑t ng√†y l√† 16 (15 + 1)
        
        return start;
    };
    
    // 3. V√íNG L·∫∂P T·∫†O C√ÅC K·ª≤
    const periods = [];
    let cursor = new Date(from);
    while (cursor <= to) {
        const start = getStartFn(cursor);
        const end = stepFn(start); // end l√† ng√†y 16 c·ªßa th√°ng sau
        
        if (end > from && start <= to) periods.push({ start, end });
        
        // Kh·∫Øc ph·ª•c l·ªói v√≤ng l·∫∑p v√¥ h·∫°n
        cursor = end; // D·ªãch chuy·ªÉn con tr·ªè t·ªõi ng√†y b·∫Øt ƒë·∫ßu k·ª≥ ti·∫øp theo
    }

    // ... (Gi·ªØ nguy√™n logic t·∫°o uniq, sort, current) ...
    const uniq = [];
    const seen = new Set();
    for (const p of periods) {
        const key = formatISODate(p.start);
        if (!seen.has(key)) { uniq.push(p); seen.add(key); }
    }
    uniq.sort((a,b) => b.start - a.start);

    const currentStart = getStartFn(new Date()); 
    const current = uniq.find(p => formatISODate(p.start) === formatISODate(currentStart));
    const result = { current: null, past: [] };

    // 4. L·ªåC V√Ä T√çNH TO√ÅN D·ªÆ LI·ªÜU T·ª™NG K·ª≤
    for (const p of uniq) {
        const isCurrent = current && formatISODate(p.start) === formatISODate(current.start);
        
        // *** LOGIC GHI NH√ÉN ƒê√É S·ª¨A CH·ªÆA ***
        let label = "";
        if (isCurrent) {
            // Hi·ªÉn th·ªã: K·ª≥ thu ph√≠: 16/09 -> H√¥m nay
            label = `K·ª≥ thu ph√≠ hi·ªán t·∫°i: ${formatVNDate(p.start)} -> H√¥m nay`; 
        } else {
            // K·ª≥ Qu√° Kh·ª©: p.end l√† 16/09. L√πi 1 ng√†y ƒë·ªÉ hi·ªÉn th·ªã 15/09.
            label = `K·ª≥ thu ph√≠: ${formatVNDate(p.start)} - ${formatVNDate(new Date(p.end.getTime() - 86400000))}`;
        }

        // --- 1. T√çNH TI√äU TH·ª§ (T·ªïng K·ª≥ thu ph√≠) ---
        let startValue, endValue, latestDataDate = null;
        let numericTotal = "N/A";
        let workingDaysResult = { workingDays: 0, dayOffsCount: 0, dayOffDates: [] };

        // START VALUE: L·∫•y ch·ªâ s·ªë t·∫°i ng√†y B·∫ÆT ƒê·∫¶U k·ª≥ (V√≠ d·ª•: 16/09)
        startValue = findValueExact(readings, p.start);

        if (isCurrent) {
            // END VALUE: K·ª≥ HI·ªÜN T·∫†I - L·∫•y ch·ªâ s·ªë m·ªõi nh·∫•t (t√≠nh ƒë·∫øn h√¥m nay)
            const latestReading = findLatestReadingBeforeOrOnMark(readings, today);
            endValue = latestReading ? latestReading.value : null;
            latestDataDate = latestReading ? latestReading.date : null;
        } else {
            // END VALUE: K·ª≥ QU√Å KH·ª® - L·∫•y ch·ªâ s·ªë t·∫°i ng√†y cu·ªëi k·ª≥ (15/09)
            // p.end l√† 16/09. L√πi 1 ng√†y ƒë·ªÉ l·∫•y ch·ªâ s·ªë 15/09.
            const lastDayOfPeriod = new Date(p.end.getTime());
            lastDayOfPeriod.setDate(lastDayOfPeriod.getDate() - 1); 
            
            endValue = findValueExact(readings, lastDayOfPeriod);
        }

        if (startValue !== null && endValue !== null) {
            let diff = endValue - startValue;
            if (diff < 0) diff = 0;
            numericTotal = diff;
        }

        // --- 2. T√çNH S·ªê NG√ÄY L√ÄM VI·ªÜC R√íNG (D√πng chung cho Trung b√¨nh v√† Kho√°n) ---
        let endDayForCounting = null;
        if (isCurrent) {
            // K·ª≥ Hi·ªán T·∫°i: ƒê·∫øm ng√†y t·ª´ p.start (16/09) ƒë·∫øn Ng√†y h√¥m nay
            endDayForCounting = today; 
        } else {
            // K·ª≥ Qu√° Kh·ª©: ƒê·∫øm ng√†y t·ª´ p.start (16/08) ƒë·∫øn 15/09
            endDayForCounting = new Date(p.end.getTime());
            endDayForCounting.setDate(endDayForCounting.getDate() - 1); // L√πi 1 ng√†y (16/09 -> 15/09)
        }

        if (endDayForCounting) {
            workingDaysResult = calculateWorkingDays(p.start, endDayForCounting, companyName, config, processedHolidayData);
        }
        
        // *** KH·∫ÆC PH·ª§C L·ªñI THI·∫æU 1 NG√ÄY CHO K·ª≤ HI·ªÜN T·∫†I ***
        let workingDaysForAvg = workingDaysResult.workingDays;
        if (isCurrent && workingDaysForAvg > 0) {
            // N·∫øu h√†m calculateWorkingDays t·ª± ƒë·ªông tr·ª´ 1 ng√†y, ta ph·∫£i c·ªông l·∫°i 1 ng√†y cho k·ª≥ hi·ªán t·∫°i 
            // ƒë·ªÉ bao g·ªìm c·∫£ h√¥m nay trong t√≠nh to√°n kho√°n.
            workingDaysForAvg += 1; 
        }
        
        const dayOffsCount = workingDaysResult.dayOffsCount;
        const dayOffDates = workingDaysResult.dayOffDates;

        // Kh·ªëi l∆∞·ª£ng kho√°n (Quota)
        const quotaValue = workingDaysForAvg * QUOTA_MULTIPLIER;

        // --- 3. T√çNH TRUNG B√åNH (AVG) ---
        const avg = (typeof numericTotal === "number" && workingDaysForAvg > 0) ? safeFixed(numericTotal/workingDaysForAvg,1) : "N/A";
        const totalFixed = safeFixed(numericTotal, 1);
        const quotaFixed = safeFixed(quotaValue, 0);

        if (isCurrent) {
            result.current = { label, total: totalFixed, avg, quota: quotaFixed, start: p.start, end: p.end, latestDataDate, dayOffsCount, holidayDates: dayOffDates };
        } else {
            // Kh√°c v·ªõi tu·∫ßn/th√°ng/nƒÉm, billing ch·ªâ gi·ªØ t·ªëi ƒëa 12 k·ª≥ qu√° kh·ª©
            if (result.past.length < 12) {
                result.past.push({ label, total: totalFixed, avg, quota: quotaFixed, start: p.start, end: p.end, latestDataDate, dayOffsCount, holidayDates: dayOffDates });
            }
        }
    }

    if (!result.current) {
        result.current = { label: "T·ªïng K·ª≥ thu ph√≠ hi·ªán t·∫°i", total:"N/A", avg:"N/A", quota:"N/A", dayOffsCount: 0, holidayDates: [] };
    }
    return result;
}
    
    // M·ªöI: H√ÄM GET REPORT MODE
    function getReportMode() {
        const checkedRadio = document.querySelector('input[name="report-mode"]:checked');
        return checkedRadio ? Number(checkedRadio.value) : 0; // Default: 0 (Normal)
    }

    // ========== B·ªî SUNG: LOGIC HI·ªÇN TH·ªä GHI CH√ö CU·ªêI B·∫¢NG ==========
    function toggleFooterNoteDisplay() {
        const reportFooterNote = document.getElementById('reportFooterNote');
        const mode = getReportMode(); // L·∫•y gi√° tr·ªã mode (0, 1, 2)
        
        if (reportFooterNote) {
            // Hi·ªÉn th·ªã n·∫øu mode l√† 1 (Ng√†y ngh·ªâ) ho·∫∑c 2 (Chi ti·∫øt)
            if (mode === 1 || mode === 2) {
                reportFooterNote.style.display = 'block';
            } else {
                reportFooterNote.style.display = 'none';
            }
        }
    }
    //
    // H√ÄM M·ªöI: C·∫¨P NH·∫¨T V·ªä TR√ç SLIDER CHO TOGGLE SWITCH
    function updateToggleSlider() {
        const toggle = document.getElementById('reportModeToggle');
        const slider = toggle.querySelector('a');
        const checked = toggle.querySelector('input:checked');
        if (!checked) return;

        const index = Number(checked.value); // 0,1,2
        const styles = getComputedStyle(document.documentElement);
        const labelWidth = parseFloat(styles.getPropertyValue('--label-width'));
        const gap = parseFloat(styles.getPropertyValue('--gap')) || 0;

        // v·ªã tr√≠ = index * (labelWidth + gap)
        const offset = index * (labelWidth + gap);
        slider.style.transform = `translateX(${offset}px)`;
        }
    // ========== RENDER ==========
    function reRenderReport() {
        let finalFrom = currentFilter.from;
        let finalTo = currentFilter.to;
        const now = new Date();
        const currentYearStart = formatISODate(new Date(now.getFullYear(), 0, 1)); 
        const todayISO = formatISODate(now);

        if (!finalFrom) finalFrom = currentYearStart;
        if (!finalTo) finalTo = todayISO;
        
        note.textContent = `ƒêang xem d·ªØ li·ªáu t·ª´ ${new Date(finalFrom).toLocaleDateString('vi-VN')} ƒë·∫øn ${new Date(finalTo).toLocaleDateString('vi-VN')}`;

        currentFilter.from = finalFrom;
        currentFilter.to = finalTo;

        renderReport(allReports);
        updateToggleSlider();
        // B·ªî SUNG: ƒêi·ªÅu khi·ªÉn ghi ch√∫ cu·ªëi b·∫£ng sau khi render xong
        toggleFooterNoteDisplay(); 
        }
    //
    // enhance accessibility & keyboard navigation for 3-way toggle
(function enhanceReportModeToggle() {
  const container = document.getElementById('reportModeToggle');
  if (!container) return;

  const inputs = Array.from(container.querySelectorAll('input[type="radio"]'));
  const labels = inputs.map(i => document.querySelector(`label[for="${i.id}"]`));
  const slider = container.querySelector('a');

  // init aria roles
  container.setAttribute('role', 'tablist');
  labels.forEach((lbl, idx) => {
    if (!lbl) return;
    lbl.setAttribute('role', 'tab');
    lbl.setAttribute('tabindex', '0'); // make label focusable
    lbl.dataset.index = String(idx);
  });

  // ensure slider position is correct on load
  setTimeout(() => { updateToggleSlider(); }, 10);

  // when radios change, move slider and re-render (keeps existing behavior)
  inputs.forEach((inp, idx) => {
    inp.addEventListener('change', () => {
      // mark aria-selected on labels
      labels.forEach(l => l && l.setAttribute('aria-selected', 'false'));
      const lbl = labels[idx];
      if (lbl) lbl.setAttribute('aria-selected', 'true');

      // move slider (fallback to existing function)
      try { updateToggleSlider(); } catch(e){ /* ignore */ }
      // re-render
      try { reRenderReport(); } catch(e){ console.warn(e); }
    });
  });

  // keyboard navigation: Left/Right arrows to change selection
    container.addEventListener('keydown', (ev) => {
        if (!['ArrowLeft','ArrowRight','Home','End'].includes(ev.key)) return;
        ev.preventDefault();
        const curIndex = inputs.findIndex(i => i.checked);
        let nextIndex = curIndex;
        if (ev.key === 'ArrowLeft') nextIndex = Math.max(0, curIndex - 1);
        if (ev.key === 'ArrowRight') nextIndex = Math.min(inputs.length - 1, curIndex + 1);
        if (ev.key === 'Home') nextIndex = 0;
        if (ev.key === 'End') nextIndex = inputs.length - 1;
        if (nextIndex !== curIndex && inputs[nextIndex]) {
        inputs[nextIndex].checked = true;
        inputs[nextIndex].dispatchEvent(new Event('change', { bubbles: true }));
        }
    });

    // also allow Enter/Space on labels to toggle (for screen readers)
    labels.forEach(lbl => {
        if (!lbl) return;
        lbl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const idx = Number(lbl.dataset.index || 0);
            if (inputs[idx]) {
            inputs[idx].checked = true;
            inputs[idx].dispatchEvent(new Event('change', { bubbles: true }));
            inputs[idx].focus();
            }
        }
        });
    });
    })();

    // M·ªöI: H√ÄM RENDER B·∫¢NG CHI TI·∫æT NG√ÄY NGH·ªà
    function renderHolidayDetailTable(allData, companies) {
        
        holidayDetailTableBody.innerHTML = ''; // Clear previous content
        
        // 1. Render Headers
        const tableHeaders = companies.map(c => `<th>${c}</th>`).join('');
        holidayDetailTableHead.innerHTML = `<tr><th>K·ª≥</th>${tableHeaders}</tr>`;
        
        // 2. Render Body
        let bodyHtml = "";
        
        // Th·ª© t·ª± hi·ªÉn th·ªã
        const periodTypes = [
            { key: 'week', label: 'TU·∫¶N' }, 
            { key: 'month', label: 'TH√ÅNG' }, 
            { key: 'billing', label: 'K·ª≤ THU PH√ç' }, 
            { key: 'year', label: 'NƒÇM' }
        ];

        periodTypes.forEach(type => {
            const allPeriods = allData[type.key];
            if (!allPeriods || allPeriods.length === 0) return;

        // X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng h√†ng hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh (ƒë·ªìng b·ªô v·ªõi handler toggle)
            let visibleCount;
            if (type.key === 'month' || type.key === 'billing') {
                visibleCount = 2; // K·ª≥ hi·ªán t·∫°i + 1 qu√° kh·ª©
            } else if (type.key === 'year') {
                visibleCount = 0; // ·∫©n h·∫øt
            } else if (type.key === 'week') {
                visibleCount = 5; // 1 k·ª≥ hi·ªán t·∫°i + 4 k·ª≥ qu√° kh·ª© (y√™u c·∫ßu c·ªßa b·∫°n)
            } else {
                visibleCount = allPeriods.length;
            }

            let toggleId = `toggle-detail-${type.key}`;
            let headerLabel;

            // H√†ng ti√™u ƒë·ªÅ lo·∫°i k·ª≥
            bodyHtml += `<tr style="height: 5px;"><td colspan="${companies.length + 1}" style="border: none; padding: 0;"></td></tr>`;

            headerLabel = `# CHI TI·∫æT NG√ÄY NGH·ªà THEO ${type.label} `;

            // Th√™m n√∫t toggle n·∫øu c√≥ h√†ng c·∫ßn ·∫©n
            if (allPeriods.length > visibleCount) {
                // N·∫øu c√≥ h√†ng b·ªã ·∫©n m·∫∑c ƒë·ªãnh -> icon l√† '‚ñ∂' (ƒë√≥ng/g·ªçn)
                const iconText = (allPeriods.length > visibleCount) ? '‚ñ∂' : '‚ñº';
                headerLabel = `# CHI TI·∫æT NG√ÄY NGH·ªà THEO ${type.label} (${visibleCount}/${allPeriods.length}) <span class="toggle-btn" data-target-id="${toggleId}">${iconText}</span> `;
            }

            bodyHtml += `<tr style="background: #f0f0f0; font-weight: bold;" class="detail-period-header"><td colspan="${companies.length + 1}" style="text-align: left; background: #e0e0e0; font-size: 1.1em;">${headerLabel}</td></tr>`;

            // Render t·∫•t c·∫£ c√°c k·ª≥, nh∆∞ng set display d·ª±a tr√™n visibleCount
            allPeriods.forEach((period, index) => {
                // X√°c ƒë·ªãnh tr·∫°ng th√°i hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh d·ª±a tr√™n visibleCount
                const displayStyle = (index < visibleCount) ? "table-row" : "none";

                let rowHtml = `<tr class="child-row-detail" data-parent-id="${toggleId}" style="display: ${displayStyle};"><td style="text-align: left;">${period.label}</td>`;
                companies.forEach(company => {
                    const detail = period.companyData[company] || 'Kh√¥ng c√≥ ng√†y ngh·ªâ';
                    rowHtml += `<td>${detail}</td>`;
                });
                rowHtml += '</tr>';
                bodyHtml += rowHtml;
            });

        });

        holidayDetailTableBody.innerHTML = bodyHtml;
        holidayDetailReportDiv.style.display = 'block';

        // ·∫®n/hi·ªán c·ªôt theo b·ªô l·ªçc nh√≥m c√¥ng ty
        filterHolidayDetailTableByCompanyGroup(companies);
    }


    function renderReport(reports) {
        const byCompany = {};
        reports.forEach(r => {
            if (!r.company || !r.ngay_ghi || r.chi_so == null) return;
            const valStr = r.chi_so.toString().replace(/,/g, '.'); 
            let finalVal = Number(valStr);
            
            if (valStr.includes('.') && valStr.split('.').length > 2) {
                finalVal = Number(valStr.replace(/\./g, ''));
            } else if (valStr.includes('.') && valStr.split('.')[1].length === 3) {
                 finalVal = Number(valStr.replace(/\./g, ''));
            } else {
                 finalVal = Number(valStr);
            }

            const d = new Date(r.ngay_ghi);
            if (isNaN(d) || isNaN(finalVal)) return;

            if (!byCompany[r.company]) byCompany[r.company] = []; 
            byCompany[r.company].push({ date: d, value: finalVal });
        });

        Object.keys(byCompany).forEach(c => {
            byCompany[c].sort((a, b) => a.date - b.date);
        });

        const companiesFromReports = Object.keys(byCompany);
        const companiesFromMaster = allMasterCompanies.map(c => c.company).filter(Boolean);
        
        const allUniqueCompanies = new Set([
            ...companiesFromReports, 
            ...companiesFromMaster
        ]);

        const companies = Array.from(allUniqueCompanies).sort((a, b) => a.localeCompare(b));

        const tableHeaders = companies.map(c => `<th>${c}</th>`).join('');
        theadRow.innerHTML = `<th>L∆∞u l∆∞·ª£ng</th>${tableHeaders}`;
        tbody.innerHTML = "";

        const from = currentFilter.from ? new Date(currentFilter.from) : new Date(new Date().getFullYear(), 0, 1);
        const to = currentFilter.to ? new Date(currentFilter.to) : new Date();
        to.setHours(23, 59, 59, 999);

        if(userRole === 'admin' && companies.length > 0) {
            renderQuotaMultipliers(companies);
        }
        
        // L·∫§Y TR·∫†NG TH√ÅI M·ªöI (0: Normal, 1: Count, 2: List)
        const reportMode = getReportMode(); 
        
        // B∆Ø·ªöC M·ªöI: Reset holiday details v√† ·∫©n b·∫£ng chi ti·∫øt ng√†y ngh·ªâ
        allHolidayDetails = { week: [], month: [], billing: [], year: [] };
        holidayDetailReportDiv.style.display = 'none';

        function renderPeriod(name, periodDataByCompany, prefix, reportMode) {
          let html = "";
          const latestDates = periodDataByCompany
            .map(d => d?.data?.current?.latestDataDate)
            .filter(date => date != null);

          const uniqueDates = [...new Set(latestDates.map(d => d instanceof Date ? formatVNDate(d) : d))];

          let endLabel;
          if (uniqueDates.length === 1) {
            endLabel = uniqueDates[0];   
          } else if (uniqueDates.length > 1) {
            endLabel = ">";       
          } else {
            endLabel = formatVNDate(new Date()); 
          }

          
        const rawStartDate = periodDataByCompany[0]?.data?.current?.start;

        let startLabel;
        if (rawStartDate) {
            startLabel = formatVNDate(rawStartDate);
        } else {
            startLabel = "N/A";
        }

        const currentLabel = `${name} hi·ªán t·∫°i (${startLabel} - ${endLabel})`;
        const toggleHtml = `<span class="toggle-btn">‚ñ∂</span>`;


        // Logic ƒë·ªÉ x√°c ƒë·ªãnh n·ªôi dung √¥ (Total)
        function getDisplayContent(dataItem, isPast = false, idx = 0) {
            const currentData = isPast ? dataItem?.data?.past[idx] : dataItem?.data?.current;
            const totalFixed = currentData?.total || 'N/A';
            const dayOffs = currentData?.dayOffsCount || 0;
            const holidayDates = currentData?.holidayDates || [];
            
            let displayContent;
            let tooltipAttr = '';
            
            // Mode 0 (B√¨nh th∆∞·ªùng): Hi·ªÉn th·ªã T·ªïng l∆∞u l∆∞·ª£ng
            if (reportMode === 0) { 
                displayContent = totalFixed;
            } 
            // Mode 1 (Ng√†y ngh·ªâ) v√† Mode 2 (Chi ti·∫øt) hi·ªÉn th·ªã T·ªïng l∆∞u l∆∞·ª£ng (S·ªë ng√†y ngh·ªâ)
            else { 
                displayContent = `${totalFixed} (${dayOffs})`;
                const tooltipDates = formatHolidayDates(holidayDates);
                tooltipAttr = tooltipDates ? `title="${tooltipDates}"` : '';
            }
            
            // Thu th·∫≠p d·ªØ li·ªáu chi ti·∫øt ng√†y ngh·ªâ n·∫øu ƒëang ·ªü Mode 2
            let holidayDetail = null;
            if (reportMode === 2) {
                 holidayDetail = {
                    label: isPast ? currentData.label : currentLabel,
                    company: dataItem.company,
                    datesHtml: formatHolidayDatesInline(holidayDates)
                };
            }
            
            return { displayContent, tooltipAttr, holidayDetail };
        }


          // ===== render ph·∫ßn T·ªïng (total-current-row - Xanh Nh·∫°t) =====
          html += `<tr class="main-row current-row total-current-row" data-target="toggle-${prefix}-total">
            <td>T·ªïng ${currentLabel}${toggleHtml}</td>
            ${periodDataByCompany.map(d => {
                const { displayContent, tooltipAttr } = getDisplayContent(d, false);
                return `<td ${tooltipAttr}>${displayContent}</td>`;
            }).join('')}
          </tr>`;

          // --- DATA COLLECTION CHO MODE 2 (K·ª≥ hi·ªán t·∫°i) ---
          if (reportMode === 2) {
            const currentDataRow = { label: currentLabel, companyData: {} };
            periodDataByCompany.forEach(d => {
                const result = getDisplayContent(d, false);
                currentDataRow.companyData[d.company] = result.holidayDetail.datesHtml;
            });
            allHolidayDetails[prefix].push(currentDataRow);
          }


          // child rows (past)
          let pastItems = periodDataByCompany[0]?.data?.past || [];
          if (prefix === "week" && isInitialLoad) {
            pastItems = pastItems.slice(0, 4);
          }
          pastItems.forEach((p, idx) => {
            html += `<tr class="child-row past-row" data-parent="toggle-${prefix}-total">
                <td>${p.label}</td>
                ${periodDataByCompany.map(d => {
                    const { displayContent, tooltipAttr } = getDisplayContent(d, true, idx);
                    return `<td ${tooltipAttr}>${displayContent}</td>`;
                }).join('')}
            </tr>`;
            
            // --- DATA COLLECTION CHO MODE 2 (C√°c k·ª≥ qu√° kh·ª©) ---
            if (reportMode === 2) {
                const pastDataRow = { label: p.label, companyData: {} };
                periodDataByCompany.forEach(d => {
                    const result = getDisplayContent(d, true, idx);
                    pastDataRow.companyData[d.company] = result.holidayDetail.datesHtml;
                });
                allHolidayDetails[prefix].push(pastDataRow);
            }
          });

        
          // ===== render ph·∫ßn Trung b√¨nh (detail-current-row - Tr·∫Øng) =====
          
              html += `<tr class="main-row current-row detail-current-row" data-target="toggle-${prefix}-avg">
                <td>Trung b√¨nh ${currentLabel} (m¬≥/ng√†y)${toggleHtml}</td>
                ${periodDataByCompany.map(d => `<td>${d?.data?.current?.avg || 'N/A'}</td>`).join('')}
              </tr>`;

              pastItems.forEach((p, idx) => {
                html += `<tr class="child-row past-row" data-parent="toggle-${prefix}-avg">
                    <td>Trung b√¨nh: ${p.label}</td>
                    ${periodDataByCompany.map(d => `<td>${d?.data?.past[idx]?.avg || 'N/A'}</td>`).join('')}
                </tr>`;
              });

               // ===== render ph·∫ßn Kho√°n (ch·ªâ cho billing) (detail-current-row - Tr·∫Øng) =====
              if (prefix === "billing") {
                html += `<tr class="main-row current-row detail-current-row" data-target="toggle-${prefix}-quota">
                    <td>Kh·ªëi l∆∞·ª£ng kho√°n ${currentLabel}${toggleHtml}</td>
                    ${periodDataByCompany.map(d => `<td>${d?.data?.current?.quota || 'N/A'}</td>`).join('')}
                </tr>`;

                pastItems.forEach((p, idx) => {
                  html += `<tr class="child-row past-row" data-parent="toggle-${prefix}-quota">
                      <td>Kh·ªëi l∆∞·ª£ng kho√°n: ${p.label.split(': ')[1] || p.label}</td>
                      ${periodDataByCompany.map(d => `<td>${d?.data?.past[idx]?.quota || 'N/A'}</td>`).join('')}
                  </tr>`;
                });
              }
            // <--- (H·∫æT KH·ªêI X√ìA ƒêI·ªÄU KI·ªÜN)

            // T·∫†O KHO·∫¢NG TR·∫ÆNG C√ÅCH GI·ªÆA C√ÅC LO·∫†I K·ª≤
            html += `<tr style="height: 10px; background: white !important;"><td colspan="${companies.length + 1}" style="border: none; padding: 0;"></td></tr>`;

            return html;
        }


        let reportHTML = '';
        
        // Truy·ªÅn reportMode v√†o t·∫•t c·∫£ c√°c h√†m renderPeriod
        const weekData = companies.map(c => ({ company: c, data: getPeriodsInFilter(byCompany[c] || [], from, to, "week", config, allProcessedHolidays, c) }));
        reportHTML += renderPeriod("Tu·∫ßn", weekData, "week", reportMode);

        const monthData = companies.map(c => ({ company: c, data: getPeriodsInFilter(byCompany[c] || [], from, to, "month", config, allProcessedHolidays, c) }));
        reportHTML += renderPeriod("Th√°ng", monthData, "month", reportMode);
        
        const billingData = companies.map(c => ({ company: c, data: getBillingPeriodsInFilter(byCompany[c] || [], from, to, config, allProcessedHolidays, c) }));
        reportHTML += renderPeriod("K·ª≥ thu ph√≠", billingData, "billing", reportMode);

        const yearData = companies.map(c => ({ company: c, data: getPeriodsInFilter(byCompany[c] || [], from, to, "year", config, allProcessedHolidays, c) }));
        reportHTML += renderPeriod("NƒÉm", yearData, "year", reportMode);

        tbody.innerHTML = reportHTML;
        
        // B∆Ø·ªöC CU·ªêI: N·∫øu l√† Mode 2, render b·∫£ng chi ti·∫øt ng√†y ngh·ªâ
        if (reportMode === 2) {
            renderHolidayDetailTable(allHolidayDetails, companies);
        }

        // G·ªçi filterReportByCompanyGroup() sau khi render
        filterReportByCompanyGroup();
    }

    // === NEW HELPER: H√ÄM GHI B·∫¢N GHI KH·ªûI T·∫†O ===
    async function writeInitialReading(companyName) {
    const initialDate = new Date("2025-01-01T00:00:00Z");

    const newReading = {
        company: companyName,
        ngay_ghi: formatISODate(initialDate),
        chi_so: 0,
        createdBy: "admin@gmail.com",
        ghi_chu: "Chi so khoi tao tu dong (Auto-Init)",
        fileId: "",
        fileUrl: "",
        createdAt: new Date()
    };

    await addDoc(collection(db, "reports_1"), newReading);

    console.log(`LOG: ƒê√£ th√™m b·∫£n ghi kh·ªüi t·∫°o cho c√¥ng ty: ${companyName}`);
}

    // === END NEW HELPER ===

    // === MASTER LIST MANAGER FUNCTIONS ===

    function renderMasterListManager() {
        if (allMasterCompanies.length === 0) {
            currentMasterListDiv.textContent = "Danh s√°ch hi·ªán t·∫°i: (Tr·ªëng)";
        } else {
            const companyNames = allMasterCompanies.map(c => c.company).join(', ');
            currentMasterListDiv.innerHTML = `Danh s√°ch hi·ªán t·∫°i: <strong>${companyNames}</strong>`;
        }
    }

    async function manageMasterCompany(companyName, action) {
    const safeName = companyName.trim();
    const docRef = doc(db, "companies_master", safeName);

    if (action === 'add') {
        await setDoc(docRef, { company: safeName, isActive: true });
        await writeInitialReading(safeName);

        console.log(`LOG: ƒê√£ th√™m c√¥ng ty ${safeName} v√†o Master List + b·∫£n ghi kh·ªüi t·∫°o`);
    } 
    else if (action === 'remove') {
        await deleteDoc(docRef);
        await deleteInitialReading(safeName); 
        console.log(`LOG: ƒê√£ x√≥a c√¥ng ty ${safeName} kh·ªèi Master List`);
    }
}

    // === END MASTER LIST MANAGER FUNCTIONS ===
    
async function deleteInitialReading(companyName) {
    const q = query(
        collection(db, "reports_1"),
        where("company", "==", companyName),
        where("chi_so", "==", 0)
    );
    const snap = await getDocs(q);

    snap.forEach(async (docSnap) => {
        await deleteDoc(docSnap.ref);
        console.log(`LOG: ƒê√£ x√≥a b·∫£n ghi kh·ªüi t·∫°o cho c√¥ng ty ${companyName}`);
    });
}
//

    // === C√ÅC H√ÄM X·ª¨ L√ù L·ªåC ===
    function resetYearSelectIfEditingDates() {
      if (yearSelect && yearSelect.value !== "") yearSelect.value = "";
    }
    [fromInput, toInput].forEach(el => {
      if (!el) return;
      el.addEventListener("focus", resetYearSelectIfEditingDates);
      el.addEventListener("input", resetYearSelectIfEditingDates);
      el.addEventListener("change", resetYearSelectIfEditingDates);
    });

    // H√ÄM KH·ªûI T·∫†O REALTIME LISTENER (M·∫∑c ƒë·ªãnh)
    function startRealtimeReports() {
        if (unsubscribeReports1) return; // ƒê√£ ch·∫°y r·ªìi th√¨ th√¥i

        unsubscribeReports1 = listenReports("reports_1", async (reports) => {
            allReports = reports;

            // 1. Populate Year Select
            const years = [...new Set(reports.map(r => {
                const dateString = r.ngay_ghi;
                if (dateString) return new Date(dateString).getFullYear();
                return null;
            }).filter(y => y !== null))].sort((a,b)=>b-a);

            const ys = document.getElementById("yearSelect");
            if(ys) {
                const currentVal = ys.value; // Gi·ªØ gi√° tr·ªã ƒëang ch·ªçn
                ys.innerHTML = `<option value="">--Ch·ªçn nƒÉm--</option>`;
                years.forEach(y => ys.innerHTML += `<option value="${y}">${y}</option>`);
                if (currentVal && years.includes(Number(currentVal))) ys.value = currentVal;
            }
            
            // 2. Set default filter on initial load
            if(isInitialLoad) {
                const currentYear = new Date().getFullYear();
                if (years.includes(currentYear) && ys) {
                  const todayISO = formatISODate(new Date());
                  const currentYearStart = currentYear + '-01-01';
                  
                  // document.querySelector('input[name="report-mode"]').checked = true; 
                  ys.value = currentYear;
                  currentFilter.from = currentYearStart;
                  currentFilter.to = todayISO; 
                }
            }

            // 3. Get config
            await getReportConfig(); 
            
            // 4. Render report
            reRenderReport();
            
            if (companyGroupFilter) {
                filterReportByCompanyGroup();
            }
            
            isInitialLoad = false;
        });
    }

    const applyDateFilter = async () => {
      const fromVal = fromInput.value;
      const toVal = toInput.value;
      const yearVal = yearSelect.value;

      const todayISO = formatISODate(new Date());
      const currentYear = new Date().getFullYear();
      const currentYearStart = currentYear + '-01-01';

      if (yearVal) {
        currentFilter.from = `${yearVal}-01-01`;
        currentFilter.to = `${yearVal}-12-31`;
        fromInput.value = "";
        toInput.value = "";
      } else if (fromVal && toVal) {
        currentFilter.from = fromVal;
        currentFilter.to = toVal;
      } else if (toVal) {
        currentFilter.from = currentYearStart;
        currentFilter.to = toVal;
      } else if (fromVal) {
        currentFilter.from = fromVal;
        currentFilter.to = todayISO;
      } else {
        currentFilter.from = null;
        currentFilter.to = null;
      }

      // LOGIC M·ªöI: T·∫£i d·ªØ li·ªáu theo nhu c·∫ßu (B·ªè qua gi·ªõi h·∫°n 6000)
      if (currentFilter.from && currentFilter.to) {
          // 1. T·∫Øt Realtime Listener (ƒë·ªÉ tr√°nh xung ƒë·ªôt d·ªØ li·ªáu v√† ti·∫øt ki·ªám)
          if (unsubscribeReports1) {
              unsubscribeReports1();
              unsubscribeReports1 = null;
              console.log("LOG: ƒê√£ t·∫Øt Realtime Listener ƒë·ªÉ chuy·ªÉn sang ch·∫ø ƒë·ªô L·ªçc L·ªãch s·ª≠.");
          }

          // 2. T·∫£i d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß t·ª´ Server cho kho·∫£ng th·ªùi gian n√†y
          showLoading("ƒêang t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠...");
          try {
              // G·ªçi h√†m getReportsByDate (ƒë√£ c√≥ trong script.js) ƒë·ªÉ l·∫•y ch√≠nh x√°c kho·∫£ng th·ªùi gian
              allReports = await getReportsByDate("reports_1", "ngay_ghi", currentFilter.from, currentFilter.to);
              
              await getReportConfig(); // C·∫≠p nh·∫≠t config
              reRenderReport();
              filterReportByCompanyGroup();
              
          } catch (e) {
              console.error("L·ªói t·∫£i l·ªãch s·ª≠:", e);
              showSwal("error", "L·ªói t·∫£i d·ªØ li·ªáu", e.message);
          } finally {
              hideLoading();
          }
      } else {
          // N·∫øu b·ªè l·ªçc -> Quay l·∫°i ch·∫ø ƒë·ªô Realtime m·∫∑c ƒë·ªãnh
          if (!unsubscribeReports1) {
              startRealtimeReports();
          } else {
              reRenderReport();
              filterReportByCompanyGroup();
          }
      }
    };

    if(applyFilterBtn) {
        applyFilterBtn.addEventListener("click", (e) => {
            e.preventDefault();
            applyDateFilter();
        });
    }

    if(yearSelect) {
        yearSelect.addEventListener("change", async (e) => {
            // G·ªçi h√†m applyDateFilter ƒë·ªÉ x·ª≠ l√Ω logic t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠
            // H√†m n√†y ƒë√£ bao g·ªìm vi·ªác x√≥a input ng√†y th√°ng v√† thi·∫øt l·∫≠p filter
            await applyDateFilter();
        });
    }
    
    if (companyGroupFilter) {
        companyGroupFilter.addEventListener('change', () => {
             filterReportByCompanyGroup();
        });
    }
    
    // G√ÅN LISTENER CHO C√îNG T·∫ÆC 3 N·∫§C
if (reportModeToggle) {
        // C·∫≠p nh·∫≠t v·ªã tr√≠ slider ngay l·∫≠p t·ª©c khi click (tr∆∞·ªõc khi reRenderReport c·∫≠p nh·∫≠t d·ªØ li·ªáu)
        reportModeToggle.addEventListener('click', (e) => {
            // D√πng setTimeout 0ms ƒë·ªÉ ƒë·∫£m b·∫£o input radio k·ªãp nh·∫≠n gi√° tr·ªã checked m·ªõi
            // tr∆∞·ªõc khi ta g·ªçi updateToggleSlider() v√† reRenderReport().
            setTimeout(() => {
                updateToggleSlider();
                reRenderReport();
            }, 0);
        });
    }
    
    // G√ÅN LISTENER CHO SELECT MOBILE
    const mobileSelect = document.getElementById('mobileReportModeSelect');
    if (mobileSelect) {
        mobileSelect.addEventListener('change', (e) => {
            const value = e.target.value;
            // ƒê·ªìng b·ªô v·ªõi radio buttons
            const radio = document.querySelector(`input[name="report-mode"][value="${value}"]`);
            if (radio) {
                radio.checked = true;
                updateToggleSlider();
                reRenderReport();
            }
        });
        
        // ƒê·ªìng b·ªô ng∆∞·ª£c l·∫°i: khi radio thay ƒë·ªïi, c·∫≠p nh·∫≠t select
        const radios = document.querySelectorAll('input[name="report-mode"]');
        radios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                mobileSelect.value = e.target.value;
            });
        });
    }
    
    // Di chuy·ªÉn select Nh√≥m c√¥ng ty v√†o toggle-switch-container tr√™n mobile
    if (window.innerWidth <= 768) {
        const companyGroupSelect = document.getElementById('companyGroupFilter');
        const toggleContainer = document.querySelector('.toggle-switch-container');
        if (companyGroupSelect && toggleContainer) {
            // Clone select ƒë·ªÉ gi·ªØ event listeners
            const clonedSelect = companyGroupSelect.cloneNode(true);
            // Th√™m v√†o ƒë·∫ßu toggle-switch-container
            toggleContainer.insertBefore(clonedSelect, toggleContainer.firstChild);
            // ·∫®n select g·ªëc
            companyGroupSelect.style.display = 'none';
            
            // ƒê·ªìng b·ªô gi√° tr·ªã gi·ªØa 2 select
            clonedSelect.addEventListener('change', (e) => {
                companyGroupSelect.value = e.target.value;
                companyGroupSelect.dispatchEvent(new Event('change'));
            });
        }
    }
    
    // === G√ÅN S·ª∞ KI·ªÜN QU·∫¢N L√ù MASTER LIST ===
    if (addCompanyBtn) {
        addCompanyBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await manageMasterCompany(companyNameInput.value, 'add');
        });
    }

    if (removeCompanyBtn) {
        removeCompanyBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await manageMasterCompany(companyNameInput.value, 'remove');
        });
    }
    // === K·∫æT TH√öC G√ÅN S·ª∞ KI·ªÜN QU·∫¢N L√ù MASTER LIST ===


// ==== THAY TH·∫æ: handler n√∫t Xu·∫•t b√°o c√°o ====
document.getElementById("exportPDF").addEventListener("click", async (e) => {
  e.preventDefault();
  try {
    // ƒë·∫£m b·∫£o render m·ªõi nh·∫•t tr∆∞·ªõc khi xu·∫•t
    reRenderReport();

    const fromDate = currentFilter.from || formatISODate(new Date(new Date().getFullYear(), 0, 1));
    const toDate = currentFilter.to || formatISODate(new Date());

    // clone container ch·ª©a n·ªôi dung PDF
    const pdfReportEl = document.getElementById('pdfReport');
    if (!pdfReportEl) {
      console.error("EXPORT ERROR: #pdfReport element not found in DOM.");
      showSwal("error", "L·ªói xu·∫•t PDF", "Kh√¥ng t√¨m th·∫•y v√πng b√°o c√°o ƒë·ªÉ xu·∫•t (pdfReport).");
      return;
    }

    const combinedContent = document.createElement('div');
    combinedContent.appendChild(pdfReportEl.cloneNode(true));

    const currentMode = getReportMode();

    // n·∫øu mode = 2, th√™m b·∫£ng chi ti·∫øt ng√†y ngh·ªâ v√†o b·∫£n sao
    if (currentMode === 2) {
      if (holidayDetailReportDiv) {
        const detailClone = holidayDetailReportDiv.cloneNode(true);
        detailClone.style.display = 'block';
        detailClone.querySelectorAll('.toggle-btn').forEach(btn => btn.textContent = '‚ñº');
        detailClone.querySelectorAll('.child-row-detail').forEach(row => row.style.display = 'table-row');
        const target = combinedContent.querySelector('#pdfReport');
        if (target) target.appendChild(detailClone);
      }
    }

    const elToExport = combinedContent.querySelector('#pdfReport');
    if (!elToExport) {
      console.error("EXPORT ERROR: cloned #pdfReport not found inside combinedContent.");
      showSwal("error", "L·ªói xu·∫•t PDF", "Kh√¥ng th·ªÉ chu·∫©n b·ªã n·ªôi dung ƒë·ªÉ xu·∫•t.");
      return;
    }

    // g·ªçi h√†m xu·∫•t (await ƒë·ªÉ b·∫Øt l·ªói)
    await exportTableToPDF(elToExport, `bao_cao_thong_ke_${fromDate}_${toDate}.pdf`);

  } catch (err) {
    console.error("EXPORT ERROR (click handler):", err);
    showSwal("error", "L·ªói xu·∫•t PDF", err && err.message ? err.message : String(err));
  }
});


// ==== THAY TH·∫æ: exportTableToPDF (an to√†n, restore UI, logs) ====
async function exportTableToPDF(element, filename) {
  if (!element) {
    console.error("exportTableToPDF: element is null");
    throw new Error("No element provided to exportTableToPDF");
  }

  if (typeof window.html2pdf !== 'function' && typeof window.html2pdf === 'undefined') {
    console.warn("html2pdf not detected on window. Attempting to continue, but export may fail.");
  }

  // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu ƒë·ªÉ restore sau khi xu·∫•t
  const childRows = Array.from(document.querySelectorAll('.child-row'));
  const prevChildDisplay = childRows.map(r => r.style.display || '');
  const pdfOnlyEls = Array.from(document.querySelectorAll('.pdf-only'));
  const prevPdfOnlyDisplay = pdfOnlyEls.map(el => el.style.display || '');
  const toggleEl = document.getElementById('reportModeToggle');
  const prevToggleDisplay = toggleEl ? toggleEl.style.display : null;
  const prevNote = note ? note.textContent : "";

  try {
    // 1) Hi·ªán t·∫•t c·∫£ child-row & pdf-only trong UI (ƒë·ªÉ clone l·∫•y tr·∫°ng th√°i hi·ªÉn th·ªã)
    childRows.forEach(r => r.style.display = 'table-row');
    pdfOnlyEls.forEach(el => el.style.display = 'block');

    // 2) ·∫®n control toggle g·ªëc (n·∫øu c√≥)
    if (toggleEl) toggleEl.style.display = 'none';

    // 3) ch·ªânh note cho PDF
    if (note) note.textContent = (note.textContent || "").replace('ƒêang xem d·ªØ li·ªáu', 'B√°o c√°o th·ªëng k√™ chi ti·∫øt');

    // 4) ƒë·∫£m b·∫£o hi·ªÉn th·ªã t·∫•t c·∫£ c·ªôt (mu·ªën d√πng ch·∫ø ƒë·ªô export all companies)
    if (companyGroupFilter) {
      companyGroupFilter.value = 'all';
      filterReportByCompanyGroup();
    }

    // 5) chu·∫©n b·ªã options html2pdf
    const options = {
      margin: 10,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, logging: false },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };

    // 6) L·∫•y b·∫£n sao element (an to√†n) ƒë·ªÉ truy·ªÅn cho html2pdf
    const content = element.cloneNode(true);

    // 7) Lo·∫°i b·ªè c√°c control kh√¥ng mong mu·ªën tr√™n b·∫£n sao
    content.querySelectorAll('.toggle-btn').forEach(btn => btn.remove());
    content.querySelector('#reportModeToggle')?.remove();

    // 8) M·ªü t·∫•t c·∫£ h√†ng con tr√™n b·∫£n sao (ƒë·∫£m b·∫£o xu·∫•t ƒë·∫ßy ƒë·ªß)
    content.querySelectorAll('.child-row').forEach(r => r.style.display = 'table-row');
    content.querySelectorAll('.child-row-detail').forEach(r => r.style.display = 'table-row');

    // 9) Ki·ªÉm tra html2pdf t·ªìn t·∫°i tr∆∞·ªõc khi ch·∫°y
    if (typeof window.html2pdf !== 'function' && typeof window.html2pdf === 'undefined') {
      // Th∆∞ vi·ªán kh√¥ng c√≥ theo t√™n window.html2pdf (m·ªôt s·ªë build expose theo kh√°c), th·ª≠ fallback
      if (typeof window.html2pdf !== 'function') {
        console.error("exportTableToPDF: html2pdf is not available on window.");
        throw new Error("Th∆∞ vi·ªán html2pdf ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ƒë·∫£m b·∫£o script html2pdf.js ƒë∆∞·ª£c n·∫°p.");
      }
    }

    // 10) Th·ª±c hi·ªán xu·∫•t v√† ch·ªù ho√†n t·∫•t
    await window.html2pdf(content, options);

  } catch (err) {
    console.error("exportTableToPDF error:", err);
    throw err;
  } finally {
    // RESTORE tr·∫°ng th√°i giao di·ªán ban ƒë·∫ßu d√π th√†nh c√¥ng hay l·ªói
    // restore child rows
    const curChildRows = Array.from(document.querySelectorAll('.child-row'));
    curChildRows.forEach((r, i) => {
      r.style.display = prevChildDisplay[i] || 'none';
    });

    // restore pdf-only
    Array.from(document.querySelectorAll('.pdf-only')).forEach((el, i) => {
      el.style.display = prevPdfOnlyDisplay[i] || 'none';
    });

    // restore toggle display
    if (toggleEl) toggleEl.style.display = prevToggleDisplay || 'flex';

    // restore note
    if (note) note.textContent = prevNote;

    // restore company group filter (b·ªè v·ªÅ gi√° tr·ªã c≈© n·∫øu c·∫ßn)
    // (l∆∞u √Ω: filterReportByCompanyGroup() s·∫Ω ƒë∆∞·ª£c g·ªçi b·ªüi reRenderReport n·∫øu c·∫ßn)
    if (companyGroupFilter) {
      // kh√¥ng √©p restore gi√° tr·ªã v√¨ user c√≥ th·ªÉ mu·ªën gi·ªØ filter,
      // nh∆∞ng n·∫øu b·∫°n mu·ªën restore gi√° tr·ªã tr∆∞·ªõc export, l∆∞u value r·ªìi set l·∫°i ·ªü tr√™n.
      filterReportByCompanyGroup();
    }
  }
}

    // === K·∫æT TH√öC C√ÅC H√ÄM X·ª¨ L√ù L·ªåC ===


    async function getReportConfig() {
    const configRef = doc(db, "config", "reportConfig");
    const configSnap = await getDoc(configRef);

    console.log("üî• configSnap.exists:", configSnap.exists());
    const snapData = configSnap.exists() ? configSnap.data() : {};
    console.log("üî• raw snapData:", JSON.stringify(snapData));

    const snapQuota = (snapData.quotaMultipliers && typeof snapData.quotaMultipliers === 'object') ? snapData.quotaMultipliers : {};

    config = {
        weekDayStart: (snapData.weekDayStart ?? config.weekDayStart),
        monthDayStart: (snapData.monthDayStart ?? config.monthDayStart),
        billingDayStart: (snapData.billingDayStart ?? config.billingDayStart),
        yearDayStart: (snapData.yearDayStart ?? config.yearDayStart),
        quotaMultipliers: { ...(config.quotaMultipliers || {}), ...snapQuota },
    };

    console.log("üî• merged config:", JSON.stringify(config));

    // --- X·ª¨ L√ù D·ªÆ LI·ªÜU NG√ÄY NGH·ªà T·ª™ reports_2 ---
    allProcessedHolidays = {};
    allHolidayRecords.forEach(r => {
        if (!r.company) return;
        const company = r.company;
        const ngayNghi = r.ngay_nghi;
        const ngayLamDB = r.ngay_lam_db;

        if (!allProcessedHolidays[company]) {
            allProcessedHolidays[company] = { dayOffs: new Set(), specialWorkdays: new Set() };
        }

        if (ngayNghi) {
            const dateStr = formatISODate(new Date(ngayNghi));
            if (dateStr) allProcessedHolidays[company].dayOffs.add(dateStr);
        }
        if (ngayLamDB) {
            const dateStr = formatISODate(new Date(ngayLamDB));
            if (dateStr) allProcessedHolidays[company].specialWorkdays.add(dateStr);
        }
    });

    // Update UI selects
    document.getElementById("weekDayStart").value = config.weekDayStart;
    document.getElementById("monthDayStart").value = config.monthDayStart;
    document.getElementById("billingDayStart").value = config.billingDayStart;
    document.getElementById("yearDayStart").value = config.yearDayStart;
}


    document.getElementById("saveConfig").addEventListener("click", saveConfig);
    async function saveConfig() {
    
    const isConfirmed = await showConfirmSwal(
        "X√°c nh·∫≠n L∆∞u C√†i ƒê·∫∑t",
        "Vi·ªác n√†y s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn t·∫•t c·∫£ c√°c b√°o c√°o.<br>B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?",
        "C√≥, L∆∞u C√†i ƒê·∫∑t", 
        "Kh√¥ng, H·ªßy B·ªè",
        "warning" 
    );

    if (!isConfirmed) {
        return; 
    }
    
    const newConfig = {
        weekDayStart: Number(document.getElementById("weekDayStart").value),
        monthDayStart: Number(document.getElementById("monthDayStart").value),
        billingDayStart: Number(document.getElementById("billingDayStart").value),
        yearDayStart: Number(document.getElementById("yearDayStart").value),
        quotaMultipliers: config.quotaMultipliers,
    };
    
    document.querySelectorAll('#quotaMultipliersSetting input[data-company]').forEach(input => {
        const company = input.dataset.company;
        const value = parseFloat(input.value);
        newConfig.quotaMultipliers[company] = isNaN(value) ? 0 : value;
    });

    showLoading("ƒêang l∆∞u c√†i ƒë·∫∑t..."); 
    try {
        await setDoc(doc(db, "config", "reportConfig"), newConfig, { merge: true });
        config = newConfig; 
        showSwal("success", "ƒê√£ l∆∞u c√†i ƒë·∫∑t!", "C√°c b√°o c√°o s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫°i.");
        reRenderReport(); 
    } catch (e) {
        showSwal("error", "L·ªói khi l∆∞u c√†i ƒë·∫∑t", e.message);
        console.error("LOG: L·ªói khi l∆∞u config:", e);
    } finally {
        hideLoading(); 
    }
}

    function renderQuotaMultipliers(companies) {
    let html = "<div class='quota-scroll'><table><thead><tr><th>STT</th><th>C√¥ng ty</th><th>H·ªá s·ªë (m¬≥/ng√†y)</th></tr></thead><tbody>";
    companies.forEach((company, idx) => {
      const currentMultiplier = config.quotaMultipliers?.[company] || 0;
      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${company}</td>
          <td><input type="number" step="1" value="${currentMultiplier}" data-company="${company}" style="width: 80px; text-align: center;"></td>
        </tr>
      `;
    });
    html += "</tbody></table></div>";
    quotaMultipliersSettingDiv.innerHTML = html;
    }


    // ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    onAuth(async (user) => {
        if (user) {
            console.log("LOG: Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p.");
            notLogged.style.display = "none";
            content.style.display = "block";

            userRole = await getRole(user.email);
            // B∆Ø·ªöC M·ªöI: Hi·ªÉn th·ªã n√∫t c·∫•u h√¨nh v√† setup modal cho Admin
            if (userRole === 'admin') {
                document.getElementById("adminSettings").style.display = "block";
                const configBtn = document.getElementById('openConfigModal');
                if (configBtn) {
                    configBtn.style.display = 'inline-block';
                }
            } else {
                document.getElementById("adminSettings").style.display = "none";
            }
            // === Listener M·ªöI: companies_master (Master List) ===
            listenCollection("companies_master", (masterDocs) => {
                allMasterCompanies = masterDocs.filter(d => d && d.company);
                renderMasterListManager();
                reRenderReport();
            });

            // === K·∫æT TH√öC Listener M·ªöI ===


            // Listener 1: reports_1 (Ch·ªâ s·ªë ti√™u th·ª•) - D√πng h√†m m·ªõi startRealtimeReports
            startRealtimeReports();
            
            // Listener 2: reports_2 (Ng√†y ngh·ªâ/Ng√†y l√†m vi·ªác ƒë·∫∑c bi·ªát)
            listenReports("reports_2", async (holidays) => {
                allHolidayRecords = holidays;
                
                // Sau khi reports_2 ƒë∆∞·ª£c t·∫£i, c·∫ßn ch·∫°y l·∫°i config ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu m·ªõi v√† render l·∫°i b√°o c√°o
                if (!isInitialLoad) {
                    await getReportConfig();
                    reRenderReport();
                    // ƒê·∫£m b·∫£o l·ªçc ƒë∆∞·ª£c √°p d·ª•ng l·∫°i sau khi render
                    filterReportByCompanyGroup();
                }
            });

            
        } else {
            notLogged.style.display = "block";
            content.style.display = "none";
        }
    });
    setupConfigModal();
  </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>
