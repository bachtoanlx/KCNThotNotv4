<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>L·ªãch l√†m vi·ªác</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
  /* ======= B·∫¢NG CHUNG ======= */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }

  /* ======= KHUNG M·ªñI PH·∫¶N (3 KHUNG ADMIN) ======= */
  .rule-box {
    margin-top: 20px;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
    background: #f7f7f7;
    display: block;
    flex-direction: column;
    gap: 10px;
    width: 100%;
    box-sizing: border-box;
  }

  /* H√†ng nh·∫≠p li·ªáu trong m·ªói khung */
  .rule-box .input-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  /* √î nh·∫≠p vƒÉn b·∫£n co gi√£n h·ª£p l√Ω */
  .rule-box input[type="text"] {
    flex: 1;
    min-width: 250px;
  }

  /* Ph·∫ßn t·ª≠ c√≤n l·∫°i: select, date, button */
  .rule-box select,
  .rule-box input[type="date"],
  .rule-box input[type="time"],
  .rule-box button {
    height: 32px;
    padding: 4px 8px;
  }

  /* ======= N√öT TRONG B·∫¢NG ======= */
  .rule-box table button {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .rule-box table button:hover {
    background: #c0392b;
  }

  /* ======= C√ÅC B·∫¢NG TRONG PH·∫¶N ADMIN ======= */
  .rule-box table {
    width: 100%;
    /* border-collapse: collapse;  <-- ƒê√É X√ìA (Th·ª´a) */
    margin-top: 0px;
    background: #fff;
    border: none;
  }

  .rule-box table thead th {
    background-color: #f0f0f0;
    font-weight: 600;
    text-align: center; /* K·∫ø th·ª´a t·ª´ 'th' to√†n c·ª•c */
    padding: 8px;
    border: 1px solid #ccc;
  }

  .rule-box table tbody td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: center; /* K·∫ø th·ª´a t·ª´ 'td' to√†n c·ª•c */
    vertical-align: middle;
  }

  .rule-box table tbody tr:nth-child(odd) {
    background-color: #fafafa;
  }
  .rule-box table tbody tr:nth-child(even) {
    background-color: #ffffff;
  }

  .rule-box table tbody tr:hover {
    background-color: #eaf3ff;
    transition: background-color 0.2s ease;
  }

  .rule-box + .rule-box {
    margin-top: 20px;
  }

  .rule-box h3 {
    margin-top: 0;
    text-align: left;
    color: #333;
  }

  .rule-box table th,
  .rule-box table td {
    white-space: normal;
    text-overflow: ellipsis;
    overflow: hidden;
  }

  .rule-box table td:first-child
  {
    text-align: left;
    padding-left: 10px;
  }

  .rule-box table th:first-child {
    text-align: center;
    padding-left: 10px;
  }

  /* ======= PH·∫¶N 3: C√ÄI ƒê·∫∂T QUY T·∫ÆC NG√ÄY L√ÄM ======= */
  #workPatternConfig #dayCheckboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  #workPatternConfig #dayCheckboxes label {
    display: flex;
    align-items: center;
    gap: 4px;
    border: 1px solid #ccc;
    padding: 3px 6px;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
  }

  /* ======= B·∫¢NG L·ªäCH L√ÄM VI·ªÜC ======= */
  #scheduleTable {
    table-layout: fixed;
    word-wrap: break-word;
    /* border-collapse: collapse; <-- ƒê√É X√ìA (Th·ª´a) */
    width: 100%;
    background: white;
  }

  #scheduleTable thead th {
    background-color: #f0f0f0;
    font-weight: 600;
    text-align: center !important; 
    padding: 10px;
    border: 1px solid #ccc;
  }

  /* --- ƒê√É T·ªêI ∆ØU H√ìA --- */
  #scheduleTable tbody td {
    border: 1px solid #ccc;
    padding: 8px 10px; /* Th√™m padding tr√°i/ph·∫£i m·∫∑c ƒë·ªãnh */
    text-align: left; /* CƒÉn tr√°i t·∫•t c·∫£ TD trong tbody */
    line-height: 1.4em;
  }
  
  /* CƒÉn l·ªÅ tr√°i cho c·ªôt Ng√†y (v·ªën ƒë√£ left) */
  #scheduleTable td:nth-child(1) {
     padding-left: 8px; /* Gi·ªØ nguy√™n padding ri√™ng */
  }
  /* --- K·∫æT TH√öC T·ªêI ∆ØU H√ìA --- */

  #scheduleTable tbody tr:nth-child(odd) {
    background-color: #fafafa;
  }

  #scheduleTable tbody tr:nth-child(even) {
    background-color: #ffffff;
  }

  #scheduleTable tbody tr:hover {
    background-color: #eaf3ff;
    transition: background-color 0.2s ease;
  }
  
  /* ƒê·ªô r·ªông b·∫£ng <-- ƒê√É X√ìA KH·ªêI N√ÄY (Th·ª´a) */

  /* ƒê·ªô r·ªông c·ªôt c·ª• th·ªÉ */
  #scheduleTable th:nth-child(1),
  #scheduleTable td:nth-child(1) {
    width: 15%;
    min-width: 150px; 
    /* (ƒê√£ x√≥a text-align: left;) */
  }

  #scheduleTable th:nth-child(2),
  #scheduleTable td:nth-child(2) {
    width: 20%;
    min-width: 150px;
    /* text-align: left; <-- ƒê√É X√ìA (ƒê√£ g·ªôp) */
    /* padding-left: 10px; <-- ƒê√É X√ìA (ƒê√£ g·ªôp) */
    /* line-height: 1.4em; <-- ƒê√É X√ìA (ƒê√£ g·ªôp) */
  }

  #scheduleTable th:nth-child(3),
  #scheduleTable td:nth-child(3) {
    width: 45%;
    min-width: 150px;
    /* text-align: left; <-- ƒê√É X√ìA (ƒê√£ g·ªôp) */
    /* padding-left: 10px; <-- ƒê√É X√ìA (ƒê√£ g·ªôp) */
    /* line-height: 1.4em; <-- ƒê√É X√ìA (ƒê√£ g·ªôp) */
  }

  #scheduleTable th:nth-child(4),
  #scheduleTable td:nth-child(4) {
    width: 20%;
    min-width: 150px;
    /* text-align: left; <-- ƒê√É X√ìA (ƒê√£ g·ªôp) */
    padding-left: 8px; /* Gi·ªØ padding ri√™ng */
  }

  /* D√≤ng ‚Äúh√¥m nay‚Äù t√¥ s√°ng */
  #scheduleTable tr.today-row {
    background-color: #dff0ff !important;
    font-weight: 600;
  }
  /* ======= MODAL XEM L·ªäCH C√Å NH√ÇN ======= */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4); 
}

#personalScheduleModal .modal-content {
    background-color: #fefefe;
    margin: 4% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 900px; 
    border-radius: 10px;
    position: relative;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    animation-name: animatetop;
    animation-duration: 0.4s
}

@keyframes animatetop {
    from {top: -300px; opacity: 0}
    to {top: 0; opacity: 1}
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}

#personalScheduleDetails {
    margin-top: 15px;
    text-align: left;
}
/* === CSS CHO DANH S√ÅCH ·∫®N/HI·ªÜN === */
.list-header {
    display: flex;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
    margin-top: 20px;
}
.list-header h4 {
    margin: 0;
}

/* KH·ªêI .toggle-visibility-btn ƒê√É B·ªä X√ìA */

.collapsible-content {
    display: block; /* Lu√¥n hi·ªÉn th·ªã */
    max-height: 175px; /* Gi·ªõi h·∫°n chi·ªÅu cao */
    overflow-y: auto; /* B·∫≠t thanh cu·ªôn d·ªçc */
    margin-top: 10px;
    background: #fff;
    border: 1px solid #ccc;
}
/* --- M·ªöI: Ghim c·ªë ƒë·ªãnh ti√™u ƒë·ªÅ b·∫£ng khi cu·ªôn --- */
.collapsible-content thead th {
    position: sticky;
    top: 0px; /* Ghim v√†o m√©p tr√™n (d√πng -1px ƒë·ªÉ che vi·ªÅn) */
    
    /* ƒê·∫£m b·∫£o ti√™u ƒë·ªÅ c√≥ n·ªÅn, kh√¥ng b·ªã trong su·ªët */
    background-color: #f0f0f0; 
    z-index: 1; /* ƒê·∫£m b·∫£o ti√™u ƒë·ªÅ lu√¥n n·∫±m tr√™n n·ªôi dung */
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    
}
/* === CSS L√ÄM N·ªîI B·∫¨T K·∫æT QU·∫¢ T√åM KI·∫æM === */
#scheduleTable tr.highlight {
    background-color: #fff8c4 !important;
    font-weight: bold;
}

/* === CSS CHO B·ªê C·ª§C ƒêI·ªÄU KHI·ªÇN TU·∫¶N === */
#weekNavigator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding: 8px;
    background-color: #f9f9f9;
}

.week-nav-group {
    display: flex;
    align-items: center;
    gap: 2px;
}

#weekNavigator button {
    padding: 3px 12px;
    font-size: 14px !important;
    border: 1px solid #ccc;
    background-color: #e01313bd;
    border-radius: 4px;
    cursor: pointer;
}

#weekNavigator button:hover {
    background-color: #7789ecb7;
}

#weekNumberDisplay {
    font-weight: bold;
    font-size: 14px;
    margin: 0 10px;
    width: 100px;
    text-align: center;
}

.week-label {
  color: #666;
  font-size: 13px;
  font-weight: 500;
}

/* === CSS CHO M√ÄU N·ªÄN NH√ìM XEN K·∫º === */
.rule-box table tbody tr.group-color-a {
    background-color: #f8f9fa;
}
.rule-box table tbody tr.group-color-b {
    background-color: #e9f7ef;
}

.rule-box table tbody tr.group-color-a:hover,
.rule-box table tbody tr.group-color-b:hover {
    background-color: #eaf3ff !important;
}
/* === GIAO DI·ªÜN D·∫†NG TH·∫∫ CHO M√ÄN H√åNH NH·ªé (C·∫¢I TI·∫æN) === */
@media (max-width: 768px) {
  /* Reset ƒë·ªô r·ªông b·∫£ng khi sang giao di·ªán th·∫ª d·ªçc */
  #scheduleTable {
    table-layout: auto !important;
    width: 100% !important;
  }

  #scheduleTable th,
  #scheduleTable td {
    width: auto !important;
    min-width: unset !important;
    max-width: none !important;
  }

  #scheduleTable,
  #scheduleTable thead,
  #scheduleTable tbody,
  #scheduleTable th,
  #scheduleTable td,
  #scheduleTable tr {
    display: block;
    width: 100%;
  }

  #scheduleTable thead {
    display: none; /* ·∫®n ti√™u ƒë·ªÅ c·ªôt */
  }

  #scheduleTable tr {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 10px;
    margin-bottom: 14px;
    padding: 10px 14px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  #scheduleTable td {
    display: flex;
    flex-direction: column;
    border: none;
    padding: 6px 0;
    font-size: 14px;
    text-align: left;
    line-height: 1.5em;
  }

  #scheduleTable td::before {
    content: attr(data-label);
    font-weight: 600;
    margin-bottom: 2px;
    color: #444;
    font-size: 13px;
  }

  #scheduleTable tr.today-row {
    background-color: #eef6ff !important;
    border-color: #99c4ff;
  }

  #scheduleTable td + td {
    margin-top: 2px;
  }

  #scheduleTable td[data-label="Ghi ch√∫"] {
    color: #555;
    font-style: italic;
  }

  #scheduleTable td[data-label="Ng√†y"] br {
    display: none;
  }

  #scheduleTable td[data-label="Ng√†y"] {
    flex-direction: row;
    align-items: baseline;
    flex-wrap: wrap;
  }

  #scheduleTable td[data-label="Ng√†y"] .week-label {
    display: none;
  }

  #scheduleTable td[data-label="Ng√†y"]::before {
    content: "üìÖ " attr(data-label);
  }

  #scheduleTable td[data-label="Ng∆∞·ªùi l√†m"]::before {
    content: "üë§ " attr(data-label);
  }

  #scheduleTable td[data-label="C√¥ng vi·ªác"]::before {
    content: "üíº " attr(data-label);
  }

  #scheduleTable td[data-label="Ghi ch√∫"]::before {
    content: "üìù " attr(data-label);
  }
}
</style>
</head>
<body>
  <div id="menu-placeholder"></div>
  <div id="loading-placeholder"></div>

  <div id="notLogged" style="display:none;">
    ‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y.
  </div>
<div id="personalScheduleModal" class="modal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>C√¥ng vi·ªác S·∫Øp t·ªõi c·ªßa b·∫°n</h2>
        <hr>
        <div id="personalScheduleDetails">
            <p>ƒêang t·∫£i l·ªãch...</p>
        </div>

        <div style="text-align:center; margin-top: 20px;">
            <button id="closeModalBottom" style="padding: 8px 20px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">ƒê√≥ng</button>
        </div>
        
    </div>
  </div>

  <div id="pageContent" style="display:none;">
  <h2>üìÖ L·ªãch l√†m vi·ªác trong tu·∫ßn</h2>

  <div class="card-body">
  <div style="margin-bottom: 15px; margin-top: 10px;">
      <input type="text" id="globalSearchInput" placeholder="üîç T√¨m ki·∫øm c√¥ng vi·ªác, nh√¢n vi√™n, ghi ch√∫..." style="width: 100%; padding: 8px; box-sizing: border-box;">
  </div>

  <div class="table-responsive-wrapper">
  <table id="scheduleTable">
    <thead>
        <tr>
        <th>Th·ª© & Ng√†y</th>
        <th>Ng∆∞·ªùi l√†m</th>
        <th>C√¥ng vi·ªác</th>
        <th>Ghi ch√∫</th>
        </tr>
    </thead>
    <tbody id="scheduleBody"></tbody>
  </table>
  </div>

  <div id="weekNavigator">
    <button id="todayWeekBtn">Tu·∫ßn hi·ªán t·∫°i</button>
    
    <div class="week-nav-group">
      <button id="firstWeekBtn" title="Tu·∫ßn ƒë·∫ßu ti√™n c·ªßa nƒÉm">|&lt;</button>
      <button id="prevWeekBtn" title="Tu·∫ßn tr∆∞·ªõc">&lt;&lt;</button>
      <span id="weekNumberDisplay"></span>
      <button id="nextWeekBtn" title="Tu·∫ßn k·∫ø ti·∫øp">&gt;&gt;</button>
      <button id="lastWeekBtn" title="Tu·∫ßn cu·ªëi c√πng c·ªßa nƒÉm">&gt;|</button>
    </div>
  </div>


  <div id="adminConfig" class="rule-box admin-only">
  <h3>‚öôÔ∏è 1.C√†i ƒë·∫∑t quy t·∫Øc c√¥ng vi·ªác (Admin)</h3>
  <div class="input-row">
    <input type="text" id="jobName" placeholder="T√™n c√¥ng vi·ªác">
    <label><input type="checkbox" id="isAdminJobRuleCheckbox"> #CV Admin</label>
    <input type="time" id="jobTime" title="Ch·ªçn gi·ªù ph·∫£i ho√†n th√†nh c√¥ng vi·ªác">
    <select id="domSelect">
      <option value="">--Ng√†y--</option>
      <script>
        for (let i = 1; i <= 31; i++) {
          document.write(`<option value="${i}">${i}</option>`);
        }
      </script>
    </select>
    <select id="daySelect">
      <option value="">--Th·ª©--</option>
      <option value="2">T2</option>
      <option value="3">T3</option>
      <option value="4">T4</option>
      <option value="5">T5</option>
      <option value="6">T6</option>
      <option value="7">T7</option>
      <option value="8">CN</option>
      <option value="all">M·ªçi ng√†y</option>
    </select>
    <select id="weekSelect">
      <option value="">--Tu·∫ßn--</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="all">M·ªçi tu·∫ßn</option>
    </select>
    <select id="monthSelect">
      <option value="">--Th√°ng--</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="all">M·ªçi th√°ng</option>
    </select>
    
    <button id="saveRule">üíæ L∆∞u</button>
  </div>

  <div class="input-row">
    <input type="text" id="jobNote" placeholder="Ghi ch√∫ (T√πy ch·ªçn)">
  </div>

  <div class="list-header">
      <h4>Danh s√°ch quy t·∫Øc ƒë√£ th√™m</h4>
  </div>
  <div class="collapsible-content">
    <table id="ruleList">
    <thead>
      <tr>
        <th>C√¥ng vi·ªác</th><th>Gi·ªù</th><th>Ng√†y</th><th>Th·ª©</th><th>Tu·∫ßn</th><th>Th√°ng</th><th>Ghi ch√∫</th><th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
  </table>
</div>

<div id="manualJobConfig" class="rule-box admin-only">
  <h3>üìù 2.Th√™m c√¥ng vi·ªác th·ªß c√¥ng (b·∫•t k·ª≥ ng√†y n√†o)</h3>
  <div class="input-row">
    <input type="text" id="manualJobName" placeholder="T√™n c√¥ng vi·ªác">
    <label><input type="checkbox" id="isAdminManualJobCheckbox"> #CV Admin</label>
    <input type="time" id="manualJobTime" title="Ch·ªçn gi·ªù ph·∫£i ho√†n th√†nh c√¥ng vi·ªác">
    <input type="date" id="manualJobDate">
    
    <button id="saveManualJob">üíæ L∆∞u</button>
  </div>
  <input type="text" id="manualJobNote" placeholder="Ghi ch√∫ (T√πy ch·ªçn)">
  <div class="list-header">
    <h4>Danh s√°ch c√¥ng vi·ªác th·ªß c√¥ng</h4>
  </div>
  <div class="collapsible-content">
    <table id="manualJobList">
    <thead>
      <tr><th>C√¥ng vi·ªác</th><th>Gi·ªù</th><th>Ng√†y</th><th>Ghi ch√∫</th><th>H√†nh ƒë·ªông</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
  </table>
</div>
<div id="workPatternConfig" class="rule-box admin-only">
  <h3>üß≠ 3.C√†i ƒë·∫∑t quy t·∫Øc ng√†y l√†m (Admin)</h3>

<div class="input-row">
    <input type="text" id="patternUser" placeholder="Nh√¢n vi√™n (email ho·∫∑c m√£)">
    <input type="text" id="patternDisplayName" placeholder="T√™n hi·ªÉn th·ªã tr√™n l·ªãch">
    <input type="date" id="patternStartDate" title="Ng√†y b·∫Øt ƒë·∫ßu √°p d·ª•ng quy t·∫Øc">
    <select id="patternTypeSelect">
      <option value="administrative">1.L·ªãch C·ªë ƒë·ªãnh</option>
      <option value="shift_rotation">2.L·ªãch Theo Ca</option>
    </select>
    <button id="savePattern">üíæ L∆∞u</button>
  </div>

  <div id="administrativeInputs">
    <div class="input-row">
      <label>Th·ª© l√†m vi·ªác:</label>
      <div id="dayCheckboxes">
        <label><input type="checkbox" value="2">T2</label>
        <label><input type="checkbox" value="3">T3</label>
        <label><input type="checkbox" value="4">T4</label>
        <label><input type="checkbox" value="5">T5</label>
        <label><input type="checkbox" value="6">T6</label>
        <label><input type="checkbox" value="7">T7</label>
        <label><input type="checkbox" value="8">CN</label>
      </div>
    </div>
    <div class="input-row">
        <label>Gi·ªù b·∫Øt ƒë·∫ßu:</label> <input type="time" id="adminStartTime">
        <label>Gi·ªù k·∫øt th√∫c:</label> <input type="time" id="adminEndTime">

    </div>
  </div>

  <div id="shiftRotationInputs" style="display:none;">
      <div class="input-row">
          <label>Gi·ªù b·∫Øt ƒë·∫ßu ca:</label>
          <input type="time" id="shiftStartTime">
          <label>Gi·ªù k·∫øt th√∫c ca:</label>
          <input type="time" id="shiftEndTime">
          
      </div>
  </div>

  <div class="input-row">
      <input type="text" id="patternNote" placeholder="Ghi ch√∫ (T√πy ch·ªçn)">
  </div>

  <div class="list-header">
      <h4>Danh s√°ch quy t·∫Øc ng√†y l√†m</h4>      
  </div>
  <div class="collapsible-content">
    <table id="patternList">
    <thead>
      <tr><th>Nh√¢n vi√™n</th><th>T√™n hi·ªÉn th·ªã</th><th>Ki·ªÉu</th><th>Chi ti·∫øt</th><th>Ng√†y B·∫Øt ƒë·∫ßu</th><th>Ng√†y K·∫øt th√∫c</th><th>Gi·ªù Bƒê</th><th>Gi·ªù KT</th><th>H√†nh ƒë·ªông</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</div>
</div>

<div id="footer-placeholder"></div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script type="module">
    import { auth, db, onAuth, getRole, addLog, showSwal, showLoading, hideLoading, getCurrentUserEmail } from "./script.js";
    import { collection, addDoc, deleteDoc, doc, getDocs, serverTimestamp, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { initMenu } from "./menu.js";

     // === H√ÄM CHU·∫®N H√ìA K√ù T·ª∞ ƒê·∫¶U TI√äN C·ª¶A CHU·ªñI ===
    function getNormalizedFirstChar(str) {
          if (!str || str.trim() === "") return '?';
          return str
              .trim()
              .normalize('NFD') // T√°ch k√Ω t·ª± v√† d·∫•u (VD: "√â" -> "E" + "¬¥")
              .replace(/[\u0300-\u036f]/g, '') // X√≥a t·∫•t c·∫£ c√°c lo·∫°i d·∫•u
              .charAt(0) // L·∫•y k√Ω t·ª± ƒë·∫ßu ti√™n ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a
              .toUpperCase(); // Vi·∫øt hoa
    }

    // === Load menu, modal v√† footer===
    fetch("menu.html").then(r => r.text()).then(h => {
      document.getElementById("menu-placeholder").innerHTML = h;
      initMenu();
    });
    fetch("modal.html").then(r => r.text()).then(h => {
      document.getElementById("loading-placeholder").innerHTML = h;
    });
    fetch("footer.html").then(r => r.text()).then(h => {
        document.getElementById("footer-placeholder").innerHTML = h;
    });

    const notLogged = document.getElementById("notLogged");
    const content = document.getElementById("pageContent");
    let currentlyViewedDate = new Date();

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return [d.getUTCFullYear(), weekNo];
    }

    const scheduleBody = document.getElementById("scheduleBody");
    const ruleListBody = document.querySelector("#ruleList tbody");
    const jobInput = document.getElementById("jobName");
    const daySelect = document.getElementById("daySelect");
    const weekSelect = document.getElementById("weekSelect");
    const monthSelect = document.getElementById("monthSelect"); 
    const domSelect = document.getElementById("domSelect");
    const saveBtn = document.getElementById("saveRule");
    const adminConfig = document.getElementById("adminConfig");
    const manualJobInput = document.getElementById("manualJobName");
    const manualJobDate = document.getElementById("manualJobDate");
    const saveManualBtn = document.getElementById("saveManualJob");
    const manualJobList = document.querySelector("#manualJobList tbody");

    let allRulesData = [];
    let allManualJobsData = [];
    let allPatternsData = [];

    // --- D√íNG M·ªöI TH√äM V√ÄO ---
    let rulesLoaded = false;
    let manualJobsLoaded = false;
    let patternsLoaded = false;
    let initialLoadComplete = false; // C·ªù ch√≠nh

    const specificDate = document.getElementById("specificDate");
    const jobNoteInput = document.getElementById("jobNote");
    const manualJobNoteInput = document.getElementById("manualJobNote");
    const personalScheduleModal = document.getElementById("personalScheduleModal");
    const closeModalBtn = document.getElementById("closeModal");
    const personalScheduleDetails = document.getElementById("personalScheduleDetails");


    let userRole = "user";

    // --- H√ÄM 1 (M·ªöI): onAuth ---
    onAuth(async (user) => {
        if (!user) {
            notLogged.style.display = "block";
            content.style.display = "none";
            return;
        }
        userRole = await getRole(user.email);
        notLogged.style.display = "none";
        content.style.display = "block";
        if (userRole === "admin") adminConfig.classList.add("admin-visible");

        // B·∫Øt ƒë·∫ßu l·∫Øng nghe th·ªùi gian th·ª±c
        setupRealtimeListeners(user.email, userRole);
    });

    // --- H√ÄM 2 (M·ªöI): checkAllDataLoadedAndRender ---
    function checkAllDataLoadedAndRender(email, role) {
        // N·∫øu ƒë√£ t·∫£i xong l·∫ßn ƒë·∫ßu, ch·ªâ c·∫ßn v·∫Ω l·∫°i l·ªãch
        if (initialLoadComplete) {
            console.log("Real-time: D·ªØ li·ªáu thay ƒë·ªïi, v·∫Ω l·∫°i l·ªãch.");
            renderSchedule(globalSearchInput.value, currentlyViewedDate);
            return;
        }
        
        // Ki·ªÉm tra xem c·∫£ 3 listener ƒë√£ s·∫µn s√†ng ch∆∞a
        if (rulesLoaded && manualJobsLoaded && patternsLoaded) {
            initialLoadComplete = true; // ƒê√°nh d·∫•u ho√†n t·∫•t t·∫£i l·∫ßn ƒë·∫ßu
            
            console.log("T·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ t·∫£i. Hi·ªÉn th·ªã l·∫ßn ƒë·∫ßu.");
            renderSchedule(globalSearchInput.value, currentlyViewedDate);
            showPersonalScheduleModal(email, role); // G·ªçi modal sau khi ƒë√£ c√≥ d·ªØ li·ªáu
        }
    }

    // --- H√ÄM 3 (M·ªöI): setupRealtimeListeners ---
    // (H√†m n√†y thay th·∫ø cho c·∫£ 3 h√†m load... c≈©)
    function setupRealtimeListeners(email, role) {
        
        // 1. L·∫Øng nghe work_rules
        onSnapshot(collection(db, "work_rules"), (snapshot) => {
            console.log("Real-time: work_rules ƒë√£ thay ƒë·ªïi.");
            allRulesData = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
            
            // (Copy y h·ªát logic S·∫Øp x·∫øp t·ª´ h√†m loadRules c≈© c·ªßa b·∫°n)
            allRulesData.sort((a, b) => {
                const groupA = getNormalizedFirstChar(a.job);
                const groupB = getNormalizedFirstChar(b.job);
                if (groupA !== groupB) return groupA.localeCompare(groupB);
                if (b.createdAt && a.createdAt) return b.createdAt.toMillis() - a.createdAt.toMillis();
                return 0;
            });

            renderRuleList(allRulesData); // C·∫≠p nh·∫≠t b·∫£ng admin
            
            if (!rulesLoaded) rulesLoaded = true; // ƒê·∫∑t c·ªù
            checkAllDataLoadedAndRender(email, role); // Ki·ªÉm tra
        });

        // 2. L·∫Øng nghe manual_jobs
        onSnapshot(collection(db, "manual_jobs"), (snapshot) => {
            console.log("Real-time: manual_jobs ƒë√£ thay ƒë·ªïi.");
            allManualJobsData = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

            // (Copy y h·ªát logic S·∫Øp x·∫øp t·ª´ h√†m loadManualJobs c≈© c·ªßa b·∫°n)
            allManualJobsData.sort((a, b) => {
                const groupA = getNormalizedFirstChar(a.job);
                const groupB = getNormalizedFirstChar(b.job);
                if (groupA !== groupB) return groupA.localeCompare(groupB);
                if (b.createdAt && a.createdAt) return b.createdAt.toMillis() - a.createdAt.toMillis();
                return 0;
            });

            renderManualJobList(allManualJobsData); // C·∫≠p nh·∫≠t b·∫£ng admin
            
            if (!manualJobsLoaded) manualJobsLoaded = true; // ƒê·∫∑t c·ªù
            checkAllDataLoadedAndRender(email, role); // Ki·ªÉm tra
        });

        // 3. L·∫Øng nghe work_patterns
        onSnapshot(collection(db, "work_patterns"), (snapshot) => {
            console.log("Real-time: work_patterns ƒë√£ thay ƒë·ªïi.");
            allPatternsData = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

            // (Copy y h·ªát logic S·∫Øp x·∫øp t·ª´ h√†m loadPatterns c≈© c·ªßa b·∫°n)
            allPatternsData.sort((a, b) => {
                return (a.user || "").localeCompare(b.user || "");
            });

            renderPatternList(allPatternsData); // C·∫≠p nh·∫≠t b·∫£ng admin
            
            if (!patternsLoaded) patternsLoaded = true; // ƒê·∫∑t c·ªù
            checkAllDataLoadedAndRender(email, role); // Ki·ªÉm tra
        });
    }
        
    //
    function renderRuleList(rulesToRender) {
        ruleListBody.innerHTML = "";
        let lastGroupChar = null;
        let useColorB = false; // B·∫Øt ƒë·∫ßu v·ªõi m√†u A (false)

        rulesToRender.forEach(d => {
            const currentGroupChar = getNormalizedFirstChar(d.job);

            // N·∫øu chuy·ªÉn sang m·ªôt nh√≥m m·ªõi, h√£y ƒë·∫£o m√†u
            if (currentGroupChar !== lastGroupChar) {
                useColorB = !useColorB; // ƒê·∫£o m√†u (A -> B, B -> A)
                lastGroupChar = currentGroupChar;
            }

            const tr = document.createElement("tr");
            tr.className = useColorB ? 'group-color-b' : 'group-color-a';

            const noteDisplay = (d.note || "-").replace("[CVAdmin]", "<b>[CVAdmin]</b>");

            tr.innerHTML = `
                <td>${d.job}</td>
                <td>${d.time || "-"}</td>
                <td>${d.dom || "-"}</td>
                <td>${d.day === "8" ? "CN" : (d.day === "all" ? "M·ªçi ng√†y" : (d.day ? "T" + d.day : "-"))}</td>
                <td>${d.week === "all" ? "M·ªçi tu·∫ßn" : (d.week || "-")}</td>
                <td>${d.month === "all" ? "M·ªçi th√°ng" : (d.month || "-")}</td>
                <td>${noteDisplay}</td>
                <td><button data-id="${d.id}">üóëÔ∏è</button></td>`;

            tr.querySelector("button").addEventListener("click", async () => {
                const ruleIdToDelete = d.id;
                const ruleData = allRulesData.find(r => r.id === ruleIdToDelete);
                try {
                    await deleteDoc(doc(db, "work_rules", ruleIdToDelete));
                    addLog("admin_delete_work_rule", {
                        email: getCurrentUserEmail(),
                        deletedRuleId: ruleIdToDelete,
                        deletedRule: ruleData || {}
                    });
                    showSwal("success", "ƒê√£ x√≥a quy t·∫Øc!");
                } catch (error) {
                    addLog("admin_delete_work_rule_error", {
                        email: getCurrentUserEmail(),
                        ruleId: ruleIdToDelete,
                        error: error.message
                    });
                    showSwal("error", "L·ªói khi x√≥a quy t·∫Øc!");
                }
            });
            ruleListBody.appendChild(tr);
        });
    }

    

    function renderManualJobList(jobsToRender) {
        manualJobList.innerHTML = "";
        let lastGroupChar = null;
        let useColorB = false; // B·∫Øt ƒë·∫ßu v·ªõi m√†u A (false)

        jobsToRender.forEach(d => {
            const currentGroupChar = getNormalizedFirstChar(d.job);

            if (currentGroupChar !== lastGroupChar) {
                useColorB = !useColorB;
                lastGroupChar = currentGroupChar;
            }

            const tr = document.createElement("tr");
            tr.className = useColorB ? 'group-color-b' : 'group-color-a';

            const noteDisplay = (d.note || "-").replace("[CVAdmin]", "<b>[CVAdmin]</b>");

            tr.innerHTML = `
                <td>${d.job}</td>
                <td>${d.time || "-"}</td>
                <td>${d.date}</td>
                <td>${noteDisplay}</td>
                <td><button data-id="${d.id}">üóëÔ∏è</button></td>`;

            tr.querySelector("button").addEventListener("click", async () => {
                const jobIdToDelete = d.id;
                const jobData = allManualJobsData.find(j => j.id === jobIdToDelete);
                try {
                    await deleteDoc(doc(db, "manual_jobs", jobIdToDelete));
                    addLog("admin_delete_manual_job", {
                        email: getCurrentUserEmail(),
                        deletedJobId: jobIdToDelete,
                        deletedJob: jobData || {} 
                    });
                    showSwal("success", "ƒê√£ x√≥a c√¥ng vi·ªác th·ªß c√¥ng!");
                } catch (error) {
                    addLog("admin_delete_manual_job_error", {
                        email: getCurrentUserEmail(),
                        jobId: jobIdToDelete,
                        error: error.message
                    });
                    showSwal("error", "L·ªói khi x√≥a c√¥ng vi·ªác!");
                }
            });
            manualJobList.appendChild(tr);
        });
    }

    saveBtn.addEventListener("click", async () => {
        const isAdmin = document.getElementById("isAdminJobRuleCheckbox").checked;
        const originalNote = jobNoteInput.value.trim();
        
        const jobData = {
            job: jobInput.value.trim(),
            time: document.getElementById("jobTime").value,
            day: daySelect.value,
            week: weekSelect.value,
            month: monthSelect.value,
            dom: domSelect.value,
            // --- LOGIC M·ªöI CHO GHI CH√ö ---
            note: isAdmin ? `[CVAdmin] ${originalNote}`.trim() : originalNote,
            is_admin_job: isAdmin, // V·∫´n l∆∞u boolean ƒë·ªÉ ·∫©n/hi·ªán tr√™n l·ªãch
            createdAt: serverTimestamp()
        };
        if (!jobData.job) return showSwal("error", "Vui l√≤ng nh·∫≠p t√™n c√¥ng vi·ªác!");
        // (logic validation c·ªßa b·∫°n ·ªü ƒë√¢y)

        try {
            const docRef = await addDoc(collection(db, "work_rules"), jobData);
            addLog("admin_create_work_rule", {
                email: getCurrentUserEmail(),
                ruleId: docRef.id,
                ...jobData
            });
            showSwal("success", "ƒê√£ l∆∞u quy t·∫Øc!");
            [jobInput, daySelect, weekSelect, monthSelect, domSelect, jobNoteInput, document.getElementById("jobTime")].forEach(el => el.value = ""); 
        } catch (error) {
            addLog("admin_create_work_rule_error", {
                email: getCurrentUserEmail(),
                error: error.message,
                data: jobData
            });
            showSwal("error", "L·ªói!", "Kh√¥ng th·ªÉ l∆∞u quy t·∫Øc: " + error.message);
        }
    });

    saveManualBtn.addEventListener("click", async () => {
        const isAdmin = document.getElementById("isAdminManualJobCheckbox").checked;
        const originalNote = manualJobNoteInput.value.trim();

        const jobData = {
            job: manualJobInput.value.trim(),
            time: document.getElementById("manualJobTime").value,
            date: manualJobDate.value,
            // --- LOGIC M·ªöI CHO GHI CH√ö ---
            note: isAdmin ? `[CVAdmin] ${originalNote}`.trim() : originalNote,
            is_admin_job: isAdmin, // V·∫´n l∆∞u boolean
            createdAt: serverTimestamp()
        };
        if (!jobData.job || !jobData.date) return showSwal("error", "Vui l√≤ng nh·∫≠p t√™n v√† ch·ªçn ng√†y!");

        try {
            const docRef = await addDoc(collection(db, "manual_jobs"), jobData);
            addLog("admin_create_manual_job", {
                email: getCurrentUserEmail(),
                jobId: docRef.id,
                ...jobData
            });
            showSwal("success", "ƒê√£ l∆∞u c√¥ng vi·ªác th·ªß c√¥ng!");
            [manualJobInput, manualJobDate, manualJobNoteInput, document.getElementById("manualJobTime")].forEach(el => el.value = "");
        } catch (error) {
            addLog("admin_create_manual_job_error", {
                email: getCurrentUserEmail(),
                error: error.message,
                data: jobData
            });
            showSwal("error", "L·ªói!", "Kh√¥ng th·ªÉ l∆∞u c√¥ng vi·ªác: " + error.message);
        }
    });

    function getWeekOfMonth(date) {
        const day = date.getDate();
        return Math.ceil(day / 7);
    }

// --- LOGIC M·ªöI: ƒêI·ªÄU KHI·ªÇN GIAO DI·ªÜN M·ª§C 3 ---
    const patternTypeSelect = document.getElementById('patternTypeSelect');
    const administrativeInputs = document.getElementById('administrativeInputs');
    const shiftRotationInputs = document.getElementById('shiftRotationInputs');

    patternTypeSelect.addEventListener('change', () => {
        if (patternTypeSelect.value === 'administrative') {
            administrativeInputs.style.display = 'block';
            shiftRotationInputs.style.display = 'none';
        } else {
            administrativeInputs.style.display = 'none';
            shiftRotationInputs.style.display = 'block';
        }
    });

    //THAY TH·∫æ H√ÄM savePattern C≈®
    document.getElementById("savePattern").addEventListener("click", async () => {
        // --- B∆Ø·ªöC 1: L·∫§Y D·ªÆ LI·ªÜU CHUNG ---
        const user = document.getElementById("patternUser").value.trim();
        const displayName = document.getElementById("patternDisplayName").value.trim();
        const patternStartDate = document.getElementById("patternStartDate").value;
        const note = document.getElementById("patternNote").value.trim();
        const type = document.getElementById("patternTypeSelect").value;

        // --- VALIDATION C∆† B·∫¢N ---
        if (!user || !displayName || !patternStartDate) {
            return Swal.fire("Thi·∫øu th√¥ng tin!", "Vui l√≤ng nh·∫≠p Nh√¢n vi√™n, T√™n hi·ªÉn th·ªã v√† Ng√†y b·∫Øt ƒë·∫ßu.", "warning");
        }

        let data = { user, displayName, patternStartDate, note, type, createdAt: serverTimestamp() };

        // --- B∆Ø·ªöC 2: L·∫§Y D·ªÆ LI·ªÜU V√Ä VALIDATE T√ôY THEO LO·∫†I QUY T·∫ÆC ---
        if (type === 'administrative') {
            const workDaysOfWeek = Array.from(document.querySelectorAll("#dayCheckboxes input:checked")).map(cb => parseInt(cb.value));
            const startTime = document.getElementById("adminStartTime").value;
            const endTime = document.getElementById("adminEndTime").value;

            if (workDaysOfWeek.length === 0) return Swal.fire("Thi·∫øu th√¥ng tin!", "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th·ª© l√†m vi·ªác.", "warning");
            if (!startTime || !endTime) return Swal.fire("Thi·∫øu th√¥ng tin!", "Vui l√≤ng nh·∫≠p Gi·ªù b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c.", "warning");
            
            data.workDaysOfWeek = workDaysOfWeek;
            data.startTime = startTime;
            data.endTime = endTime;

            // Logic t·ª± ƒë·ªông ph√°t hi·ªán ca g·ªëi ƒë·∫ßu
            const [startH, startM] = (data.startTime || "00:00").split(':').map(Number);
            const [endH, endM] = (data.endTime || "00:00").split(':').map(Number);
            if ( (endH < startH) || (endH === startH && endM < startM) ) {
                data.isNextDay = true;
            } else if (startH === endH && startM === endM && (startH !== 0 || startM !== 0)) {
                data.isNextDay = true;
            } else {
                data.isNextDay = false;
            }

        } else { // type === 'shift_rotation'
            const startTime = document.getElementById("shiftStartTime").value;
            const endTime = document.getElementById("shiftEndTime").value;
            if (!startTime || !endTime) return Swal.fire("Thi·∫øu th√¥ng tin!", "Vui l√≤ng nh·∫≠p Gi·ªù b·∫Øt ƒë·∫ßu v√† Gi·ªù k·∫øt th√∫c ca.", "warning");
            data.startTime = startTime;
            data.endTime = endTime;

            // Logic t·ª± ƒë·ªông ph√°t hi·ªán ca g·ªëi ƒë·∫ßu
            const [startH, startM] = (data.startTime || "00:00").split(':').map(Number);
            const [endH, endM] = (data.endTime || "00:00").split(':').map(Number);
            if ( (endH < startH) || (endH === startH && endM < startM) ) {
                data.isNextDay = true;
            } else if (startH === endH && startM === endM && (startH !== 0 || startM !== 0)) {
                data.isNextDay = true;
            } else {
                data.isNextDay = false;
            }
        }

        // --- B∆Ø·ªöC 3: L∆ØU V√ÄO FIRESTORE V√Ä G·ªåI APPS SCRIPT ---
        try {
            showLoading("ƒêang l∆∞u quy t·∫Øc...");
            const docRef = await addDoc(collection(db, "work_patterns"), data);
            addLog("admin_create_work_pattern", {
                email: getCurrentUserEmail(),
                patternId: docRef.id,
                ...data
            });
            hideLoading(); // T·∫Øt loading "ƒêang l∆∞u quy t·∫Øc"
            

            // === B·∫ÆT ƒê·∫¶U KH·ªêI G·ª¨I EMAIL (ƒê√É S·ª¨A L·ªñI LOADING) ===
            try {
                showLoading("ƒêang g·ª≠i email ch√†o m·ª´ng..."); // B·∫≠t loading "G·ª≠i email"
                const idToken = await auth.currentUser.getIdToken(true);
                const scriptUrl = "https://script.google.com/macros/s/AKfycbwuNTOBpbG2Zla8V6MLRLVY_xoRPhqZS6DT6YImnw9YCOZhJARQ1mSrNLEPZvM33PwqaA/exec";
                
                const formData = new FormData();
                formData.append("action", "addUser");
                formData.append("idToken", idToken);
                formData.append("data", JSON.stringify({ name: displayName, email: user })); 
                
                const response = await fetch(scriptUrl, { method: "POST", body: formData });
                const result = await response.json();
                
                if (result.success) {
                    addLog("apps_script_add_user_success", { email: getCurrentUserEmail(), status: "success", targetUser: user });
                    showSwal("success", "ƒê√£ g·ª≠i email ch√†o m·ª´ng!");
                } else {
                    addLog("apps_script_add_user_failure", { email: getCurrentUserEmail(), targetEmail: user, error: result.message || result.error });
                    showSwal("warning", "ƒê√£ l∆∞u (L·ªói g·ª≠i email)", `ƒê√£ l∆∞u quy t·∫Øc, nh∆∞ng kh√¥ng th·ªÉ g·ª≠i email: ${result.message || result.error}`);
                }
            } catch (err) {
                addLog("apps_script_call_error", { email: getCurrentUserEmail(), targetEmail: user, error: err.message });
                showSwal("warning", "ƒê√£ l∆∞u (L·ªói g·ªçi Script)", `ƒê√£ l∆∞u quy t·∫Øc, nh∆∞ng kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Apps Script: ${err.message}`);
            } finally {
                hideLoading();
                Swal.fire("‚úÖ ƒê√£ l∆∞u!", "Quy t·∫Øc ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng.", "success");
            }
            // === K·∫æT TH√öC KH·ªêI G·ª¨I EMAIL ===

        } catch (error) {
            // L·ªói khi l∆∞u v√†o Firestore
            hideLoading();
            addLog("admin_create_work_pattern_error", {
                email: getCurrentUserEmail(),
                error: error.message,
                data: data
            });
            Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ l∆∞u quy t·∫Øc: " + error.message, "error");
        }
    });

    
function renderPatternList(patternsToRender) {
        const tbody = document.querySelector("#patternList tbody");
        tbody.innerHTML = "";
        
        patternsToRender.forEach(d => {
            let detail = "", startTime = d.startTime || "-", endTime = "-";

            if (d.type === 'administrative') {
                const mapDay = {2:"T2",3:"T3",4:"T4",5:"T5",6:"T6",7:"T7",8:"CN"};
                detail = (d.workDaysOfWeek || []).map(x => mapDay[x]).join(", ");
                endTime = d.endTime || "-"; // Hi·ªÉn th·ªã gi·ªù KT
                if(d.isNextDay) detail += " (G·ªëi ƒë·∫ßu)"; // Th√™m chi ti·∫øt g·ªëi ƒë·∫ßu
            } else if (d.type === 'shift_rotation') {
                endTime = d.endTime || "-"; // Hi·ªÉn th·ªã gi·ªù KT
                if (d.isNextDay === true) {
                    detail = "Ca xoay v√≤ng (K·∫øt th√∫c h√¥m sau)";
                } else {
                    detail = "Ca xoay v√≤ng (Trong ng√†y)";
                }
            }
            if (d.isNextDay === true && endTime !== "-") {
                                endTime += " *";
            }
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${d.user}</td>
                <td>${d.displayName || "-"}</td>
                <td>${d.type === "administrative" ? "C·ªë ƒë·ªãnh" : "Xoay V√≤ng"}</td>
                <td>${detail}</td>
                <td>${d.patternStartDate}</td>
                <td><input type="date" class="end-date-input" data-id="${d.id}" value="${d.patternEndDate || ""}" title="Ch·ªçn ƒë·ªÉ ƒë·∫∑t ng√†y k·∫øt th√∫c."></td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td><button class="delPattern" data-id="${d.id}">üóëÔ∏è</button></td>`;

            // G·∫Øn s·ª± ki·ªán T·ª± ƒë·ªông l∆∞u Ng√†y K·∫øt th√∫c
            tr.querySelector(".end-date-input").addEventListener('change', async (e) => {
                const ruleId = e.target.dataset.id;
                const newEndDate = e.target.value;
                const ruleRef = doc(db, "work_patterns", ruleId);
                
                try {
                    showLoading("ƒêang c·∫≠p nh·∫≠t...");
                    await updateDoc(ruleRef, {
                        patternEndDate: newEndDate || null 
                    });
                    hideLoading();
                    Swal.fire("ƒê√£ c·∫≠p nh·∫≠t!", "ƒê√£ c·∫≠p nh·∫≠t ng√†y k·∫øt th√∫c.", "success");
                } catch (error) {
                    hideLoading();
                    Swal.fire("L·ªói!", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t: " + error.message, "error");
                }
            });

            // G·∫Øn s·ª± ki·ªán cho n√∫t X√≥a (C·∫¢I TI·∫æN 3)
            tr.querySelector(".delPattern").addEventListener("click", async (e) => {
                const patternIdToDelete = e.target.dataset.id;
                
                // --- B·∫ÆT ƒê·∫¶U C·∫¢NH B√ÅO ---
                Swal.fire({
                    title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn?',
                    text: "X√≥a vƒ©nh vi·ªÖn quy t·∫Øc n√†y c√≥ th·ªÉ l√†m x√°o tr·ªôn l·ªãch s·ª≠ xoay ca! B·∫°n n√™n s·ª≠ d·ª•ng 'Ng√†y k·∫øt th√∫c' ƒë·ªÉ thay th·∫ø.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'V·∫´n x√≥a!',
                    cancelButtonText: 'H·ªßy'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            await deleteDoc(doc(db, "work_patterns", patternIdToDelete));
                            Swal.fire('ƒê√£ x√≥a!', 'Quy t·∫Øc ƒë√£ b·ªã x√≥a.', 'success');
                        } catch (error) {
                            Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ x√≥a: ' + error.message, 'error');
                        }
                    }
                });
                // --- K·∫æT TH√öC C·∫¢NH B√ÅO ---
            });
            tbody.appendChild(tr);
        });
    }
    // X√≥a h√†m findWorkersForDate c≈© ƒëi.
    // Thay th·∫ø ho√†n to√†n h√†m renderSchedule c≈© b·∫±ng h√†m m·ªõi n√†y.

// Th√™m helper: ki·ªÉm tra 1 rule c√≥ ph√π h·ª£p v·ªõi ng√†y d kh√¥ng
function ruleMatchesDate(rule, d) {
    const dayNum = d.getDate();                    // ng√†y trong th√°ng (1..31)
    const monthNum = d.getMonth() + 1;             // th√°ng (1..12)
    const weekOfMonth = getWeekOfMonth(d);         // h√†m b·∫°n ƒë√£ c√≥
    const weekDay = d.getDay() === 0 ? 8 : d.getDay() + 1; // mapping: CN -> 8, T2..T7 -> 2..7

    // Ng√†y c·ª• th·ªÉ trong th√°ng (dom)
    if (rule.dom && rule.dom !== "" && rule.dom !== String(dayNum)) return false;

    // Th·ª©
    if (rule.day && rule.day !== "" && rule.day !== "all") {
        // rule.day c√≥ th·ªÉ l∆∞u l√† string '8' cho CN ho·∫∑c s·ªë kh√°c
        if (Number(rule.day) !== Number(weekDay)) return false;
    }

    // Tu·∫ßn trong th√°ng
    if (rule.week && rule.week !== "" && rule.week !== "all") {
        if (Number(rule.week) !== Number(weekOfMonth)) return false;
    }

    // Th√°ng
    if (rule.month && rule.month !== "" && rule.month !== "all") {
        if (Number(rule.month) !== Number(monthNum)) return false;
    }

    return true;
}

// T√¨m danh s√°ch c√¥ng vi·ªác (work_rules) ph√π h·ª£p cho 1 ng∆∞·ªùi v√†o 1 ng√†y
function findJobsForPersonOnDate(personDisplayName, d) {
    // N·∫øu mu·ªën match theo user (email/m√£) thay displayName b·∫±ng pattern.user
    // ·ªû ƒë√¢y ta match theo rule chung (kh√¥ng g√°n admin job m·∫∑c ƒë·ªãnh)
    const matched = allRulesData.filter(rule => {
        // B·ªè qua quy t·∫Øc ch·ªâ d√†nh cho admin (n·∫øu b·∫°n mu·ªën bao g·ªìm, remove ƒëi·ªÅu ki·ªán n√†y)
        if (rule.is_admin_job) return false;
        return ruleMatchesDate(rule, d);
    });

    // N·∫øu mu·ªën gi·ªõi h·∫°n job theo ng∆∞·ªùi c·ª• th·ªÉ (vd rule c√≥ tr∆∞·ªùng assignedTo), th√™m ƒëi·ªÅu ki·ªán ·ªü tr√™n.
    // Tr·∫£ v·ªÅ m·∫£ng chu·ªói m√¥ t·∫£ ng·∫Øn
    return matched.map(r => {
        const timePart = r.time ? ` ${r.time}` : "";
        return `${r.job}${timePart}${r.note ? " ‚Äî " + r.note : ""}`;
    });
}
//
/**
     * Helper 1: Ki·ªÉm tra quy t·∫Øc c√≤n hi·ªáu l·ª±c
     */
    const isRuleActiveOnDate = (rule, date) => {
        const startDate = new Date(rule.patternStartDate + 'T00:00:00');
        const endDate = rule.patternEndDate ? new Date(rule.patternEndDate + 'T00:00:00') : null;
        if (date < startDate) return false;
        if (endDate && date > endDate) return false;
        return true;
    };
    
    /**
     * Helper 2 (M·ªöI): Logic s·∫Øp x·∫øp xoay ca 3 c·∫•p
     * ∆Øu ti√™n 1: Ng√†y b·∫Øt ƒë·∫ßu (s·ªõm nh·∫•t tr∆∞·ªõc)
     * ∆Øu ti√™n 2: Gi·ªù b·∫Øt ƒë·∫ßu (s·ªõm nh·∫•t tr∆∞·ªõc)
     * ∆Øu ti√™n 3: T√™n A-Z
     */
    const sortShiftRules = (a, b) => {
        // 1. So s√°nh Ng√†y
        const dateA = new Date(a.patternStartDate);
        const dateB = new Date(b.patternStartDate);
        if (dateA - dateB !== 0) {
            return dateA - dateB;
        }

        // 2. So s√°nh Gi·ªù (n·∫øu Ng√†y tr√πng)
        const timeA = a.startTime || "00:00";
        const timeB = b.startTime || "00:00";
        if (timeA.localeCompare(timeB) !== 0) {
            return timeA.localeCompare(timeB);
        }

        // 3. So s√°nh T√™n (n·∫øu c·∫£ Ng√†y v√† Gi·ªù tr√πng)
        return (a.displayName || "").localeCompare(b.displayName || "");
    };
// H√†m renderSchedule thay th·∫ø ‚Äî d√°n ƒë√® h√†m c≈©
async function renderSchedule(searchQuery = "", referenceDate = new Date()) {
    scheduleBody.innerHTML = "";
    
    const lowerCaseQuery = searchQuery.toLowerCase().trim();

    const weekStart = new Date(referenceDate);
    weekStart.setDate(referenceDate.getDate() - weekStart.getDay() + (weekStart.getDay() === 0 ? -6 : 1));

    const adminRules = allPatternsData.filter(p => p.type === 'administrative');
    const allShiftRules = allPatternsData.filter(p => p.type === 'shift_rotation');

    for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        const yesterday = new Date(d);
        yesterday.setDate(d.getDate() - 1);

        let people = [];  // danh s√°ch ng∆∞·ªùi l√†m (t√™n + ca/gi·ªù)

        const dayOfWeek = d.getDay() === 0 ? 8 : d.getDay() + 1;

        // ===== 1) L·ªäCH C·ªê ƒê·ªäNH (C·∫¨P NH·∫¨T C·∫¢I TI·∫æN 1) =====
        adminRules.forEach(rule => {
            if (!isRuleActiveOnDate(rule, d) || !Array.isArray(rule.workDaysOfWeek)) {
                return;
            }

            const startTime = rule.startTime || "00:00";
            const endTime = rule.endTime || "00:00";
            
            // --- LOGIC M·ªöI T·ª∞ SUY LU·∫¨N ---
            const [startH, startM] = (startTime || "00:00").split(':').map(Number);
            const [endH, endM] = (endTime || "00:00").split(':').map(Number);
            let isNightShift = false;

            if ( (endH < startH) || (endH === startH && endM < startM) ) {
                isNightShift = true;
            } else if (rule.isNextDay === true && startH === endH && startM === endM) {
                isNightShift = true; // X·ª≠ l√Ω ca 24h
            }
            // --- K·∫æT TH√öC LOGIC M·ªöI ---
            
            const prevDay = dayOfWeek === 2 ? 8 : dayOfWeek - 1;

            // 1Ô∏è‚É£ Ca b·∫Øt ƒë·∫ßu h√¥m nay
            if (rule.workDaysOfWeek.includes(dayOfWeek)) {
                const shiftLabel = isNightShift
                    ? `- ${rule.displayName} (${startTime} ‚Äì ${endTime} h√¥m sau)`
                    : `- ${rule.displayName} (${startTime} ‚Äì ${endTime})`;
                people.push(shiftLabel);
                // (Kh√¥ng t√¨m c√¥ng vi·ªác ·ªü ƒë√¢y n·ªØa)
            }
            // 2Ô∏è‚É£ Ca b·∫Øt ƒë·∫ßu h√¥m qua nh∆∞ng k√©o sang h√¥m nay
            else if (isNightShift && rule.workDaysOfWeek.includes(prevDay)) {
                //const shiftLabel = `- ${rule.displayName} (Ti·∫øp ca ƒë√™m ${startTime} h√¥m qua ‚Äì ${endTime} s√°ng nay)`;
                //people.push(shiftLabel);
                // (Kh√¥ng t√¨m c√¥ng vi·ªác ·ªü ƒë√¢y n·ªØa)
            }
        });


        // ===== 2) L·ªäCH XOAY CA (C·∫¨P NH·∫¨T C·∫¢I TI·∫æN 4) =====
        if (allShiftRules.length > 0) {
            
            // 1. T√¨m "Ng√†y 0" (refDate) ·ªïn ƒë·ªãnh - D√ôNG LOGIC S·∫ÆP X·∫æP M·ªöI
            // (Ch√∫ng ta s·∫Øp x·∫øp to√†n b·ªô 1 l·∫ßn ƒë·ªÉ t√¨m ra ng∆∞·ªùi ƒë·∫ßu ti√™n tuy·ªát ƒë·ªëi)
            const sortedAllRules = [...allShiftRules].sort(sortShiftRules);
            const refDate = new Date(sortedAllRules[0].patternStartDate + 'T00:00:00');
            
            // 2. L·ªçc v√† S·∫ÆP X·∫æP danh s√°ch H√îM QUA (D√ôNG LOGIC M·ªöI)
            const membersYesterday = allShiftRules
                .filter(rule => isRuleActiveOnDate(rule, yesterday))
                .sort(sortShiftRules); // <-- √ÅP D·ª§NG LOGIC S·∫ÆP X·∫æP M·ªöI
            
            // 3. L·ªçc v√† S·∫ÆP X·∫æP danh s√°ch H√îM NAY (D√ôNG LOGIC M·ªöI)
            const membersToday = allShiftRules
                .filter(rule => isRuleActiveOnDate(rule, d))
                .sort(sortShiftRules); // <-- √ÅP D·ª§NG LOGIC S·∫ÆP X·∫æP M·ªöI

            let workerYesterday = null, isNightYesterday = false, workerYesterdayName = null;

            // 4. T√çNH CA H√îM QUA
            if (membersYesterday.length > 0) {
                const n_yesterday = membersYesterday.length;
                const daysSinceYesterday = Math.floor((yesterday - refDate) / (1000 * 60 * 60 * 24));
                const workerIndexYesterday = (daysSinceYesterday % n_yesterday + n_yesterday) % n_yesterday;
                
                workerYesterday = membersYesterday[workerIndexYesterday];
                workerYesterdayName = workerYesterday.displayName;
                if (workerYesterday) {
                    const [startH, startM] = (workerYesterday.startTime || "00:00").split(':').map(Number);
                    const [endH, endM] = (workerYesterday.endTime || "00:00").split(':').map(Number);

                    if ( (endH < startH) || (endH === startH && endM < startM) ) {
                        isNightYesterday = true;
                    } else if (workerYesterday.isNextDay === true && startH === endH && startM === endM) {
                        isNightYesterday = true; // Ca 24h
                    }
                }
                
                if (isNightYesterday) {
                    //const shiftLabel = `- ${workerYesterday.displayName} (Ti·∫øp ca ƒë√™m ${workerYesterday.startTime} h√¥m qua ‚Äì ${workerYesterday.endTime} s√°ng nay)`;
                    //people.push(shiftLabel);
                }
            }

            // 5. T√çNH CA H√îM NAY
            if (membersToday.length > 0) {
                const n_today = membersToday.length;
                const daysSinceToday = Math.floor((d - refDate) / (1000 * 60 * 60 * 24));
                const workerIndexToday = (daysSinceToday % n_today + n_today) % n_today;
                const workerToday = membersToday[workerIndexToday];
                
                if (workerToday) {
                    let isNightToday = false;
                    const [startH, startM] = (workerToday.startTime || "00:00").split(':').map(Number);
                    const [endH, endM] = (workerToday.endTime || "00:00").split(':').map(Number);

                    if ( (endH < startH) || (endH === startH && endM < startM) ) {
                        isNightToday = true;
                    } else if (workerToday.isNextDay === true && startH === endH && startM === endM) {
                        isNightToday = true; // Ca 24h
                    }
                    if (!isNightYesterday || workerYesterdayName !== workerToday.displayName) {
                        const shiftLabel = `- ${workerToday.displayName} (${workerToday.startTime} ‚Äì ${workerToday.endTime}${isNightToday ? " h√¥m sau" : ""})`;
                        people.push(shiftLabel);
                    }
                }
            }
        }

// ===== 3) T·ªîNG H·ª¢P C√îNG VI·ªÜC (C·∫¨P NH·∫¨T C·∫¢I TI·∫æN 2) =====
        
        let jobsForDay = []; // Kh·ªüi t·∫°o m·∫£ng c√¥ng vi·ªác
        let notesForDay = []; // KH·ªûI T·∫†O M·∫¢NG GHI CH√ö (M·ªöI)
        
        // 3.1) L·ªçc C√¥ng vi·ªác Quy t·∫Øc (M·ª•c 1)
        const allRuleJobs = allRulesData.filter(rule => 
            ( !rule.is_admin_job || userRole === 'admin' ) &&
            ruleMatchesDate(rule, d) 
        );
        allRuleJobs.forEach(r => {
            jobsForDay.push(`${r.job}${r.time ? " " + r.time : ""}`);
            
            // T·∫°o ghi ch√∫
            const noteDisplay = (r.note || "").replace("[CVAdmin]", "<b>[CVAdmin]</b>");
            
            // --- S·ª¨A LOGIC ---
            // Lu√¥n push 1 gi√° tr·ªã ƒë·ªÉ 2 m·∫£ng song h√†nh
            notesForDay.push(noteDisplay && noteDisplay !== "" ? noteDisplay : "");
        });

        // 3.2) L·ªçc C√¥ng vi·ªác Th·ªß c√¥ng (M·ª•c 2)
        const isoDate = d.toISOString().slice(0, 10);
        const allManualJobs = allManualJobsData.filter(m => 
            ( !m.is_admin_job || userRole === 'admin' ) &&
            m.date === isoDate 
        );
        allManualJobs.forEach(mj => {
            jobsForDay.push(`${mj.job}${mj.time ? " " + mj.time : ""}`);
            
            // T·∫°o ghi ch√∫
            const noteDisplay = (mj.note || "").replace("[CVAdmin]", "<b>[CVAdmin]</b>");

            // --- S·ª¨A LOGIC ---
            // Lu√¥n push 1 gi√° tr·ªã ƒë·ªÉ 2 m·∫£ng song h√†nh
            notesForDay.push(noteDisplay && noteDisplay !== "" ? noteDisplay : "");
        });

        // ===== 4) HI·ªÇN TH·ªä TR√äN B·∫¢NG =====
        const thuDisplay = d.getDay() === 0 ? 'Ch·ªß Nh·∫≠t' : 'Th·ª© ' + (d.getDay() + 1);
        const dateStr = d.toLocaleDateString("vi-VN");
        const [year, weekNo] = getWeekNumber(d);
        const tr = document.createElement("tr");
        
        // Th√™m t√¥ s√°ng "h√¥m nay"
        const today = new Date();
        if (d.toDateString() === today.toDateString()) {
            tr.classList.add('today-row');
        }

        // T·∫°o n·ªôi dung cho c·ªôt Ghi ch√∫
        const notesContent = notesForDay.length 
            ? notesForDay.map(n => (n !== "") ? `- ${n}` : "").join('<br>') 
            : '-';

        tr.innerHTML = `
            <td data-label="Ng√†y">${thuDisplay} (${dateStr}) <br> <span class="week-label">(Tu·∫ßn ${weekNo})</span></td>
            <td data-label="Ng∆∞·ªùi l√†m">${people.length ? people.join('<br>') : '-'}</td>
            <td data-label="C√¥ng vi·ªác">${jobsForDay.length ? jobsForDay.map(j => `- ${j}`).join('<br>') : '-'}</td>
            <td data-label="Ghi ch√∫">${notesContent}</td>
        `;
        if (lowerCaseQuery && tr.textContent.toLowerCase().includes(lowerCaseQuery)) {
            tr.classList.add('highlight');
        }
        scheduleBody.appendChild(tr);
    }

    const [year, weekNo] = getWeekNumber(referenceDate);
    document.getElementById('weekNumberDisplay').textContent = `Tu·∫ßn ${weekNo} / ${year}`;
}

    


    function getDaysDifference(date1, date2) {
        const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.round((d1 - d2) / (1000 * 60 * 60 * 24));
    }
    
    // Logic modal
    closeModalBtn.onclick = () => personalScheduleModal.style.display = "none";
    window.onclick = (event) => { if (event.target == personalScheduleModal) personalScheduleModal.style.display = "none"; };
    document.getElementById("closeModalBottom").onclick = () => personalScheduleModal.style.display = "none";

    

    // Logic t√¨m ki·∫øm
    const globalSearchInput = document.getElementById('globalSearchInput');
    globalSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        filterAndRenderAdminLists(query);
        renderSchedule(query, currentlyViewedDate);
    });

    function filterAndRenderAdminLists(query) {
        // N·∫øu kh√¥ng c√≥ query, hi·ªÉn th·ªã l·∫°i t·∫•t c·∫£
        if (!query) {
            renderRuleList(allRulesData);
            renderManualJobList(allManualJobsData);
            renderPatternList(allPatternsData);
            return;
        }

        // 1. L·ªçc B·∫£ng 1: Quy t·∫Øc c√¥ng vi·ªác (T√¨m theo T√™n CV, Ghi ch√∫)
        const filteredRules = allRulesData.filter(rule => 
            (rule.job && rule.job.toLowerCase().includes(query)) ||
            (rule.note && rule.note.toLowerCase().includes(query))
        );
        renderRuleList(filteredRules);

        // 2. L·ªçc B·∫£ng 2: CV Th·ªß c√¥ng (T√¨m theo T√™n CV, Ghi ch√∫, Ng√†y)
        const filteredManualJobs = allManualJobsData.filter(job => 
            (job.job && job.job.toLowerCase().includes(query)) ||
            (job.note && job.note.toLowerCase().includes(query)) ||
            (job.date && job.date.includes(query))
        );
        renderManualJobList(filteredManualJobs);

        // 3. L·ªçc B·∫£ng 3: Quy t·∫Øc ng√†y l√†m (T√¨m theo Email, T√™n hi·ªÉn th·ªã)
        const filteredPatterns = allPatternsData.filter(p => 
            (p.user && p.user.toLowerCase().includes(query)) ||
            (p.displayName && p.displayName.toLowerCase().includes(query))
        );
        renderPatternList(filteredPatterns);
    }
    // Logic chuy·ªÉn tu·∫ßn
    const weekNav = document.getElementById('weekNavigator');
    if (weekNav) {
        weekNav.addEventListener('click', (event) => {
            const targetId = event.target.id;
            const currentYear = currentlyViewedDate.getFullYear();
            switch (targetId) {
                case 'prevWeekBtn': currentlyViewedDate.setDate(currentlyViewedDate.getDate() - 7); break;
                case 'nextWeekBtn': currentlyViewedDate.setDate(currentlyViewedDate.getDate() + 7); break;
                case 'todayWeekBtn': currentlyViewedDate = new Date(); break;
                case 'firstWeekBtn': currentlyViewedDate = new Date(currentYear, 0, 1); break;
                case 'lastWeekBtn': currentlyViewedDate = new Date(currentYear, 11, 31); break;
                default: return;
            }
            renderSchedule(globalSearchInput.value, currentlyViewedDate);
        });
    }

  // H√†m g·ªçi modal l·ªãch l√†m vi·ªác c√° nh√¢n (ƒê√É S·ª¨A L·∫†I HO√ÄN TO√ÄN)
  async function showPersonalScheduleModal(email, currentUserRole) {
      personalScheduleModal.style.display = "block";
      personalScheduleDetails.innerHTML = "<p>ƒêang t·∫£i l·ªãch c√° nh√¢n...</p>";

      // 1. L·∫§Y QUY T·∫ÆC C√Å NH√ÇN
      const todayForFilter = new Date();
      const userPatterns = allPatternsData.filter(p => p.user === email && isRuleActiveOnDate(p, todayForFilter));

      if (userPatterns.length === 0) {
          personalScheduleDetails.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y quy t·∫Øc l√†m vi·ªác n√†o ƒëang ho·∫°t ƒë·ªông cho t√†i kho·∫£n n√†y.</p>";
          return;
      }

      // 2. L·∫§Y TH√îNG TIN ƒê·ªÇ T√çNH XOAY CA (N·∫æU C√ì)
      const allShiftRules = allPatternsData.filter(p => p.type === 'shift_rotation');
      const sortedAllRules = [...allShiftRules].sort(sortShiftRules);
      const refDate = (sortedAllRules.length > 0) ? new Date(sortedAllRules[0].patternStartDate + 'T00:00:00') : null;

      const today = new Date();
      
      // 3. T√çNH KHUNG TH·ªúI GIAN (T·ª™ H√îM NAY ƒê·∫æN CH·ª¶ NH·∫¨T)
      const currentDayOfWeek = today.getDay(); // 0=CN, 1=T2, 6=T7
      // daysToScan = s·ªë ng√†y c√≤n l·∫°i (0 = h√¥m nay)
      // T2(1) -> 6 (i=0..6)
      // T7(6) -> 1 (i=0..1)
      // CN(0) -> 0 (i=0)
      const daysToScan = (currentDayOfWeek === 0) ? 0 : (7 - currentDayOfWeek);

      let html = `<table style="width:100%; border-collapse:collapse; border:1px solid #ccc; text-align:left;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">Ng√†y & Ca l√†m</th>
            <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">C√¥ng vi·ªác & Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody>`;

      let hasWorkDay = false; // Bi·∫øn ki·ªÉm tra

      // 4. L·∫∂P QUA C√ÅC NG√ÄY C√íN L·∫†I TRONG TU·∫¶N
      for (let i = 0; i <= daysToScan; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() + i);
          const dayNum = d.getDay() === 0 ? 8 : d.getDay() + 1;
          const isToday = d.toDateString() === today.toDateString();
          const dateStr = d.toLocaleDateString("vi-VN");
          const thuDisplay = d.getDay() === 0 ? 'Ch·ªß Nh·∫≠t' : 'Th·ª© ' + (d.getDay() + 1);

          let matchedShifts = [];

          // --- T√åM CA L√ÄM C·ª¶A C√Å NH√ÇN ---
          userPatterns.forEach(rule => {
              if (!isRuleActiveOnDate(rule, d)) return;
              // L·ªãch C·ªë ƒë·ªãnh
              if (rule.type === "administrative" && Array.isArray(rule.workDaysOfWeek) && rule.workDaysOfWeek.includes(dayNum)) {
                  matchedShifts.push(`üë§ ${rule.displayName} (${rule.startTime} ‚Äì ${rule.endTime}${rule.isNextDay ? " (h√¥m sau)" : ""})`);
              }
              // L·ªãch Xoay V√≤ng
              if (rule.type === "shift_rotation" && refDate) {
                  const allMembersToday = allShiftRules.filter(r => isRuleActiveOnDate(r, d)).sort(sortShiftRules);
                  if (allMembersToday.length > 0) {
                      const n_today = allMembersToday.length;
                      const daysSinceToday = Math.floor((d - refDate) / (1000 * 60 * 60 * 24));
                      const workerIndexToday = (daysSinceToday % n_today + n_today) % n_today;
                      const workerToday = allMembersToday[workerIndexToday];
                      
                      if (workerToday && workerToday.displayName === rule.displayName) {
                          matchedShifts.push(`üë§ ${rule.displayName} (${rule.startTime} ‚Äì ${rule.endTime}${rule.isNextDay ? " (h√¥m sau)" : ""})`);
                      }
                  }
              }
          });
          // --- K·∫æT TH√öC T√åM CA L√ÄM ---

          // Ch·ªâ hi·ªÉn th·ªã ng√†y c√≥ l√†m vi·ªác
          if (matchedShifts.length > 0) {
              hasWorkDay = true;
              let tasksHtml = "";

              // --- T√åM C√îNG VI·ªÜC (S·ª¨A L·∫†I LOGIC HI·ªÇN TH·ªä) ---
              // (Code l·ªçc allRuleJobs v√† allManualJobs)
              const allRuleJobs = allRulesData.filter(rule => 
                  ( !rule.is_admin_job || currentUserRole === 'admin' ) && 
                  ruleMatchesDate(rule, d)
              );
              const isoDate = d.toISOString().slice(0, 10);
              const allManualJobs = allManualJobsData.filter(m => 
                  ( !m.is_admin_job || currentUserRole === 'admin' ) &&
                  m.date === isoDate
              );
              
              const allTasks = [...allRuleJobs, ...allManualJobs];

              if (allTasks.length > 0) {
                  // D√πng logic map().join() gi·ªëng h·ªát b·∫£ng ch√≠nh
                  const tasksArray = allTasks.map(task => {
                      const noteDisplay = (task.note || "").replace("[CVAdmin]", "<b>[CVAdmin]</b>");
                      const noteString = noteDisplay && noteDisplay !== "" ? ` <i>‚Äî ${noteDisplay}</i>` : "";
                      // Th√™m g·∫°ch ngang "- "
                      return `- ${task.job} ${task.time ? `(${task.time})` : ""}${noteString}`;
                  });
                  tasksHtml = tasksArray.join('<br>'); // N·ªëi b·∫±ng <br>
              } else {
                  // B·ªè padding-left
                  tasksHtml = "<i style='font-size: 0.9em;'>Kh√¥ng c√≥ c√¥ng vi·ªác chung n√†o ƒë∆∞·ª£c g√°n.</i>";
              }
              // --- K·∫æT TH√öC T√åM C√îNG VI·ªÜC ---
              // --- K·∫æT TH√öC T√åM C√îNG VI·ªÜC ---

              // G·ªôp n·ªôi dung ca l√†m
              const shiftContent = matchedShifts.join("<br>");

              html += `
                <tr${isToday ? " style='background:#dff0ff;font-weight:bold;'" : ""}>
                  <td style="padding: 8px; border: 1px solid #ccc; text-align: center;">
                    ${thuDisplay}<br>${dateStr}
                    <br>
                    <span style="font-size: 0.9em; color: #333;">${shiftContent}</span>
                  </td>
                  <td style="padding: 8px; border: 1px solid #ccc; text-align: left;">${tasksHtml}</td>
                </tr>`;
          }
      } // K·∫øt th√∫c v√≤ng l·∫∑p

      html += `</tbody></table>`;
      
      if (!hasWorkDay) {
          html = `<p>B·∫°n kh√¥ng c√≥ l·ªãch l√†m vi·ªác n√†o t·ª´ h√¥m nay ƒë·∫øn cu·ªëi tu·∫ßn.</p>`;
      }
      
      personalScheduleDetails.innerHTML = html;
  }

  </script>

</body>
</html>