<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ch√†o M·ª´ng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Th√™m th∆∞ vi·ªán Fuse.js ƒë·ªÉ t√¨m ki·∫øm m·ªù -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
</head>
    <style>
        body {
            margin: 0;
            padding: 0;

        }

        /* Div ri√™ng bi·ªát cho ·∫£nh n·ªÅn */
        #background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://cdn.vietnambiz.vn/2019/9/19/httpsspecials-imagesforbesimgcomdamimageserve1149089169960x0-15688771604242001572975.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1; /* ƒê·∫∑t div n√†y ·ªü l·ªõp d∆∞·ªõi c√πng */

            /* √Åp d·ª•ng tr·ª±c ti·∫øp hi·ªáu ·ª©ng l√†m m·ªù cho h√¨nh n·ªÅn */
            filter: blur(5px);
            -webkit-filter: blur(5px); /* H·ªó tr·ª£ tr√¨nh duy·ªát Safari */
        }

        /* Container ch·ª©a t·∫•t c·∫£ n·ªôi dung trang */
            #content-container {
                position: relative;
                z-index: 1; 
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;

                /* Thay ƒë·ªïi d√≤ng min-height th√†nh flex: 1 */
                flex: 1; /* <-- Quan tr·ªçng: D√≤ng n√†y s·∫Ω l√†m n√≥ chi·∫øm h·∫øt kh√¥ng gian th·ª´a */
            }
        .welcome-text {
            color: #1f5a92;
            text-shadow: 2px 2px 4px rgba(235, 241, 243, 0.9);
        }
        /* CSS ƒëi·ªÉu ch·ªânh footer */
        .site-footer {
            background-color: transparent !important; /* L√†m cho n·ªÅn trong su·ªët */
            border-top: none !important; /* B·ªè ƒë∆∞·ªùng k·∫ª ph√≠a tr√™n footer */
            color: #fff; /* ƒê·ªïi m√†u ch·ªØ th√†nh tr·∫Øng ƒë·ªÉ d·ªÖ ƒë·ªçc tr√™n n·ªÅn ·∫£nh */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); /* Th√™m b√≥ng cho ch·ªØ ƒë·ªÉ n·ªïi b·∫≠t h∆°n */
        }

        .site-footer a {
            color: #f0f8ff; /* ƒê·ªïi m√†u link cho s√°ng h∆°n */
        }
        #footer-placeholder {
            margin-bottom: 40px; /* Th√™m kho·∫£ng c√°ch ƒë·ªÉ kh√¥ng b·ªã che b·ªüi d√≤ng ch·ªØ ch·∫°y */
        }
        /* Home login box */
        .home-login-box {
            margin-top: 18px;
            background: rgba(255,255,255,0.7); /* slightly translucent */
            padding: 18px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.14);
            max-width: 420px;
            width: 95%;
            color: #034892;
            text-align: center; /* center labels and header */
        }
        /* Keep welcome text centered on all sizes and ensure two-line center alignment */
        .welcome-text {
            text-align: center;
            text-transform: uppercase; /* display in uppercase as requested */
            line-height: 1.05;
        }
        @media (min-width: 900px) {
            /* On larger screens keep column layout but align items centered */
            #content-container { flex-direction: column; gap: 18px; }
        }

        /* Footer bar with scrolling message */
        .home-footer-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15,30,60,0.6);
            color: #fff;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1;  /* ƒê·∫∑t z-index th·∫•p h∆°n ƒë·ªÉ n·∫±m d∆∞·ªõi footer */
            font-size: 14px;
        }
        .home-footer-date { margin-left: 8px; white-space: nowrap; }
        .marquee-wrap { 
            overflow: hidden; 
            flex: 1;
        }
        .marquee {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: marquee 30s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* Chatbox styles */
        .chat-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .chat-header {
            background: #1f3765;
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin: 5px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background: #e3f2fd;
            align-self: flex-end;
        }

        .bot-message {
            background: #f5f5f5;
            align-self: flex-start;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }

        .chat-input button {
            padding: 10px 20px;
            background: #1f3765;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .chat-input button:hover {
            background: #2c4d8c;
        }

        .chat-toggle {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: #1f3765;
            color: white;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-container.hidden {
            transform: translateX(400px);
            opacity: 0;
        }
    </style>

<body>

    <div id="background-image"></div>
    <div id="menu-placeholder"></div>
    <div id="loading-placeholder"></div>
    <div id="alert-placeholder"></div>

    <div id="content-container">
        <h1 class="welcome-text">CH√ÄO M·ª™NG B·∫†N ƒê·∫æN V·ªöI<br>KHU C√îNG NGHI·ªÜP TH·ªêT N·ªêT</h1>
        <!-- Inline login box (always visible) so users can login without opening modal -->
        <div class="home-login-box" aria-label="ƒêƒÉng nh·∫≠p nhanh">
            <h3 style="margin:0 0 8px 0; color:#0b3b6f;">ƒêƒÉng nh·∫≠p</h3>
            <form id="homeLoginForm">
                <input type="email" id="homeEmail" name="email" placeholder="Email" required style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:6px;" />
                <input type="password" id="homePassword" name="password" placeholder="M·∫≠t kh·∫©u" required style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ddd; border-radius:6px;" />
                <button type="submit" id="homeLoginSubmit" class="submit-btn" style="width:100%; background:#1f3765; color:#fff; padding:10px; border-radius:6px; border:none;">ƒêƒÉng nh·∫≠p</button>
            </form>
        </div>
    </div>


    <div id="footer-placeholder"></div>
    <div class="home-footer-bar" role="contentinfo">
      <div class="marquee-wrap"><div class="marquee" id="homeMarquee">CH√ÄO M·ª™NG B·∫†N ƒê·∫æN V·ªöI TRUNG T√ÇM X√ÇY D·ª∞NG H·∫† T·∫¶NG KHU C√îNG NGHI·ªÜP TH·ªêT N·ªêT,  KV TH·ªöI H√íA 1, P. TH·ªêT N·ªêT, TP C·∫¶N TH∆†</div></div>
      <div class="home-footer-date" id="homeFooterDate"></div>
    </div>

    <!-- Chat Toggle Button -->
    <div class="chat-toggle" id="chatToggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="currentColor"/>
        </svg>
    </div>

    <!-- Chat Container -->
    <div class="chat-container hidden" id="chatContainer">
        <div class="chat-header">
            <span>Tr·ª£ l√Ω KCN Th·ªët N·ªët <span id="aiStatus" style="font-size: 10px; opacity: 0.7;"></span></span>
            <span style="cursor: pointer" id="chatClose">‚úï</span>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa KCN Th·ªët N·ªët. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." />
            <button id="chatSubmit">G·ª≠i</button>
            <button id="chatReset" style="background: #6c757d; margin-left: 5px;" title="ƒê·∫∑t l·∫°i h·ªôi tho·∫°i">‚Üª</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script type="module">
        import { initMenu } from "./menu.js"; // Gi·ªØ nguy√™n
        import { auth, addLog, showSwal, db, collection, query, getDocs, where, orderBy, limit } from "./script.js";
        import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        // Import AI chatbot functions
        import { getAIResponse, detectDataQuery, resetConversation, hasValidAPIKey } from "./chatbot-ai.js";
        // Import Firebase query functions
        import { 
            getLatestCompanyIndex, 
            getCompanyIndexHistory,
            getTotalCompanies,
            getAllCompanies,
            compareCompaniesThisMonth,
            getHolidays, 
            getNextHoliday,
            getSpecialWorkdays,
            getWeeklyStatistics,
            getMonthlyStatistics,
            getTopConsumers,
            getQuotaMultipliers,
            getStartDaySettings,
            getDefaultHolidays
        } from "./chatbot-firebase-queries.js";

        // load menu
        fetch("menu.html").then(r => r.text()).then(h => {
            document.getElementById("menu-placeholder").innerHTML = h;
            initMenu();

            // Attach submit handler to the inline homepage login form (if present)
            const homeForm = document.getElementById('homeLoginForm');
            if (homeForm) {
                homeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = (document.getElementById('homeEmail') || {}).value || '';
                    const password = (document.getElementById('homePassword') || {}).value || '';
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        await addLog('login_success', { email, status: 'success', timestamp: new Date().toISOString(), userAgent: navigator.userAgent });
                        showSwal('success', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                        homeForm.reset();
                    } catch (err) {
                        console.error('LOGIN FAIL (home):', err);
                        try { await addLog('login_failure', { email, status: 'error', error_code: err.code, error_message: err.message, timestamp: new Date().toISOString(), userAgent: navigator.userAgent }); } catch(e){}
                        showSwal('error', 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i t√†i kho·∫£n.');
                    }
                });
            }
        });

        // load modal 
        fetch("modal.html").then(r => r.text()).then(h => {
            document.getElementById("loading-placeholder").innerHTML = h;
        });
        // T·∫¢I FOOTER (th√™m ƒëo·∫°n n√†y v√†o)
        fetch("footer.html").then(r => r.text()).then(h => {
            document.getElementById("footer-placeholder").innerHTML = h;
        });

        // Lo·∫°i b·ªè ho√†n to√†n logic ki·ªÉm tra ƒëƒÉng nh·∫≠p ƒë·ªÉ trang lu√¥n hi·ªÉn th·ªã

        // Setup footer date and marquee behavior
        (function(){
          const dEl = document.getElementById('homeFooterDate');
          if (dEl) dEl.textContent = new Date().toLocaleDateString('vi-VN');
          const mq = document.getElementById('homeMarquee');
          if (mq) {
            mq.addEventListener('mouseenter', ()=> mq.style.animationPlayState = 'paused');
            mq.addEventListener('mouseleave', ()=> mq.style.animationPlayState = 'running');
          }
        })();

        // Chat functionality
        (function(){ // ƒê∆°n gi·∫£n h√≥a th√†nh m·ªôt IIFE duy nh·∫•t
            const chatToggle = document.getElementById('chatToggle');
            const chatContainer = document.getElementById('chatContainer');
            const chatClose = document.getElementById('chatClose');
            const chatInput = document.getElementById('chatInput');
            const chatSubmit = document.getElementById('chatSubmit');
            const chatMessages = document.getElementById('chatMessages');
            
            let allCompanies = []; // Bi·∫øn l∆∞u danh s√°ch c√¥ng ty
            let fuse; // Bi·∫øn cho Fuse.js
            let lastMentionedCompany = null; // Bi·∫øn l∆∞u t√™n c√¥ng ty ƒë∆∞·ª£c nh·∫Øc ƒë·∫øn g·∫ßn nh·∫•t
            let companySearchTerm = null; // Khai b√°o bi·∫øn n√†y ·ªü ƒë√¢y
            let chatbotState = 'idle'; // 'idle', 'waitingForCompanyIndexCompany'
            let lastIntent = null; // e.g., 'getLatestCompanyIndex'

            // H√†m kh·ªüi t·∫°o: T·∫£i danh s√°ch c√¥ng ty m·ªôt l·∫ßn
            async function initializeChatbot() {
                try {
                    const companiesRef = collection(db, "reports_1");
                    const snapshot = await getDocs(companiesRef);
                    const uniqueCompanies = new Set();
                    snapshot.forEach(doc => {
                        if (doc.data().company) uniqueCompanies.add(doc.data().company);
                    });
                    allCompanies = Array.from(uniqueCompanies);
                    fuse = new Fuse(allCompanies, { includeScore: true, threshold: 0.4 }); // C·∫•u h√¨nh Fuse.js
                    console.log("Chatbot initialized with companies:", allCompanies);
                } catch (error) { console.error("Failed to initialize chatbot companies:", error); }
            }

            // Toggle chat visibility
            chatToggle.addEventListener('click', () => {
                chatContainer.classList.remove('hidden');
            });

            chatClose.addEventListener('click', () => {
                chatContainer.classList.add('hidden');
            });

            // Handle message submission
            function addMessage(content, isUser = false, isHtml = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
                if (isHtml) {
                    messageDiv.innerHTML = content;
                } else {
                    // Parse markdown
                    let parsedContent = content
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') // **bold**
                        .replace(/\*(.+?)\*/g, '<em>$1</em>') // *italic*
                        .replace(/`(.+?)`/g, '<code>$1</code>') // `code`
                        .replace(/\n/g, '<br>'); // Line breaks
                    messageDiv.innerHTML = parsedContent;
                }
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // N·∫øu l√† tin nh·∫Øn c√≥ n√∫t x√°c nh·∫≠n, th√™m event listener
                if (isHtml && content.includes('confirm-btn')) {
                    messageDiv.querySelectorAll('.confirm-btn').forEach(btn => {
                        btn.addEventListener('click', handleConfirmationClick, { once: true });
                    });
                }
            }

            // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫•n n√∫t "ƒê√∫ng" / "Kh√¥ng"
            async function handleConfirmationClick(event) {
                const button = event.target;
                const isConfirmed = button.dataset.confirmed === 'yes';
                const companyName = button.dataset.company;

                // V√¥ hi·ªáu h√≥a c√°c n√∫t trong tin nh·∫Øn n√†y
                button.parentElement.querySelectorAll('.confirm-btn').forEach(b => b.disabled = true);

                if (isConfirmed) {
                    lastMentionedCompany = companyName; // Set lastMentionedCompany on confirmation
                    const response = await getLatestCompanyIndexFromFirebase(companyName);
                    setTimeout(() => addMessage(response), 300);
                } else { setTimeout(() => addMessage("Xin l·ªói, v·∫≠y b·∫°n vui l√≤ng g√µ l·∫°i t√™n c√¥ng ty ch√≠nh x√°c h∆°n nh√©."), 300); }
            }

            // H√†m: L·∫•y s·ªë l∆∞·ª£ng c√¥ng ty t·ª´ Firebase
            async function getCompanyCountFromFirebase() {
                try {
                    const companiesRef = collection(db, "reports_1");
                    const snapshot = await getDocs(companiesRef);
                    const uniqueCompanies = new Set();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.company) {
                            uniqueCompanies.add(data.company);
                        }
                    });
                    return `Hi·ªán t·∫°i c√≥ ${uniqueCompanies.size} c√¥ng ty trong KCN Th·ªët N·ªët.`;
                } catch (error) {
                    console.error("Chatbot Error - getCompanyCountFromFirebase:", error);
                    return "Xin l·ªói, t√¥i kh√¥ng th·ªÉ l·∫•y th√¥ng tin s·ªë l∆∞·ª£ng c√¥ng ty l√∫c n√†y.";
                }
            }

            // H√†m: L·∫•y ch·ªâ s·ªë m·ªõi nh·∫•t c·ªßa m·ªôt c√¥ng ty t·ª´ Firebase
            async function getLatestCompanyIndexFromFirebase(companyName) {
                try {
                    const reportsRef = collection(db, "reports_1");
                    const q = query(
                        reportsRef,
                        where("company", "==", companyName),
                        orderBy("ngay_ghi", "desc"), // Gi·∫£ ƒë·ªãnh 'ngay_ghi' l√† chu·ªói ng√†y c√≥ th·ªÉ s·∫Øp x·∫øp (YYYY-MM-DD)
                        orderBy("createdAt", "desc"), // S·∫Øp x·∫øp ph·ª• n·∫øu c√≥ nhi·ªÅu b√°o c√°o c√πng ng√†y
                        limit(1) // Ch·ªâ l·∫•y b√°o c√°o m·ªõi nh·∫•t
                    );
                    const snapshot = await getDocs(q);

                    if (!snapshot.empty) {
                        const latestReport = snapshot.docs[0].data();
                        const chiSo = latestReport.chi_so ? latestReport.chi_so.toLocaleString('vi-VN') : 'N/A';
                        const ngayGhi = latestReport.ngay_ghi || 'N/A';
                        return `Ch·ªâ s·ªë m·ªõi nh·∫•t c·ªßa ${companyName} l√† ${chiSo} v√†o ng√†y ${ngayGhi}.`;
                    } else {
                        return `Kh√¥ng t√¨m th·∫•y ch·ªâ s·ªë n√†o cho c√¥ng ty ${companyName}.`;
                    }
                } catch (error) {
                    console.error(`Chatbot Error - getLatestCompanyIndexFromFirebase for ${companyName}:`, error);
                    return `Xin l·ªói, t√¥i kh√¥ng th·ªÉ l·∫•y ch·ªâ s·ªë m·ªõi nh·∫•t c·ªßa ${companyName} l√∫c n√†y.`;
                }
            }

            async function handleUserInput(userMessage) {
                // Add user message to chat
                addMessage(userMessage, true);

                const lowerMsg = userMessage.toLowerCase();
                
                // ====== AI-POWERED CHATBOT ======
                // B∆∞·ªõc 1: Ki·ªÉm tra xem c√≥ c·∫ßn truy v·∫•n database kh√¥ng
                const dataQuery = detectDataQuery(userMessage);
                console.log('üîç detectDataQuery result:', dataQuery);
                let contextData = null;
                
                // B∆∞·ªõc 2: N·∫øu c·∫ßn truy v·∫•n d·ªØ li·ªáu, l·∫•y d·ªØ li·ªáu tr∆∞·ªõc
                if (dataQuery) {
                    try {
                        switch (dataQuery.type) {
                            case 'companyList':
                                // L·∫•y danh s√°ch v√† s·ªë l∆∞·ª£ng c√¥ng ty
                                const totalCount = await getTotalCompanies();
                                const companies = await getAllCompanies();
                                contextData = { 
                                    totalCompanies: totalCount,
                                    companies: companies.slice(0, 20) // Gi·ªõi h·∫°n 20 c√¥ng ty ƒë·∫ßu ti√™n
                                };
                                break;

                            case 'companyData':
                                if (dataQuery.company) {
                                    // L·∫•y ch·ªâ s·ªë m·ªõi nh·∫•t c·ªßa c√¥ng ty
                                    console.log('üìä Fetching data for company:', dataQuery.company);
                                    const latestData = await getLatestCompanyIndex(dataQuery.company);
                                    console.log('üìä Latest data:', latestData);
                                    contextData = { companyData: latestData };
                                } else {
                                    // T√¨m ki·∫øm fuzzy ƒë·ªÉ g·ª£i √Ω c√¥ng ty
                                    console.log('üîé Running fuzzy search for:', userMessage);
                                    const results = fuse.search(userMessage);
                                    console.log('üîé Fuzzy results:', results);
                                    if (results.length > 0 && results[0].score < 0.3) {
                                        const suggestion = results[0].item;
                                        const confirmationHtml = `<p>√ù b·∫°n l√† "${suggestion}" ph·∫£i kh√¥ng?</p>
                                            <button class="confirm-btn" data-confirmed="yes" data-company="${suggestion}">ƒê√∫ng</button>
                                            <button class="confirm-btn" data-confirmed="no">Kh√¥ng</button>`;
                                        setTimeout(() => addMessage(confirmationHtml, false, true), 500);
                                        return;
                                    } else {
                                        console.warn('‚ö†Ô∏è No fuzzy match found or score too low');
                                    }
                                }
                                break;

                            case 'holidayData':
                                // L·∫•y ng√†y ngh·ªâ th√°ng n√†y
                                const now = new Date();
                                const startDate = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
                                const endDate = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-31`;
                                const holidays = await getHolidays(startDate, endDate);
                                const nextHoliday = await getNextHoliday();
                                contextData = { holidays, nextHoliday };
                                break;

                            case 'specialWorkday':
                                // L·∫•y ng√†y l√†m vi·ªác ƒë·∫∑c bi·ªát
                                const now2 = new Date();
                                const start2 = `${now2.getFullYear()}-${String(now2.getMonth()+1).padStart(2,'0')}-01`;
                                const end2 = `${now2.getFullYear()}-${String(now2.getMonth()+1).padStart(2,'0')}-31`;
                                const specialDays = await getSpecialWorkdays(start2, end2);
                                contextData = { specialWorkdays: specialDays };
                                break;

                            case 'statistics':
                                // L·∫•y th·ªëng k√™ theo timeframe
                                if (dataQuery.timeframe === 'tu·∫ßn' || dataQuery.timeframe === 'week') {
                                    contextData = { stats: await getWeeklyStatistics() };
                                } else if (dataQuery.timeframe === 'th√°ng' || dataQuery.timeframe === 'month') {
                                    contextData = { stats: await getMonthlyStatistics() };
                                } else {
                                    // M·∫∑c ƒë·ªãnh l·∫•y c·∫£ 2
                                    const weekly = await getWeeklyStatistics();
                                    const monthly = await getMonthlyStatistics();
                                    contextData = { weeklyStats: weekly, monthlyStats: monthly };
                                }
                                break;

                            case 'comparison':
                                // So s√°nh c√¥ng ty ho·∫∑c l·∫•y top consumers
                                const topConsumers = await getTopConsumers(dataQuery.limit || 5);
                                const comparison = await compareCompaniesThisMonth();
                                contextData = { topConsumers, comparison: comparison.slice(0, 10) };
                                break;

                            case 'quotaMultipliers':
                                // L·∫•y h·ªá s·ªë kho√°n
                                const quotas = await getQuotaMultipliers();
                                contextData = { quotas };
                                break;

                            case 'systemConfig':
                                // L·∫•y c·∫•u h√¨nh h·ªá th·ªëng
                                const startDaySettings = await getStartDaySettings();
                                const defaultHolidays = await getDefaultHolidays();
                                contextData = { startDaySettings, defaultHolidays };
                                break;

                            case 'history':
                                // L·∫•y l·ªãch s·ª≠ c√¥ng ty (n·∫øu c√≥ company trong dataQuery)
                                if (dataQuery.company) {
                                    const now3 = new Date();
                                    const start3 = new Date(now3.getFullYear(), now3.getMonth(), 1);
                                    const end3 = new Date(now3.getFullYear(), now3.getMonth() + 1, 0);
                                    const startStr = start3.toISOString().split('T')[0];
                                    const endStr = end3.toISOString().split('T')[0];
                                    const history = await getCompanyIndexHistory(dataQuery.company, startStr, endStr);
                                    contextData = { history, company: dataQuery.company };
                                }
                                break;

                            default:
                                // Kh√¥ng c√≥ query type c·ª• th·ªÉ
                                break;
                        }
                    } catch (error) {
                        console.error('Error fetching data:', error);
                        contextData = { error: 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ database' };
                    }
                }

                // B∆∞·ªõc 3: G·ªçi AI ƒë·ªÉ x·ª≠ l√Ω v√† tr·∫£ l·ªùi
                const aiResponse = await getAIResponse(userMessage, contextData);
                
                // B∆∞·ªõc 4: Hi·ªÉn th·ªã ph·∫£n h·ªìi t·ª´ AI
                setTimeout(() => addMessage(aiResponse), 500);
            }

            // Handle submit button click
            chatSubmit.addEventListener('click', () => {
                const message = chatInput.value.trim();
                if (message) {
                    handleUserInput(message);
                    chatInput.value = '';
                }
            });

            // Handle enter key press
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const message = chatInput.value.trim();
                    if (message) {
                        handleUserInput(message);
                        chatInput.value = '';
                    }
                }
            });

            // Handle reset button
            const chatReset = document.getElementById('chatReset');
            chatReset.addEventListener('click', () => {
                resetConversation();
                chatMessages.innerHTML = '';
                addMessage('Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa KCN Th·ªët N·ªët. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?');
            });

            // Kh·ªüi t·∫°o chatbot khi trang t·∫£i xong
            initializeChatbot();
            
            // Ki·ªÉm tra v√† hi·ªÉn th·ªã tr·∫°ng th√°i AI
            const aiStatusEl = document.getElementById('aiStatus');
            if (aiStatusEl) {
                if (!hasValidAPIKey()) {
                    aiStatusEl.textContent = '(Ch·∫ø ƒë·ªô c∆° b·∫£n)';
                    aiStatusEl.title = 'Ch∆∞a c√≥ API key. Chatbot ho·∫°t ƒë·ªông ·ªü ch·∫ø ƒë·ªô gi·ªõi h·∫°n. Xem GEMINI_API_SETUP.md ƒë·ªÉ c·∫•u h√¨nh AI.';
                    aiStatusEl.style.color = '#ffa500';
                } else {
                    aiStatusEl.textContent = '(AI)';
                    aiStatusEl.title = 'Chatbot ƒëang s·ª≠ d·ª•ng Google Gemini AI';
                    aiStatusEl.style.color = '#00ff00';
                }
            }
        })();
    </script>
</body>
</html>